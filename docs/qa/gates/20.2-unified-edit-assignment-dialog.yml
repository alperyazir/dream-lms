# Quality Gate Decision for Story 20.2
# Generated: 2025-12-26
# Reviewer: Quinn (Test Architect)

schema: 1
story: "20.2"
story_title: "Unified Edit Assignment Dialog"
gate: CONCERNS
status_reason: "Critical functional gaps: recipients not pre-filled (data loss risk), time planning not supported, missing integration tests"
reviewer: "Quinn (Test Architect)"
updated: "2025-12-26T00:00:00Z"

waiver:
  active: false

top_issues:
  - id: "DATA-001"
    severity: high
    finding: "Recipients (class_ids, student_ids) always empty in edit mode - creates data loss risk if user saves"
    suggested_action: "Fetch recipients when opening edit dialog or extend preview endpoint to include recipient data"
    suggested_owner: dev
    refs:
      - "frontend/src/lib/assignment-utils.ts:28-29"
      - "Frontend uses AssignmentPreviewResponse which doesn't include recipients"

  - id: "FUNC-001"
    severity: medium
    finding: "Time planning not supported in edit mode - always set to false, date_groups always empty"
    suggested_action: "Either implement time planning edit support OR disable editing time-planned assignments with clear warning message"
    suggested_owner: dev
    refs:
      - "frontend/src/lib/assignment-utils.ts:34-36"

  - id: "TEST-001"
    severity: medium
    finding: "Missing integration tests for edit flow - only mapper unit tests exist"
    suggested_action: "Add integration tests verifying: pre-population, update mutation, edit for different assignment types"
    suggested_owner: dev
    refs:
      - "frontend/src/lib/__tests__/assignment-utils.test.ts"
      - "Need: frontend/src/components/assignments/__tests__/AssignmentCreationDialog.edit.test.tsx"

risk_summary:
  totals:
    critical: 0
    high: 1      # Recipients data loss risk
    medium: 2    # Time planning + missing tests
    low: 0
  highest: high
  recommendations:
    must_fix:
      - "Fix recipients pre-filling to prevent data loss on edit"
      - "Address time planning limitation (implement or disable)"
    monitor:
      - "Integration test coverage for edit mode"

quality_score: 70
expires: "2026-01-09T00:00:00Z"

evidence:
  tests_reviewed: 3
  risks_identified: 3
  trace:
    ac_covered: [1, 2, 3, 4, 5, 6, 10, 11, 12, 13, 16, 17, 18, 19, 20, 21, 22, 23, 24, 26]
    ac_gaps: [7, 8, 9, 14, 15, 25]
    ac_gaps_notes: |
      AC 7-8: Time planning state/sessions not pre-filled (always false/empty)
      AC 9: Recipients not pre-filled (always empty arrays)
      AC 14: Cannot change recipients (always empty, would unassign all if saved)
      AC 15: Cannot modify time planning (not supported in edit mode)
      AC 25: Does not work for time-planned assignments (loses time planning config)

nfr_validation:
  security:
    status: PASS
    notes: "Proper ownership verification; update endpoint validates teacher can only edit own assignments"
  performance:
    status: PASS
    notes: "No performance issues; reuses existing dialog; proper query invalidation"
  reliability:
    status: CONCERNS
    notes: "Recipients always empty creates data loss risk; time planning unsupported limits functionality"
  maintainability:
    status: PASS
    notes: "Clean code structure; good separation of concerns; mapper function well-designed"

recommendations:
  immediate:
    - action: "Investigate why AssignmentPreviewResponse doesn't include recipients and fix"
      refs: ["frontend/src/lib/assignment-utils.ts:28-29", "Possibly add getAssignmentWithRecipients endpoint"]
      estimated_effort: "2-3 hours"
      priority: "CRITICAL"

    - action: "Decide on time planning approach: implement edit support OR disable editing time-planned assignments"
      refs: ["frontend/src/lib/assignment-utils.ts:34-36"]
      estimated_effort: "1-2 hours"
      priority: "CRITICAL"

    - action: "Add integration tests for edit flow (pre-population, update mutation, different assignment types)"
      refs: ["frontend/src/components/assignments/__tests__/"]
      estimated_effort: "1 hour"
      priority: "HIGH"

  future:
    - action: "Add E2E test for complete edit workflow"
      refs: ["frontend/tests/"]

    - action: "Consider dedicated 'get assignment for edit' endpoint instead of using preview"
      refs: ["backend/app/api/routes/assignments.py"]

    - action: "Add loading state while fetching assignment data for edit"
      refs: ["frontend/src/components/assignments/AssignmentCreationDialog.tsx"]

history:
  - at: "2025-12-26T00:00:00Z"
    gate: CONCERNS
    note: "Initial QA review - critical functional gaps identified (recipients, time planning, tests)"
