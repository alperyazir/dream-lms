# Risk Profile: Story 2.4

**Story:** 2.4 - Build Books & Assignments Pages (Mock Data)
**Date:** 2025-10-28
**Reviewer:** Quinn (Test Architect)
**Status:** Ready for Review

---

## Executive Summary

- **Total Risks Identified:** 8
- **Critical Risks:** 1 (DATA-001)
- **High Risks:** 2 (OPS-001, DATA-002)
- **Medium Risks:** 2 (TECH-001, PERF-001)
- **Low Risks:** 3 (SEC-001, BUS-001, OPS-002)
- **Risk Score:** 44/100 ⚠️ **HIGH RISK**

**⚠️ CRITICAL ISSUE DETECTED:** State management bug prevents newly created assignments from appearing in list until page refresh. This is a must-fix blocking issue.

---

## Critical Risks Requiring Immediate Attention

### 1. DATA-001: State Management Bug - New Assignments Not Visible

**Score: 9 (Critical)**
**Category:** Data Risk
**Probability:** High (3) - Bug confirmed in code review
**Impact:** High (3) - Core feature completely broken

**Description:**
Newly created assignments via AssignmentWizard don't appear in the teacher assignments list until page refresh. This severely impacts user experience and makes the feature appear broken.

**Root Cause Analysis:**
```typescript
// AssignmentWizard.tsx:115
mockAssignments.push(newAssignment)  // ❌ Direct array mutation

// teacher/assignments/index.tsx:66
}, [statusFilter, sortOrder])  // ❌ useMemo doesn't track mockAssignments changes
```

The wizard directly mutates the `mockAssignments` array using `.push()`, but React doesn't detect this change because:
1. The array reference doesn't change (same memory address)
2. The assignments list component uses `useMemo` with dependencies on `statusFilter` and `sortOrder` only
3. No state management triggers re-render when array is mutated

**Affected Components:**
- `frontend/src/components/assignments/AssignmentWizard.tsx` (line 115)
- `frontend/src/routes/_layout/teacher/assignments/index.tsx` (lines 52-66)
- `frontend/src/routes/_layout/teacher/books/$bookId.tsx` (if it lists assignments)

**Detection Method:**
Code review revealed missing reactive state management

**User Impact:**
Teacher creates assignment → sees success toast → navigates to assignments page → **assignment is missing** → confusion and frustration → must refresh browser to see assignment

**Mitigation:**

**Strategy:** Preventive (fix before production)

**Required Actions:**
1. **Option A (Recommended):** Add React state management
   ```typescript
   // In teacher/assignments/index.tsx
   const [assignments, setAssignments] = useState(mockAssignments)

   // Pass setAssignments to wizard via context or callback
   // In wizard: setAssignments(prev => [...prev, newAssignment])
   ```

2. **Option B:** Use Zustand store for global assignment state
   ```typescript
   // stores/assignmentStore.ts
   const useAssignmentStore = create((set) => ({
     assignments: mockAssignments,
     addAssignment: (assignment) =>
       set((state) => ({ assignments: [...state.assignments, assignment] }))
   }))
   ```

3. **Option C:** Force re-render with key prop based on assignment count

**Testing Requirements:**
- **Unit Test:** Verify assignment appears immediately after creation
- **Integration Test:** Full wizard flow → verify list updates without refresh
- **Manual Test:** Create assignment → navigate to list → confirm visible

**Residual Risk:** Low after fix - standard React patterns are well-tested

**Owner:** Dev Team
**Timeline:** **Must fix before deployment** (blocking issue)

---

## High Risks

### 2. OPS-001: No Unit Tests Written

**Score: 6 (High)**
**Category:** Operational Risk
**Probability:** High (3) - Confirmed via `glob` search
**Impact:** Medium (2) - Increases bug risk, reduces maintainability

**Description:**
Story requirements specify mandatory unit tests for AssignmentCard, BookCard, and mock data structures. Search for `**/*.test.tsx` found zero test files despite all task checkboxes marked complete.

**Detection Method:**
```bash
glob: frontend/src/components/**/*.test.tsx
Result: No files found
```

**Required Test Coverage:**
- ✅ **Mandatory (Blocking):**
  - AssignmentCard component (3 test cases)
  - BookCard component (1 test case)
  - Mock data structure validation
- ⚠️ **Recommended (Not Blocking):**
  - AssignmentWizard (4 test cases)
  - Search/filter functions (2 test cases)

**Target Coverage:** >70% on new components

**Mitigation:**

**Actions Required:**
1. Create test files following co-location pattern:
   ```
   components/assignments/AssignmentCard.test.tsx
   components/books/BookCard.test.tsx
   lib/mockData.test.ts
   ```

2. Run coverage report: `npm run test:coverage`

3. Fix any failing tests before marking story complete

**Testing Requirements:**
- Minimum 70% coverage on new components
- All acceptance criteria validated via tests
- CI/CD pipeline integration (if applicable)

**Timeline:** Before marking story "Done" (currently blocks Done status)

---

### 3. DATA-002: Mock Data Lost on Page Refresh

**Score: 6 (High)**
**Category:** Data Risk
**Probability:** High (3) - Inevitable with in-memory storage
**Impact:** Medium (2) - Poor UX, confusion

**Description:**
All user-created assignments exist only in-memory and are lost on page refresh. Teacher creates 5 assignments, refreshes page, all assignments gone except original mock data.

**User Impact:**
- Teachers lose all work on refresh
- Cannot test realistic workflows
- Confusion about whether assignments were actually saved

**Mitigation:**

**Strategy:** Corrective (improve UX within mock data constraints)

**Actions:**
1. **Quick Fix:** Add localStorage persistence
   ```typescript
   // Save on create
   localStorage.setItem('mockAssignments', JSON.stringify(mockAssignments))

   // Load on init
   const savedAssignments = localStorage.getItem('mockAssignments')
   if (savedAssignments) {
     mockAssignments = JSON.parse(savedAssignments)
   }
   ```

2. **Better Fix:** Use Zustand with persist middleware
   ```typescript
   const useAssignmentStore = create(
     persist(
       (set) => ({ assignments: mockAssignments, ... }),
       { name: 'dream-lms-assignments' }
     )
   )
   ```

3. **Add Warning Message:** Display banner "Demo Mode: Data is not saved permanently"

**Testing Requirements:**
- Manual test: Create assignment → refresh → verify persists
- Test localStorage clear functionality
- Validate JSON serialization of all data types

**Residual Risk:** Low - localStorage is reliable for mock data demo

**Owner:** Dev Team
**Timeline:** Optional enhancement (not blocking deployment)

---

## Medium Risks

### 4. TECH-001: Timezone Issues in Date Comparisons

**Score: 4 (Medium)**
**Category:** Technical Risk
**Probability:** Medium (2) - Depends on user timezone
**Impact:** Medium (2) - Assignments miscategorized

**Description:**
Date comparison logic for "Past Due" filtering uses `new Date()` which creates dates in user's local timezone. This could cause assignments to be incorrectly marked as past due.

**Code Location:**
```typescript
// teacher/assignments/index.tsx:39-48
const now = new Date()  // Local timezone
const dueDate = new Date(assignment.due_date)  // ISO string converted to local

if (dueDate < now) {
  return "past-due"
}
```

**Scenarios:**
- User in EST creates assignment due "5pm EST"
- User in PST views it → might show as past due at 2pm PST
- Inconsistent "Past Due" badge across timezones

**Mitigation:**

**Actions:**
1. Use UTC for all comparisons:
   ```typescript
   const now = new Date()
   const dueDate = new Date(assignment.due_date)

   // Compare timestamps (always UTC)
   if (dueDate.getTime() < now.getTime())
   ```

2. Add timezone display to UI:
   ```typescript
   {new Date(assignment.due_date).toLocaleString(undefined, {
     timeZoneName: 'short'
   })}
   ```

3. Validate `datetime-local` input handles timezones correctly

**Testing Requirements:**
- Test in different timezones (EST, PST, UTC)
- Test edge case: assignment due "now" ±1 hour
- Test date picker input/output consistency

**Residual Risk:** Low - standard date handling best practices

**Owner:** Dev Team
**Timeline:** Before production deployment

---

### 5. PERF-001: Multiple Countdown Timers

**Score: 4 (Medium)**
**Category:** Performance Risk
**Probability:** Medium (2) - Only affects views with many assignments
**Impact:** Medium (2) - UI lag, battery drain

**Description:**
Student assignment view shows countdown timers via `useCountdown` hook. With 20+ assignments, 20+ timers run every second updating React state.

**Code Location:**
```typescript
// components/assignments/AssignmentCard.tsx:574
const { days, hours, minutes } = useCountdown(assignment.due_date)
```

**Performance Impact:**
- 20 assignments = 20 timers × 1 update/second = 20 re-renders/second
- Mobile devices: battery drain
- Older devices: UI lag/jank

**Mitigation:**

**Actions:**
1. **Use Single Timer:** One global timer updates all countdowns
   ```typescript
   // hooks/useGlobalCountdown.ts
   const useGlobalCountdown = () => {
     const [now, setNow] = useState(Date.now())

     useEffect(() => {
       const interval = setInterval(() => setNow(Date.now()), 1000)
       return () => clearInterval(interval)
     }, [])

     return now
   }

   // In component:
   const now = useGlobalCountdown()
   const countdown = calculateCountdown(assignment.due_date, now)
   ```

2. **Virtualization:** Only render visible cards
   ```typescript
   import { useVirtualizer } from '@tanstack/react-virtual'
   ```

3. **Increase Update Interval:** Update every 10-30 seconds instead of every second

**Testing Requirements:**
- Performance profiling with 50+ assignments
- Monitor re-renders with React DevTools Profiler
- Test on low-end mobile device

**Residual Risk:** Medium - only affects large assignment lists

**Owner:** Dev Team
**Timeline:** Monitor in production, optimize if needed

---

## Low Risks

### 6. SEC-001: No Access Control on Student Data

**Score: 3 (Low)**
**Category:** Security Risk
**Probability:** Low (1) - Mock data, no real PII
**Impact:** High (3) - If real data were present

**Description:**
Mock data includes student names, scores, completion status with no authentication or authorization checks. Acceptable for mock data phase but must be addressed when integrating real backend.

**Mitigation:**
- Document requirement for Epic 3: Add JWT validation, role-based access control
- Ensure backend API has proper authorization before data is real
- Add security review gate before production

**Timeline:** Epic 3+ (backend integration)

---

### 7. BUS-001: Assignment Wizard UX Complexity

**Score: 2 (Low)**
**Category:** Business Risk
**Probability:** Low (1) - Multi-step wizards are common pattern
**Impact:** Medium (2) - Could confuse some users

**Description:**
4-step wizard might feel complex for simple assignment creation. Some teachers may prefer a single-page form.

**Mitigation:**
- Add "Quick Create" option in future story
- User testing to validate wizard UX
- Add progress save (Step 2 → close → reopen → still on Step 2)

**Timeline:** Post-MVP enhancement

---

### 8. OPS-002: Dark Mode Testing Incomplete

**Score: 1 (Minimal)**
**Category:** Operational Risk
**Probability:** Low (1) - Minor UI issue
**Impact:** Low (1) - Cosmetic only

**Description:**
Story checklist shows "Check color contrast meets accessibility standards" unchecked in dark mode testing section.

**Mitigation:**
- Run contrast checker tool (WebAIM, Lighthouse)
- Test all status badge colors in dark mode
- Ensure WCAG AA compliance (4.5:1 ratio)

**Timeline:** Before marking story "Done"

---

## Risk Distribution

### By Category
- **Data Risks:** 2 (1 critical, 1 high)
- **Operational Risks:** 2 (1 high, 1 low)
- **Technical Risks:** 1 (medium)
- **Performance Risks:** 1 (medium)
- **Security Risks:** 1 (low)
- **Business Risks:** 1 (low)

### By Component
- **Frontend State Management:** 2 risks (DATA-001, DATA-002)
- **Testing Infrastructure:** 1 risk (OPS-001)
- **Date/Time Handling:** 1 risk (TECH-001)
- **Performance Optimization:** 1 risk (PERF-001)
- **Security/Access Control:** 1 risk (SEC-001)
- **User Experience:** 1 risk (BUS-001)
- **Accessibility:** 1 risk (OPS-002)

---

## Detailed Risk Register

| Risk ID  | Category | Description                          | Probability | Impact | Score | Priority |
|----------|----------|--------------------------------------|-------------|--------|-------|----------|
| DATA-001 | Data     | New assignments not visible          | High (3)    | High (3) | 9   | **Critical** |
| OPS-001  | Ops      | No unit tests written                | High (3)    | Med (2)  | 6   | High     |
| DATA-002 | Data     | Mock data lost on refresh            | High (3)    | Med (2)  | 6   | High     |
| TECH-001 | Tech     | Timezone issues in date comparisons  | Med (2)     | Med (2)  | 4   | Medium   |
| PERF-001 | Perf     | Multiple countdown timers            | Med (2)     | Med (2)  | 4   | Medium   |
| SEC-001  | Security | No access control on student data    | Low (1)     | High (3) | 3   | Low      |
| BUS-001  | Business | Wizard UX complexity                 | Low (1)     | Med (2)  | 2   | Low      |
| OPS-002  | Ops      | Dark mode testing incomplete         | Low (1)     | Low (1)  | 1   | Minimal  |

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Complete Before Production)

**DATA-001 Validation:**
1. **Test: Assignment Creation and Immediate Visibility**
   - Step 1: Open AssignmentWizard from book detail page
   - Step 2: Complete all 4 wizard steps
   - Step 3: Click "Create Assignment"
   - Step 4: Navigate to `/teacher/assignments`
   - **Expected:** New assignment appears in list immediately
   - **Actual (before fix):** Assignment missing until page refresh

2. **Test: Assignment Persists Across Filters**
   - Create assignment with due date tomorrow
   - Filter by "Active"
   - **Expected:** Assignment visible in Active filter
   - Switch to "All Assignments"
   - **Expected:** Assignment still visible

3. **Test: Multiple Assignments Created in Sequence**
   - Create assignment A
   - Create assignment B
   - Navigate to assignments list
   - **Expected:** Both A and B visible

**OPS-001 Validation:**
1. Run `npm run test` → must pass
2. Run `npm run test:coverage` → must show >70% coverage on new components
3. Verify test files exist:
   - `components/assignments/AssignmentCard.test.tsx`
   - `components/books/BookCard.test.tsx`
   - `lib/mockData.test.ts`

### Priority 2: High Risk Tests

**DATA-002 Validation:**
- If localStorage persistence added:
  - Create assignment → refresh → verify persists
  - Create 5 assignments → refresh → verify all 5 persist
  - Clear localStorage → verify returns to default mock data

**TECH-001 Validation:**
- Create assignment due "today at 11:59pm"
- Wait until past midnight
- Verify shows as "Past Due" correctly
- Test in different browser timezone settings

### Priority 3: Medium/Low Risk Tests

**PERF-001 Validation:**
- Load student assignments page with 20+ assignments
- Open Chrome DevTools → Performance tab
- Record 10 seconds
- Check for excessive re-renders
- Verify smooth 60fps scrolling

**Standard Functional Tests:**
- Book catalog search works (case-insensitive)
- Filter by Publisher, Grade, Activity Type
- Assignment wizard validation (required fields)
- Student assignment tabs (To Do, Completed, Past Due)
- Responsive design (mobile, tablet, desktop)

---

## Risk Acceptance Criteria

### Must Fix Before Production ⛔

1. **DATA-001:** State management bug (critical)
   - Fix: Add reactive state management for assignments
   - Validation: All Priority 1 tests pass

2. **OPS-001:** Unit tests missing (high)
   - Fix: Write mandatory tests (AssignmentCard, BookCard, mockData)
   - Validation: `npm run test:coverage` shows >70%

### Can Deploy with Mitigation ⚠️

3. **DATA-002:** Mock data persistence (high)
   - Mitigation: Add banner "Demo Mode - Data not permanently saved"
   - Future: Implement localStorage or defer to backend integration
   - Rationale: Acceptable for mock data phase if users are warned

4. **TECH-001:** Timezone handling (medium)
   - Mitigation: Document timezone assumptions in code comments
   - Future: Fix when backend provides timezone-aware dates
   - Rationale: Edge case, affects small percentage of users

5. **PERF-001:** Countdown timer performance (medium)
   - Mitigation: Monitor performance metrics
   - Future: Optimize if user reports lag
   - Rationale: Only affects users with 20+ assignments

### Accepted Risks ✅

6. **SEC-001:** No access control (low)
   - Acceptance: Mock data only, no real PII
   - Defer to: Epic 3 (backend integration)

7. **BUS-001:** Wizard UX complexity (low)
   - Acceptance: Standard pattern, validated by dev team
   - Future: User testing in beta phase

8. **OPS-002:** Dark mode contrast (minimal)
   - Acceptance: Visual issue only, not blocking
   - Fix: Quick WCAG checker run before Done

---

## Monitoring Requirements

**Post-Deployment Monitoring:**

1. **Performance Metrics** (PERF-001)
   - Track page load time for `/student/assignments`
   - Monitor client-side CPU usage
   - Alert if >100ms render time

2. **Error Rates** (DATA-001, TECH-001)
   - Track assignment creation success rate
   - Monitor date parsing errors
   - Alert on >1% failure rate

3. **Business KPIs** (BUS-001)
   - Assignment wizard completion rate
   - Time spent per wizard step
   - Abandonment rate per step

4. **User Feedback**
   - Collect feedback on wizard UX
   - Track support tickets related to assignments not appearing

---

## Risk Review Triggers

**Review and update risk profile when:**

1. **Architecture changes significantly**
   - Backend integration begins (Epic 3)
   - State management library changes
   - Database schema finalized

2. **New integrations added**
   - Real authentication system
   - Third-party activity player
   - Analytics/monitoring tools

3. **Security vulnerabilities discovered**
   - Dependency vulnerabilities (npm audit)
   - OWASP ZAP scan findings
   - Penetration test results

4. **Performance issues reported**
   - User reports of lag
   - Slow page load metrics
   - Mobile device complaints

5. **Regulatory requirements change**
   - FERPA compliance needed
   - GDPR requirements
   - Accessibility standards updated (WCAG 2.2)

---

## Recommendations Summary

### Immediate Actions (Before Production)

1. ⛔ **Fix DATA-001:** Implement reactive state management for assignments
2. ⛔ **Fix OPS-001:** Write mandatory unit tests
3. ⚠️ **Mitigate DATA-002:** Add localStorage persistence OR warning banner
4. ⚠️ **Fix TECH-001:** Validate timezone handling in date comparisons
5. ✅ **Complete OPS-002:** Run WCAG contrast checker

### Nice-to-Have Improvements

1. Optimize countdown timer performance (PERF-001)
2. Add "Quick Create" assignment option (BUS-001)
3. Conduct user testing on wizard UX
4. Add E2E Playwright tests
5. Implement virtualization for large assignment lists

### Deferred to Future Epics

1. Backend integration with real data persistence
2. Authentication and authorization system
3. Role-based access control (RBAC)
4. Production monitoring and alerting
5. Security audit and penetration testing

---

## Conclusion

Story 2.4 has **1 critical risk** (DATA-001) that is a **blocking issue** for production deployment. The state management bug causes newly created assignments to not appear in the list, breaking core functionality.

Additionally, **mandatory unit tests** (OPS-001) have not been written despite task checkboxes being marked complete.

**Recommended Gate Decision:** **FAIL** (must fix critical bugs before proceeding)

Once DATA-001 is fixed and tests are written, the story can be re-evaluated. With those fixes in place, the remaining risks are manageable with appropriate mitigations.

**Estimated Fix Time:**
- DATA-001 fix: 2-4 hours (add state management)
- OPS-001 fix: 4-6 hours (write mandatory tests)
- **Total:** 1 day of development work

After fixes, recommend full regression testing and re-review before marking story "Done".

---

**Report Generated:** 2025-10-28
**Next Review:** After critical fixes implemented
**QA Contact:** Quinn (Test Architect)
