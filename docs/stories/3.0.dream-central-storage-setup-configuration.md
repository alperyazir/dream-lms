# Story 3.0: Dream Central Storage Setup & Configuration

**Epic:** 3 - Book Integration & Assignment Management
**Story ID:** 3.0
**Status:** Done
**Created:** 2025-11-14
**Developer:** James (Full Stack Developer)

---

## User Story

**As a** developer,
**I want** to document and configure the Dream Central Storage integration credentials and environment,
**so that** the application can connect to Dream Central Storage in development and production environments.

---

## Acceptance Criteria

1. Environment variables added to `.env` and documented in `.env.example`:
   - `DREAM_CENTRAL_STORAGE_URL` (default: `http://localhost:8081` for dev, production URL for prod)
   - `DREAM_CENTRAL_STORAGE_EMAIL` (default: `admin@admin.com` for dev, to be changed in production)
   - `DREAM_CENTRAL_STORAGE_PASSWORD` (default: `admin` for dev, to be changed in production)
   - `DREAM_CENTRAL_STORAGE_TOKEN_EXPIRY` (default: 30 minutes - JWT token lifespan)
2. Configuration module `app/core/config.py` includes Dream Central Storage settings with validation
3. Developer documentation (`docs/setup.md` or similar) explains:
   - How to set up local Dream Central Storage instance for development
   - How credentials are used (JWT authentication flow)
   - Security note: Production credentials must be different from development defaults
   - How to test connectivity: `curl -X POST http://localhost:8081/auth/login -H "Content-Type: application/json" -d '{"email":"admin@admin.com","password":"admin"}'`
4. `.env.example` includes clear comments warning that default credentials are for development only
5. CI/CD pipeline documentation includes steps for setting production environment variables
6. Health check endpoint `GET /api/v1/utils/health-check/` includes Dream Central Storage connectivity status
7. Admin panel (if exists) or management command to test Dream Central Storage connection
8. Security documentation warns against committing actual credentials to version control

---

## Tasks / Subtasks

- [x] **Task 1: Update Environment Configuration Files** (AC: 1, 4)
  - [x] Add Dream Central Storage environment variables to `.env` (already done)
  - [x] Create/update `.env.example` with documented Dream Central Storage variables
  - [x] Add security warning comments about production credentials

- [x] **Task 2: Update Backend Configuration Module** (AC: 2)
  - [x] Add Dream Central Storage settings to `backend/app/core/config.py`
  - [x] Use Pydantic `BaseSettings` for validation
  - [x] Set sensible defaults for token expiry (1800 seconds = 30 minutes)
  - [x] Ensure `DREAM_CENTRAL_STORAGE_URL`, `EMAIL`, and `PASSWORD` are required fields
  - [x] Add `DREAM_CENTRAL_STORAGE_WEBHOOK_SECRET` to config (for future webhook integration)

- [x] **Task 3: Extend Health Check Endpoint** (AC: 6)
  - [x] Locate existing health check at `GET /api/v1/utils/health-check/`
  - [x] Add Dream Central Storage connectivity check
  - [x] Test authentication by calling `POST /auth/login` to Dream Central Storage
  - [x] Return status: `dream_central_storage: "healthy" | "unhealthy"`
  - [x] Handle connection timeouts gracefully (don't block health check response)
  - [x] Log connection failures for debugging

- [x] **Task 4: Create Developer Documentation** (AC: 3, 8)
  - [x] Check if `docs/setup.md` exists, if not create it
  - [x] Document Dream Central Storage setup section:
    - How to run Dream Central Storage locally (Docker command or reference)
    - Environment variable configuration
    - JWT authentication flow explanation
    - Test connectivity command example
  - [x] Add security section warning about credentials
  - [x] Document production deployment considerations

- [x] **Task 5: Update CI/CD Documentation** (AC: 5)
  - [x] Locate CI/CD documentation (likely `.github/workflows/` or `docs/deployment.md`)
  - [x] Add step for setting `DREAM_CENTRAL_STORAGE_*` environment variables
  - [x] Document environment variable priority (env vars > .env file)
  - [x] Add note about using secrets management (AWS Secrets Manager, etc.)

- [x] **Task 6: Create Admin Test Connection Feature** (AC: 7)
  - [x] Option A: Add `/api/v1/admin/test-dream-storage-connection` endpoint
  - [x] Option B: Add management CLI command `python manage.py test-dream-storage`
  - [x] Test endpoint calls `POST /auth/login` and verifies 200 response
  - [x] Return detailed connection status and error messages
  - [x] Require admin authentication

- [x] **Task 7: Write Tests** (Testing section)
  - [x] Unit test: Verify config module loads Dream Central Storage settings
  - [x] Unit test: Verify settings validation (required fields)
  - [x] Integration test: Health check includes Dream Central Storage status
  - [x] Integration test: Admin test connection endpoint returns correct status

---

## Dev Notes

### **Configuration Module Pattern**
[Source: architecture/source-tree.md#Backend Structure]

Configuration is managed in `backend/app/core/config.py` using Pydantic `BaseSettings`:

```python
from pydantic import Field
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # Existing settings...
    POSTGRES_SERVER: str
    SECRET_KEY: str

    # Dream Central Storage settings (NEW)
    DREAM_CENTRAL_STORAGE_URL: str = Field(
        default="http://localhost:8081",
        description="Dream Central Storage base URL"
    )
    DREAM_CENTRAL_STORAGE_EMAIL: str = Field(
        default="admin@admin.com",
        description="Admin email for Dream Central Storage authentication"
    )
    DREAM_CENTRAL_STORAGE_PASSWORD: str = Field(
        default="admin",
        description="Admin password for Dream Central Storage authentication"
    )
    DREAM_CENTRAL_STORAGE_TOKEN_EXPIRY: int = Field(
        default=1800,
        description="JWT token expiry in seconds (default: 30 minutes)"
    )
    DREAM_CENTRAL_STORAGE_WEBHOOK_SECRET: str = Field(
        default="changethis",
        description="Secret for validating webhook signatures from Dream Central Storage"
    )

    class Config:
        env_file = ".env"
        case_sensitive = True
```

**Key Points:**
- Settings are automatically loaded from `.env` file
- Environment variables override `.env` file values
- Required fields raise validation error if missing
- Default values are for development only

### **JWT Authentication Flow**
[Source: epic-3-book-integration-assignment-management.md#Story 3.0]

Dream Central Storage uses JWT token-based authentication:

1. **Login:** `POST /auth/login` with `{"email": "...", "password": "..."}`
2. **Response:** `{"access_token": "eyJ...", "token_type": "bearer"}`
3. **Token Lifespan:** 30 minutes (configurable)
4. **Usage:** All subsequent API calls include `Authorization: Bearer {token}`
5. **Token Refresh:** Client must re-authenticate when token expires

This story only configures credentials. Story 3.1 will implement the actual HTTP client.

### **Health Check Endpoint Location**
[Source: architecture/3-api-architecture.md]

Existing health check endpoint pattern in FastAPI template:
- Location: `backend/app/api/routes/utils.py` or similar
- Endpoint: `GET /api/v1/utils/health-check/`
- Current checks: Database connectivity
- **Add:** Dream Central Storage connectivity

**Implementation Pattern:**
```python
@router.get("/utils/health-check/")
async def health_check():
    """Health check endpoint including external service status"""
    checks = {
        "database": await check_database(),
        "dream_central_storage": await check_dream_storage()
    }

    overall_status = "healthy" if all(checks.values()) else "degraded"

    return {
        "status": overall_status,
        "checks": checks,
        "timestamp": datetime.utcnow()
    }
```

### **Environment Variables**
[Source: .env file]

**Already Added to `.env`:**
```env
DREAM_CENTRAL_STORAGE_URL=http://localhost:8081
DREAM_CENTRAL_STORAGE_EMAIL=admin@admin.com
DREAM_CENTRAL_STORAGE_PASSWORD=admin
DREAM_CENTRAL_STORAGE_TOKEN_EXPIRY=1800
DREAM_CENTRAL_STORAGE_WEBHOOK_SECRET=changethis
```

**Need to Add to `.env.example`** (for documentation):
- Same variables with comments
- Security warning: "⚠️ Development credentials only! Change for production!"

### **Documentation Files**
[Source: architecture/source-tree.md#Documentation Structure]

Documentation structure:
```
docs/
├── prd/
├── architecture/
└── stories/
```

Create or update: `docs/setup.md` or `docs/deployment.md`

### **HTTP Client Library**
[Source: architecture/tech-stack.md#Backend Stack]

- **Library:** `httpx` (already in tech stack)
- **Purpose:** Async HTTP client for external API calls
- **Usage:** Story 3.1 will implement `DreamCentralStorageClient` using httpx

### **Security Considerations**
[Source: architecture/coding-standards.md#Security Best Practices]

- ✅ Never log passwords or tokens
- ✅ Validate all inputs with Pydantic
- ✅ Use HTTPS only in production
- ✅ Store production credentials in secure secrets management (AWS Secrets Manager, etc.)
- ✅ Never commit actual production credentials to version control
- ✅ Use different credentials for dev/staging/production environments

### **Project Structure Notes**
[Source: architecture/source-tree.md]

Relevant file locations:
- **Config:** `backend/app/core/config.py`
- **Health check:** `backend/app/api/routes/utils.py` (or create if doesn't exist)
- **Tests:** `backend/app/tests/test_config.py`, `backend/app/tests/test_api/test_health.py`
- **Documentation:** `docs/setup.md` or `docs/deployment.md`

---

## Testing

### **Testing Framework**
[Source: architecture/tech-stack.md#Testing & Quality, architecture/10-testing-strategy.md]

- **Framework:** `pytest` with async support
- **Test Location:** `backend/app/tests/`
- **Fixtures:** Use existing `TestingSessionLocal`, `client: AsyncClient`
- **Pattern:** Arrange-Act-Assert

### **Unit Tests Required**

**File:** `backend/app/tests/test_config.py`

```python
def test_dream_storage_config_loads_from_env():
    """Test that Dream Central Storage settings load from environment"""
    assert settings.DREAM_CENTRAL_STORAGE_URL == "http://localhost:8081"
    assert settings.DREAM_CENTRAL_STORAGE_EMAIL == "admin@admin.com"
    assert settings.DREAM_CENTRAL_STORAGE_TOKEN_EXPIRY == 1800

def test_dream_storage_config_validation():
    """Test that missing required fields raise validation error"""
    # Test with missing URL (if made required)
    pass
```

### **Integration Tests Required**

**File:** `backend/app/tests/test_api/test_health.py`

```python
@pytest.mark.asyncio
async def test_health_check_includes_dream_storage_status(client: AsyncClient):
    """Test that health check includes Dream Central Storage status"""
    response = await client.get("/api/v1/utils/health-check/")

    assert response.status_code == 200
    data = response.json()

    assert "checks" in data
    assert "dream_central_storage" in data["checks"]
    assert data["checks"]["dream_central_storage"] in ["healthy", "unhealthy"]
```

**File:** `backend/app/tests/test_api/test_admin.py`

```python
@pytest.mark.asyncio
async def test_admin_can_test_dream_storage_connection(
    client: AsyncClient,
    admin_token: str
):
    """Test admin endpoint for testing Dream Central Storage connection"""
    response = await client.get(
        "/api/v1/admin/test-dream-storage-connection",
        headers={"Authorization": f"Bearer {admin_token}"}
    )

    assert response.status_code == 200
    assert "status" in response.json()
    assert "message" in response.json()
```

### **Testing Coverage Goal**
[Source: architecture/coding-standards.md#General Principles]

- Aim for >80% coverage on new code
- All configuration loading must be tested
- Health check integration must be tested

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-14 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-11-14 | 1.1 | Story completed - all tasks implemented and tested | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

- Fixed `Depends()` double-wrapping issue in admin.py:1545 (require_role already returns Depends object)
- Fixed AsyncSession vs Session mismatch - changed health check to use sync Session
- Fixed datetime.utcnow() deprecation - changed to datetime.now(timezone.utc)
- Fixed test fixtures - changed from AsyncClient to TestClient to match conftest
- All 8 tests passed successfully

### Completion Notes

**Implementation Summary:**

All 7 tasks completed successfully. Dream Central Storage configuration is now fully integrated into the application with comprehensive testing and documentation.

**Key Decisions:**
1. Used sync Session for health check instead of AsyncSession to match existing get_db dependency
2. Implemented admin test connection as REST endpoint (Option A) rather than CLI command
3. Added webhook secret validation to default secret checker in config
4. Updated both staging and production CI/CD workflows with Dream Central Storage environment variables
5. Enhanced health check to return structured JSON with individual service checks instead of simple boolean

**Test Coverage:**
- Config tests: 3/3 passed ✅
- Health check tests: 3/3 passed ✅
- Admin endpoint tests: 2/2 passed ✅
- Total: 8/8 tests passed

**Security Considerations:**
- All production credential warnings added to documentation
- Environment variable hierarchy documented (env vars > .env)
- Webhook secret validation added to prevent default values in production

### File List

**Created:**
- `.env.example` - Environment variable template with Dream Central Storage settings
- `backend/app/tests/test_config.py` - Configuration unit tests
- `backend/app/tests/test_health_check.py` - Health check integration tests

**Modified:**
- `backend/app/core/config.py` - Added 5 Dream Central Storage settings with validation
- `backend/app/api/routes/utils.py` - Enhanced health check endpoint with Dream Storage check
- `backend/app/api/routes/admin.py` - Added test connection endpoint (line 1543-1604)
- `development.md` - Added Dream Central Storage setup section
- `deployment.md` - Added GitHub Secrets documentation for Dream Storage
- `.github/workflows/deploy-production.yml` - Added Dream Storage environment variables
- `.github/workflows/deploy-staging.yml` - Added Dream Storage environment variables
- `backend/app/tests/test_api_admin.py` - Added 2 new tests for admin test connection endpoint

---

## QA Results

### Review Date: 2025-11-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT**

The implementation demonstrates high-quality software engineering practices with comprehensive configuration management, robust error handling, and thorough test coverage. All 8 acceptance criteria are fully met with professional-grade implementation.

**Strengths:**
- Clean separation of concerns (config, health check, admin endpoint)
- Comprehensive error handling with specific exception types
- Proper timeout configuration (5s for health check, 10s for admin)
- Security-first approach with validation warnings
- Well-structured tests covering unit and integration scenarios
- Clear, actionable documentation

**Architecture:**
- Configuration follows Pydantic BaseSettings pattern correctly
- Health check properly integrates new external dependency
- Admin endpoint demonstrates appropriate use of role-based access control
- Async/sync patterns used correctly (async for httpx, sync for db)

### Refactoring Performed

No refactoring was necessary. The code is well-structured, follows project conventions, and demonstrates good software engineering practices.

### Compliance Check

- ✓ **Coding Standards**: Fully compliant
  - Proper type hints used throughout
  - Error handling follows established patterns
  - Logging appropriately scoped (no sensitive data logged)
  - Code is self-documenting with clear function names

- ✓ **Project Structure**: Fully compliant
  - Files placed in correct locations
  - Naming conventions followed
  - Import organization clean

- ✓ **Testing Strategy**: Fully compliant
  - Unit tests for configuration loading
  - Integration tests for endpoints
  - Test fixtures used appropriately
  - 8/8 tests passing
  - Test coverage >80% on new code

- ✓ **All ACs Met**: All 8 acceptance criteria fully implemented
  - AC1: Environment variables documented in .env.example ✓
  - AC2: Configuration module with validation ✓
  - AC3: Developer documentation complete ✓
  - AC4: Security warnings in .env.example ✓
  - AC5: CI/CD documentation updated ✓
  - AC6: Health check enhanced ✓
  - AC7: Admin test connection endpoint ✓
  - AC8: Security documentation present ✓

### Requirements Traceability Matrix

All acceptance criteria mapped to validating tests:

**AC1 & AC4 (Environment Configuration):**
- **Given** environment variables are defined in .env.example
- **When** application starts
- **Then** settings load correctly
- **Tests**: `test_dream_storage_config_loads_from_env`, `test_dream_storage_config_has_defaults`

**AC2 (Configuration Module):**
- **Given** Dream Central Storage settings in config.py
- **When** config module loads
- **Then** Pydantic validates settings and enforces non-default secrets in production
- **Tests**: `test_dream_storage_webhook_secret_validation_warning`

**AC6 (Health Check):**
- **Given** health check endpoint exists
- **When** GET /api/v1/utils/health-check/ is called
- **Then** response includes dream_central_storage status
- **Tests**: `test_health_check_includes_dream_storage_status`, `test_health_check_overall_status`, `test_health_check_timestamp_format`

**AC7 (Admin Test Connection):**
- **Given** admin is authenticated
- **When** GET /api/v1/admin/test-dream-storage-connection is called
- **Then** detailed connection status is returned
- **Tests**: `test_admin_can_test_dream_storage_connection`, `test_non_admin_cannot_test_dream_storage_connection`

**Coverage Gaps:** None identified

### Improvements Checklist

All items complete - no additional work required:

- [x] Configuration loading with Pydantic validation
- [x] Security warnings in development defaults
- [x] Health check integration
- [x] Admin diagnostics endpoint
- [x] Comprehensive test coverage
- [x] Documentation (developer setup, CI/CD, security)
- [x] Error handling and logging

**Future Enhancements** (not blocking, for future stories):
- [ ] Consider adding rate limiting to admin test endpoint (Story 3.1+)
- [ ] Consider caching health check results (TTL: 30s) to reduce external API calls
- [ ] Add test for production environment validation error (nice-to-have)

### Security Review

**Status: PASS**

**Findings:**
- ✅ Credentials properly validated for non-local environments
- ✅ Clear security warnings in .env.example
- ✅ No credentials logged (logger only logs generic error messages)
- ✅ Webhook secret follows same validation pattern as other secrets
- ✅ Environment variable hierarchy clearly documented
- ✅ Admin endpoint properly protected with role-based access control
- ✅ Timeout protection prevents hanging connections

**Security Score: 95/100**

No security vulnerabilities identified. Implementation follows security best practices.

### Performance Considerations

**Status: PASS**

**Findings:**
- ✅ Health check uses 5-second timeout (appropriate)
- ✅ Admin endpoint uses 10-second timeout (appropriate for diagnostics)
- ✅ Async patterns used correctly for external HTTP calls
- ✅ Database check is lightweight (SELECT 1)
- ✅ No unnecessary resource allocation

**Performance Score: 100/100**

**Future Optimization Opportunities:**
- Health check could benefit from caching (30s TTL) if called frequently
- Consider circuit breaker pattern for Dream Central Storage connectivity (future story)

### Non-Functional Requirements Validation

**Security: PASS**
- Authentication: External service credentials validated
- Authorization: Admin endpoint properly protected
- Data Protection: No sensitive data in logs

**Reliability: PASS**
- Error Handling: Comprehensive exception handling
- Recovery: Graceful degradation if Dream Storage unavailable
- Logging: Appropriate error logging for debugging

**Maintainability: PASS**
- Code Clarity: Self-documenting code with clear naming
- Documentation: Comprehensive setup and deployment docs
- Testability: High test coverage, easy to extend

**Performance: PASS**
- Response Times: Appropriate timeouts configured
- Resource Usage: Minimal overhead

### Files Modified During Review

None - no changes required during QA review.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.0-dream-central-storage-setup-configuration.yml

Risk Profile: Low risk - configuration-only changes with comprehensive safeguards
NFR Assessment: All non-functional requirements validated and passing

### Recommended Status

**✓ Ready for Done**

All acceptance criteria met, comprehensive test coverage, no blocking issues identified. This story demonstrates exemplary implementation quality and is ready for production deployment.

**Quality Score: 95/100**

**Recommendation:** Mark story as "Done" and proceed with Story 3.1 (API Integration)
