# Story 28.1: Teacher-Controlled Student Password Management

## Epic: Teacher-Controlled Student Passwords

**Epic ID:** 28
**Story ID:** 28.1
**Status:** Draft
**Priority:** High

---

## Problem Statement

Students frequently forget their usernames and passwords, creating a significant support burden for teachers and administrators. The current system generates random passwords that are difficult to remember and requires students to change passwords on first login, adding complexity.

**Market Feedback:**
- Students (especially younger ones) struggle to remember credentials
- Teachers spend excessive time helping students recover access
- The forced password change on first login adds friction
- Random generated passwords are not memorable

---

## User Story

**As a** Teacher/Administrator,
**I want** to set and view student passwords directly,
**So that** I can easily help students who forget their credentials without going through reset workflows.

---

## Proposed Solution

Transform student password management from a secure-but-complex model to a teacher-controlled model optimized for K-12 educational environments:

1. **Custom Password Input:** Allow password specification during student creation (individual or bulk)
2. **Password Visibility:** Teachers can view student passwords at any time
3. **Password Modification:** Teachers can change student passwords directly
4. **Remove Student Password Change:** Students cannot change their own passwords

---

## Story Context

### Existing System Integration

| Aspect | Current Implementation |
|--------|----------------------|
| **Integrates with** | User model, Student model, Admin/Student API routes |
| **Technology** | FastAPI backend, React frontend, bcrypt hashing |
| **Current Pattern** | Passwords hashed (one-way), `must_change_password` flag |
| **Touch Points** | `admin.py`, `students.py`, `users.py`, `crud.py`, `models.py`, frontend forms |

### Current Password Flow

1. Admin/Teacher creates student â†’ System generates random password
2. Password hashed with bcrypt (irreversible)
3. `must_change_password = True` set on user
4. First login â†’ Student forced to change password
5. Teacher cannot see or retrieve original password

### Proposed Password Flow

1. Admin/Teacher creates student â†’ Can provide custom password OR auto-generate
2. Password stored encrypted (reversible) alongside hash
3. `must_change_password = False` (removed entirely for students)
4. Student logs in with provided credentials
5. Teacher can view/change password anytime

---

## Acceptance Criteria

### Functional Requirements

#### Backend Changes

- [ ] **AC1:** Add `viewable_password` field to User model (encrypted, nullable)
- [ ] **AC2:** Update student creation endpoint to accept optional `password` parameter
- [ ] **AC3:** When password provided, use it; when not provided, auto-generate
- [ ] **AC4:** Store reversibly encrypted password in `viewable_password` field
- [ ] **AC5:** Create endpoint `GET /admin/students/{id}/password` to retrieve password
- [ ] **AC6:** Create endpoint `PUT /admin/students/{id}/password` to set new password
- [ ] **AC7:** Bulk import accepts optional password column in Excel template
- [ ] **AC8:** Bulk import with "class password" option (same password for all students in upload)
- [ ] **AC9:** Remove `must_change_password` flag behavior for student role
- [ ] **AC10:** Block password change endpoints for student role users

#### Frontend Changes

- [ ] **AC11:** Student creation form includes optional password field with visibility toggle
- [ ] **AC12:** Student creation form shows "auto-generate" checkbox (default checked)
- [ ] **AC13:** Student list shows "View Password" action per student
- [ ] **AC14:** Password viewing modal with copy-to-clipboard functionality
- [ ] **AC15:** "Set Password" dialog for changing student password
- [ ] **AC16:** Bulk import template includes password column
- [ ] **AC17:** Bulk import UI shows "Apply same password to all" option
- [ ] **AC18:** Remove password change option from student profile/settings
- [ ] **AC19:** Remove first-login password change flow for students

### Integration Requirements

- [ ] **AC20:** Existing students without `viewable_password` show "Password not available" (set before feature)
- [ ] **AC21:** Existing login flow continues to work unchanged
- [ ] **AC22:** Teachers can only view/modify passwords for students they created or in their classes
- [ ] **AC23:** Admins/Supervisors can view/modify passwords for all students in their scope

### Quality Requirements

- [ ] **AC24:** Encryption key stored in environment variables
- [ ] **AC25:** Unit tests for password encryption/decryption
- [ ] **AC26:** API tests for new password endpoints
- [ ] **AC27:** Frontend tests for password visibility components
- [ ] **AC28:** Migration script handles existing users gracefully

---

## Technical Design

### Database Changes

```python
# models.py - User model addition
class User(SQLModel, table=True):
    # ... existing fields ...

    # New field - encrypted but reversible for teacher viewing
    # Only populated for student role users
    viewable_password_encrypted: str | None = Field(default=None, max_length=500)
```

### Encryption Approach

```python
# core/security.py - Add symmetric encryption
from cryptography.fernet import Fernet

def get_encryption_key() -> bytes:
    """Get encryption key from environment."""
    key = settings.PASSWORD_ENCRYPTION_KEY
    if not key:
        raise ValueError("PASSWORD_ENCRYPTION_KEY not configured")
    return key.encode()

def encrypt_password(plain_password: str) -> str:
    """Encrypt password for storage (reversible)."""
    f = Fernet(get_encryption_key())
    return f.encrypt(plain_password.encode()).decode()

def decrypt_password(encrypted_password: str) -> str:
    """Decrypt password for viewing."""
    f = Fernet(get_encryption_key())
    return f.decrypt(encrypted_password.encode()).decode()
```

### API Endpoints

```python
# New endpoints in admin.py

@router.get("/students/{student_id}/password")
def get_student_password(
    student_id: uuid.UUID,
    session: SessionDep,
    current_user: User = require_role(UserRole.admin, UserRole.supervisor, UserRole.teacher)
) -> StudentPasswordResponse:
    """Get viewable password for a student."""
    # Verify access rights
    # Decrypt and return password
    pass

@router.put("/students/{student_id}/password")
def set_student_password(
    student_id: uuid.UUID,
    body: SetStudentPasswordRequest,
    session: SessionDep,
    current_user: User = require_role(UserRole.admin, UserRole.supervisor, UserRole.teacher)
) -> StudentPasswordResponse:
    """Set new password for a student."""
    # Verify access rights
    # Update both hashed_password and viewable_password_encrypted
    pass
```

### Schema Additions

```python
# schemas/student.py

class StudentPasswordResponse(BaseModel):
    student_id: uuid.UUID
    username: str
    password: str | None  # None if pre-feature student
    message: str | None

class SetStudentPasswordRequest(BaseModel):
    password: str = Field(min_length=4, max_length=50)

class StudentCreateAPI(BaseModel):
    # ... existing fields ...
    password: str | None = Field(default=None, min_length=4, max_length=50)
```

### Bulk Import Changes

```python
# Excel template new columns
IMPORT_COLUMNS = [
    "Full Name *",
    "Username",
    "Password",  # NEW - optional
    "Email",
    "Parent Email",
    "Grade",
    "Class"
]

# Bulk import options
class BulkImportOptions(BaseModel):
    apply_same_password: bool = False
    class_password: str | None = None  # Used when apply_same_password is True
```

---

## UI/UX Specifications

### Student Creation Form

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Student                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Full Name *         [________________________]   â”‚
â”‚ Username *          [________________________]   â”‚
â”‚                                                  â”‚
â”‚ Password            [________________________]   â”‚
â”‚                     [ğŸ‘] Show   [ğŸ”„] Generate    â”‚
â”‚                                                  â”‚
â”‚ â˜‘ Auto-generate password (uncheck to enter)     â”‚
â”‚                                                  â”‚
â”‚ Email               [________________________]   â”‚
â”‚ Parent Email        [________________________]   â”‚
â”‚ Grade               [____â–¼]                      â”‚
â”‚ Class               [____â–¼]                      â”‚
â”‚                                                  â”‚
â”‚         [Cancel]              [Create Student]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Student List - Password Actions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Students                                     [+ Add] [Import]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Name           â”‚ Username    â”‚ Class â”‚ Actions                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ahmet YÄ±lmaz   â”‚ ahmet.y     â”‚ 3A    â”‚ [ğŸ‘ Password] [âœ] [ğŸ—‘]    â”‚
â”‚ Elif Kaya      â”‚ elif.k      â”‚ 3A    â”‚ [ğŸ‘ Password] [âœ] [ğŸ—‘]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Password View Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Student Credentials                        [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚   Student: Ahmet YÄ±lmaz                         â”‚
â”‚   Username: ahmet.yilmaz                        â”‚
â”‚                                                  â”‚
â”‚   Password: â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢  [ğŸ‘ Show]                 â”‚
â”‚                                                  â”‚
â”‚   [ğŸ“‹ Copy Username]  [ğŸ“‹ Copy Password]        â”‚
â”‚                                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                  â”‚
â”‚   [ğŸ”„ Set New Password]                         â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Bulk Import - Class Password Option

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Import Students                            [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 2: Import Options                          â”‚
â”‚                                                  â”‚
â”‚ Password Strategy:                              â”‚
â”‚ â—‹ Auto-generate unique password for each        â”‚
â”‚ â—‹ Use passwords from Excel file                 â”‚
â”‚ â— Apply same password to all students           â”‚
â”‚                                                  â”‚
â”‚   Class Password: [_______________________]     â”‚
â”‚                   (e.g., "class3a-2024")        â”‚
â”‚                                                  â”‚
â”‚         [Back]                    [Continue]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Considerations

### Encryption

- Use Fernet (AES-128-CBC) symmetric encryption
- Encryption key stored in environment variable `PASSWORD_ENCRYPTION_KEY`
- Key should be generated with `Fernet.generate_key()`
- Key rotation plan: Re-encrypt all passwords when key changes

### Access Control

- Only authorized roles can view passwords (Admin, Supervisor, Teacher)
- Teachers limited to students they created or students in their classes
- Audit log for password viewing (optional, recommended for compliance)

### Trade-offs Acknowledged

| Security Aspect | Impact | Mitigation |
|-----------------|--------|------------|
| Reversible encryption | Lower security than hashing | Encrypted with secure key, access controlled |
| Teacher sees passwords | Privacy concern | Teachers already have authority over students |
| No student password autonomy | Students can't secure accounts | Appropriate for K-12 supervised environment |

### Compliance Note

This approach is common in K-12 EdTech (ClassDojo, Seesaw, Google Classroom for young students). The supervised educational environment justifies the trade-off between security and usability.

---

## Migration Plan

### Database Migration

```python
# alembic migration
def upgrade():
    op.add_column(
        'user',
        sa.Column('viewable_password_encrypted', sa.String(500), nullable=True)
    )

def downgrade():
    op.drop_column('user', 'viewable_password_encrypted')
```

### Existing Users

- Existing students will have `viewable_password_encrypted = NULL`
- UI shows "Password not available - set new password" for these users
- Teachers can set new password to enable viewing

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Encryption key compromise | Low | High | Secure key storage, key rotation capability |
| Teacher misuse | Low | Medium | Audit logging, access scoped to own students |
| Regulatory concerns | Low | Medium | Document compliance with FERPA/COPPA as supervised environment |

### Rollback Plan

1. Deploy migration (additive - no data loss)
2. Feature flag to disable password viewing
3. If issues, disable flag - reverts to current behavior
4. Remove column in future migration if feature abandoned

---

## Definition of Done

- [ ] Database migration applied successfully
- [ ] Backend endpoints implemented and tested
- [ ] Frontend components implemented and tested
- [ ] Bulk import updated with password options
- [ ] Student password change removed
- [ ] First-login password change flow removed for students
- [ ] Encryption key documented in deployment guide
- [ ] Integration tests passing
- [ ] Manual QA completed
- [ ] Documentation updated

---

## Estimation

| Component | Effort |
|-----------|--------|
| Backend - Model & Migration | 1 hour |
| Backend - Encryption Utils | 1 hour |
| Backend - API Endpoints | 2 hours |
| Backend - Bulk Import Updates | 2 hours |
| Backend - Tests | 2 hours |
| Frontend - Creation Form | 2 hours |
| Frontend - Password View/Set | 2 hours |
| Frontend - Bulk Import UI | 1 hour |
| Frontend - Remove Student Password Change | 1 hour |
| Frontend - Tests | 2 hours |
| Integration Testing | 1 hour |
| **Total** | **~17 hours** |

---

## Dependencies

- None (self-contained feature)

## Blocked By

- None

## Related Stories

- Epic 11 (superseded by this approach for student passwords)
- Story 9.9: Bulk Student Import via Excel (enhanced by this story)

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2025-01-11 | PM (John) | Initial story creation |
