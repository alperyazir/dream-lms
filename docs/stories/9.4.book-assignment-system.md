# Story 9.4: Book Assignment System

**Epic:** 9 - UX Improvements & Polish
**Story ID:** 9.4
**Status:** Done
**Created:** 2025-12-03
**Priority:** High

---

## Story

**As a** Publisher,
**I want** to assign specific books to specific schools and teachers,
**so that** only authorized teachers can access and use my published content.

---

## Background

Currently, all teachers can see all books in the system. This story introduces a book assignment/licensing system where:
- Publishers control which schools/teachers have access to their books
- Teachers only see books that have been assigned to them or their school
- Publishers can assign to entire schools (all teachers) or individual teachers

---

## Acceptance Criteria

### Data Model
1. New `BookAssignment` model tracks which books are assigned to which schools/teachers
2. Assignment can be at school level (all teachers in school get access) or teacher level
3. Assignment includes: book_id, school_id (optional), teacher_id (optional), assigned_by, assigned_at
4. At least one of school_id or teacher_id must be set
5. Publisher can only assign books they own/publish

### Publisher Book Assignment UI
6. Publisher's Books page shows "Assign" button for each book
7. Clicking "Assign" opens assignment dialog
8. Assignment dialog shows:
   - Book being assigned (cover, title)
   - School dropdown (schools under this publisher)
   - When school is selected, shows teachers in that school
   - Option to assign to "All Teachers in School" or select specific teachers
   - Checkbox list for individual teacher selection
9. Publisher can assign same book to multiple schools/teachers in one operation
10. Existing assignments shown with option to remove

### Publisher Assignment Management
11. Publisher has "Book Assignments" page/section showing all assignments
12. List view shows: Book, School, Teacher(s), Assigned Date
13. Publisher can filter by book or school
14. Publisher can remove/revoke assignments

### Teacher Book Visibility
15. Teachers only see books assigned to them OR their school in Library/Books view
16. If no books assigned, show empty state: "No books available. Contact your publisher."
17. Book catalog endpoints filter by teacher's access
18. Existing assignment creation still works (teachers can only assign from accessible books)

### Admin Override
19. Admin can view all book assignments across publishers
20. Admin can assign books on behalf of publishers (optional/future)

---

## Tasks / Subtasks

### Backend Tasks - Data Model

- [x] **Task 1: Create BookAssignment Model** (AC: 1, 2, 3, 4)
  - [x] Create `BookAssignment` model in `models.py`:
    ```python
    class BookAssignment(Base):
        id: UUID
        book_id: UUID (FK to books)
        school_id: UUID (FK to schools, nullable)
        teacher_id: UUID (FK to users, nullable)
        assigned_by: UUID (FK to users - the publisher)
        assigned_at: datetime
        # Constraint: school_id OR teacher_id must be set
    ```
  - [x] Add unique constraint to prevent duplicate assignments
  - [x] Add indexes for efficient querying
  - [x] Create Alembic migration

- [x] **Task 2: Create BookAssignment Schemas** (AC: 1, 2, 3)
  - [x] Create `backend/app/schemas/book_assignment.py`
  - [x] `BookAssignmentCreate`: book_id, school_id?, teacher_id?
  - [x] `BookAssignmentResponse`: full assignment details with book/school/teacher info
  - [x] `BookAssignmentListResponse`: paginated list
  - [x] `BulkBookAssignmentCreate`: book_id, school_id, teacher_ids[] for bulk assign

### Backend Tasks - Publisher Endpoints

- [x] **Task 3: Create Book Assignment Endpoints** (AC: 5, 6, 9, 10)
  - [x] Create `backend/app/api/routes/book_assignments.py`
  - [x] `POST /api/v1/book-assignments` - Create assignment(s)
    - [x] Validate publisher owns the book
    - [x] Validate school belongs to publisher (if school_id provided)
    - [x] Validate teacher belongs to school (if teacher_id provided)
    - [x] Support bulk assignment (multiple teachers)
    - [x] Prevent duplicate assignments
  - [x] `GET /api/v1/book-assignments` - List assignments
    - [x] Filter by book_id, school_id
    - [x] Only return publisher's own assignments
    - [x] Include pagination
  - [x] `DELETE /api/v1/book-assignments/{id}` - Remove assignment
    - [x] Validate publisher owns the assignment
  - [x] Register routes in main router

- [x] **Task 4: Create Assignment Service** (AC: 5, 9)
  - [x] Create `backend/app/services/book_assignment_service.py`
  - [x] `create_assignment(db, book_id, school_id, teacher_id, assigned_by)`
  - [x] `create_bulk_assignments(db, book_id, school_id, teacher_ids, assigned_by)`
  - [x] `get_publisher_assignments(db, publisher_id, book_id?, school_id?)`
  - [x] `delete_assignment(db, assignment_id, publisher_id)`
  - [x] `check_teacher_access(db, teacher_id, book_id)` - used by other services

### Backend Tasks - Teacher Book Access

- [x] **Task 5: Update Book Catalog Endpoint for Teachers** (AC: 15, 16, 17)
  - [x] Modify `GET /api/v1/books` endpoint
  - [x] If requester is Teacher:
    - [x] Get teacher's school_id
    - [x] Query books where: assignment exists for teacher_id OR school_id
    - [x] Return only accessible books
  - [x] If requester is Publisher/Admin: return all books (as before)
  - [x] Add `accessible_book_ids` helper function

- [x] **Task 6: Update Assignment Creation Validation** (AC: 18)
  - [x] Modify assignment creation endpoint
  - [x] When teacher creates assignment, validate they have access to the book
  - [x] Return 403 if teacher doesn't have access to selected book

### Frontend Tasks - Publisher Assignment UI

- [x] **Task 7: Create Book Assignment Dialog** (AC: 6, 7, 8, 9)
  - [x] Create `frontend/src/components/books/BookAssignmentDialog.tsx`
  - [x] Props: book (the book being assigned), onClose, onSuccess
  - [x] Display book info at top (cover thumbnail, title, author)
  - [x] School selector dropdown (fetch schools under publisher)
  - [x] On school select, show teacher options:
    - [x] "Assign to all teachers in this school" checkbox
    - [x] OR individual teacher checkboxes
  - [x] Show already-assigned indicator for existing assignments
  - [x] "Assign" button - calls API, shows success, closes dialog
  - [x] Support assigning to multiple schools (tabs or expandable sections)

- [x] **Task 8: Add Assign Button to Publisher Books View** (AC: 6)
  - [x] Locate Publisher's book list/grid component
  - [x] Add "Assign" button to each book card/row
  - [x] On click, open BookAssignmentDialog with that book
  - [x] Show badge/indicator if book has existing assignments

- [x] **Task 9: Create Book Assignments Management Page** (AC: 11, 12, 13, 14)
  - [x] Create `frontend/src/routes/_layout/publisher/book-assignments.tsx`
  - [x] Add route to Publisher navigation
  - [x] Fetch all publisher's assignments from API
  - [x] Display in table/list view:
    - [x] Book (cover + title)
    - [x] School name
    - [x] Teacher name (or "All Teachers")
    - [x] Assigned date
    - [x] Actions: Remove
  - [x] Add filters: By Book, By School
  - [x] Add search functionality
  - [x] Confirm dialog before removing assignment

### Frontend Tasks - Teacher Book Visibility

- [x] **Task 10: Update Teacher Books/Library View** (AC: 15, 16)
  - [x] Teacher's book list already uses API
  - [x] Verify API returns filtered books (from Task 5)
  - [x] Add empty state component when no books available
  - [x] Empty state message: "No books available yet. Contact your publisher to get access to books."
  - [x] Include helpful icon/illustration

- [x] **Task 11: Update Assignment Creation Book Selection** (AC: 17, 18)
  - [x] Verify assignment creation only shows accessible books
  - [x] Book selector should use same filtered API
  - [x] If teacher has no books, show message and disable assignment creation

---

## API Endpoints Summary

| Method | Endpoint | Description | Access |
|--------|----------|-------------|--------|
| POST | `/api/v1/book-assignments` | Create assignment(s) | Publisher |
| GET | `/api/v1/book-assignments` | List assignments | Publisher |
| DELETE | `/api/v1/book-assignments/{id}` | Remove assignment | Publisher |
| GET | `/api/v1/books` | List books (filtered for teachers) | All |

---

## Technical Notes

### Assignment Query for Teachers
```sql
SELECT DISTINCT b.* FROM books b
LEFT JOIN book_assignments ba ON b.id = ba.book_id
WHERE ba.teacher_id = :teacher_id
   OR ba.school_id = :teacher_school_id
```

### Handling "All Teachers in School"
When assigning to entire school, set only `school_id` without `teacher_id`. This means any teacher in that school has access. Individual teacher assignments override for specific teachers at different schools.

### Migration Considerations
- Existing teachers have no assignments = no book access
- Migration script option: auto-assign all existing books to all schools (one-time)
- Or: require publishers to manually assign after deployment

---

## Dependencies

- Book catalog system (Epic 3)
- School/Teacher relationships established

---

## Estimation

- **Complexity:** High
- **Components:** New data model, multiple endpoints, Publisher UI, Teacher visibility changes

---

## QA Results

### Review Date: 2025-12-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is solid with good separation of concerns between service layer, API routes, and frontend components. The data model properly enforces constraints (unique assignments, required target). The BookAssignmentDialog component is well-structured with comprehensive state management for complex multi-selection scenarios.

### Refactoring Performed

None - code quality is acceptable for current scope.

### Compliance Check

- Coding Standards: ✓ Follows project patterns
- Project Structure: ✓ Files in correct locations
- Testing Strategy: ✓ Integration and service tests added (27 tests passing)
- All ACs Met: ✓ Core ACs 1-18 implemented; AC 19-20 (Admin override) marked as optional/future in story

### Improvements Checklist

- [x] Add integration tests for API endpoints (create, bulk create, list, delete) ✓ Fixed 2025-12-05
- [x] Add service layer unit tests for `book_assignment_service.py` functions ✓ Fixed 2025-12-05
- [ ] Add frontend component tests for BookAssignmentDialog (future)
- [ ] Optimize N+1 queries in `get_publisher_assignments` (future - not blocking)
- [ ] Consider adding rate limiting for bulk assignment endpoint (future)

### Security Review

✓ **PASS** - Authorization properly enforced:
- Publisher ownership validated before book assignment
- School/teacher relationships verified before assignment
- Only publisher can delete their own book assignments
- Teachers can only see books assigned to them or their school

### Performance Considerations

**Minor Concern**: The `get_publisher_assignments` function in `book_assignment_service.py` (lines 181-233) performs individual database queries in a loop for each assignment to fetch related book, school, teacher, and assigner info. This could be optimized with JOINs for better performance with large datasets. Not blocking for current scale.

### Files Modified During Review

None

### Gate Status

Gate: CONCERNS → docs/qa/gates/9.4-book-assignment-system.yml

### Recommended Status

✗ Changes Required - See unchecked items above

**Note**: The missing integration/service tests are the primary concern. The implementation is functionally complete and working, but test coverage should be improved before marking as Done. Story owner may choose to proceed with current coverage if acceptable for project timeline.

---

## Dev Agent Record - QA Fix Application

### Applied Date: 2025-12-05

### Applied By: James (Dev Agent)

### QA Gate Reviewed: 9.4-book-assignment-system.yml

### Fixes Applied

#### 1. Added Integration Tests for API Endpoints (Medium Priority)
- **File**: `backend/app/tests/test_api/test_book_assignments.py`
- **Changes**: Added `TestBookAssignmentAPIEndpoints` class with 7 integration tests:
  - `test_create_bulk_assignment_school_level` - Tests school-level bulk assignment
  - `test_create_bulk_assignment_specific_teachers` - Tests specific teacher assignments
  - `test_list_book_assignments` - Tests listing all assignments
  - `test_list_assignments_filter_by_book` - Tests filtering by book_id
  - `test_get_book_assignments_for_book` - Tests getting assignments for specific book
  - `test_delete_book_assignment` - Tests assignment deletion
  - `test_unauthorized_access_denied` - Tests 403 for non-publisher access

#### 2. Added Service Layer Unit Tests (Low Priority)
- **File**: `backend/app/tests/test_services/test_book_assignment_service.py` (NEW)
- **Changes**: Created comprehensive service layer tests with 12 async tests:
  - `TestCreateAssignment`: 3 tests for single assignment creation
  - `TestCreateBulkAssignments`: 2 tests for bulk assignment
  - `TestCheckTeacherBookAccess`: 3 tests for access checking
  - `TestGetAccessibleBookIds`: 2 tests for getting accessible books
  - `TestDeleteAssignment`: 2 tests for deletion

### Test Results

```
======================== 27 passed, 5 warnings in 6.46s ========================
```

All 27 tests pass (8 schema/model tests + 7 API integration tests + 12 service tests).

### Files Added/Modified

| File | Action | Description |
|------|--------|-------------|
| `backend/app/tests/test_services/__init__.py` | Created | Package init file |
| `backend/app/tests/test_services/test_book_assignment_service.py` | Created | Service layer unit tests |
| `backend/app/tests/test_api/test_book_assignments.py` | Updated | Added API integration tests |

### Items Not Addressed (Future/Optional)

- [ ] Add frontend component tests for BookAssignmentDialog (frontend testing scope)
- [ ] Optimize N+1 queries in `get_publisher_assignments` (performance enhancement, not blocking)
- [ ] Consider rate limiting for bulk assignment endpoint (security enhancement)

### Gate Status After Fix

Gate should be updated from **CONCERNS** → **PASS** for test coverage items.

### Recommended Story Status

**Ready for Review** - Primary QA concerns (missing tests) have been addressed. Remaining items are optional enhancements.

---

## QA Results - Re-Review

### Review Date: 2025-12-05 (Re-review)

### Reviewed By: Quinn (Test Architect)

### Purpose

Re-review after Dev Agent (James) applied fixes for previously identified test coverage gaps.

### Verification of Applied Fixes

#### Fix 1: Integration Tests for API Endpoints ✓ VERIFIED
- **7 new integration tests** added to `TestBookAssignmentAPIEndpoints`
- Coverage includes: bulk assignment (school/teacher), listing, filtering, deletion, authorization
- All tests passing

#### Fix 2: Service Layer Unit Tests ✓ VERIFIED
- **12 new async unit tests** in `test_book_assignment_service.py`
- Coverage includes all critical service functions:
  - `create_assignment` (3 tests)
  - `create_bulk_assignments` (2 tests)
  - `check_teacher_book_access` (3 tests)
  - `get_accessible_book_ids` (2 tests)
  - `delete_assignment` (2 tests)
- All tests passing

### Test Execution Results

```
======================== 27 passed, 5 warnings in 6.49s ========================
```

### Requirements Traceability

| AC | Coverage | Test Location |
|----|----------|---------------|
| AC 1-4 (Data Model) | ✓ | Schema/model tests |
| AC 5 (Publisher owns book) | ✓ | API integration tests |
| AC 9 (Bulk assign) | ✓ | `test_create_bulk_assignment_*` |
| AC 10 (Remove assignments) | ✓ | `test_delete_book_assignment` |
| AC 11-14 (Assignment management) | ✓ | List/filter tests |
| AC 15-18 (Teacher visibility) | ✓ | Access checking tests |

### Compliance Check (Updated)

- Coding Standards: ✓ Follows project patterns
- Project Structure: ✓ Files in correct locations
- Testing Strategy: ✓ **RESOLVED** - Comprehensive test coverage (27 tests)
- All ACs Met: ✓ Core ACs 1-18 implemented

### Remaining Items (Future/Non-blocking)

- [ ] Frontend component tests for BookAssignmentDialog
- [ ] N+1 query optimization in `get_publisher_assignments`
- [ ] Rate limiting for bulk assignment endpoint

### Gate Status

Gate: **PASS** → docs/qa/gates/9.4-book-assignment-system.yml

### Recommended Status

✓ **Ready for Done** - All critical QA concerns resolved. Test coverage is now comprehensive.
