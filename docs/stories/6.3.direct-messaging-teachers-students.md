# Story 6.3: Direct Messaging Between Teachers & Students

**Epic:** 6 - Communication, Feedback & Supplementary Materials
**Story ID:** 6.3
**Status:** Done
**Created:** 2025-12-02
**Developer:** (Pending Assignment)

---

## Story

**As a** teacher,
**I want** to send and receive direct messages with my students,
**so that** I can answer questions, provide guidance, and maintain communication.

---

## Acceptance Criteria

1. Message model includes: id, sender_id (FK user), recipient_id (FK user), subject, body, parent_message_id (FK for threading), is_read, sent_at
2. Teacher and student navigation includes "Messages" menu item with unread count badge
3. Messages page displays inbox with list of conversations (grouped by participants)
4. Each conversation shows: participant name/photo, last message preview, timestamp, unread indicator
5. Clicking conversation opens message thread view showing all messages in chronological order
6. **Compose New Message**: Button opens modal with fields: recipient (searchable dropdown - teacher sees their students, student sees their teachers), subject, message body (rich text editor with formatting)
7. **Message Thread View**: Shows all messages in conversation with sender name, timestamp, message body
8. **Reply**: Text input at bottom of thread to send reply (auto-fills recipient and subject as "Re: [subject]")
9. API endpoint `POST /api/messages` creates new message and sends notification to recipient
10. API endpoint `GET /api/messages/conversations` returns list of conversations for authenticated user
11. API endpoint `GET /api/messages/thread/{user_id}` returns full message thread with specific user
12. When message is received, recipient gets "message_received" notification
13. Marking message as read updates is_read flag and clears notification
14. Search functionality allows finding messages by participant name or subject
15. Messages include basic XSS protection (sanitize HTML input)
16. Teacher can message multiple students (creates separate threads, not group chat)
17. Students can only message teachers who have assigned them work (privacy protection)
18. Integration tests verify messaging workflow between teacher and student

---

## Tasks / Subtasks

### Backend Tasks

- [x] **Task 1: Create DirectMessage Model** (AC: 1)
  - [x] Add `DirectMessage` model to `backend/app/models.py`
  - [x] Fields: id (UUID PK), sender_id (FK users), recipient_id (FK users), subject (str, nullable), body (text), parent_message_id (FK self, nullable), is_read (bool), sent_at (datetime)
  - [x] Add constraint: sender_id != recipient_id (no self-messaging)
  - [x] Add indexes on sender_id, recipient_id, sent_at DESC, is_read
  - [x] Create Alembic migration

- [x] **Task 2: Create Message Schemas** (AC: 1, 9, 10, 11)
  - [x] Create `backend/app/schemas/message.py`
  - [x] `MessageCreate`: recipient_id, subject (optional), body (required)
  - [x] `MessagePublic`: all fields plus sender_name, recipient_name
  - [x] `ConversationPublic`: participant_id, participant_name, participant_role, last_message_preview, last_message_timestamp, unread_count
  - [x] `MessageThreadResponse`: list of messages with participant info

- [x] **Task 3: Create Message API Routes** (AC: 9, 10, 11, 13)
  - [x] Create `backend/app/api/routes/messages.py`
  - [x] `POST /api/v1/messages` - Create new message (AC: 9)
    - Validate recipient exists
    - Create DirectMessage record
    - Call notification_service with type `message_received`
  - [x] `GET /api/v1/messages/conversations` - List conversations (AC: 10)
    - Group messages by conversation partner
    - Return most recent message, unread count per conversation
    - Support pagination (limit, offset)
  - [x] `GET /api/v1/messages/thread/{user_id}` - Get thread (AC: 11)
    - Return all messages between current user and specified user
    - Order by sent_at ascending
    - Mark unread messages as read (AC: 13)
  - [x] `PATCH /api/v1/messages/{id}/read` - Mark single message read (AC: 13)
  - [x] Register router in `backend/app/api/main.py`

- [x] **Task 4: Create Message Service** (AC: 15, 16, 17)
  - [x] Create `backend/app/services/message_service.py`
  - [x] `create_message(db, sender_id, recipient_id, subject, body, parent_message_id=None)`
  - [x] `get_conversations(db, user_id, limit, offset)` - Aggregate conversations
  - [x] `get_thread(db, user_id, partner_id)` - Get full thread
  - [x] `get_allowed_recipients(db, user_id, user_role)` - Get valid recipients (AC: 17)
    - Teachers: Get students from their classes
    - Students: Get teachers who have assigned them work
  - [x] `sanitize_message_body(body)` - Basic HTML sanitization (AC: 15)

- [x] **Task 5: Implement Privacy Controls** (AC: 17)
  - [x] In message creation, validate student can only message teachers who assigned them work
  - [x] Query: Join assignments → assignment_students → teachers to find valid teachers
  - [x] Return 403 if student tries to message unauthorized teacher
  - [x] Teachers can message any student in their classes

- [x] **Task 6: Backend Unit Tests** (AC: 18)
  - [x] Create `backend/app/tests/test_api/test_messages.py`
  - [x] Test message creation (teacher to student)
  - [x] Test message creation (student to teacher)
  - [x] Test student cannot message unauthorized teacher (AC: 17)
  - [x] Test get_conversations returns grouped conversations
  - [x] Test get_thread returns messages in order
  - [x] Test notification sent on message creation (AC: 12)
  - [x] Test marking message as read (AC: 13)

### Frontend Tasks

- [x] **Task 7: Create Message API Service** (AC: 9, 10, 11)
  - [x] Create `frontend/src/services/messagesApi.ts`
  - [x] `getConversations()` - GET /api/v1/messages/conversations
  - [x] `getThread(userId: string)` - GET /api/v1/messages/thread/{userId}
  - [x] `sendMessage(data: MessageCreate)` - POST /api/v1/messages
  - [x] `markAsRead(messageId: string)` - PATCH /api/v1/messages/{id}/read
  - [x] `getRecipients()` - GET /api/v1/messages/recipients (allowed recipients)

- [x] **Task 8: Create useMessages Hook** (AC: 2, 3, 4, 5)
  - [x] Create `frontend/src/hooks/useMessages.ts`
  - [x] Use TanStack Query for data fetching
  - [x] `useConversations()` - Fetch and cache conversations
  - [x] `useThread(userId)` - Fetch specific thread
  - [x] `useSendMessage()` - Mutation for sending messages
  - [x] Invalidate conversations cache after sending message

- [x] **Task 9: Update Messaging Page - Replace Mock Data** (AC: 3, 4, 5, 7, 8, 14)
  - [x] Modify `frontend/src/routes/_layout/messaging/index.tsx`
  - [x] Replace `mockConversations` with `useConversations()` hook
  - [x] Update `ConversationList` to use real data
  - [x] Update `MessageThread` to use `useThread()`
  - [x] Update `MessageForm` to call `sendMessage` mutation
  - [x] Implement search filter on frontend (AC: 14)

- [x] **Task 10: Create Compose Message Modal** (AC: 6, 16)
  - [x] Create `frontend/src/components/messaging/ComposeMessageModal.tsx`
  - [x] Searchable recipient dropdown (using allowed recipients API)
  - [x] Subject field (optional)
  - [x] Message body field with basic formatting
  - [x] Send button triggers `sendMessage` mutation
  - [x] Support selecting multiple recipients (creates separate threads) (AC: 16)

- [x] **Task 11: Update Navigation with Unread Badge** (AC: 2)
  - [x] Modify sidebar/navigation to include "Messages" link
  - [x] Query unread message count from conversations API
  - [x] Display badge with unread count (similar to notification bell)

- [x] **Task 12: Add Message Types** (AC: 1)
  - [x] Add to `frontend/src/types/message.ts`:
    - `Message` interface
    - `Conversation` interface
    - `MessageCreate` interface

### Integration Tasks

- [x] **Task 13: Integration Testing** (AC: 18)
  - [x] Test full flow: Teacher sends message → Student receives notification → Student views message → Message marked read
  - [x] Test conversation list shows correct unread counts
  - [x] Test privacy: Student can only see threads with their teachers

---

## Dev Notes

### Previous Story Insights (Story 6.2)
[Source: docs/stories/6.2.assignment-deadline-notifications.md#Dev Agent Record]

- NotificationService patterns are established in `backend/app/services/notification_service.py`
- Use `create_notification(db, user_id, notification_type, title, message, link)` function
- NotificationType enum already includes `message_received` type
- Notification links follow pattern: `/messaging` or `/messaging?user={userId}`
- Scheduled task patterns established for background jobs

### Existing Frontend Infrastructure
[Source: frontend/src/routes/_layout/messaging/index.tsx]

The messaging UI is already implemented with mock data:
- `frontend/src/routes/_layout/messaging/index.tsx` - Full messaging page
- `frontend/src/routes/_layout/messaging/$conversationId.tsx` - Conversation detail route
- Components exist in `frontend/src/components/messaging/`:
  - `ConversationList.tsx` - Displays list of conversations
  - `MessageThread.tsx` - Shows messages in a thread
  - `MessageForm.tsx` - Reply form component
- Mock data in `frontend/src/lib/mockData.ts` (to be replaced)

**Key UI Features Already Implemented:**
- Two-column layout (conversation list + thread view)
- Search filtering on conversations
- Responsive design with mobile back button
- Avatar display for participants
- Unread badge display

### Data Models
[Source: docs/architecture/2-database-schema-design.md#2.2.5]

**DirectMessage Table:**
```sql
CREATE TABLE direct_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sender_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    recipient_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    subject VARCHAR(500),
    body TEXT NOT NULL,
    parent_message_id UUID REFERENCES direct_messages(id) ON DELETE SET NULL,
    is_read BOOLEAN DEFAULT false,
    sent_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT no_self_messaging CHECK (sender_id != recipient_id)
);

CREATE INDEX idx_direct_messages_sender_id ON direct_messages(sender_id);
CREATE INDEX idx_direct_messages_recipient_id ON direct_messages(recipient_id);
CREATE INDEX idx_direct_messages_sent_at ON direct_messages(sent_at DESC);
CREATE INDEX idx_direct_messages_is_read ON direct_messages(is_read);
```

**Note:** The architecture doc shows `messages` table but we'll use `direct_messages` to avoid confusion with the existing `Message` schema class (simple response type).

### API Endpoints
[Source: docs/architecture/3-api-architecture.md#3.4.7]

```
POST   /api/v1/messages                    # Send new message
GET    /api/v1/messages/conversations      # List conversations
GET    /api/v1/messages/thread/{user_id}   # Get message thread
PATCH  /api/v1/messages/{id}/read          # Mark as read
GET    /api/v1/messages/recipients         # Get allowed recipients
```

### NotificationType
[Source: backend/app/models.py:1243-1252]

`message_received` is already defined in NotificationType enum:
```python
class NotificationType(str, Enum):
    assignment_created = "assignment_created"
    deadline_approaching = "deadline_approaching"
    feedback_received = "feedback_received"
    message_received = "message_received"  # ← Already exists!
    student_completed = "student_completed"
    past_due = "past_due"
    material_shared = "material_shared"
    system_announcement = "system_announcement"
```

### Privacy Control Logic (AC: 17)
[Source: docs/prd/epic-6-communication-feedback-supplementary-materials.md]

Students can only message teachers who have assigned them work. Query pattern:
```python
# Get valid teachers for a student
SELECT DISTINCT t.user_id
FROM teachers t
JOIN assignments a ON a.teacher_id = t.id
JOIN assignment_students ast ON ast.assignment_id = a.id
WHERE ast.student_id = :student_id
```

Teachers can message any student in their classes:
```python
# Get valid students for a teacher
SELECT DISTINCT s.user_id
FROM students s
JOIN class_students cs ON cs.student_id = s.id
JOIN classes c ON c.id = cs.class_id
WHERE c.teacher_id = :teacher_id
```

### XSS Protection (AC: 15)
[Source: docs/architecture/coding-standards.md#Security Best Practices]

Use a simple HTML sanitizer to prevent XSS:
```python
import bleach

ALLOWED_TAGS = ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li']
ALLOWED_ATTRS = {}

def sanitize_message_body(body: str) -> str:
    """Sanitize message body to prevent XSS attacks."""
    return bleach.clean(body, tags=ALLOWED_TAGS, attributes=ALLOWED_ATTRS, strip=True)
```

Add `bleach` to requirements.txt if not already present.

### File Locations
[Source: docs/architecture/source-tree.md]

**Backend (New Files):**
- `backend/app/models.py` - Add DirectMessage model
- `backend/app/schemas/message.py` - NEW: Message schemas
- `backend/app/api/routes/messages.py` - NEW: Message endpoints
- `backend/app/services/message_service.py` - NEW: Message business logic
- `backend/alembic/versions/xxx_add_direct_messages.py` - NEW: Migration

**Frontend (Modify Existing):**
- `frontend/src/routes/_layout/messaging/index.tsx` - Replace mock data
- `frontend/src/services/messagesApi.ts` - NEW: API client
- `frontend/src/hooks/useMessages.ts` - NEW: React Query hooks
- `frontend/src/types/message.ts` - NEW: TypeScript types
- `frontend/src/components/messaging/ComposeMessageModal.tsx` - NEW: Compose modal

### Conversation Aggregation Query
[Source: Implementation guidance]

To group messages into conversations, use window functions:
```python
# Get conversations with last message and unread count
WITH conversation_partners AS (
    SELECT
        CASE
            WHEN sender_id = :user_id THEN recipient_id
            ELSE sender_id
        END as partner_id,
        *
    FROM direct_messages
    WHERE sender_id = :user_id OR recipient_id = :user_id
),
ranked AS (
    SELECT
        partner_id,
        body as last_message,
        sent_at,
        ROW_NUMBER() OVER (PARTITION BY partner_id ORDER BY sent_at DESC) as rn
    FROM conversation_partners
)
SELECT
    r.partner_id,
    u.full_name as participant_name,
    u.role as participant_role,
    r.last_message as last_message_preview,
    r.sent_at as last_message_timestamp,
    (SELECT COUNT(*) FROM direct_messages
     WHERE recipient_id = :user_id AND sender_id = r.partner_id AND is_read = false) as unread_count
FROM ranked r
JOIN users u ON u.id = r.partner_id
WHERE r.rn = 1
ORDER BY r.sent_at DESC;
```

---

## Testing

### Test File Locations
[Source: docs/architecture/source-tree.md#Backend Structure]

- Backend tests: `backend/app/tests/test_api/test_messages.py`
- Frontend tests: `frontend/src/hooks/useMessages.test.ts` (optional)

### Testing Patterns
[Source: docs/architecture/coding-standards.md#Testing Patterns]

```python
@pytest.mark.asyncio
async def test_teacher_can_send_message_to_student(
    client: AsyncClient,
    teacher_token: str,
    db_session: AsyncSession
):
    """Test that teachers can send messages to their students."""
    # Arrange
    student = await create_test_student(db_session, teacher_id=teacher.id)

    # Act
    response = await client.post(
        "/api/v1/messages",
        json={
            "recipient_id": str(student.user_id),
            "subject": "Great work!",
            "body": "You did an excellent job on the assignment."
        },
        headers={"Authorization": f"Bearer {teacher_token}"}
    )

    # Assert
    assert response.status_code == 201
    data = response.json()
    assert data["recipient_id"] == str(student.user_id)
    assert data["subject"] == "Great work!"
```

### Test Scenarios Required

**Message Creation:**
- Teacher sends message to student in their class → Success
- Student sends message to teacher who assigned them work → Success
- Student sends message to random teacher → 403 Forbidden (AC: 17)
- Message to non-existent user → 404 Not Found
- Empty body → 422 Validation Error

**Conversations:**
- User with 5 conversations → Returns 5 grouped conversations
- Unread count accurate per conversation
- Most recent message shown in preview
- Pagination works correctly

**Thread:**
- Get thread returns messages in chronological order
- Viewing thread marks unread messages as read (AC: 13)
- Thread between two users only shows their messages

**Notifications:**
- Sending message creates notification for recipient (AC: 12)
- Notification type is `message_received`
- Notification includes sender name and link to messaging

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-02 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Backend tests: 20 tests passing in `backend/app/tests/test_api/test_messages.py`
- Fixed Assignment NOT NULL constraint by adding Book to test fixtures

### Completion Notes

**Implementation Summary:**

1. **Backend Implementation:**
   - Added `DirectMessage` model with `CheckConstraint` for no self-messaging
   - Created comprehensive message schemas in `backend/app/schemas/message.py`
   - Implemented message service with conversation aggregation using SQL CASE expressions
   - Added privacy controls: Students can only message teachers who assigned them work
   - Integrated XSS protection using bleach library
   - Created notification on message send (message_received type)
   - All 20 backend tests passing

2. **Frontend Implementation:**
   - Created message types in `frontend/src/types/message.ts`
   - Created API service in `frontend/src/services/messagesApi.ts`
   - Created TanStack Query hooks in `frontend/src/hooks/useMessages.ts`
   - Updated messaging components to use API types instead of mock data
   - Created ComposeMessageModal for new conversations
   - Updated Navbar with real unread message count

3. **Key Design Decisions:**
   - Used participant_id instead of conversation_id for thread identification
   - Backend auto-marks messages as read when fetching thread
   - 30-second polling for conversations, 10-second for active threads

### File List

**Backend (New/Modified):**
- `backend/app/models.py` - Added DirectMessage model
- `backend/app/schemas/message.py` - NEW: Message schemas
- `backend/app/services/message_service.py` - NEW: Message business logic
- `backend/app/api/routes/messages.py` - NEW: Message API endpoints
- `backend/app/api/main.py` - Registered messages router
- `backend/app/alembic/versions/c3047193e5b5_add_direct_messages_table.py` - NEW: Migration
- `backend/pyproject.toml` - Added bleach dependency
- `backend/app/tests/test_api/test_messages.py` - NEW: 20 test cases

**Frontend (New/Modified):**
- `frontend/src/types/message.ts` - NEW: TypeScript types
- `frontend/src/services/messagesApi.ts` - NEW: API client
- `frontend/src/hooks/useMessages.ts` - NEW: TanStack Query hooks
- `frontend/src/components/messaging/ConversationList.tsx` - Updated to use API types
- `frontend/src/components/messaging/MessageThread.tsx` - Updated to use API types
- `frontend/src/components/messaging/ComposeMessageModal.tsx` - NEW: Compose modal
- `frontend/src/routes/_layout/messaging/index.tsx` - Updated to use real API
- `frontend/src/routes/_layout/messaging/$conversationId.tsx` - Updated to use real API
- `frontend/src/components/Common/Navbar.tsx` - Updated to use real unread count

---

## QA Results

(To be filled by QA agent)
