# Story 5.3: Assignment-Specific Analytics & Common Mistakes

**Epic:** 5 - Analytics, Reporting & Teacher Insights
**Story ID:** 5.3
**Status:** Done
**Created:** 2025-01-28
**Developer:** (To be assigned)

---

## Story

**As a** teacher,
**I want** to see detailed results for a specific assignment including which questions students struggled with,
**so that** I can identify common misconceptions and reteach difficult concepts.

---

## Acceptance Criteria

1. Assignment detail page includes "Results" tab showing completion statistics
2. **Completion Overview**: Shows completed count, in progress count, not started count, past due count with visual progress bar
3. **Score Statistics**: Displays average score, median score, highest score, lowest score
4. **Student Results Table**: Lists all assigned students with columns: student name, status, score, time spent, completion date, "View Details" button
5. Table is sortable by any column and filterable by status
6. **Question-Level Analysis** (activity-type specific):
   - Multiple-choice/True-False: Shows each question with percentage of students who answered correctly
   - **Most Missed Questions**: Highlights top 3 questions with lowest correct percentage
   - **Answer Distribution**: For each question, shows how many students selected each option
7. Word matching: Shows which pairs were most commonly matched incorrectly
8. Fill-in-blank: Shows which blanks had lowest correct rate and common incorrect answers
9. Word search: Shows which words were found least often
10. API endpoint `GET /api/assignments/{assignment_id}/detailed-results` returns question-level analytics
11. Backend aggregates answers_json from all students to calculate question statistics
12. Visual heatmap for multiple-choice showing correct (green) vs. incorrect (red) answer distributions
13. Teacher can click "View Details" for individual student to see their full submitted answers
14. Export functionality for assignment results (PDF/Excel)
15. Integration tests verify accurate question-level aggregation

---

## Tasks / Subtasks

- [x] **Task 1: Backend Schema Definitions** (AC: 2, 3, 10)
  - [x] 1.1: Create `AssignmentDetailedResultsResponse` Pydantic schema with completion overview fields
  - [x] 1.2: Create `CompletionOverview` schema (completed, in_progress, not_started, past_due counts)
  - [x] 1.3: Create `ScoreStatistics` schema (avg, median, highest, lowest)
  - [x] 1.4: Create `StudentResultItem` schema (student_id, name, status, score, time_spent, completed_at)
  - [x] 1.5: Create `QuestionAnalysis` schema (question_id, question_text, correct_percentage, answer_distribution)
  - [x] 1.6: Create `MostMissedQuestion` schema (question_id, question_text, correct_percentage, common_wrong_answer)

- [x] **Task 2: Backend Analytics Service - Assignment Results** (AC: 10, 11)
  - [x] 2.1: Add `get_assignment_detailed_results(assignment_id, teacher_id)` function to `analytics_service.py`
  - [x] 2.2: Implement completion overview calculation (count by status, identify past_due)
  - [x] 2.3: Implement score statistics calculation (avg, median using sorted list, min, max)
  - [x] 2.4: Build student results list from `assignment_students` table
  - [x] 2.5: Implement question-level aggregation from `answers_json` JSONB column

- [x] **Task 3: Question-Level Analysis by Activity Type** (AC: 6, 7, 8, 9, 11)
  - [x] 3.1: Implement multiple-choice/true-false analysis (correct % per question, answer distribution)
  - [x] 3.2: Implement "most missed questions" identification (top 3 lowest correct %)
  - [x] 3.3: Implement word matching error analysis (incorrect pair mappings)
  - [x] 3.4: Implement fill-in-blank analysis (correct rate per blank, common wrong answers)
  - [x] 3.5: Implement word search analysis (find rate per word)
  - [x] 3.6: Create activity-type dispatch function to route to appropriate analyzer

- [x] **Task 4: Backend API Endpoint** (AC: 10, 13)
  - [x] 4.1: Add `GET /api/v1/assignments/{assignment_id}/detailed-results` endpoint to `routes/assignments.py`
  - [x] 4.2: Verify teacher owns assignment (via `_verify_assignment_ownership()` helper)
  - [x] 4.3: Return 404 for non-existent or unauthorized assignments
  - [x] 4.4: Add `GET /api/v1/assignments/{assignment_id}/students/{student_id}/answers` endpoint for individual student details

- [x] **Task 5: Backend Integration Tests** (AC: 15)
  - [x] 5.1: Create `backend/app/tests/test_api/test_assignment_analytics.py`
  - [x] 5.2: Test completion overview calculation with multiple students in various statuses
  - [x] 5.3: Test score statistics (avg, median, min, max) with known values
  - [x] 5.4: Test question-level aggregation for multiple-choice activity
  - [x] 5.5: Test "most missed questions" identification
  - [x] 5.6: Test authorization (teacher can only see own assignments)
  - [x] 5.7: Test empty assignment (no submissions yet)
  - [x] 5.8: Test activity-type specific analysis (word matching, fill-in-blank, word search)

- [x] **Task 6: Frontend TypeScript Types** (AC: 2, 3, 4, 6)
  - [x] 6.1: Add `AssignmentDetailedResults` interface to `types/analytics.ts`
  - [x] 6.2: Add `CompletionOverview`, `ScoreStatistics`, `StudentResultItem` types
  - [x] 6.3: Add `QuestionAnalysis`, `MostMissedQuestion`, `AnswerDistribution` types

- [x] **Task 7: Frontend API Service** (AC: 10, 13)
  - [x] 7.1: Add `getAssignmentDetailedResults(assignmentId)` to `services/assignmentsApi.ts`
  - [x] 7.2: Add `getStudentAnswers(assignmentId, studentId)` function

- [x] **Task 8: Frontend Hook** (AC: 10)
  - [x] 8.1: Create `hooks/useAssignmentResults.ts` with TanStack Query (5-minute stale time)
  - [x] 8.2: Return `{ results, isLoading, error, refetch }`
  - [x] 8.3: Create `hooks/useAssignmentResults.test.tsx` with hook tests

- [x] **Task 9: Frontend Results Tab Component** (AC: 1, 2, 3, 4, 5, 12)
  - [x] 9.1: Add "Results" tab to assignment detail page (`routes/_layout/teacher/assignments.$assignmentId.tsx` or similar)
  - [x] 9.2: Create completion overview section with progress bar visualization
  - [x] 9.3: Create score statistics cards (avg, median, high, low)
  - [x] 9.4: Create student results table with sorting and status filtering
  - [x] 9.5: Add "View Details" button linking to individual student answers modal/page

- [x] **Task 10: Question-Level Analysis UI** (AC: 6, 7, 8, 9, 12)
  - [x] 10.1: Create question analysis section with conditional rendering by activity type
  - [x] 10.2: Implement "Most Missed Questions" highlight cards
  - [x] 10.3: Create answer distribution visualization (bar chart or heatmap) using Recharts
  - [x] 10.4: Display activity-type specific analysis (word pairs, blanks, word search)

- [x] **Task 11: Frontend Component Tests** (AC: 15)
  - [x] 11.1: Create `routes/__tests__/assignment-results.test.tsx`
  - [x] 11.2: Test completion overview display
  - [x] 11.3: Test score statistics display
  - [x] 11.4: Test student table sorting and filtering
  - [x] 11.5: Test question-level analysis rendering
  - [x] 11.6: Test empty state handling

- [x] **Task 12: Export Functionality** (AC: 14)
  - [x] 12.1: Add export button (PDF/Excel) to results tab
  - [x] 12.2: Implement client-side Excel export using `xlsx` library
  - [x] 12.3: Defer PDF export to future story if complex (note in completion notes)

---

## Dev Notes

### Previous Story Insights (Story 5.2)
[Source: docs/stories/5.2.class-wide-performance-analytics.md#Dev Agent Record]

- Reuse analytics service patterns from `analytics_service.py`
- Teacher authorization via `_verify_class_ownership()` - create similar `_verify_assignment_ownership()` helper
- Return 404 instead of 403 to prevent information disclosure
- TanStack Query with 5-minute stale time for frontend caching
- Recharts BarChart for visualizations
- Use TrendIndicator component pattern for score comparisons
- Test patterns: 14 backend + 54 frontend tests across hook and component

### Data Models
[Source: docs/architecture/2-database-schema-design.md#2.2.4]

**assignment_students table (key fields for this story):**
```
- id (UUID, PK)
- assignment_id (UUID, FK)
- student_id (UUID, FK)
- status (ENUM: 'not_started', 'in_progress', 'completed')
- score (INTEGER, 0-100)
- answers_json (JSONB) - Contains student's submitted answers
- progress_json (JSONB)
- started_at (TIMESTAMP)
- completed_at (TIMESTAMP)
- time_spent_minutes (INTEGER)
```

**answers_json Structure by Activity Type:**
- Multiple-choice: `{ "q1": "a", "q2": "b", ... }` or similar
- Word matching: `{ "word1": "matchedWord", ... }`
- Fill-in-blank: `{ "blank1": "answer", ... }`
- Word search: `{ "foundWords": ["word1", "word2"] }`

Note: Actual structure depends on activity player implementation - inspect existing `answers_json` data in database or check activity player submission logic.

**activity_type ENUM values:**
```
'dragdroppicture', 'dragdroppicturegroup', 'matchTheWords',
'circle', 'markwithx', 'puzzleFindWords'
```

### API Specifications
[Source: docs/architecture/3-api-architecture.md#3.4.5]

**Endpoint to implement:**
```
GET /api/v1/assignments/{assignment_id}/detailed-results
```

Response should include:
- Completion overview (counts by status)
- Score statistics (avg, median, high, low)
- Student results list (sortable)
- Question-level analysis (activity-type dependent)

**Authorization:** Teacher must own the assignment (check `assignment.teacher_id == current_teacher.id`)

### Analytics Engine Patterns
[Source: docs/architecture/7-analytics-engine.md#7.2]

Error pattern detection example:
```python
# Analyze answers_json for common incorrect patterns
for assignment, student_assignment in low_score_assignments:
    if assignment.activity.activity_type == 'matchTheWords':
        # Analyze which pairs are frequently mismatched
        pass
```

### File Locations
[Source: docs/architecture/source-tree.md]

**Backend:**
- Schema: `backend/app/schemas/analytics.py` (extend existing)
- Service: `backend/app/services/analytics_service.py` (add new function)
- Route: `backend/app/api/routes/assignments.py` (add new endpoint)
- Tests: `backend/app/tests/test_api/test_assignment_analytics.py` (new file)

**Frontend:**
- Types: `frontend/src/types/analytics.ts` (extend existing)
- API: `frontend/src/services/assignmentsApi.ts` (add new functions)
- Hook: `frontend/src/hooks/useAssignmentResults.ts` (new file)
- Hook Tests: `frontend/src/hooks/useAssignmentResults.test.tsx` (new file)
- Page: `frontend/src/routes/_layout/teacher/assignments/$assignmentId.tsx` (add Results tab) or similar existing assignment detail page
- Component Tests: `frontend/src/routes/__tests__/assignment-results.test.tsx` (new file)

### Technical Constraints
[Source: docs/architecture/tech-stack.md]

- Backend: Python 3.11+, FastAPI, SQLModel, PostgreSQL with JSONB
- Frontend: React 18, TypeScript 5.x, TanStack Query 5.x, Recharts 2.x
- Testing: pytest (backend), Vitest + RTL (frontend)

### Testing Requirements
[Source: docs/architecture/10-testing-strategy.md]

**Backend Testing Patterns:**
```python
@pytest.mark.asyncio
async def test_get_assignment_detailed_results(
    client: AsyncClient,
    teacher_token: str,
    sample_assignment_with_submissions: Assignment
):
    """Test that teacher can get detailed results for their assignment."""
    response = await client.get(
        f"/api/v1/assignments/{sample_assignment_with_submissions.id}/detailed-results",
        headers={"Authorization": f"Bearer {teacher_token}"}
    )
    assert response.status_code == 200
    data = response.json()
    assert "completion_overview" in data
    assert "score_statistics" in data
    assert "student_results" in data
    assert "question_analysis" in data
```

**Frontend Testing Patterns:**
- Use React Testing Library
- Test loading, error, and populated states
- Test sorting and filtering interactions
- Mock API responses

---

## Testing

### Test File Locations
- Backend: `backend/app/tests/test_api/test_assignment_analytics.py`
- Frontend Hook: `frontend/src/hooks/useAssignmentResults.test.tsx`
- Frontend Component: `frontend/src/routes/__tests__/assignment-results.test.tsx`

### Testing Standards
[Source: docs/architecture/10-testing-strategy.md, docs/architecture/coding-standards.md#Testing Patterns]

**Backend:**
- Use pytest with async fixtures
- Create fixtures for teacher token, sample assignment with multiple submissions
- Test authorization (own assignments only)
- Test edge cases (empty, single submission, all statuses)
- Test activity-type specific aggregation

**Frontend:**
- Use Vitest + React Testing Library
- Test hook with QueryClientProvider wrapper
- Test component with mock data for all activity types
- Test table sorting and filtering
- Test chart rendering with mocked Recharts

### Test Coverage Expectations
- Backend: 10-15 integration tests covering all ACs
- Frontend: 15-20 tests (5-8 hook tests, 10-15 component tests)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-28 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A - No significant debugging issues encountered.

### Completion Notes

**Story 5.3 Implementation Complete**

All 12 tasks completed successfully:
- Backend: Schemas, analytics service functions, API endpoints, and integration tests (13 tests)
- Frontend: TypeScript types, API services, hooks (20 tests), Results tab component (49 tests), export functionality

**Key Implementation Details:**
1. Activity-type specific analysis implemented for: dragdroppicture, dragdroppicturegroup, matchTheWords, circle, markwithx, puzzleFindWords
2. Teacher authorization via `_verify_assignment_ownership()` helper returning 404 (not 403) for security
3. TanStack Query hooks with 5-minute stale time for caching
4. Recharts BarChart with color-coded performance heatmap
5. Excel export using `xlsx` library (PDF export deferred to future story)
6. View Details dialog for individual student answers

**Test Coverage:**
- Backend: 13 integration tests covering all ACs
- Frontend Hook: 20 tests for useAssignmentResults and useStudentAnswers
- Frontend Component: 49 tests covering Results tab, Students tab, filters, dialogs, and edge cases

### File List

**Backend (Modified/Created):**
- `backend/app/schemas/analytics.py` - Extended with Story 5.3 schemas (12 new Pydantic models)
- `backend/app/services/analytics_service.py` - Added assignment analytics functions
- `backend/app/api/routes/assignments.py` - Added new endpoints
- `backend/app/tests/test_api/test_assignment_analytics.py` - New test file (13 tests)

**Frontend (Modified/Created):**
- `frontend/src/types/analytics.ts` - Extended with Story 5.3 types
- `frontend/src/services/assignmentsApi.ts` - Added new API functions
- `frontend/src/hooks/useAssignmentResults.ts` - New hook file
- `frontend/src/hooks/useAssignmentResults.test.tsx` - New test file (20 tests)
- `frontend/src/routes/_layout/teacher/assignments/$assignmentId.tsx` - Rewritten with Results tab
- `frontend/src/routes/__tests__/assignment-results.test.tsx` - New test file (49 tests)
- `frontend/package.json` - Added xlsx dependency

---

## QA Results

### Gate Decision: **PASS**

**Reviewed By:** Quinn (QA Agent)
**Review Date:** 2025-11-28
**Gate File:** `docs/qa/gates/5.3-assignment-specific-analytics-common-mistakes.yml`

---

### Test Execution Summary

| Test Suite | Tests | Passed | Failed | Status |
|------------|-------|--------|--------|--------|
| Backend Integration | 13 | 13 | 0 | ✅ |
| Frontend Hook | 20 | 20 | 0 | ✅ |
| Frontend Component | 49 | 49 | 0 | ✅ |
| **Total** | **82** | **82** | **0** | **✅** |

---

### Acceptance Criteria Validation

| AC | Description | Status |
|----|-------------|--------|
| 1 | Results tab on assignment detail page | ✅ PASS |
| 2 | Completion overview with progress bar | ✅ PASS |
| 3 | Score statistics (avg, median, high, low) | ✅ PASS |
| 4 | Student results table with all columns | ✅ PASS |
| 5 | Table sortable and filterable by status | ✅ PASS |
| 6 | Question-level analysis (activity-specific) | ✅ PASS |
| 7 | Word matching error analysis | ✅ PASS |
| 8 | Fill-in-blank analysis | ✅ PASS |
| 9 | Word search analysis | ✅ PASS |
| 10 | API endpoint for detailed results | ✅ PASS |
| 11 | Backend JSONB aggregation | ✅ PASS |
| 12 | Visual heatmap for performance | ✅ PASS |
| 13 | View Details for student answers | ✅ PASS |
| 14 | Export functionality (Excel) | ✅ PASS |
| 15 | Integration tests | ✅ PASS |

---

### Risk Assessment

| Category | Risk Level | Notes |
|----------|------------|-------|
| Security | LOW | Authorization via ownership check, returns 404 not 403 |
| Performance | LOW | TanStack Query caching, efficient JSONB queries |
| Reliability | LOW | ErrorBoundary, loading/error states handled |

---

### Issues Found During Review

| ID | Severity | Description | Status |
|----|----------|-------------|--------|
| QA-5.3-001 | LOW | View Details button missing navigation handler on assignments list | ✅ RESOLVED |

**Resolution:** Fixed routing by converting `assignments.tsx` to layout with Outlet and moving list content to `assignments/index.tsx`.

---

### Recommendations

1. **REC-5.3-001** (LOW): Consider adding PDF export in future story as planned
2. **REC-5.3-002** (LOW): Consider keyboard navigation for student table (accessibility)

---

### Conclusion

Story 5.3 implementation is **COMPLETE** and meets all acceptance criteria. The implementation follows established patterns from Story 5.2, maintains comprehensive test coverage (82 tests), and properly handles all 6 activity types. A minor routing fix was applied during QA review to enable navigation to the assignment detail page.
