# Story 30.7: Writing Skill — Sentence Builder & Fill-Blank Formats

**Status:** Ready for Review
**Epic:** Epic 30 - Skill-Based AI Assignment Generation & Reporting
**Story Points:** 5
**Priority:** Medium
**Dependencies:** Story 30.3 (V2 API and dispatcher)

---

## User Story

As a **teacher**,
I want **to generate Writing-focused activities that emphasize expression and composition**,
So that **my students practice written expression, not just grammar rules or vocabulary recall**.

---

## Acceptance Criteria

1. [x] Writing Sentence Builder generates sentences with expressive/compositional focus
2. [x] Writing Fill-blank accepts multiple valid answers scored by predefined alternatives
3. [x] Activities include context/scenario prompts (e.g., "You are writing a letter to a friend")
4. [x] Writing activities feel pedagogically distinct from Grammar activities
5. [x] Difficulty scales with CEFR level

---

## Tasks & Subtasks

- [x] **Task 1: Create Writing Sentence Builder Generator** (AC: 1, 3, 4)
  - [x] Create `backend/app/services/ai_generation/writing_sentence_builder_service.py`
  - [x] Writing-focused LLM prompts emphasizing expressive sentences
  - [x] Includes context/scenario per sentence from LLM
  - [x] Reuses SentenceBuilderActivity schema (same frontend player)

- [x] **Task 2: Create Writing Fill-Blank Generator** (AC: 2, 3, 5)
  - [x] Create `backend/app/services/ai_generation/writing_fill_blank_service.py`
  - [x] Create `backend/app/schemas/writing_fill_blank.py` with context + acceptable_answers
  - [x] LLM generates 3-5 valid alternatives per blank
  - [x] Ensures correct_answer is always in acceptable_answers list

- [x] **Task 3: Register in Dispatcher** (AC: 1, 2)
  - [x] Updated GENERATOR_MAP: writing×sentence_builder → "writing_sentence_builder"
  - [x] Updated GENERATOR_MAP: writing×fill_blank → "writing_fill_blank"
  - [x] Added V2 endpoint routing branches for both generators
  - [x] Added writing fill-blank storage methods

- [x] **Task 4: Unit Tests** (AC: 1-5)
  - [x] 23 tests in `backend/app/tests/test_writing_generators.py` — all passing
  - [x] Schema tests (7), prompt tests (6), SB service tests (3), FB service tests (4), storage tests (3)
  - [x] Regression: 148 tests passing across Stories 30.1-30.7

---

## Dev Notes

### Distinction from Grammar Activities
The key pedagogical difference:
- **Grammar fill-blank**: "She _______ to school every day." → Tests verb conjugation (one correct answer)
- **Writing fill-blank**: "The sunset was _______." → Tests expressive word choice (many valid answers)

The LLM prompts enforce this distinction. Writing activities never have a single "correct" grammatical form as the answer.

### Reuse Patterns
- Writing Sentence Builder reuses the SentenceBuilderActivity schema (same interaction on frontend)
- Writing Fill-blank has its own WritingFillBlankActivity schema with context + acceptable_answers

### Testing
- Test file: `backend/app/tests/test_writing_generators.py`
- Verify Writing generators produce contextual prompts
- Verify multiple acceptable answers exist

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `backend/app/schemas/writing_fill_blank.py` | Created | Request, item, activity, public schemas |
| `backend/app/services/ai_generation/writing_sentence_builder_service.py` | Created | WritingSentenceBuilderService with writing-focused LLM prompts |
| `backend/app/services/ai_generation/writing_fill_blank_service.py` | Created | WritingFillBlankService with multi-answer support |
| `backend/app/services/ai_generation/prompts/writing_prompts.py` | Created | SB + FB system/user prompts, JSON schemas, difficulty guidelines |
| `backend/app/services/skill_generation_dispatcher.py` | Modified | writing×sentence_builder + writing×fill_blank now implemented |
| `backend/app/api/routes/ai_generation.py` | Modified | Added writing_sentence_builder + writing_fill_blank branches |
| `backend/app/services/ai_generation/quiz_storage_service.py` | Modified | Added writing fill-blank storage methods |
| `backend/app/tests/test_writing_generators.py` | Created | 23 unit tests |
| `backend/app/tests/test_ai_generation_v2.py` | Modified | Updated map counts (11 implemented, 1 stub), added writing dispatcher tests |

### Completion Notes
- All 4 tasks implemented and verified
- 23 unit tests passing, 148 regression tests passing
- GENERATOR_MAP now has 11 implemented combos + 1 stub (vocabulary×matching)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2026-02-13 | 1.1 | Implementation complete — all tasks done, 23+148 tests passing | Dev Agent (James) |
