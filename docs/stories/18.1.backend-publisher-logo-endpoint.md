# Story 18.1: Backend - Publisher Logo Endpoint

**Epic:** 18 - DCS Logo Integration
**Story ID:** 18.1
**Status:** Done
**Created:** 2025-12-20
**Priority:** Medium

---

## Story

**As an** API consumer,
**I want** an endpoint to fetch publisher logos from Dream Central Storage,
**so that** the frontend can display publisher branding without local storage.

---

## Acceptance Criteria

### Endpoint Functionality
1. New endpoint `GET /api/v1/publishers/{publisher_id}/logo` returns publisher logo
2. Endpoint fetches logo from DCS path: `publishers/{publisher_name}/logo.{ext}`
3. Supports multiple image extensions: .png, .jpg, .jpeg, .svg
4. Returns correct MIME type based on file extension
5. Returns image bytes as response body (not JSON)

### Error Handling
6. Returns 404 when logo not found in DCS (with cache headers)
7. Returns 404 when publisher ID doesn't exist
8. DCS connection errors return 503 with retry-after header
9. Errors are logged but don't expose internal details to client
10. Graceful fallback when DCS is unavailable

### Caching
11. Successful responses include `Cache-Control: public, max-age=86400` (24 hours)
12. Successful responses include `ETag` header based on content hash
13. 404 responses include `Cache-Control: public, max-age=3600` (1 hour)
14. Endpoint supports conditional requests (If-None-Match returns 304)

### Authentication
15. Endpoint is publicly accessible (no auth required for logos)
16. Uses internal DCS client authentication (JWT) for DCS requests

### Path Resolution
17. Publisher name is URL-encoded for DCS path (handles spaces, special chars)
18. Tries extensions in order: png, jpg, jpeg, svg
19. Returns first match found

---

## Tasks / Subtasks

### Task 1: Add Logo Fetch Method to DCS Client (AC: 2, 3, 17, 18)

- [x] Add `get_publisher_logo` method to `DreamCentralStorageClient`:

```python
# backend/app/services/dream_storage_client.py

async def get_publisher_logo(self, publisher_name: str) -> tuple[bytes, str] | None:
    """
    Fetch publisher logo from DCS.

    Args:
        publisher_name: Publisher organization name

    Returns:
        Tuple of (content_bytes, mime_type) or None if not found

    Raises:
        DreamStorageError: If DCS request fails (except 404)
    """
    # URL-encode publisher name for path safety
    encoded_name = url_quote(publisher_name, safe="")

    # Try different extensions
    extensions = [
        ("png", "image/png"),
        ("jpg", "image/jpeg"),
        ("jpeg", "image/jpeg"),
        ("svg", "image/svg+xml"),
    ]

    for ext, mime_type in extensions:
        logo_path = f"publishers/{encoded_name}/logo.{ext}"
        try:
            # Use existing download pattern
            url = f"/storage/publishers/{encoded_name}/object?path=logo.{ext}"
            response = await self._make_request("GET", url)
            return (response.content, mime_type)
        except DreamStorageNotFoundError:
            continue
        except Exception as e:
            logger.warning(f"Error fetching logo for {publisher_name}: {e}")
            continue

    return None  # No logo found
```

### Task 2: Create Publisher Logo Endpoint (AC: 1, 4, 5, 6, 7, 15)

- [x] Add endpoint to `publishers.py`:

```python
# backend/app/api/routes/publishers.py

from fastapi import Response
from fastapi.responses import Response as FastAPIResponse
import hashlib

@router.get(
    "/{publisher_id}/logo",
    summary="Get publisher logo",
    description="Fetch publisher logo from Dream Central Storage. Returns image bytes.",
    responses={
        200: {"content": {"image/png": {}, "image/jpeg": {}, "image/svg+xml": {}}},
        404: {"description": "Logo not found"},
        503: {"description": "DCS unavailable"},
    },
)
async def get_publisher_logo(
    publisher_id: uuid.UUID,
    session: SessionDep,
    dcs_client: DreamCentralStorageClient = Depends(get_dream_storage_client),
) -> Response:
    """
    Get publisher logo from DCS.

    Returns the logo image with appropriate MIME type and caching headers.
    Returns 404 if no logo is available.
    """
    # Get publisher
    publisher = session.get(Publisher, publisher_id)
    if not publisher:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Publisher not found"
        )

    try:
        result = await dcs_client.get_publisher_logo(publisher.name)

        if result is None:
            # No logo found - return 404 with cache
            return Response(
                status_code=404,
                headers={"Cache-Control": "public, max-age=3600"}
            )

        content, mime_type = result
        etag = hashlib.md5(content).hexdigest()

        return Response(
            content=content,
            media_type=mime_type,
            headers={
                "Cache-Control": "public, max-age=86400",
                "ETag": f'"{etag}"',
            }
        )

    except DreamStorageError as e:
        logger.error(f"DCS error fetching logo for {publisher_id}: {e}")
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail="Storage service temporarily unavailable",
            headers={"Retry-After": "60"}
        )
```

### Task 3: Add Conditional Request Support (AC: 14)

- [x] Add If-None-Match handling:

```python
from fastapi import Header

@router.get("/{publisher_id}/logo")
async def get_publisher_logo(
    publisher_id: uuid.UUID,
    if_none_match: str | None = Header(default=None),
    session: SessionDep,
    dcs_client: DreamCentralStorageClient = Depends(get_dream_storage_client),
) -> Response:
    # ... get logo ...

    etag = hashlib.md5(content).hexdigest()

    # Check conditional request
    if if_none_match and if_none_match.strip('"') == etag:
        return Response(
            status_code=304,
            headers={
                "Cache-Control": "public, max-age=86400",
                "ETag": f'"{etag}"',
            }
        )

    # Return full response
    return Response(...)
```

### Task 4: Add DCS Client Dependency (AC: 16)

- [x] Ensure `get_dream_storage_client` is available as FastAPI dependency
- [x] Add import to publishers.py:

```python
from app.services.dream_storage_client import (
    DreamCentralStorageClient,
    DreamStorageError,
    get_dream_storage_client,
)
```

### Task 5: Write Unit Tests (AC: 1-19)

- [x] Test successful logo fetch (returns image bytes)
- [x] Test correct MIME type for each extension
- [x] Test 404 when publisher not found
- [x] Test 404 when logo not in DCS
- [x] Test 503 on DCS error
- [x] Test cache headers on success
- [x] Test cache headers on 404
- [x] Test conditional request (304 response)
- [x] Test publisher name URL encoding

```python
# backend/app/tests/test_api/test_publisher_logo.py

import pytest
from unittest.mock import AsyncMock, patch

class TestPublisherLogoEndpoint:

    @pytest.mark.asyncio
    async def test_get_logo_success(self, client, test_publisher, mock_dcs):
        """Test successful logo retrieval."""
        mock_dcs.get_publisher_logo.return_value = (b"PNG...", "image/png")

        response = client.get(f"/api/v1/publishers/{test_publisher.id}/logo")

        assert response.status_code == 200
        assert response.headers["content-type"] == "image/png"
        assert "Cache-Control" in response.headers
        assert "ETag" in response.headers

    @pytest.mark.asyncio
    async def test_get_logo_not_found(self, client, test_publisher, mock_dcs):
        """Test 404 when logo not in DCS."""
        mock_dcs.get_publisher_logo.return_value = None

        response = client.get(f"/api/v1/publishers/{test_publisher.id}/logo")

        assert response.status_code == 404
        assert "Cache-Control" in response.headers

    @pytest.mark.asyncio
    async def test_get_logo_publisher_not_found(self, client):
        """Test 404 when publisher doesn't exist."""
        fake_id = "00000000-0000-0000-0000-000000000000"
        response = client.get(f"/api/v1/publishers/{fake_id}/logo")

        assert response.status_code == 404

    @pytest.mark.asyncio
    async def test_conditional_request_304(self, client, test_publisher, mock_dcs):
        """Test If-None-Match returns 304."""
        content = b"PNG..."
        mock_dcs.get_publisher_logo.return_value = (content, "image/png")

        # First request to get ETag
        response1 = client.get(f"/api/v1/publishers/{test_publisher.id}/logo")
        etag = response1.headers["ETag"]

        # Second request with If-None-Match
        response2 = client.get(
            f"/api/v1/publishers/{test_publisher.id}/logo",
            headers={"If-None-Match": etag}
        )

        assert response2.status_code == 304
```

### Task 6: Update API Documentation (AC: 1)

- [x] Ensure OpenAPI schema includes logo endpoint
- [x] Document response types and headers
- [x] Add examples for each response code

---

## Technical Notes

### DCS Path Convention

```
Bucket: publishers
Path: publishers/{publisher_name}/logo.{ext}

Example paths:
- publishers/Universal%20ELT/logo.png
- publishers/Dream%20Publishing/logo.svg
```

### MIME Type Mapping

| Extension | MIME Type |
|-----------|-----------|
| .png | image/png |
| .jpg | image/jpeg |
| .jpeg | image/jpeg |
| .svg | image/svg+xml |

### Files to Modify

| File | Changes |
|------|---------|
| `backend/app/services/dream_storage_client.py` | Add `get_publisher_logo` method |
| `backend/app/api/routes/publishers.py` | Add logo endpoint |
| `backend/app/tests/test_api/test_publisher_logo.py` | New test file |

### Caching Strategy

- **Success (200)**: Cache 24 hours - logos rarely change
- **Not Found (404)**: Cache 1 hour - allow for logo uploads without long wait
- **ETag**: MD5 hash of content for conditional requests

### Error Handling

```python
# DCS errors mapped to HTTP status codes
DreamStorageNotFoundError -> 404 (cached)
DreamStorageAuthError -> 503 (retry)
DreamStorageServerError -> 503 (retry)
DreamStorageError (other) -> 503 (retry)
```

---

## Dependencies

- Existing DCS client (`dream_storage_client.py`)
- Publisher model

---

## Estimation

- **Complexity:** Low
- **Components:** Backend only

---

## Definition of Done

- [x] Logo endpoint returns images from DCS
- [x] Correct MIME types for all supported formats
- [x] 404 returned when logo not found (with cache)
- [x] 503 returned on DCS errors (with retry-after)
- [x] Cache headers on all responses
- [x] Conditional request support (304)
- [x] Unit tests pass
- [x] No auth required for logo endpoint
- [x] API documentation updated

---

## Test Scenarios

| Scenario | Expected Result |
|----------|-----------------|
| Publisher with PNG logo in DCS | Returns image/png with 24h cache |
| Publisher with SVG logo in DCS | Returns image/svg+xml with 24h cache |
| Publisher with no logo in DCS | Returns 404 with 1h cache |
| Invalid publisher ID | Returns 404 |
| DCS unavailable | Returns 503 with Retry-After |
| Conditional request (matching ETag) | Returns 304 |
| Publisher name with spaces | URL-encoded path to DCS |

---

## Dev Agent Record

### Agent Model Used
- [x] Claude Opus 4.5 (claude-opus-4-5-20251101)

### Tasks
_Checkboxes updated during implementation_

### Debug Log References
_Add links to debug log entries if issues arise_

### Completion Notes
- Implemented `get_publisher_logo` method in DCS client that tries extensions in order (png, jpg, jpeg, svg)
- Created public endpoint `GET /api/v1/publishers/{publisher_id}/logo` with proper caching headers
- ETag-based conditional request support (304 Not Modified)
- 13 unit tests covering all acceptance criteria
- OpenAPI documentation auto-generated from endpoint decorators

### File List
| File | Status | Description |
|------|--------|-------------|
| `backend/app/services/dream_storage_client.py` | Modified | Added `get_publisher_logo` method |
| `backend/app/api/routes/publishers.py` | Modified | Added logo endpoint with imports |
| `backend/app/tests/test_api/test_publisher_logo.py` | Created | 13 unit tests for logo endpoint |

### Change Log
| Date | Change | Author |
|------|--------|--------|
| 2025-12-20 | Story created | John (PM) |
| 2025-12-20 | Implementation complete | James (Dev Agent) |
