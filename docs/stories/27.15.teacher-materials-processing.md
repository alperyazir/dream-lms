# Story 27.15: Teacher Materials Processing

**Status:** Ready for Review

**Epic:** Epic 27 - DreamAI - AI-Powered Content Generation
**Story Points:** 13
**Priority:** Medium
**Dependencies:** Stories 27.1-27.3 (LLM Provider Layer), Story 27.9 (AI Quiz patterns)

---

## Story

**As a** teacher,
**I want** to upload my own materials (PDFs, text) for AI question generation,
**so that** I can create custom activities from content beyond the standard course books.

---

## Acceptance Criteria

1. [ ] PDF upload and text extraction
2. [ ] Direct text/paste input
3. [ ] Document preview before processing
4. [ ] Same generation options as book-based
5. [ ] Save generated content to teacher's personal library (isolated)
6. [ ] Material history/library
7. [ ] Content NOT shared with other teachers

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create Teacher Material Database Models** (AC: 5, 6, 7)
  - [ ] Add to `backend/app/models.py`:
  - [ ] Create `TeacherMaterial` model:
    - `id: UUID` (primary key)
    - `teacher_id: UUID` (foreign key, owner)
    - `name: str` (material name)
    - `description: str | None`
    - `source_type: str` ("pdf", "text")
    - `original_filename: str | None` (for PDFs)
    - `file_path: str | None` (storage path for PDFs)
    - `extracted_text: str` (processed text)
    - `word_count: int`
    - `language: str | None` (detected)
    - `created_at: datetime`
    - `updated_at: datetime`
  - [ ] Create `TeacherGeneratedContent` model:
    - `id: UUID` (primary key)
    - `teacher_id: UUID` (foreign key)
    - `material_id: UUID | None` (foreign key, null if book-based)
    - `book_id: int | None` (null if material-based)
    - `activity_type: str`
    - `content: JSON` (activity data)
    - `created_at: datetime`
    - `is_used: bool = False` (used in assignment)

- [ ] **Task 2: Create Alembic Migration** (AC: 5, 6)
  - [ ] Create migration for teacher material tables
  - [ ] Add indexes for teacher_id queries

- [ ] **Task 3: Create Teacher Material Schemas** (AC: All)
  - [ ] Create `backend/app/schemas/teacher_material.py`
  - [ ] Define schemas:
    - `TeacherMaterialCreate` (name, description, text)
    - `TeacherMaterialResponse`
    - `TeacherMaterialUploadResponse` (for PDF upload)
    - `TextExtractionResult` (extracted_text, word_count, language)
    - `TeacherGeneratedContentResponse`

- [ ] **Task 4: Create PDF Processing Service** (AC: 1, 3)
  - [ ] Create `backend/app/services/pdf_processing_service.py`
  - [ ] Implement text extraction:
    - Use `pypdf` for text-based PDFs
    - Handle multi-page documents
    - Clean extracted text (remove headers/footers)
  - [ ] Implement OCR fallback for scanned PDFs:
    - Detect if PDF is image-based
    - Use Gemini Vision for OCR (from Story 27.3)
  - [ ] Handle errors gracefully:
    - Corrupted PDFs
    - Password-protected PDFs
    - Empty documents

- [ ] **Task 5: Create Teacher Material Service** (AC: All)
  - [ ] Create `backend/app/services/teacher_material_service.py`
  - [ ] Implement `TeacherMaterialService`:
    - `async upload_pdf(file, teacher_id) -> TeacherMaterial`
    - `async create_from_text(text, name, teacher_id) -> TeacherMaterial`
    - `async get_materials(teacher_id) -> list[TeacherMaterial]`
    - `async get_material(material_id, teacher_id) -> TeacherMaterial`
    - `async delete_material(material_id, teacher_id) -> bool`
  - [ ] Implement file storage:
    - Store PDFs in local storage or S3
    - Generate unique file paths
    - Clean up on deletion
  - [ ] Implement language detection:
    - Use langdetect library
    - Default to 'en' if unsure

- [ ] **Task 6: Extend AI Generation for Materials** (AC: 4, 5)
  - [ ] Modify generation services to accept material source:
    - Accept `material_id` as alternative to `book_id`
    - Fetch extracted text from material
    - Same generation logic applies
  - [ ] Add to schemas:
    - `source_type: Literal["book", "material"]`
    - `material_id: UUID | None`
  - [ ] Save generated content to teacher's library:
    - Create `TeacherGeneratedContent` record
    - Associate with material_id
    - Ensure isolation by teacher_id

- [ ] **Task 7: Create Teacher Material API Endpoints** (AC: All)
  - [ ] Create `backend/app/api/routes/teacher_materials.py`
  - [ ] Material endpoints:
    - `POST /api/v1/materials/upload` - Upload PDF
    - `POST /api/v1/materials/text` - Create from text
    - `GET /api/v1/materials` - List teacher's materials
    - `GET /api/v1/materials/{id}` - Get material details
    - `DELETE /api/v1/materials/{id}` - Delete material
  - [ ] Generated content endpoints:
    - `GET /api/v1/materials/generated` - List teacher's generated content
    - `DELETE /api/v1/materials/generated/{id}` - Delete generated content
  - [ ] Register router

- [ ] **Task 8: Write Backend Tests** (AC: All)
  - [ ] Create `test_pdf_processing_service.py`
  - [ ] Create `test_teacher_material_service.py`
  - [ ] Create `test_api/test_teacher_materials.py`
  - [ ] Test PDF upload and extraction
  - [ ] Test text material creation
  - [ ] Test isolation (teacher can only see own materials)

### Frontend Tasks

- [ ] **Task 9: Create Teacher Material Types** (AC: All)
  - [ ] Create `frontend/src/types/teacher-material.ts`

- [ ] **Task 10: Create Teacher Material API Service** (AC: All)
  - [ ] Create `frontend/src/services/teacherMaterialsApi.ts`

- [ ] **Task 11: Create Material Upload Component** (AC: 1, 2, 3)
  - [ ] Create `frontend/src/components/DreamAI/MaterialUpload.tsx`
  - [ ] **Tab 1: Upload PDF**
    - Drag-and-drop zone
    - File picker button
    - Upload progress indicator
    - Preview extracted text after processing
    - Edit extracted text if needed
  - [ ] **Tab 2: Paste Text**
    - Large textarea for direct input
    - Character/word count
    - Language detection indicator
  - [ ] **Common:**
    - Name field (required)
    - Description field (optional)
    - Save button
    - Cancel button

- [ ] **Task 12: Create Material Library Component** (AC: 5, 6)
  - [ ] Create `frontend/src/components/DreamAI/MaterialLibrary.tsx`
  - [ ] Display teacher's saved materials:
    - Material name
    - Source type (PDF/Text)
    - Word count
    - Created date
    - Actions: View, Use for Generation, Delete
  - [ ] Search/filter functionality
  - [ ] Empty state for new teachers

- [ ] **Task 13: Update Generation Forms for Material Source** (AC: 4)
  - [ ] Modify all generation forms (Quiz, Reading, etc.):
    - Add "Source" toggle: Book / My Materials
    - Show book selector when "Book" selected
    - Show material selector when "My Materials" selected
  - [ ] Create `frontend/src/components/DreamAI/SourceSelector.tsx`:
    - Reusable component for source selection
    - Book picker or material picker based on mode

- [ ] **Task 14: Create Generated Content Library** (AC: 5, 7)
  - [ ] Create `frontend/src/components/DreamAI/GeneratedContentLibrary.tsx`
  - [ ] Display teacher's generated content:
    - Activity type
    - Source (book name or material name)
    - Created date
    - Usage status (used in assignment?)
    - Actions: Preview, Use, Delete
  - [ ] Filter by activity type, source type

- [ ] **Task 15: Add Materials Route** (AC: All)
  - [ ] Create `frontend/src/routes/_layout/teacher/dreamai/materials.tsx`
  - [ ] Integrate MaterialUpload and MaterialLibrary
  - [ ] Navigation from DreamAI sidebar

- [ ] **Task 16: Write Frontend Tests** (AC: All)
  - [ ] Test PDF upload flow
  - [ ] Test text paste flow
  - [ ] Test material library display
  - [ ] Test source selector

---

## Dev Notes

### Isolation Requirement

**CRITICAL:** Teacher materials and generated content must be isolated:
- Teacher A cannot see Teacher B's uploaded materials
- Teacher A cannot see content generated from Teacher B's materials
- All queries MUST filter by `teacher_id`

Book-based generated content IS shared (because it's from common course materials).

### PDF Processing Pipeline

```python
async def process_pdf(file: UploadFile) -> TextExtractionResult:
    """
    Process uploaded PDF and extract text.

    Pipeline:
    1. Save uploaded file temporarily
    2. Attempt text extraction with pypdf
    3. If minimal text found, use OCR (Gemini Vision)
    4. Clean and normalize extracted text
    5. Detect language
    6. Return extraction result
    """
    # Save to temp location
    temp_path = await save_temp_file(file)

    try:
        # Try text extraction first
        text = extract_text_from_pdf(temp_path)

        # Check if we got meaningful content
        if len(text.strip()) < 100:
            # Likely scanned PDF, use OCR
            text = await ocr_with_gemini(temp_path)

        # Clean text
        cleaned = clean_extracted_text(text)

        # Detect language
        language = detect_language(cleaned)

        return TextExtractionResult(
            extracted_text=cleaned,
            word_count=len(cleaned.split()),
            language=language
        )
    finally:
        # Clean up temp file
        os.remove(temp_path)
```

### Storage Architecture

```
storage/
└── teacher_materials/
    └── {teacher_id}/
        └── {material_id}/
            ├── original.pdf
            └── metadata.json
```

### API Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/api/v1/materials/upload` | Upload PDF | Teacher+ |
| POST | `/api/v1/materials/text` | Create from text | Teacher+ |
| GET | `/api/v1/materials` | List materials | Teacher+ |
| GET | `/api/v1/materials/{id}` | Get material | Teacher+ |
| DELETE | `/api/v1/materials/{id}` | Delete material | Teacher+ |
| GET | `/api/v1/materials/generated` | List generated content | Teacher+ |

### Source Tree Reference

**New files to create:**
```
backend/app/
├── schemas/
│   └── teacher_material.py
├── services/
│   ├── pdf_processing_service.py
│   └── teacher_material_service.py
├── api/routes/
│   └── teacher_materials.py
├── alembic/versions/
│   └── xxx_add_teacher_material_tables.py
└── tests/
    ├── test_services/
    │   ├── test_pdf_processing_service.py
    │   └── test_teacher_material_service.py
    └── test_api/
        └── test_teacher_materials.py

frontend/src/
├── types/
│   └── teacher-material.ts
├── services/
│   └── teacherMaterialsApi.ts
├── components/
│   └── DreamAI/
│       ├── MaterialUpload.tsx
│       ├── MaterialLibrary.tsx
│       ├── GeneratedContentLibrary.tsx
│       └── SourceSelector.tsx
└── routes/_layout/teacher/dreamai/
    └── materials.tsx
```

**Files to modify:**
```
backend/app/models.py                    # Add material models
backend/app/api/main.py                  # Register router
All generation forms                     # Add source selector
```

### Dependencies

```toml
# backend/pyproject.toml
pypdf = "^4.0"          # PDF text extraction
python-magic = "^0.4"   # File type detection
langdetect = "^1.0"     # Language detection
```

---

## Testing

### Backend Test Cases

```python
@pytest.mark.asyncio
async def test_upload_pdf_extracts_text():
    """Test PDF upload extracts text correctly."""

@pytest.mark.asyncio
async def test_create_material_from_text():
    """Test creating material from pasted text."""

@pytest.mark.asyncio
async def test_material_isolation():
    """Test teacher can only see own materials."""

@pytest.mark.asyncio
async def test_generated_content_isolation():
    """Test teacher can only see own generated content."""

@pytest.mark.asyncio
async def test_delete_material_cascades():
    """Test deleting material cleans up generated content."""
```

### Frontend Test Cases

```typescript
describe('MaterialUpload', () => {
  it('handles PDF drag and drop')
  it('shows upload progress')
  it('displays extracted text preview')
  it('allows editing extracted text')
  it('handles paste text input')
  it('validates required fields')
})

describe('SourceSelector', () => {
  it('toggles between book and material modes')
  it('loads books when book mode selected')
  it('loads materials when material mode selected')
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-02 | 0.1 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
