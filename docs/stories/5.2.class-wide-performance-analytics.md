# Story 5.2: Class-Wide Performance Analytics

**Epic:** 5 - Analytics, Reporting & Teacher Insights
**Story ID:** 5.2
**Status:** Done
**Created:** 2025-01-28
**Developer:** (To be assigned)

---

## Story

**As a** teacher,
**I want** to view aggregated performance metrics for an entire class,
**so that** I can identify class-wide trends and adjust my teaching strategy.

---

## Acceptance Criteria

1. Class detail page includes "Analytics" tab alongside "Students" and "Assignments" tabs
2. **Class Overview Section**: Displays average class score, completion rate, total assignments given, active students count
3. **Score Distribution Chart**: Histogram showing how many students fall into score ranges (0-59%, 60-69%, 70-79%, 80-89%, 90-100%)
4. **Leaderboard**: Top 5 performing students (by average score) with option to view full ranked list
5. **Struggling Students Alert**: Highlights students with average score below 70% or multiple past due assignments
6. **Assignment Performance Table**: Lists all assignments with columns: assignment name, average score, completion rate, average time spent
7. **Activity Type Performance**: Bar chart comparing class average across different activity types
8. **Time Period Selector**: Weekly, Monthly, Semester, Year-to-Date filtering for all metrics
9. **Trend Analysis**: Comparison metrics showing improvement/decline vs. previous period (e.g., "Average score up 5% from last month")
10. API endpoint `GET /api/classes/{class_id}/analytics` returns aggregated class data
11. Backend performs efficient aggregation queries with proper indexing
12. Teacher can export class report as PDF or Excel with all data
13. Visual indicators for positive trends (green arrows) and concerning trends (red arrows)
14. Integration tests verify accurate aggregation across multiple students and assignments

---

## Tasks / Subtasks

- [x] **Task 1: Class Analytics API Endpoint** (AC: 10, 11)
  - [x] Create `ClassAnalyticsResponse` schema in `backend/app/schemas/analytics.py`
  - [x] Create `ClassAnalyticsSummary` schema (avg_score, completion_rate, total_assignments, active_students)
  - [x] Create `ScoreDistribution` schema for histogram data
  - [x] Create `StudentLeaderboardItem` schema (student_id, name, avg_score, rank)
  - [x] Create `StrugglingStudentItem` schema (student_id, name, avg_score, past_due_count, alert_reason)
  - [x] Create `AssignmentPerformanceItem` schema (assignment_id, name, avg_score, completion_rate, avg_time_spent)
  - [x] Create `TrendAnalysis` schema (metric_name, current_value, previous_value, change_percent, trend)
  - [x] Add `GET /api/classes/{class_id}/analytics` endpoint to `backend/app/api/routes/classes.py`
  - [x] Implement teacher authorization check (teacher must own the class)

- [x] **Task 2: Class Analytics Service** (AC: 2, 3, 4, 5, 6, 7, 9, 11)
  - [x] Create `get_class_analytics()` function in `backend/app/services/analytics_service.py`
  - [x] Implement class summary calculation (avg score, completion rate, total assignments, active students)
  - [x] Implement score distribution histogram (5 buckets: 0-59, 60-69, 70-79, 80-89, 90-100)
  - [x] Implement leaderboard query (top N students by avg score with ranking)
  - [x] Implement struggling students detection (avg score < 70% OR past_due > 2)
  - [x] Implement assignment performance aggregation
  - [x] Implement activity type performance aggregation
  - [x] Implement trend analysis (compare current period vs previous period)
  - [x] Add date range filtering support (weekly, monthly, semester, ytd)

- [x] **Task 3: Backend Integration Tests** (AC: 14)
  - [x] Create `backend/app/tests/test_api/test_class_analytics.py`
  - [x] Test successful analytics retrieval for class with data
  - [x] Test authorization (teacher can only access own classes)
  - [x] Test date range filtering (weekly, monthly, semester, ytd)
  - [x] Test score distribution accuracy
  - [x] Test leaderboard ranking correctness
  - [x] Test struggling students detection logic
  - [x] Test empty class handling (no students or no assignments)

- [x] **Task 4: Class Analytics TypeScript Types** (AC: 2-9)
  - [x] Add class analytics types to `frontend/src/types/analytics.ts`
  - [x] Create `ClassAnalyticsResponse` interface
  - [x] Create `ScoreDistribution` interface
  - [x] Create `StudentLeaderboardItem` interface
  - [x] Create `StrugglingStudent` interface
  - [x] Create `AssignmentPerformance` interface
  - [x] Create `TrendData` interface

- [x] **Task 5: Class Analytics API Service** (AC: 10)
  - [x] Create `getClassAnalytics()` function in `frontend/src/services/classesApi.ts`
  - [x] Add period parameter support (weekly, monthly, semester, ytd)

- [x] **Task 6: Class Analytics Custom Hook** (AC: 8)
  - [x] Create `frontend/src/hooks/useClassAnalytics.ts`
  - [x] Implement TanStack Query hook for fetching class analytics
  - [x] Add 5-minute stale time caching
  - [x] Handle loading and error states
  - [x] Support period parameter with refetch on change

- [x] **Task 7: Class Detail Page with Analytics Tab** (AC: 1)
  - [x] Create `frontend/src/routes/_layout/teacher/classrooms/$classId.tsx`
  - [x] Implement tabbed layout: "Students" | "Assignments" | "Analytics"
  - [x] Route from classrooms list to class detail page

- [x] **Task 8: Class Analytics Dashboard Components** (AC: 2, 3, 4, 5, 6, 7, 8, 9, 13)
  - [x] Create Class Overview summary cards (4 stat cards)
  - [x] Create Score Distribution histogram component using Recharts BarChart
  - [x] Create Leaderboard component with expandable full list
  - [x] Create Struggling Students alert component with warning styling
  - [x] Create Assignment Performance table component
  - [x] Create Activity Type Performance bar chart using Recharts
  - [x] Create Time Period selector dropdown (Weekly, Monthly, Semester, YTD)
  - [x] Create Trend indicators with green/red arrows based on change direction

- [x] **Task 9: Navigation Integration**
  - [x] Add clickable class cards/rows in classrooms page to navigate to class detail
  - [x] Ensure back navigation works correctly

- [x] **Task 10: Frontend Component Tests** (AC: 14)
  - [x] Create tests for ClassAnalyticsDashboard component
  - [x] Test rendering with mock data
  - [x] Test time period selector functionality
  - [x] Test loading and error states
  - [x] Test responsive layout

- [ ] **Task 11: Export Functionality (Deferred - Optional)** (AC: 12)
  - [ ] *(Defer to future story - similar to Story 5.1 PDF export)*

---

## Dev Notes

### Previous Story Insights (Story 5.1)
[Source: docs/stories/5.1.individual-student-performance-dashboard.md]

Key learnings from Story 5.1 implementation:
- **Analytics Service Pattern**: Use `backend/app/services/analytics_service.py` for calculation logic, keeping routes thin
- **Schema Organization**: Analytics schemas in `backend/app/schemas/analytics.py` with clear naming
- **Timezone Handling**: Use `.replace(tzinfo=None)` for SQLite datetime comparisons in tests
- **Period Type**: Reuse `PeriodType = Literal["7d", "30d", "3m", "all"]` pattern but adapt for class analytics (weekly, monthly, semester, ytd)
- **Frontend Hook Pattern**: Use TanStack Query with 5-minute stale time for caching
- **Test Fixtures**: Model field names and required fields documented in 5.1 debug log

### Data Models & Schemas
[Source: docs/architecture/2-database-schema-design.md]

**Relevant Tables:**
- `classes` - Class definition (id, name, teacher_id, school_id, grade_level, subject, is_active)
- `class_students` - Student enrollment (class_id, student_id, enrolled_at)
- `assignments` - Assignment records (teacher_id, activity_id, book_id, name, due_date)
- `assignment_students` - Student assignment records (status, score, completed_at, time_spent_minutes)
- `activities` - Activity type information (activity_type enum)

**Existing Composite Indexes for Analytics:**
```sql
CREATE INDEX idx_class_analytics
ON assignment_students(assignment_id, status, score)
INCLUDE (completed_at, time_spent_minutes);
```

### API Specifications
[Source: docs/architecture/3-api-architecture.md, existing classes.py]

**New Endpoint:**
```
GET /api/v1/classes/{class_id}/analytics?period={weekly|monthly|semester|ytd}
```

**Authorization:** Teacher must own the class (verify via `Class.teacher_id == current_teacher.id`)

**Response Format:** Follow existing pattern from `StudentAnalyticsResponse`

### Component Specifications
[Source: docs/architecture/tech-stack.md, Story 5.1]

**Chart Library:** Recharts 2.x (already installed)
- Use `BarChart` for score distribution histogram
- Use `BarChart` for activity type performance
- Reuse chart patterns from Story 5.1

**UI Components:** Shadcn UI + Tailwind CSS
- Use existing `Card`, `Tabs`, `Table`, `Badge`, `Select` components
- Use `ArrowUp` / `ArrowDown` icons from lucide-react for trend indicators

### File Locations
[Source: docs/architecture/source-tree.md]

**Backend:**
- Schema: `backend/app/schemas/analytics.py` (extend existing)
- Service: `backend/app/services/analytics_service.py` (extend existing)
- Route: `backend/app/api/routes/classes.py` (add endpoint)
- Tests: `backend/app/tests/test_api/test_class_analytics.py` (new)

**Frontend:**
- Types: `frontend/src/types/analytics.ts` (extend existing)
- API Service: `frontend/src/services/classesApi.ts` (new or extend)
- Hook: `frontend/src/hooks/useClassAnalytics.ts` (new)
- Page: `frontend/src/routes/_layout/teacher/classrooms/$classId.tsx` (new)
- Tests: `frontend/src/routes/_layout/teacher/classrooms/$classId.test.tsx` (new)
- Tests: `frontend/src/hooks/useClassAnalytics.test.tsx` (new)

### Period Types for Class Analytics

Unlike Story 5.1 which uses `7d | 30d | 3m | all`, class analytics uses academic periods:
- `weekly` - Last 7 days
- `monthly` - Last 30 days
- `semester` - Last 90 days (approximately)
- `ytd` - Year to date (from Jan 1 or academic year start)

### Score Distribution Buckets

Histogram should group students into 5 score ranges:
- 0-59% (Failing)
- 60-69% (D range)
- 70-79% (C range)
- 80-89% (B range)
- 90-100% (A range)

### Struggling Student Criteria

A student is flagged as "struggling" if:
- Average score < 70% across all completed assignments, OR
- Has 2+ past due assignments

### Trend Calculation

Compare current period metrics to previous period of same length:
- If current period is "monthly" (30 days), compare to previous 30 days
- Calculate percentage change: `((current - previous) / previous) * 100`
- Display with appropriate color: green for positive, red for negative

---

## Testing

### Backend Testing Standards
[Source: docs/architecture/10-testing-strategy.md]

**Test Location:** `backend/app/tests/test_api/test_class_analytics.py`

**Pattern:** Follow pytest + AsyncClient pattern from Story 5.1
```python
@pytest.mark.asyncio
async def test_get_class_analytics_success(client: AsyncClient, teacher_token: str):
    """Test successful class analytics retrieval."""
    # Arrange - create class with students and assignments
    # Act - call GET /api/v1/classes/{class_id}/analytics
    # Assert - verify response structure and calculations
```

**Required Test Cases:**
- Success with populated class
- Authorization check (teacher can't access other teachers' classes)
- Date range filtering works correctly
- Score distribution buckets are accurate
- Leaderboard ranking is correct
- Empty class returns zeros/empty arrays

### Frontend Testing Standards
[Source: docs/architecture/10-testing-strategy.md, Story 5.1]

**Test Location:**
- `frontend/src/routes/_layout/teacher/classrooms/$classId.test.tsx`
- `frontend/src/hooks/useClassAnalytics.test.tsx`

**Pattern:** Vitest + React Testing Library
```typescript
describe('ClassAnalyticsDashboard', () => {
  it('renders class overview with correct metrics', () => {
    // Test summary cards display correct values
  })

  it('displays score distribution histogram', () => {
    // Test chart renders with mock data
  })
})
```

---

## Change Log

| Date       | Version | Description            | Author |
|------------|---------|------------------------|--------|
| 2025-01-28 | 1.0     | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A - No significant debugging issues encountered during implementation.

### Completion Notes

**Summary:**
- Implemented comprehensive class-wide analytics dashboard following Story 5.1 patterns
- Backend endpoint `GET /api/v1/classes/{class_id}/analytics` with teacher ownership verification
- Score distribution histogram with 5 buckets (0-59%, 60-69%, 70-79%, 80-89%, 90-100%)
- Leaderboard (top 5), struggling students alerts, assignment performance table
- Activity type performance bar chart comparing averages across types
- Time period filtering (weekly, monthly, semester, ytd) with trend indicators
- Full test coverage: 14 backend tests, 54 frontend tests (15 hook + 39 component)

**Implementation Details:**
- Reused existing analytics service patterns from Story 5.1
- Teacher authorization via `_verify_class_ownership()` helper
- TanStack Query with 5-minute stale time for frontend caching
- Recharts BarChart for score distribution and activity type charts
- TrendIndicator component with up/down/stable arrows and colors
- Tabbed interface (Students, Assignments, Analytics) in class detail page

**Deferred:**
- Task 11: Export Functionality (PDF/Excel) - deferred to future story

### File List

**Backend:**
- `backend/app/schemas/analytics.py` - Extended with class analytics schemas
- `backend/app/services/analytics_service.py` - Added `get_class_analytics()`, `get_class_period_dates()`
- `backend/app/api/routes/classes.py` - Added `/api/v1/classes/{class_id}/analytics` endpoint
- `backend/app/tests/test_api/test_class_analytics.py` - 14 integration tests (new file)

**Frontend:**
- `frontend/src/types/analytics.ts` - Added class analytics TypeScript types
- `frontend/src/services/classesApi.ts` - New file with `getClassAnalytics()` function
- `frontend/src/hooks/useClassAnalytics.ts` - New hook with TanStack Query
- `frontend/src/hooks/useClassAnalytics.test.tsx` - 15 hook tests (new file)
- `frontend/src/routes/_layout/teacher/classrooms/$classId.tsx` - New class detail page
- `frontend/src/routes/_layout/teacher/classrooms/$classId.test.tsx` - 39 component tests (new file)
- `frontend/src/routes/_layout/teacher/classrooms.tsx` - Added View button navigation

---

## QA Results

### Review Date: 2025-01-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is well-structured and follows established patterns from Story 5.1. Backend service layer properly handles aggregation calculations with correct timezone handling for SQLite compatibility. Frontend uses TanStack Query with appropriate caching (5-minute stale time) and presents a comprehensive analytics dashboard with clear visual hierarchy.

**Backend Highlights:**
- Clean schema definitions in `analytics.py` with clear naming conventions
- Service layer (`analytics_service.py`) handles complex aggregations efficiently
- Route authorization via `_verify_class_ownership()` returns 404 to prevent information disclosure
- Proper edge case handling (empty class, missing data)

**Frontend Highlights:**
- Tabbed interface (Students, Assignments, Analytics) provides clear navigation
- TrendIndicator component with proper color coding (green/red/gray)
- Recharts integration for score distribution and activity type charts
- Responsive layout with proper empty states

### Refactoring Performed

None required - implementation follows project standards and patterns.

### Compliance Check

- Coding Standards: ✓ Follows existing patterns from Story 5.1
- Project Structure: ✓ Files in correct locations per source-tree.md
- Testing Strategy: ✓ 14 backend + 54 frontend tests with proper coverage
- All ACs Met: ✓ 13/14 (AC 12 explicitly deferred to future story)

### Improvements Checklist

- [x] Backend analytics endpoint with teacher authorization
- [x] Score distribution histogram with 5 buckets
- [x] Leaderboard with proper ranking
- [x] Struggling students detection (avg < 70% OR past_due >= 2)
- [x] Assignment performance aggregation
- [x] Activity type performance breakdown
- [x] Time period filtering (weekly, monthly, semester, ytd)
- [x] Trend analysis with visual indicators
- [x] Frontend hook with 5-minute caching
- [x] Component tests with comprehensive coverage
- [ ] Export functionality (PDF/Excel) - deferred to future story per Task 11

### Security Review

**Status: PASS**
- Teacher ownership verification prevents unauthorized access
- 404 returned instead of 403 to avoid exposing class existence
- Read-only analytics endpoint with no data modification

### Performance Considerations

**Status: PASS**
- Single aggregation query pattern avoids N+1 queries
- Frontend caching reduces API calls (5-minute stale time)
- All tests complete in < 1 second

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: PASS → docs/qa/gates/5.2-class-wide-performance-analytics.yml

### Recommended Status

✓ Ready for Done

Story implementation is complete with comprehensive test coverage. The only incomplete item (AC 12 - Export functionality) is explicitly documented as deferred in Task 11. All security, performance, and quality standards are met.
