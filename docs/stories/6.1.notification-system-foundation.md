# Story 6.1: Notification System Foundation

**Epic:** 6 - Communication, Feedback & Supplementary Materials
**Story ID:** 6.1
**Status:** Done
**Created:** 2025-12-01
**Developer:** (To be assigned)

---

## Story

**As a** user of any role,
**I want** to receive in-app notifications about important events relevant to my role,
**so that** I stay informed about new assignments, deadlines, feedback, and system updates.

---

## Acceptance Criteria

1. Notification model includes: id, user_id (FK), type (enum: assignment_created, deadline_approaching, feedback_received, message_received, system_announcement), title, message, link (optional URL to relevant page), is_read, created_at
2. All user role dashboards include notification bell icon in header showing unread count badge
3. Clicking notification bell opens notification dropdown/panel showing recent 10 notifications
4. Each notification displays: icon (type-specific), title, message snippet, timestamp (relative: "2 hours ago"), read/unread indicator
5. Clicking notification marks it as read and navigates to linked page (e.g., assignment detail, message thread)
6. Notification panel includes "Mark all as read" button and "View all notifications" link to full page
7. Full notifications page shows all notifications with filtering: All, Unread, By type
8. API endpoint `GET /api/notifications` returns notifications for authenticated user with pagination
9. API endpoint `PATCH /api/notifications/{id}/read` marks notification as read
10. API endpoint `POST /api/notifications/mark-all-read` marks all as read
11. Backend service `NotificationService` provides methods: `create_notification(user_id, type, title, message, link)`
12. Real-time notification delivery using polling (every 30 seconds) or WebSocket (future enhancement)
13. Notification retention: auto-delete notifications older than 30 days
14. Unit tests verify notification creation and delivery logic
15. Integration tests verify end-to-end notification flow

---

## Tasks / Subtasks

### Backend Tasks

- [x] **Task 1: Create Notification Pydantic Schemas** (AC: 1, 8)
  - [x] Create `backend/app/schemas/notification.py`
  - [x] Define `NotificationType` enum: `assignment_created`, `deadline_approaching`, `feedback_received`, `message_received`, `student_completed`, `past_due`, `material_shared`, `system_announcement`
  - [x] Create `NotificationBase` schema with title, message, link fields
  - [x] Create `NotificationCreate` schema for service layer usage
  - [x] Create `NotificationResponse` schema with id, user_id, type, title, message, link, is_read, created_at
  - [x] Create `NotificationListResponse` with pagination metadata

- [x] **Task 2: Verify/Update Notification Database Model** (AC: 1, 13)
  - [x] Verify `Notification` model in `backend/app/models.py` matches schema requirements
  - [x] Add model if not present with fields: id (UUID), user_id (FK), type (enum), title, message, link, is_read, created_at
  - [x] Verify indexes exist: `idx_notifications_user_id`, `idx_notifications_is_read`, `idx_notifications_created_at`
  - [x] Create Alembic migration if model changes needed

- [x] **Task 3: Implement NotificationService** (AC: 11, 13)
  - [x] Create `backend/app/services/notification_service.py`
  - [x] Implement `create_notification(db, user_id, type, title, message, link=None)` async method
  - [x] Implement `get_user_notifications(db, user_id, unread_only=False, limit=10, offset=0)` async method
  - [x] Implement `mark_as_read(db, notification_id, user_id)` async method
  - [x] Implement `mark_all_as_read(db, user_id)` async method
  - [x] Implement `get_unread_count(db, user_id)` async method
  - [x] Implement `cleanup_old_notifications(db, days=30)` async method for scheduled cleanup
  - [x] Add notification type icon mapping utility

- [x] **Task 4: Create Notification API Endpoints** (AC: 8, 9, 10)
  - [x] Create `backend/app/api/routes/notifications.py`
  - [x] Implement `GET /api/v1/notifications` endpoint
    - [x] Accept query params: `unread_only` (bool), `type` (enum), `limit` (int, default 20), `offset` (int)
    - [x] Return paginated `NotificationListResponse`
    - [x] Require authenticated user
  - [x] Implement `GET /api/v1/notifications/unread-count` endpoint
    - [x] Return `{ "count": number }`
  - [x] Implement `PATCH /api/v1/notifications/{notification_id}/read` endpoint
    - [x] Verify notification belongs to authenticated user
    - [x] Mark as read and return updated notification
  - [x] Implement `POST /api/v1/notifications/mark-all-read` endpoint
    - [x] Mark all user notifications as read
    - [x] Return `{ "marked_count": number }`
  - [x] Register router in `backend/app/api/main.py`

- [x] **Task 5: Backend Unit Tests** (AC: 14)
  - [x] Create `backend/app/tests/test_services/test_notification_service.py`
  - [x] Test `create_notification` creates valid notification
  - [x] Test `get_user_notifications` with filtering and pagination
  - [x] Test `mark_as_read` updates is_read flag
  - [x] Test `mark_all_as_read` marks all user notifications
  - [x] Test `get_unread_count` returns correct count
  - [x] Test `cleanup_old_notifications` removes old records

- [x] **Task 6: Backend Integration Tests** (AC: 15)
  - [x] Create `backend/app/tests/test_api/test_notifications.py`
  - [x] Test GET notifications returns user's notifications only
  - [x] Test GET notifications pagination works correctly
  - [x] Test GET notifications filtering by type and unread
  - [x] Test PATCH read marks notification correctly
  - [x] Test POST mark-all-read marks all notifications
  - [x] Test unauthorized access returns 401
  - [x] Test accessing other user's notification returns 404

### Frontend Tasks

- [x] **Task 7: Create TypeScript Types** (AC: 1, 4)
  - [x] Create `frontend/src/types/notification.ts`
  - [x] Define `NotificationType` enum matching backend
  - [x] Define `Notification` interface with all fields
  - [x] Define `NotificationListResponse` interface with pagination
  - [x] Define `NotificationIcon` type mapping

- [x] **Task 8: Create Notification API Service** (AC: 8, 9, 10)
  - [x] Create `frontend/src/services/notificationsApi.ts`
  - [x] Implement `getNotifications(params)` function with unread_only, type, limit, offset params
  - [x] Implement `getUnreadCount()` function
  - [x] Implement `markAsRead(notificationId)` function
  - [x] Implement `markAllAsRead()` function
  - [x] Add proper TypeScript types for all functions

- [x] **Task 9: Create useNotifications Hook** (AC: 3, 5, 12)
  - [x] Create `frontend/src/hooks/useNotifications.ts`
  - [x] Implement `useNotifications()` hook using TanStack Query
    - [x] Query key: `['notifications']`
    - [x] Stale time: 30 seconds (for polling effect)
    - [x] Refetch interval: 30000ms (30 seconds) when window focused
  - [x] Implement `useUnreadCount()` hook with same polling pattern
  - [x] Implement `useMarkAsRead()` mutation hook
  - [x] Implement `useMarkAllAsRead()` mutation hook
  - [x] Invalidate queries on successful mutations

- [x] **Task 10: Create NotificationBell Component** (AC: 2, 3)
  - [x] Create `frontend/src/components/notifications/NotificationBell.tsx`
  - [x] Display bell icon (use Lucide React `Bell` icon)
  - [x] Show unread count badge when count > 0
  - [x] Badge styling: red background, white text, positioned top-right
  - [x] Handle click to open/close notification dropdown
  - [x] Use Shadcn Popover or DropdownMenu for dropdown panel

- [x] **Task 11: Create NotificationDropdown Component** (AC: 3, 4, 5, 6)
  - [x] Create `frontend/src/components/notifications/NotificationDropdown.tsx`
  - [x] Display header with "Notifications" title
  - [x] List recent 10 notifications using `useNotifications` hook
  - [x] Each notification item shows:
    - [x] Type-specific icon (Bell, Mail, CheckCircle, Clock, etc.)
    - [x] Title (truncated if long)
    - [x] Message snippet (truncated to ~50 chars)
    - [x] Relative timestamp (use `formatDistanceToNow` from date-fns)
    - [x] Unread indicator (dot or bold text)
  - [x] Click notification: mark as read, navigate to link, close dropdown
  - [x] "Mark all as read" button in header
  - [x] "View all notifications" link at bottom
  - [x] Empty state: "No notifications" message
  - [x] Loading state: skeleton loader

- [x] **Task 12: Create NotificationItem Component** (AC: 4, 5)
  - [x] Create `frontend/src/components/notifications/NotificationItem.tsx`
  - [x] Accept notification prop with full notification data
  - [x] Accept onClick handler for navigation
  - [x] Style differently for read vs unread
  - [x] Display type-specific icon based on notification.type
  - [x] Handle long titles/messages with text truncation

- [x] **Task 13: Create NotificationsPage Component** (AC: 7)
  - [x] Create `frontend/src/routes/_layout/notifications.tsx`
  - [x] Display page header "Notifications"
  - [x] Add filter tabs: "All", "Unread", dropdown for type filtering
  - [x] Display full notification list with pagination
  - [x] Show more details than dropdown (full message)
  - [x] "Mark all as read" button in header
  - [x] Empty state for no notifications
  - [x] Loading state with skeleton loader

- [x] **Task 14: Integrate NotificationBell into Header** (AC: 2)
  - [x] Update `frontend/src/components/Common/Navbar.tsx`
  - [x] Add NotificationBell component next to user avatar
  - [x] Ensure it appears for all authenticated users (all roles)
  - [x] Position appropriately in header layout

- [x] **Task 15: Add Notification Icon Mapping Utility** (AC: 4)
  - [x] Create `frontend/src/lib/notificationIcons.ts`
  - [x] Map notification types to Lucide React icons:
    - [x] `assignment_created` → FileText
    - [x] `deadline_approaching` → Clock
    - [x] `feedback_received` → MessageSquare
    - [x] `message_received` → Mail
    - [x] `student_completed` → CheckCircle
    - [x] `past_due` → AlertTriangle
    - [x] `material_shared` → Share2
    - [x] `system_announcement` → Bell

- [x] **Task 16: Frontend Component Tests** (AC: 14)
  - [x] Create `frontend/src/components/notifications/__tests__/`
  - [x] Test NotificationBell renders with unread count badge
  - [x] Test NotificationBell hides badge when count is 0
  - [x] Test NotificationDropdown displays notifications list
  - [x] Test NotificationItem displays correct icon and text
  - [x] Test mark as read functionality
  - [x] Test navigation on notification click
  - [x] Test empty and loading states

- [x] **Task 17: Add Route for Notifications Page**
  - [x] Register `/notifications` route in TanStack Router
  - [x] Ensure route is accessible to all authenticated users
  - [x] View all notifications link in NotificationDropdown

---

## Dev Notes

### Database Schema Reference
[Source: architecture/2-database-schema-design.md#2.2.5]

The notification table is already defined in the architecture:

```sql
CREATE TYPE notification_type AS ENUM (
    'assignment_created',
    'deadline_approaching',
    'feedback_received',
    'message_received',
    'student_completed',
    'past_due',
    'material_shared',
    'system_announcement'
);

CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    type notification_type NOT NULL,
    title VARCHAR(500) NOT NULL,
    message TEXT NOT NULL,
    link VARCHAR(500),
    is_read BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);
CREATE INDEX idx_notifications_type ON notifications(type);
```

### API Endpoints Reference
[Source: architecture/3-api-architecture.md#3.4.7]

```
GET    /api/v1/notifications                   # My notifications (paginated)
PATCH  /api/v1/notifications/:id/read          # Mark as read
POST   /api/v1/notifications/mark-all-read     # Mark all as read
GET    /api/v1/notifications/preferences       # Get preferences (Story 6.8)
PUT    /api/v1/notifications/preferences       # Update preferences (Story 6.8)
```

### Frontend File Locations
[Source: architecture/source-tree.md]

```
frontend/src/
├── types/
│   └── notification.ts           # TypeScript interfaces
├── services/
│   └── notificationsApi.ts       # API service
├── hooks/
│   └── useNotifications.ts       # TanStack Query hooks
├── components/
│   └── notifications/            # Notification components
│       ├── NotificationBell.tsx
│       ├── NotificationDropdown.tsx
│       ├── NotificationItem.tsx
│       ├── index.ts
│       └── __tests__/
├── routes/
│   └── _layout/
│       └── notifications.tsx     # Full notifications page
└── lib/
    └── notificationIcons.ts      # Icon mapping utility
```

### Backend File Locations
[Source: architecture/source-tree.md]

```
backend/app/
├── models.py                     # Notification model (may already exist)
├── schemas/
│   └── notification.py           # Pydantic schemas
├── services/
│   └── notification_service.py   # NotificationService
├── api/routes/
│   └── notifications.py          # API endpoints
└── tests/
    ├── test_services/
    │   └── test_notification_service.py
    └── test_api/
        └── test_notifications.py
```

### Previous Story Insights
[Source: Story 5.7 - Performance Comparison & Benchmarking]
- TanStack Query with 30-second stale time works well for polling patterns
- Recharts library used consistently for visualizations
- API service layer pattern with typed functions established
- Component tests follow Vitest + React Testing Library pattern

### Notification Type Icons
[Source: Story requirement]

| Type | Icon (Lucide React) | Color |
|------|---------------------|-------|
| assignment_created | FileText | Blue |
| deadline_approaching | Clock | Orange |
| feedback_received | MessageSquare | Green |
| message_received | Mail | Blue |
| student_completed | CheckCircle | Green |
| past_due | AlertTriangle | Red |
| material_shared | Share2 | Purple |
| system_announcement | Bell | Gray |

### Polling Strategy
[Source: AC 12]
- Use TanStack Query's `refetchInterval: 30000` for polling
- Only poll when window is focused (`refetchIntervalInBackground: false`)
- Invalidate queries when user actions occur (mark as read)
- Consider WebSocket upgrade in future stories if real-time is critical

### Notification Cleanup
[Source: architecture/2-database-schema-design.md#2.5]
- Notifications auto-delete after 30 days
- Implement via scheduled backend task or database function
- `cleanup_old_notifications()` service method for manual/scheduled cleanup

---

## Testing

### Backend Testing Requirements
[Source: architecture/10-testing-strategy.md]
- Use pytest with async fixtures
- Test file location: `backend/app/tests/test_api/test_notifications.py`
- Test service layer: `backend/app/tests/test_services/test_notification_service.py`
- Create fixtures for users with notifications
- Test authorization (user can only see own notifications)
- Test pagination and filtering

### Frontend Testing Requirements
[Source: architecture/10-testing-strategy.md]
- Use Vitest + React Testing Library
- Test file location: `frontend/src/components/notifications/__tests__/`
- Test hooks with QueryClientProvider wrapper
- Test components with mock notification data
- Test user interactions (click, mark as read)
- Test empty/loading/error states

### Test Coverage Expectations
- Backend: 10-15 integration tests
- Frontend: 15-25 tests (5-8 hook tests, 10-15 component tests)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A

### Completion Notes

Story 6.1 implemented completely with all 17 tasks:

**Backend (Tasks 1-6):**
- Created NotificationType enum and Notification Pydantic schemas
- Added Notification SQLModel with proper indexes and foreign key relationship
- Created Alembic migration for notification_type enum and notifications table
- Implemented NotificationService with all CRUD operations and 30-day cleanup
- Created notification API endpoints (GET, PATCH, POST) with proper authorization
- 34 backend tests passing (18 unit + 16 integration)

**Frontend (Tasks 7-17):**
- Created TypeScript types matching backend schemas
- Implemented notificationsApi service with axios client
- Created TanStack Query hooks with 30-second polling
- Built NotificationBell, NotificationDropdown, and NotificationItem components
- Integrated NotificationBell into Navbar for all user roles
- Created full NotificationsPage with filtering and pagination
- Added notification icon mapping utility with color theming
- 30 frontend tests passing (11 hook + 19 component)

### File List

**Backend Files Created:**
- `backend/app/schemas/notification.py`
- `backend/app/services/notification_service.py`
- `backend/app/api/routes/notifications.py`
- `backend/app/alembic/versions/b2036082d2a4_add_notification_model.py`
- `backend/app/tests/test_services/__init__.py`
- `backend/app/tests/test_services/test_notification_service.py`
- `backend/app/tests/test_api/test_notifications.py`

**Backend Files Modified:**
- `backend/app/models.py` (added NotificationType, Notification model)
- `backend/app/api/main.py` (registered notifications router)
- `backend/app/tests/conftest.py` (added async_session fixture)

**Frontend Files Created:**
- `frontend/src/types/notification.ts`
- `frontend/src/services/notificationsApi.ts`
- `frontend/src/hooks/useNotifications.ts`
- `frontend/src/hooks/useNotifications.test.tsx`
- `frontend/src/lib/notificationIcons.ts`
- `frontend/src/components/notifications/NotificationBell.tsx`
- `frontend/src/components/notifications/NotificationDropdown.tsx`
- `frontend/src/components/notifications/NotificationItem.tsx`
- `frontend/src/components/notifications/index.ts`
- `frontend/src/components/notifications/__tests__/NotificationItem.test.tsx`
- `frontend/src/components/notifications/__tests__/NotificationBell.test.tsx`
- `frontend/src/routes/_layout/notifications.tsx`

**Frontend Files Modified:**
- `frontend/src/components/Common/Navbar.tsx` (integrated NotificationBell)
- `frontend/src/routeTree.gen.ts` (auto-generated with notifications route)

---

## QA Results

### Review Date: 2025-12-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT** - This implementation demonstrates high-quality, production-ready code that follows project standards and best practices.

**Backend Highlights:**
- Clean service layer abstraction with proper async/await patterns
- Well-documented functions with Google-style docstrings
- Proper type hints throughout all modules
- Passes ruff linting checks with no issues
- Appropriate use of SQLModel for database operations
- Proper input validation via Pydantic schemas

**Frontend Highlights:**
- TypeScript types properly defined and matching backend schemas
- TanStack Query hooks with appropriate caching (30s stale time) and polling
- Optimistic updates implemented for mark-as-read mutations
- Clean component architecture with proper separation of concerns
- Good accessibility support (ARIA labels, keyboard navigation, proper roles)

### Refactoring Performed

None required - code quality is excellent.

### Compliance Check

- Coding Standards: ✓ All naming conventions, type annotations, and patterns followed
- Project Structure: ✓ Files placed in correct locations per architecture docs
- Testing Strategy: ✓ Unit and integration tests following prescribed patterns
- All ACs Met: ✓ All 15 acceptance criteria implemented and verified

### Improvements Checklist

All items handled by the implementation - no outstanding issues.

- [x] Notification model with proper fields and indexes (AC 1)
- [x] NotificationBell in header with unread badge (AC 2, 3)
- [x] Notification dropdown with recent 10 notifications (AC 3)
- [x] Type-specific icons and relative timestamps (AC 4)
- [x] Click to mark read and navigate (AC 5)
- [x] Mark all read and View all links (AC 6)
- [x] Full notifications page with filtering (AC 7)
- [x] GET /api/v1/notifications with pagination (AC 8)
- [x] PATCH /api/v1/notifications/{id}/read (AC 9)
- [x] POST /api/v1/notifications/mark-all-read (AC 10)
- [x] NotificationService with all CRUD methods (AC 11)
- [x] 30-second polling for real-time updates (AC 12)
- [x] cleanup_old_notifications() method for 30-day retention (AC 13)
- [x] Unit tests verify creation and delivery logic (AC 14)
- [x] Integration tests verify end-to-end flow (AC 15)

### Security Review

**Status: PASS**

- ✓ User authorization properly enforced - users can only access their own notifications
- ✓ Returns 404 (not 403) for attempts to access other users' notifications, preventing enumeration
- ✓ Returns 401 for unauthenticated requests
- ✓ Input validation via Pydantic schemas
- ✓ Parameterized queries (handled by SQLModel)
- ✓ No sensitive data exposure in responses

### Performance Considerations

**Status: PASS**

- ✓ Polling interval of 30 seconds is appropriate (not too aggressive)
- ✓ Database indexes on user_id, is_read, created_at, and type columns
- ✓ Pagination implemented with configurable limit/offset
- ✓ Optimistic updates in frontend to reduce perceived latency
- ✓ Query invalidation properly configured for cache consistency
- ✓ Polling disabled when window is not focused (refetchIntervalInBackground: false)

### Files Modified During Review

None - no modifications made.

### Test Results

**Backend Tests: 34 passed**
- Unit tests (notification_service): 18 tests ✓
- Integration tests (API endpoints): 16 tests ✓

**Frontend Tests: 30 passed**
- Hook tests (useNotifications): 11 tests ✓
- Component tests (NotificationBell): 7 tests ✓
- Component tests (NotificationItem): 12 tests ✓

### Gate Status

Gate: **PASS** → docs/qa/gates/6.1-notification-system-foundation.yml

### Recommended Status

✓ **Ready for Done**

The implementation is complete, well-tested, and follows all project standards. All 15 acceptance criteria are met with comprehensive test coverage.
