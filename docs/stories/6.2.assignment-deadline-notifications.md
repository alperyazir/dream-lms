# Story 6.2: Assignment & Deadline Notifications

**Epic:** 6 - Communication, Feedback & Supplementary Materials
**Story ID:** 6.2
**Status:** Done
**Created:** 2025-12-02
**Developer:** Claude (Dev Agent)

---

## Story

**As a** student,
**I want** to receive notifications when new assignments are created and when deadlines are approaching,
**so that** I never miss homework and can plan my study time.

---

## Acceptance Criteria

1. When teacher creates assignment, system sends notification to all assigned students with type "assignment_created"
2. Notification title: "New assignment: [Assignment Name]", message: "Due: [Due Date]", link: `/assignments/{id}`
3. Daily automated job runs at 8 AM to check for approaching deadlines (due within 24 hours)
4. Students with assignments due soon receive "deadline_approaching" notification
5. Notification title: "Assignment due soon: [Assignment Name]", message: "Due in [X hours]", link: `/assignments/{id}`
6. When student completes assignment, teacher receives "student_completed" notification
7. Teacher notification: "Student completed: [Student Name] finished [Assignment Name]", score displayed, link: `/assignments/{id}/results`
8. When assignment is past due and student hasn't submitted, student receives "past_due" notification (sent once, 1 day after deadline)
9. Backend uses NotificationService to create notifications at appropriate trigger points
10. Scheduled task (cron job or Celery) handles deadline reminder checks
11. Notifications batch to avoid spam: max 1 deadline reminder per student per day (aggregates multiple assignments)
12. Students can adjust notification preferences: enable/disable deadline reminders (settings page, Story 6.8)
13. Unit tests verify notification triggers for various assignment scenarios
14. Integration tests verify scheduled tasks execute correctly

---

## Tasks / Subtasks

### Backend Tasks

- [x] **Task 1: Create Assignment Notification Trigger** (AC: 1, 2, 9)
  - [x] Modify `create_assignment` in `backend/app/api/routes/assignments.py` to send notifications
  - [x] After assignment creation, iterate through all assigned students
  - [x] Call `notification_service.create_notification()` for each student with type `assignment_created`
  - [x] Format title as "New assignment: {assignment.name}"
  - [x] Format message with due date: "Due: {formatted_due_date}" or "No due date" if none
  - [x] Set link to `/student/assignments/{assignment_id}`
  - [x] Handle case where assignment has no due_date gracefully

- [x] **Task 2: Create Student Completion Notification Trigger** (AC: 6, 7, 9)
  - [x] Modify `submit_assignment` in `backend/app/api/routes/assignments.py` to send teacher notification
  - [x] Look up the assignment's teacher_id and get the teacher's user_id
  - [x] Look up the student's name from the Student model
  - [x] Call `notification_service.create_notification()` with type `student_completed`
  - [x] Format title: "Student completed: {student_name} finished {assignment_name}"
  - [x] Format message: "Score: {score}%"
  - [x] Set link to `/teacher/assignments/{assignment_id}` (teacher assignment page)

- [x] **Task 3: Create Deadline Reminder Service** (AC: 3, 4, 5, 10, 11)
  - [x] Create new file `backend/app/services/deadline_reminder_service.py`
  - [x] Implement `check_approaching_deadlines(db: AsyncSession)` function
  - [x] Query assignments with due_date within next 24 hours
  - [x] For each assignment, find students who haven't completed it
  - [x] Track notifications sent per student per day to avoid spam (AC: 11)
  - [x] Create notification with type `deadline_approaching`
  - [x] Format title: "Assignment due soon: {assignment_name}"
  - [x] Calculate hours remaining and format message: "Due in {X} hours"
  - [x] Aggregate multiple assignments into single notification if >1 due same day

- [x] **Task 4: Create Past Due Notification Service** (AC: 8, 9)
  - [x] Add `check_past_due_assignments(db: AsyncSession)` to deadline_reminder_service.py
  - [x] Query assignments with due_date 1 day past (exactly 24-48 hours ago)
  - [x] Find students with status != 'completed' for these assignments
  - [x] Send notification only once (track via notification type + assignment + user combo)
  - [x] Create notification with type `past_due`
  - [x] Format title: "Assignment past due: {assignment_name}"
  - [x] Format message: "This assignment was due on {due_date}"

- [x] **Task 5: Create Scheduled Task Endpoint** (AC: 10)
  - [x] Create `backend/app/api/routes/scheduled_tasks.py` with admin-only endpoints
  - [x] Add `POST /api/v1/admin/tasks/deadline-reminders` endpoint
  - [x] This endpoint will be called by external cron/scheduler at 8 AM daily
  - [x] Call `check_approaching_deadlines()` and `check_past_due_assignments()`
  - [x] Return summary of notifications sent
  - [x] Require admin role or special scheduler API key for security

- [x] **Task 6: Backend Unit Tests** (AC: 13)
  - [x] Create `backend/app/tests/test_services/test_deadline_reminder_service.py`
  - [x] Test `check_approaching_deadlines()` with various scenarios:
    - Assignments due in 12 hours (should notify)
    - Assignments due in 25 hours (should not notify)
    - Already completed assignments (should not notify)
    - Student already notified today (should not duplicate)
  - [x] Test `check_past_due_assignments()` with scenarios:
    - Assignment 1 day past due, not completed (should notify)
    - Assignment 1 day past due, completed (should not notify)
    - Assignment 2+ days past due (should not re-notify)

- [x] **Task 7: Backend Integration Tests** (AC: 14)
  - [x] Create `backend/app/tests/test_api/test_assignment_notifications.py`
  - [x] Test notification created when assignment is created
  - [x] Test notification created when student submits assignment
  - [x] Test scheduled task endpoint triggers deadline checks
  - [x] Verify correct notification types, titles, messages, and links

### Frontend Tasks (Minimal - Notifications already display from Story 6.1)

- [x] **Task 8: Verify Notification Links Work** (AC: 2, 5, 7)
  - [x] Verify clicking notification navigates to correct assignment page
  - [x] Student `/student/assignments/{id}` route exists and works
  - [x] Teacher `/teacher/assignments/{id}` route exists and works
  - [x] No additional route handling needed (routes already exist)

---

## Dev Notes

### Previous Story Insights (Story 6.1)
[Source: docs/stories/6.1.notification-system-foundation.md#Dev Agent Record]

- NotificationService is in `backend/app/services/notification_service.py`
- Use `create_notification(db, user_id, notification_type, title, message, link)` function
- NotificationType enum already includes: `assignment_created`, `deadline_approaching`, `student_completed`, `past_due`
- Notification model and API endpoints are complete and tested
- Frontend notification display (bell, dropdown, page) is complete - no frontend work needed for display

### Key Files to Modify

**Backend:**
- `backend/app/api/routes/assignments.py` - Add notification triggers to `create_assignment` and `submit_assignment`
- `backend/app/services/deadline_reminder_service.py` - NEW FILE for scheduled deadline checks
- `backend/app/api/routes/scheduled_tasks.py` - NEW FILE for scheduler endpoints

### Data Models
[Source: docs/architecture/2-database-schema-design.md#2.2.4]

**Assignment Model Fields Needed:**
```python
class Assignment:
    id: UUID
    teacher_id: UUID  # FK to teachers table
    name: str
    due_date: datetime | None
    # ... other fields
```

**AssignmentStudent Junction:**
```python
class AssignmentStudent:
    assignment_id: UUID
    student_id: UUID
    status: AssignmentStatus  # 'not_started', 'in_progress', 'completed'
    completed_at: datetime | None
    score: int | None
```

### Notification Types Already Defined
[Source: backend/app/models.py]

```python
class NotificationType(str, Enum):
    assignment_created = "assignment_created"
    deadline_approaching = "deadline_approaching"
    student_completed = "student_completed"
    past_due = "past_due"
    # ... others
```

### API Endpoints
[Source: docs/architecture/3-api-architecture.md#3.4.5]

- `POST /api/v1/assignments` - Trigger `assignment_created` notifications here
- `POST /api/v1/assignments/{id}/submit` - Trigger `student_completed` notification here

### Scheduled Task Design

For deadline reminders, use a simple endpoint approach:
1. Create `POST /api/v1/admin/tasks/deadline-reminders` endpoint
2. External scheduler (cron, AWS Lambda, GitHub Action) calls this at 8 AM
3. Endpoint checks deadlines and sends notifications
4. Returns JSON summary: `{"notifications_sent": 15, "students_notified": 12}`

This approach is simpler than integrating Celery and matches the existing architecture.
[Source: docs/architecture/tech-stack.md - No Celery in current stack]

### Link Format for Notifications

**For Students:**
- Assignment link: `/student/assignments/{assignment_id}`
- Or per TanStack Router: check existing route structure in `frontend/src/routes`

**For Teachers:**
- Results link: `/teacher/assignments/{assignment_id}/results`

### Spam Prevention Logic (AC: 11)

Track notifications to prevent duplicates:
1. Before sending deadline reminder, check if user already received `deadline_approaching` notification today for ANY assignment
2. If yes, aggregate into single notification listing all upcoming assignments
3. Store last deadline notification date in notification metadata or separate tracking

Simple approach: Query notifications table for `deadline_approaching` type created today for user.

---

## Testing

### Test File Locations
[Source: docs/architecture/source-tree.md#Backend Structure]

- Backend unit tests: `backend/app/tests/test_services/test_deadline_reminder_service.py`
- Backend integration tests: `backend/app/tests/test_api/test_assignment_notifications.py`

### Testing Patterns
[Source: docs/architecture/coding-standards.md#Testing Patterns]

```python
@pytest.mark.asyncio
async def test_assignment_creation_sends_notifications(
    client: AsyncClient,
    teacher_token: str,
    db_session: AsyncSession
):
    """Test that creating an assignment sends notifications to assigned students."""
    # Arrange
    # ... create teacher, students, activity

    # Act
    response = await client.post(
        "/api/v1/assignments",
        json=assignment_data,
        headers={"Authorization": f"Bearer {teacher_token}"}
    )

    # Assert
    assert response.status_code == 201
    # Verify notifications were created for each student
    notifications = await get_notifications_for_user(db_session, student_id)
    assert len(notifications) == 1
    assert notifications[0].type == NotificationType.assignment_created
```

### Test Scenarios Required

**Assignment Creation Notifications:**
- Single student assignment → 1 notification
- Multi-student assignment (5 students) → 5 notifications
- Class assignment (entire class) → N notifications (one per student in class)

**Student Completion Notifications:**
- Student submits → Teacher receives notification with correct score
- Multi-activity assignment completion → One notification per assignment (not per activity)

**Deadline Reminders:**
- Assignment due in 12 hours → Notification sent
- Assignment due in 25 hours → No notification
- Student already completed → No notification
- Same student, multiple due → Single aggregated notification

**Past Due Notifications:**
- 1 day past, incomplete → Notification sent
- 1 day past, completed → No notification
- 2+ days past → No duplicate notification

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-02 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- No significant debug issues. Key fixes included:
  - Timezone-aware datetime handling in deadline_reminder_service.py
  - Corrected route paths from `/assignments/{id}` to `/student/assignments/{id}`
  - Fixed `require_role()` usage (already returns Depends, no wrapping needed)

### Completion Notes

All 8 tasks completed successfully:
- Task 1 was already implemented in create_assignment during Epic 4 development
- Task 2: Added teacher notification on student completion in submit_assignment
- Tasks 3-4: Created comprehensive deadline_reminder_service.py with spam prevention
- Task 5: Created scheduled_tasks.py with admin-only endpoints for external scheduler
- Tasks 6-7: Created 12 unit tests + 9 integration tests (all passing)
- Task 8: Verified notification links work with existing frontend routes

Test Results:
- Unit tests: 12/12 passed
- Integration tests: 9/9 passed
- Regression tests: 41/41 passed (notifications + assignments)

### File List

**New Files:**
- `backend/app/services/deadline_reminder_service.py` - Deadline reminder and past-due check service
- `backend/app/api/routes/scheduled_tasks.py` - Admin endpoints for scheduled tasks
- `backend/app/tests/test_services/test_deadline_reminder_service.py` - Unit tests (12 tests)
- `backend/app/tests/test_api/test_assignment_notifications.py` - Integration tests (9 tests)

**Modified Files:**
- `backend/app/api/routes/assignments.py` - Added teacher notification on student completion
- `backend/app/api/main.py` - Added scheduled_tasks router
- `backend/app/core/config.py` - Added SCHEDULER_API_KEY setting

---

## QA Results

### Review Date: 2025-12-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Implementation follows established patterns with comprehensive test coverage. The deadline reminder service demonstrates good async patterns, proper error handling, and thorough documentation. Code is well-typed with dataclasses for result objects.

**Highlights:**
- Timezone-aware datetime handling for database edge cases
- Spam prevention with daily notification limits and aggregation
- Graceful error handling that doesn't fail main operations
- Clear separation between service logic and API endpoints

### Refactoring Performed

No refactoring required - code quality meets standards.

### Compliance Check

- Coding Standards: ✓ Type hints, docstrings, snake_case naming, async patterns
- Project Structure: ✓ Files in correct locations per source-tree.md
- Testing Strategy: ✓ Unit tests for service, integration tests for API
- All ACs Met: ✓ 13/14 addressed (AC 12 deferred to Story 6.8 per spec)

### Requirements Traceability

| AC | Status | Validation |
|----|--------|------------|
| 1 | ✓ | `test_create_assignment_sends_notification_to_student` |
| 2 | ✓ | `test_create_assignment_notification_includes_due_date` |
| 3 | ✓ | `test_approaching_deadline_12_hours_notifies` |
| 4 | ✓ | `test_approaching_deadline_12_hours_notifies` |
| 5 | ✓ | Notification format verified in deadline service |
| 6 | ✓ | `test_submit_assignment_sends_notification_to_teacher` |
| 7 | ✓ | Title/message/link verified in integration test |
| 8 | ✓ | `test_past_due_1_day_notifies` |
| 9 | ✓ | All triggers use `notification_service.create_notification` |
| 10 | ✓ | `test_scheduled_task_endpoint_success` |
| 11 | ✓ | `test_approaching_deadline_already_notified_today_no_duplicate` |
| 12 | N/A | Deferred to Story 6.8 (notification preferences) |
| 13 | ✓ | 12 unit tests in `test_deadline_reminder_service.py` |
| 14 | ✓ | 9 integration tests in `test_assignment_notifications.py` |

### Improvements Checklist

- [x] Timezone handling for naive datetimes (already implemented)
- [x] Spam prevention with aggregation (already implemented)
- [x] Comprehensive test coverage (21 tests passing)
- [ ] Remove or integrate unused `verify_scheduler_access()` function (future cleanup)
- [ ] Update AC 7 text to match actual link format (documentation fix)

### Security Review

**Status: PASS**
- Admin-only scheduled task endpoints properly protected with `require_role(UserRole.admin)`
- No SQL injection vulnerabilities (ORM queries with parameterized values)
- Error messages don't leak sensitive information
- Notification links use safe path construction

### Performance Considerations

**Status: PASS**
- Efficient batch processing: aggregates multiple assignments per student
- Queries use indexed fields (`user_id`, `created_at`, `type`)
- N+1 query pattern in student lookup could be optimized with joins in future
- Window-based queries (24h approaching, 24-48h past-due) are efficient

### Files Modified During Review

None - no refactoring required.

### Gate Status

**Gate: PASS** → `docs/qa/gates/6.2-assignment-deadline-notifications.yml`

**Quality Score: 90/100**
- No critical or high severity issues
- 2 low severity findings (unused code, documentation mismatch)

### Recommended Status

**✓ Ready for Done**

All acceptance criteria are met or appropriately deferred. Test coverage is comprehensive (21 tests). Implementation follows project standards and patterns. Minor issues identified are non-blocking and can be addressed in future maintenance.
