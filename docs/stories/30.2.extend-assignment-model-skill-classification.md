# Story 30.2: Extend Assignment Model for Skill Classification

**Status:** Ready for Review
**Epic:** Epic 30 - Skill-Based AI Assignment Generation & Reporting
**Story Points:** 3
**Priority:** High (Foundation — blocks generation and reporting stories)
**Dependencies:** Story 30.1 (SkillCategory and ActivityFormat tables must exist)

---

## User Story

As a **teacher**,
I want **AI-generated assignments to be tagged with their primary skill and activity format**,
So that **assignments are classified for filtering, analytics, and  skill-based reporting**.

---

## Acceptance Criteria

1. [ ] `primary_skill_id` (FK → SkillCategory, nullable) added to Assignment model
2. [ ] `activity_format_id` (FK → ActivityFormat, nullable) added to Assignment model
3. [ ] `is_mix_mode` boolean field (default false) added to Assignment model
4. [ ] Existing assignments continue to function without modification (new fields are nullable)
5. [ ] `AssignmentCreate` schema accepts `skill_id` and `format_id` for AI assignments
6. [ ] Per-question skill tagging JSON schema defined for Mix mode content in `activity_content`
7. [ ] Migration is backward compatible (ALTER TABLE ADD COLUMN, nullable)

---

## Tasks & Subtasks

- [x] **Task 1: Extend Assignment Model** (AC: 1, 2, 3, 4)
  - [x] Add to Assignment model in `backend/app/models.py`:
    - `primary_skill_id: uuid.UUID | None = Field(default=None, foreign_key="skill_categories.id", index=True)`
    - `activity_format_id: uuid.UUID | None = Field(default=None, foreign_key="activity_formats.id", index=True)`
    - `is_mix_mode: bool = Field(default=False)`
  - [x] Add relationships:
    - `primary_skill: Optional["SkillCategory"] = Relationship()`
    - `activity_format: Optional["ActivityFormat"] = Relationship()`
  - [x] Verify existing fields (`activity_type`, `activity_content`, `generation_source`) remain unchanged

- [x] **Task 2: Create Alembic Migration** (AC: 7)
  - [x] Generate migration: `alembic revision --autogenerate -m "add_skill_fields_to_assignments"`
  - [x] Verify migration only adds nullable columns (no existing column modifications)
  - [x] Test migration forward and rollback

- [x] **Task 3: Update Assignment Schemas** (AC: 5)
  - [x] Update `AssignmentCreate` in `backend/app/schemas/assignment.py`:
    - Add `skill_id: uuid.UUID | None = None`
    - Add `format_id: uuid.UUID | None = None`
    - Add `is_mix_mode: bool = False`
    - Add validator: when `source_type == "ai_content"`, `skill_id` should be provided (warning, not error — for backward compat)
  - [x] Update `AssignmentResponse` to include:
    - `primary_skill: SkillCategoryPublic | None`
    - `activity_format: ActivityFormatPublic | None`
    - `is_mix_mode: bool`
  - [x] Update `AssignmentListItem` to include:
    - `skill_name: str | None`
    - `skill_slug: str | None`
    - `skill_color: str | None`
    - `skill_icon: str | None`
    - `format_name: str | None`

- [x] **Task 4: Define Mix Mode Per-Question Skill Schema** (AC: 6)
  - [x] Document and validate the JSON structure for `activity_content` in Mix mode:
    ```json
    {
      "questions": [
        {
          "question_id": "uuid",
          "skill_id": "uuid",
          "skill_slug": "listening",
          "format_slug": "multiple_choice",
          "question_data": { ... }
        }
      ],
      "skill_distribution": {
        "listening": 2,
        "grammar": 3,
        "vocabulary": 2
      }
    }
    ```
  - [x] Create Pydantic model for validation: `MixModeContent` in `backend/app/schemas/skill.py`

- [x] **Task 5: Update Assignment List Query** (AC: 4)
  - [x] Update `list_assignments` route to eagerly load `primary_skill` and `activity_format` relationships
  - [x] Ensure no N+1 query issues (use `selectinload` or `joinedload`)
  - [x] Verify existing assignment list still works with null skill fields

- [x] **Task 6: Unit Tests** (AC: 1-7)
  - [x] Test creating assignment with skill_id and format_id
  - [x] Test creating assignment WITHOUT skill_id (backward compat — should succeed)
  - [x] Test assignment list includes skill info for tagged assignments
  - [x] Test assignment list works for assignments with null skill (old assignments)
  - [x] Test Mix mode content validation schema

---

## Dev Notes

### Relevant Source Tree
- Assignment model: `backend/app/models.py` lines ~928-968 [Source: source-tree.md]
- Assignment schemas: `backend/app/schemas/assignment.py` [Source: source-tree.md]
- Assignment routes: `backend/app/api/routes/assignments.py` [Source: source-tree.md]
- Skill schemas (from 30.1): `backend/app/schemas/skill.py`

### Current Assignment Model Fields (Context)
The Assignment model already has these AI-related fields:
- `activity_type: ActivityType | None` — existing AI activity type enum
- `activity_content: dict | None` — JSON storage for AI-generated content
- `generation_source: str | None` — "book" | "material" | "manual"
- `source_id: str | None` — book_id or material_id

The new `primary_skill_id` and `activity_format_id` complement (not replace) these fields. Old assignments use `activity_type`, new assignments use `primary_skill_id` + `activity_format_id`.

### Query Pattern for Eager Loading
Use SQLAlchemy `selectinload` to avoid N+1:
```python
query = select(Assignment).options(
    selectinload(Assignment.primary_skill),
    selectinload(Assignment.activity_format),
)
```
[Source: coding-standards.md#database-patterns]

### Testing
- Test file: `backend/app/tests/test_assignments.py` (extend existing) [Source: 10-testing-strategy.md]
- Use existing teacher_token fixtures [Source: 10-testing-strategy.md#backend-testing]
- Test backward compatibility explicitly — create assignment without new fields

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `backend/app/models.py` | Modified | Added `primary_skill_id`, `activity_format_id`, `is_mix_mode` fields and relationships to Assignment model |
| `backend/app/schemas/assignment.py` | Modified | Updated AssignmentCreate, AssignmentResponse, AssignmentListItem with skill fields; added SkillInfoCompact, FormatInfoCompact |
| `backend/app/schemas/skill.py` | Modified | Added MixModeQuestion, MixModeSkillDistribution, MixModeContent schemas |
| `backend/app/api/routes/assignments.py` | Modified | Added selectinload for primary_skill/activity_format; populated skill fields in list response |
| `backend/app/alembic/versions/b2c3d4e5f6a7_add_skill_fields_to_assignments.py` | Created | Migration: adds 3 columns + FK constraints + indexes to assignments table |
| `backend/app/tests/test_assignment_skills.py` | Created | 16 unit tests covering model, schema, and MixModeContent validation |

### Debug Log References
- Pre-existing test failures in `test_assignment_schemas.py` (8 tests) — use `uuid.uuid4()` for `book_id` which is now `int` (changed in Epic 24). NOT caused by this story.

### Completion Notes
- All 16 new tests pass (model, schema, mix-mode validation)
- All 12 Story 30.1 tests pass (no regression)
- Migration tested: forward, rollback, and re-apply all succeed on PostgreSQL
- Columns verified: `primary_skill_id` (uuid, nullable), `activity_format_id` (uuid, nullable), `is_mix_mode` (boolean, NOT NULL, default false)
- Backward compatible: existing assignments with null skill fields continue to work

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2026-02-13 | 1.1 | Implementation complete — all tasks done, tests passing | Dev Agent (James) |
