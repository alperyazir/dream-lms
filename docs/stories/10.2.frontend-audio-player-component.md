# Story 10.2: Frontend Audio Player Component

**Status:** Ready for Review
**Epic:** Epic 10 - Audio & Video Media Integration
**Story Points:** 3
**Priority:** High
**Dependencies:** Story 10.1 (Backend Streaming Media Proxy)

---

## User Story

As a **student**,
I want **to play audio instructions while completing an activity**,
So that **I can hear pronunciation, listen to passages, or follow along with audio content**.

---

## Acceptance Criteria

1. [ ] `<AudioPlayer>` component created with:
   - Play/Pause toggle button
   - Progress bar (clickable for seeking)
   - Current time / Total duration display
   - Loading state indicator
2. [ ] Audio icon (speaker) displayed in activity header when `audio_extra` is present
3. [ ] Click audio icon to show/play audio player
4. [ ] Audio player can be collapsed/minimized
5. [ ] Seeking works (user can click progress bar to jump to position)
6. [ ] Unlimited replays allowed
7. [ ] Audio does NOT auto-play (user must click to start)
8. [ ] Works on desktop and tablet (responsive design)
9. [ ] Graceful error handling if audio fails to load
10. [ ] Unit tests for player controls and state management

---

## UI Design

### Activity Header with Audio Button

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fill in the Blanks                          [ğŸ”Š Listen]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚                    Activity Content                            â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Expanded Audio Player

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fill in the Blanks                          [ğŸ”Š Listen]  [Ã—]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  â–¶ï¸   â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â—â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬   1:23 / 2:45      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚                    Activity Content                            â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### States

| State | Visual |
|-------|--------|
| No audio | No audio icon shown |
| Audio available | ğŸ”Š "Listen" button |
| Loading | Spinner in player |
| Playing | â¸ï¸ Pause button, animated progress |
| Paused | â–¶ï¸ Play button |
| Error | Error message with retry |

---

## Tasks & Subtasks

### Task 1: Create AudioPlayer Component

- [x] Create component with HTML5 `<audio>` element (hidden)
- [x] Implement play/pause toggle
- [x] Implement progress bar with seek functionality
- [x] Display current time / duration
- [x] Add loading state
- [x] Add error handling

**Status:** Completed
**Estimated effort:** 2 hours

**File:** `frontend/src/components/ActivityPlayers/AudioPlayer.tsx`

**Subtasks:**
1. Create component with HTML5 `<audio>` element (hidden)
2. Implement play/pause toggle
3. Implement progress bar with seek functionality
4. Display current time / duration
5. Add loading state
6. Add error handling

**Implementation:**

```typescript
// frontend/src/components/ActivityPlayers/AudioPlayer.tsx

import { useRef, useState, useEffect, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { Slider } from '@/components/ui/slider';
import { Play, Pause, Volume2, Loader2, AlertCircle, X } from 'lucide-react';
import { cn } from '@/lib/utils';

interface AudioPlayerProps {
  /** URL to the audio file */
  src: string;
  /** Whether the player is expanded/visible */
  isExpanded?: boolean;
  /** Callback when close button is clicked */
  onClose?: () => void;
  /** Additional CSS classes */
  className?: string;
}

export function AudioPlayer({
  src,
  isExpanded = true,
  onClose,
  className
}: AudioPlayerProps) {
  const audioRef = useRef<HTMLAudioElement>(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [currentTime, setCurrentTime] = useState(0);
  const [duration, setDuration] = useState(0);

  // Format time as MM:SS
  const formatTime = (seconds: number): string => {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  // Handle play/pause
  const togglePlay = useCallback(() => {
    const audio = audioRef.current;
    if (!audio) return;

    if (isPlaying) {
      audio.pause();
    } else {
      audio.play().catch((err) => {
        setError('Failed to play audio');
        console.error('Audio play error:', err);
      });
    }
  }, [isPlaying]);

  // Handle seek
  const handleSeek = useCallback((value: number[]) => {
    const audio = audioRef.current;
    if (!audio || !duration) return;

    const newTime = (value[0] / 100) * duration;
    audio.currentTime = newTime;
    setCurrentTime(newTime);
  }, [duration]);

  // Audio event handlers
  useEffect(() => {
    const audio = audioRef.current;
    if (!audio) return;

    const handleLoadedMetadata = () => {
      setDuration(audio.duration);
      setIsLoading(false);
    };

    const handleTimeUpdate = () => {
      setCurrentTime(audio.currentTime);
    };

    const handlePlay = () => setIsPlaying(true);
    const handlePause = () => setIsPlaying(false);
    const handleEnded = () => {
      setIsPlaying(false);
      setCurrentTime(0);
    };

    const handleError = () => {
      setError('Failed to load audio');
      setIsLoading(false);
    };

    const handleCanPlay = () => {
      setIsLoading(false);
      setError(null);
    };

    audio.addEventListener('loadedmetadata', handleLoadedMetadata);
    audio.addEventListener('timeupdate', handleTimeUpdate);
    audio.addEventListener('play', handlePlay);
    audio.addEventListener('pause', handlePause);
    audio.addEventListener('ended', handleEnded);
    audio.addEventListener('error', handleError);
    audio.addEventListener('canplay', handleCanPlay);

    return () => {
      audio.removeEventListener('loadedmetadata', handleLoadedMetadata);
      audio.removeEventListener('timeupdate', handleTimeUpdate);
      audio.removeEventListener('play', handlePlay);
      audio.removeEventListener('pause', handlePause);
      audio.removeEventListener('ended', handleEnded);
      audio.removeEventListener('error', handleError);
      audio.removeEventListener('canplay', handleCanPlay);
    };
  }, []);

  // Calculate progress percentage
  const progress = duration > 0 ? (currentTime / duration) * 100 : 0;

  if (!isExpanded) return null;

  return (
    <div
      className={cn(
        'flex items-center gap-3 rounded-lg bg-muted/50 p-3',
        className
      )}
    >
      {/* Hidden audio element */}
      <audio ref={audioRef} src={src} preload="metadata" />

      {/* Play/Pause Button */}
      <Button
        variant="ghost"
        size="icon"
        onClick={togglePlay}
        disabled={isLoading || !!error}
        className="h-10 w-10 shrink-0"
      >
        {isLoading ? (
          <Loader2 className="h-5 w-5 animate-spin" />
        ) : error ? (
          <AlertCircle className="h-5 w-5 text-destructive" />
        ) : isPlaying ? (
          <Pause className="h-5 w-5" />
        ) : (
          <Play className="h-5 w-5" />
        )}
      </Button>

      {/* Progress Bar */}
      <div className="flex flex-1 items-center gap-3">
        <Slider
          value={[progress]}
          max={100}
          step={0.1}
          onValueChange={handleSeek}
          disabled={isLoading || !!error}
          className="flex-1"
        />
      </div>

      {/* Time Display */}
      <span className="min-w-[80px] text-sm text-muted-foreground">
        {error ? (
          <span className="text-destructive">Error</span>
        ) : (
          `${formatTime(currentTime)} / ${formatTime(duration)}`
        )}
      </span>

      {/* Close Button */}
      {onClose && (
        <Button
          variant="ghost"
          size="icon"
          onClick={onClose}
          className="h-8 w-8 shrink-0"
        >
          <X className="h-4 w-4" />
        </Button>
      )}
    </div>
  );
}
```

---

### Task 2: Create AudioButton Component

- [x] Create AudioButton component

**Status:** Completed
**Estimated effort:** 30 minutes

**File:** `frontend/src/components/ActivityPlayers/AudioButton.tsx`

```typescript
// frontend/src/components/ActivityPlayers/AudioButton.tsx

import { Volume2 } from 'lucide-react';
import { Button } from '@/components/ui/button';

interface AudioButtonProps {
  onClick: () => void;
  isActive?: boolean;
}

export function AudioButton({ onClick, isActive = false }: AudioButtonProps) {
  return (
    <Button
      variant={isActive ? 'secondary' : 'outline'}
      size="sm"
      onClick={onClick}
      className="gap-2"
    >
      <Volume2 className="h-4 w-4" />
      Listen
    </Button>
  );
}
```

---

### Task 3: Create Audio URL Utility

- [x] Create getAudioUrl function
- [x] Create hasAudio type guard
- [x] Create getAudioPath helper

**Status:** Completed
**Estimated effort:** 30 minutes

**File:** `frontend/src/lib/audioUtils.ts`

```typescript
// frontend/src/lib/audioUtils.ts

/**
 * Transform activity config audio path to API URL.
 *
 * Config paths look like: "./books/SwitchtoCLIL/audio/08.mp3"
 * API expects: "/api/v1/books/{bookId}/media/audio/08.mp3"
 *
 * @param bookId - The book UUID
 * @param audioPath - The audio_extra.path from activity config
 * @returns Full API URL for streaming
 */
export function getAudioUrl(bookId: string, audioPath: string): string {
  // Remove leading "./" and "books/{bookName}/" prefix
  // "./books/SwitchtoCLIL/audio/08.mp3" â†’ "audio/08.mp3"
  let cleanPath = audioPath;

  // Remove "./" prefix
  if (cleanPath.startsWith('./')) {
    cleanPath = cleanPath.slice(2);
  }

  // Remove "books/{bookName}/" prefix if present
  const booksMatch = cleanPath.match(/^books\/[^/]+\/(.+)$/);
  if (booksMatch) {
    cleanPath = booksMatch[1];
  }

  return `/api/v1/books/${bookId}/media/${cleanPath}`;
}

/**
 * Check if an activity has audio attached.
 *
 * @param activity - Activity config object
 * @returns True if audio_extra.path exists
 */
export function hasAudio(activity: unknown): activity is { audio_extra: { path: string } } {
  return (
    typeof activity === 'object' &&
    activity !== null &&
    'audio_extra' in activity &&
    typeof (activity as { audio_extra: unknown }).audio_extra === 'object' &&
    (activity as { audio_extra: { path?: unknown } }).audio_extra !== null &&
    typeof (activity as { audio_extra: { path: unknown } }).audio_extra.path === 'string'
  );
}
```

---

### Task 4: Integrate Audio into Activity Header

- [x] Import AudioPlayer and AudioButton
- [x] Detect audio_extra in activity config
- [x] Add state for audio panel visibility
- [x] Render AudioButton in header when audio available
- [x] Render AudioPlayer when expanded
- [x] Pass activityConfig and bookId from ActivityPlayer

**Status:** Completed
**Estimated effort:** 1.5 hours

**Modify:** `frontend/src/components/ActivityPlayers/ActivityPlayerHeader.tsx`

**Subtasks:**
1. Import AudioPlayer and AudioButton
2. Detect `audio_extra` in activity config
3. Add state for audio panel visibility
4. Render AudioButton in header when audio available
5. Render AudioPlayer when expanded

**Changes:**

```typescript
// Add to ActivityPlayerHeader.tsx

import { useState } from 'react';
import { AudioPlayer } from './AudioPlayer';
import { AudioButton } from './AudioButton';
import { getAudioUrl, hasAudio } from '@/lib/audioUtils';

interface ActivityPlayerHeaderProps {
  // ... existing props
  activity: ActivityConfig;
  bookId: string;
}

export function ActivityPlayerHeader({
  activity,
  bookId,
  // ... other props
}: ActivityPlayerHeaderProps) {
  const [showAudio, setShowAudio] = useState(false);

  // Check if activity has audio
  const audioPath = hasAudio(activity) ? activity.audio_extra.path : null;
  const audioUrl = audioPath ? getAudioUrl(bookId, audioPath) : null;

  return (
    <div className="space-y-2">
      {/* Header Row */}
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-semibold">{/* Activity title */}</h2>

        {/* Audio Button - only shown if activity has audio */}
        {audioUrl && (
          <AudioButton
            onClick={() => setShowAudio(!showAudio)}
            isActive={showAudio}
          />
        )}
      </div>

      {/* Audio Player - shown when expanded */}
      {audioUrl && showAudio && (
        <AudioPlayer
          src={audioUrl}
          isExpanded={showAudio}
          onClose={() => setShowAudio(false)}
        />
      )}
    </div>
  );
}
```

---

### Task 5: Update Activity Type Definitions

- [x] Add AudioExtra interface to mockData.ts
- [x] Add audio_extra to all activity type interfaces

**Status:** Completed
**Estimated effort:** 30 minutes

**Modify:** `frontend/src/types/activity.ts` (or wherever types are defined)

```typescript
// Add audio_extra to activity type definitions

interface AudioExtra {
  path: string;
}

interface BaseActivity {
  type: string;
  // ... other common fields
  audio_extra?: AudioExtra;
}
```

---

### Task 6: Write Unit Tests

- [x] AudioPlayer.test.tsx - 12 test cases passing
- [x] audioUtils.test.ts - 21 test cases passing

**Status:** Completed
**Estimated effort:** 1.5 hours

**File:** `frontend/src/components/ActivityPlayers/AudioPlayer.test.tsx`

**Test Cases:**
1. `renders without crashing` - Basic render test
2. `shows loading state initially` - Spinner shown before audio loads
3. `shows play button when paused` - Play icon visible
4. `shows pause button when playing` - Pause icon visible after play
5. `displays correct time format` - MM:SS format
6. `seek updates time position` - Clicking progress bar changes time
7. `handles audio error gracefully` - Shows error state
8. `calls onClose when X clicked` - Close callback triggered
9. `hides when isExpanded is false` - Component not rendered

**File:** `frontend/src/lib/audioUtils.test.ts`

**Test Cases:**
1. `getAudioUrl transforms config path correctly` - Full path transformation
2. `getAudioUrl handles paths without ./ prefix` - Edge case
3. `hasAudio returns true for valid audio_extra` - Type guard works
4. `hasAudio returns false for missing audio_extra` - Type guard works

---

### Task 7: Test in Activity Players

- [x] TypeScript build passes
- [x] All 33 unit tests pass
- [x] Integration ready (ActivityHeader receives activityConfig and bookId)

**Status:** Completed
**Estimated effort:** 1 hour

**Subtasks:**
1. Add test activity with `audio_extra` to test data
2. Verify audio button appears in all 6 activity types
3. Test audio playback and seeking
4. Test on tablet viewport
5. Verify error handling for missing audio files

---

## Dev Notes

### HTML5 Audio Behavior

The `<audio>` element with streaming URL will:
1. Request with `Range: bytes=0-` on load
2. Buffer initial portion for playback
3. Send new Range requests when seeking
4. Handle 206 responses automatically

No special handling needed - browser does the heavy lifting!

### Accessibility

- Play/Pause button has aria-label
- Progress slider is keyboard accessible
- Time announced by screen readers
- Error states are announced

### Mobile Considerations

- Touch-friendly controls (44px minimum tap target)
- Progress bar has adequate height for touch
- Works in both portrait and landscape

---

## Definition of Done

- [ ] AudioPlayer component created and styled
- [ ] AudioButton component created
- [ ] Audio URL utility functions work correctly
- [ ] ActivityPlayerHeader shows audio button when available
- [ ] Audio plays and pauses correctly
- [ ] Seeking works via progress bar
- [ ] Time display updates correctly
- [ ] Error handling shows appropriate message
- [ ] Close button hides player
- [ ] Works on all 6 activity types
- [ ] Responsive on desktop and tablet
- [ ] Unit tests passing
- [ ] No console errors during playback
- [ ] Audio doesn't auto-play

---

## Testing Checklist

### Manual Testing

- [ ] Click "Listen" button â†’ player appears
- [ ] Click Play â†’ audio starts
- [ ] Click Pause â†’ audio stops
- [ ] Click progress bar â†’ audio seeks
- [ ] Drag progress slider â†’ audio seeks
- [ ] Audio ends â†’ returns to beginning
- [ ] Click X â†’ player closes
- [ ] Audio button still visible after close
- [ ] Reopen player â†’ can play again
- [ ] Test on Chrome, Firefox, Safari
- [ ] Test on iPad/tablet viewport

### Error Scenarios

- [ ] Invalid audio URL â†’ shows error state
- [ ] Network error â†’ shows error state
- [ ] Activity without audio â†’ no button shown

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### File List

**New Files:**
- `frontend/src/components/ActivityPlayers/AudioPlayer.tsx` - Audio player component with play/pause, seek, time display
- `frontend/src/components/ActivityPlayers/AudioButton.tsx` - Button to toggle audio player visibility
- `frontend/src/components/ActivityPlayers/AudioPlayer.test.tsx` - Unit tests for AudioPlayer (12 tests)
- `frontend/src/lib/audioUtils.ts` - Audio URL utilities (getAudioUrl, hasAudio, getAudioPath)
- `frontend/src/lib/audioUtils.test.ts` - Unit tests for audioUtils (21 tests)
- `frontend/src/components/ui/slider.tsx` - Shadcn slider component (installed via npx shadcn)

**Modified Files:**
- `frontend/src/components/ActivityPlayers/ActivityHeader.tsx` - Added audio button and player integration
- `frontend/src/components/ActivityPlayers/ActivityPlayer.tsx` - Pass activityConfig and bookId to ActivityHeader
- `frontend/src/lib/mockData.ts` - Added AudioExtra interface and audio_extra to all activity types

### Change Log
- Created AudioPlayer component with HTML5 audio element, play/pause, progress slider, time display, loading state, error handling
- Created AudioButton component for toggling audio player visibility
- Created audioUtils with getAudioUrl path transformation and hasAudio type guard
- Integrated audio into ActivityHeader with conditional rendering based on audio_extra presence
- Updated ActivityPlayer to pass activityConfig and bookId to ActivityHeader
- Added AudioExtra interface and audio_extra optional property to all activity type definitions
- Installed shadcn slider component for progress bar
- Created comprehensive unit tests (33 total passing)

### Completion Notes
- All 7 tasks completed
- 33 unit tests passing (12 AudioPlayer + 21 audioUtils)
- TypeScript build passes without errors
- Frontend build succeeds
- Audio player uses Radix UI Slider for accessible progress control
- Implemented retry functionality on error state
- Audio cleanup on unmount prevents memory leaks
