# Story 25.4: Frontend Admin Publisher Account UI

## Status: Ready for Review

## Story

As an admin, I need a UI to create and manage publisher user accounts so that I can onboard publishers to the LMS system.

## Acceptance Criteria

- [ ] Admin publishers page shows list of publisher user accounts
- [ ] "Add Publisher Account" button opens creation dialog
- [ ] Dialog includes DCS publisher dropdown (fetched from API)
- [ ] Dialog includes user fields (full name, username, email)
- [ ] Multiple accounts for same DCS publisher allowed
- [ ] Can edit existing publisher accounts
- [ ] Can delete publisher accounts
- [ ] Success/error toasts for all operations
- [ ] Loading states during API calls

## Technical Design

### Update Admin Publishers Page

```typescript
// frontend/src/routes/_layout/admin/publishers.tsx

function AdminPublishers() {
  // Fetch publisher USER accounts (not DCS publishers)
  const { data: accounts, isLoading } = useQuery({
    queryKey: ["publisherAccounts"],
    queryFn: () => AdminService.listPublisherAccounts(),
  })

  // Fetch DCS publishers for dropdown
  const { data: dcsPublishers } = useQuery({
    queryKey: ["dcsPublishers"],
    queryFn: () => AdminService.listPublishers(),
  })

  // Create account mutation
  const createMutation = useMutation({
    mutationFn: (data: PublisherAccountCreate) =>
      AdminService.createPublisherAccount({ requestBody: data }),
    onSuccess: (response) => {
      queryClient.invalidateQueries({ queryKey: ["publisherAccounts"] })
      if (response.password_emailed) {
        showSuccessToast("Account created. Password sent to email.")
      } else if (response.temporary_password) {
        // Show password dialog
        setPasswordResult(response)
      }
    },
  })

  return (
    <div>
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1>Publisher Accounts</h1>
          <p>Manage publisher user accounts linked to DCS</p>
        </div>
        <Button onClick={() => setIsAddDialogOpen(true)}>
          <Plus className="w-4 h-4 mr-2" />
          Add Publisher Account
        </Button>
      </div>

      {/* Accounts Table */}
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>User</TableHead>
            <TableHead>Email</TableHead>
            <TableHead>DCS Publisher</TableHead>
            <TableHead>Created</TableHead>
            <TableHead>Actions</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {accounts?.map((account) => (
            <TableRow key={account.id}>
              <TableCell>{account.full_name}</TableCell>
              <TableCell>{account.email}</TableCell>
              <TableCell>
                <div className="flex items-center gap-2">
                  <PublisherLogo publisherId={account.dcs_publisher_id} size="sm" />
                  {account.dcs_publisher_name}
                </div>
              </TableCell>
              <TableCell>{formatDate(account.created_at)}</TableCell>
              <TableCell>
                <Button variant="ghost" onClick={() => handleEdit(account)}>
                  <Edit className="w-4 h-4" />
                </Button>
                <Button variant="ghost" onClick={() => handleDelete(account)}>
                  <Trash2 className="w-4 h-4" />
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>

      {/* Add Account Dialog */}
      <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Add Publisher Account</DialogTitle>
            <DialogDescription>
              Create a user account linked to a DCS publisher
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4">
            {/* DCS Publisher Selector */}
            <div className="space-y-2">
              <Label>DCS Publisher *</Label>
              <Select
                value={newAccount.dcs_publisher_id?.toString()}
                onValueChange={(v) => setNewAccount({...newAccount, dcs_publisher_id: parseInt(v)})}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Select publisher..." />
                </SelectTrigger>
                <SelectContent>
                  {dcsPublishers?.map((pub) => (
                    <SelectItem key={pub.id} value={pub.id.toString()}>
                      {pub.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* User Fields */}
            <div className="space-y-2">
              <Label>Full Name *</Label>
              <Input
                value={newAccount.full_name}
                onChange={(e) => setNewAccount({...newAccount, full_name: e.target.value})}
              />
            </div>

            <div className="space-y-2">
              <Label>Username *</Label>
              <Input
                value={newAccount.username}
                onChange={(e) => setNewAccount({...newAccount, username: e.target.value})}
              />
            </div>

            <div className="space-y-2">
              <Label>Email *</Label>
              <Input
                type="email"
                value={newAccount.email}
                onChange={(e) => setNewAccount({...newAccount, email: e.target.value})}
              />
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setIsAddDialogOpen(false)}>
              Cancel
            </Button>
            <Button onClick={handleCreate} disabled={createMutation.isPending}>
              {createMutation.isPending ? "Creating..." : "Create Account"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  )
}
```

### API Service Updates

```typescript
// frontend/src/client/types (generated or manual)

interface PublisherAccountCreate {
  dcs_publisher_id: number
  username: string
  email: string
  full_name: string
}

interface PublisherAccountPublic {
  id: string
  username: string
  email: string | null
  full_name: string | null
  dcs_publisher_id: number | null
  dcs_publisher_name: string | null
  is_active: boolean
  created_at: string
}
```

## Dev Notes

- This replaces the old "Add Publisher" flow that created DCS publishers
- Now creates LMS user accounts linked TO existing DCS publishers
- DCS publisher dropdown populated from existing `listPublishers()` call
- Table shows both user info AND linked DCS publisher info
- Reuse existing password result dialog from current implementation

## Testing Requirements

- [ ] Publishers page loads without errors
- [ ] DCS publisher dropdown populates
- [ ] Can create account with all fields
- [ ] Validation shows for missing fields
- [ ] Success toast on account creation
- [ ] Password dialog shows when email fails
- [ ] Account appears in list after creation
- [ ] Can edit account DCS publisher link
- [ ] Can delete account with confirmation
- [ ] Loading states work correctly

## Tasks

- [ ] Update admin publishers page layout
- [ ] Create DCS publisher dropdown component
- [ ] Create account creation dialog
- [ ] Add account list with DCS enrichment
- [ ] Add edit dialog
- [ ] Add delete confirmation
- [ ] Add password result dialog
- [ ] Update API types (or regenerate client)
- [ ] Write component tests

## File List

| File | Action |
|------|--------|
| `frontend/src/routes/_layout/admin/publishers.tsx` | Modified (new UI) |
| `frontend/src/client/types.gen.ts` | Modified (regenerated with new types) |
| `frontend/src/client/sdk.gen.ts` | Modified (regenerated with new endpoints) |
| `frontend/src/client/schemas.gen.ts` | Modified (regenerated) |
| `frontend/src/components/ui/publisher-logo.tsx` | Modified (accept number publisherId) |
| `frontend/src/routes/_layout/admin/__tests__/publishers.test.tsx` | Created (unit tests) |
| `frontend/openapi.json` | Modified (updated from backend) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Tasks
- [x] Update publishers page
- [x] Add DCS dropdown
- [x] Add create dialog
- [x] Add edit/delete
- [x] Update types
- [x] Write tests

### Debug Log
- Regenerated frontend API client from OpenAPI spec to include new publisher-account endpoints
- Updated PublisherLogo component to accept `string | number` for publisherId (DCS IDs are now numbers)

### Completion Notes
- Completely rewrote admin publishers page to manage publisher USER accounts linked to DCS publishers
- Page now fetches `listPublisherAccounts()` for the table and `listPublishers()` for the DCS dropdown
- Implemented full CRUD: create, edit, delete publisher accounts
- Create dialog includes DCS publisher dropdown with all required fields (full name, username, email)
- Password result dialog handles both email delivery and temporary password display with copy functionality
- Added loading states, error handling, and success toasts for all operations
- Created comprehensive test suite with 16 unit tests covering API interactions, data handling, form validation, and password handling
- Fixed type issue in PublisherLogo component to accept number IDs from DCS

### Change Log
| Date | Change |
|------|--------|
| 2025-12-22 | Regenerated frontend API client with publisher-account endpoints |
| 2025-12-22 | Rewrote admin/publishers.tsx with new account management UI |
| 2025-12-22 | Updated PublisherLogo to accept string or number publisherId |
| 2025-12-22 | Added publishers.test.tsx with 16 unit tests |
