# Story 11.5: Frontend - First Login Password Change Flow

**Status:** Ready for Review
**Epic:** Epic 11 - Secure Password Management & Email Notifications
**Story Points:** 5
**Priority:** High
**Dependencies:** Story 11.3 (Backend password change endpoint)

---

## User Story

As a **new user logging in for the first time**,
I want **to be required to change my temporary password**,
So that **only I know my password and my account is secure**.

---

## Background & Context

### Current State

Users log in with their temporary password and go directly to their dashboard. There's no enforcement of password change.

### Target State

- After login, check `must_change_password` flag from response
- If `true`, redirect to password change page/modal
- User cannot navigate away until password is changed
- After successful change, proceed to normal dashboard

---

## Acceptance Criteria

### Functional Requirements

1. [ ] After login, check `must_change_password` from response
2. [ ] If `true`, show password change screen (not dashboard)
3. [ ] Password change form with: Current password, New password, Confirm password
4. [ ] Validation: passwords match, meets strength requirements
5. [ ] On success, redirect to appropriate role dashboard
6. [ ] User cannot close/skip the password change requirement
7. [ ] Success toast after password change

### Integration Requirements

8. [ ] Uses new `/users/me/change-initial-password` endpoint
9. [ ] Works with existing auth context
10. [ ] Stores `must_change_password` in auth state

### Quality Requirements

11. [ ] Accessible (keyboard navigation, screen reader friendly)
12. [ ] Mobile responsive
13. [ ] Clear error messages for validation failures

---

## Technical Design

### Approach: Full-Page Password Change Route

Create a dedicated route `/change-password` that users are redirected to after login if `must_change_password` is true.

### Auth Context Updates

```tsx
// frontend/src/context/AuthContext.tsx (or hooks/useAuth.ts)

interface AuthState {
  user: UserPublic | null
  token: string | null
  isAuthenticated: boolean
  mustChangePassword: boolean  // NEW
}

// After login
const login = async (credentials: LoginCredentials) => {
  const response = await LoginService.loginAccessToken({
    formData: {
      username: credentials.username,
      password: credentials.password,
    },
  })

  setAuthState({
    token: response.access_token,
    isAuthenticated: true,
    mustChangePassword: response.must_change_password,  // NEW
    user: null, // Will be fetched
  })

  // Fetch user details
  OpenAPI.TOKEN = response.access_token
  const user = await UsersService.readUserMe()
  setAuthState(prev => ({ ...prev, user }))

  // Redirect based on must_change_password
  if (response.must_change_password) {
    navigate({ to: '/change-password' })
  } else {
    navigateToRoleDashboard(user.role)
  }
}
```

### New Change Password Route

```tsx
// frontend/src/routes/change-password.tsx

import { createFileRoute, redirect, useNavigate } from "@tanstack/react-router"
import { useMutation } from "@tanstack/react-query"
import { useState } from "react"
import { useForm } from "react-hook-form"
import { z } from "zod"
import { zodResolver } from "@hookform/resolvers/zod"
import { Eye, EyeOff, Lock, ShieldCheck } from "lucide-react"

import { UsersService } from "@/client"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import useCustomToast from "@/hooks/useCustomToast"
import { useAuth } from "@/hooks/useAuth"

// Validation schema
const changePasswordSchema = z.object({
  currentPassword: z.string().min(1, "Current password is required"),
  newPassword: z
    .string()
    .min(8, "Password must be at least 8 characters")
    .max(40, "Password must be less than 40 characters")
    .regex(/[A-Z]/, "Password must contain at least one uppercase letter")
    .regex(/[a-z]/, "Password must contain at least one lowercase letter")
    .regex(/[0-9]/, "Password must contain at least one number"),
  confirmPassword: z.string().min(1, "Please confirm your password"),
}).refine((data) => data.newPassword === data.confirmPassword, {
  message: "Passwords don't match",
  path: ["confirmPassword"],
})

type ChangePasswordForm = z.infer<typeof changePasswordSchema>

export const Route = createFileRoute("/change-password")({
  beforeLoad: ({ context }) => {
    // Redirect if not authenticated or doesn't need password change
    if (!context.auth.isAuthenticated) {
      throw redirect({ to: "/login" })
    }
    if (!context.auth.mustChangePassword) {
      throw redirect({ to: "/" })
    }
  },
  component: ChangePasswordPage,
})

function ChangePasswordPage() {
  const navigate = useNavigate()
  const { showSuccessToast, showErrorToast } = useCustomToast()
  const { setMustChangePassword, user } = useAuth()
  const [showCurrentPassword, setShowCurrentPassword] = useState(false)
  const [showNewPassword, setShowNewPassword] = useState(false)

  const {
    register,
    handleSubmit,
    formState: { errors },
    setError,
  } = useForm<ChangePasswordForm>({
    resolver: zodResolver(changePasswordSchema),
  })

  const changePasswordMutation = useMutation({
    mutationFn: (data: { currentPassword: string; newPassword: string }) =>
      UsersService.changeInitialPassword({
        requestBody: {
          current_password: data.currentPassword,
          new_password: data.newPassword,
        },
      }),
    onSuccess: () => {
      showSuccessToast("Password changed successfully!")
      setMustChangePassword(false)
      // Navigate to role-appropriate dashboard
      navigateToRoleDashboard()
    },
    onError: (error: any) => {
      if (error.body?.detail === "Current password is incorrect") {
        setError("currentPassword", { message: "Current password is incorrect" })
      } else {
        showErrorToast(error.body?.detail || "Failed to change password")
      }
    },
  })

  const navigateToRoleDashboard = () => {
    const role = user?.role
    switch (role) {
      case "admin":
        navigate({ to: "/admin/dashboard" })
        break
      case "publisher":
        navigate({ to: "/publisher/dashboard" })
        break
      case "teacher":
        navigate({ to: "/teacher/dashboard" })
        break
      case "student":
        navigate({ to: "/student/dashboard" })
        break
      default:
        navigate({ to: "/" })
    }
  }

  const onSubmit = (data: ChangePasswordForm) => {
    changePasswordMutation.mutate({
      currentPassword: data.currentPassword,
      newPassword: data.newPassword,
    })
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-background to-muted p-4">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-primary/10">
            <ShieldCheck className="h-6 w-6 text-primary" />
          </div>
          <CardTitle className="text-2xl">Change Your Password</CardTitle>
          <CardDescription>
            For security, you must change your temporary password before continuing.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
            {/* Current Password */}
            <div className="space-y-2">
              <Label htmlFor="currentPassword">Current Password</Label>
              <div className="relative">
                <Lock className="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
                <Input
                  id="currentPassword"
                  type={showCurrentPassword ? "text" : "password"}
                  className="pl-9 pr-9"
                  placeholder="Enter your temporary password"
                  {...register("currentPassword")}
                />
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  className="absolute right-1 top-1 h-8 w-8"
                  onClick={() => setShowCurrentPassword(!showCurrentPassword)}
                >
                  {showCurrentPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                </Button>
              </div>
              {errors.currentPassword && (
                <p className="text-sm text-destructive">{errors.currentPassword.message}</p>
              )}
            </div>

            {/* New Password */}
            <div className="space-y-2">
              <Label htmlFor="newPassword">New Password</Label>
              <div className="relative">
                <Lock className="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
                <Input
                  id="newPassword"
                  type={showNewPassword ? "text" : "password"}
                  className="pl-9 pr-9"
                  placeholder="Enter your new password"
                  {...register("newPassword")}
                />
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  className="absolute right-1 top-1 h-8 w-8"
                  onClick={() => setShowNewPassword(!showNewPassword)}
                >
                  {showNewPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                </Button>
              </div>
              {errors.newPassword && (
                <p className="text-sm text-destructive">{errors.newPassword.message}</p>
              )}
              <p className="text-xs text-muted-foreground">
                At least 8 characters with uppercase, lowercase, and number
              </p>
            </div>

            {/* Confirm Password */}
            <div className="space-y-2">
              <Label htmlFor="confirmPassword">Confirm New Password</Label>
              <div className="relative">
                <Lock className="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
                <Input
                  id="confirmPassword"
                  type="password"
                  className="pl-9"
                  placeholder="Confirm your new password"
                  {...register("confirmPassword")}
                />
              </div>
              {errors.confirmPassword && (
                <p className="text-sm text-destructive">{errors.confirmPassword.message}</p>
              )}
            </div>

            {/* Submit Button */}
            <Button
              type="submit"
              className="w-full"
              disabled={changePasswordMutation.isPending}
            >
              {changePasswordMutation.isPending ? "Changing Password..." : "Change Password"}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
```

### Protected Route Wrapper Update

```tsx
// frontend/src/components/Common/ProtectedRoute.tsx (if exists)
// Or in route beforeLoad hooks

// Add check to redirect to password change if needed
beforeLoad: ({ context }) => {
  if (!context.auth.isAuthenticated) {
    throw redirect({ to: "/login" })
  }
  if (context.auth.mustChangePassword) {
    throw redirect({ to: "/change-password" })
  }
}
```

### Update Login Handler

```tsx
// frontend/src/routes/login.tsx - onSubmit success handler

const loginMutation = useMutation({
  mutationFn: (data: LoginForm) =>
    LoginService.loginAccessToken({
      formData: {
        username: data.username,
        password: data.password,
      },
    }),
  onSuccess: async (response) => {
    // Store token
    OpenAPI.TOKEN = response.access_token
    localStorage.setItem("access_token", response.access_token)

    // Check if password change required
    if (response.must_change_password) {
      // Store flag for route guard
      setMustChangePassword(true)
      navigate({ to: "/change-password" })
    } else {
      // Normal flow - fetch user and go to dashboard
      const user = await UsersService.readUserMe()
      setUser(user)
      navigateToRoleDashboard(user.role)
    }
  },
})
```

---

## Tasks & Subtasks

### Task 1: Update Auth Context/State

**Estimated effort:** 1 hour

1. [x] Add `mustChangePassword` to auth state
2. [x] Update login function to check and store flag
3. [x] Add `setMustChangePassword` function
4. [x] Persist flag appropriately (session storage recommended)

### Task 2: Create Change Password Route

**Estimated effort:** 2 hours

1. [x] Create `/change-password` route file
2. [x] Implement password change form with validation
3. [x] Integrate with `/users/me/change-initial-password` endpoint
4. [x] Add password visibility toggles
5. [x] Add proper error handling
6. [x] Style to match app design

### Task 3: Add Route Protection

**Estimated effort:** 1 hour

1. [x] Add beforeLoad guard to change-password route
2. [x] Update other route guards to redirect if mustChangePassword
3. [x] Ensure user cannot navigate away without changing password

### Task 4: Update Login Flow

**Estimated effort:** 30 minutes

1. [x] Update login success handler to check flag
2. [x] Redirect to change-password if needed
3. [x] Test login â†’ password change â†’ dashboard flow

### Task 5: Add Password Strength Indicator (Optional Enhancement)

**Estimated effort:** 30 minutes

1. [x] Visual indicator of password strength
2. [x] Real-time feedback as user types

### Task 6: Testing

**Estimated effort:** 1 hour

1. [x] Test new user login â†’ forced password change
2. [x] Test existing user login â†’ normal flow
3. [x] Test validation errors
4. [x] Test cannot navigate away
5. [x] Test success redirect to correct dashboard
6. [x] Test mobile responsiveness

---

## Definition of Done

- [x] Login checks `must_change_password` flag
- [x] Password change page implemented and styled
- [x] User cannot bypass password change requirement
- [x] After change, redirects to appropriate dashboard
- [x] Validation working (length, complexity, match)
- [x] Error messages clear and helpful
- [x] Mobile responsive
- [x] TypeScript builds without errors

---

## UI Mockup

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                    â”‚
â”‚              ğŸ›¡ï¸                                   â”‚
â”‚                                                    â”‚
â”‚        Change Your Password                        â”‚
â”‚                                                    â”‚
â”‚   For security, you must change your temporary     â”‚
â”‚   password before continuing.                      â”‚
â”‚                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ ğŸ”’  Enter your temporary password  ğŸ‘ï¸ â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ ğŸ”’  Enter your new password       ğŸ‘ï¸  â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚   At least 8 characters with uppercase,           â”‚
â”‚   lowercase, and number                           â”‚
â”‚                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ ğŸ”’  Confirm your new password          â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚         Change Password                â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Risk Mitigation

- **Primary Risk:** Breaking login flow for existing users
- **Mitigation:** Existing users have `must_change_password=false`, so they skip this flow
- **Rollback Plan:** Remove route guard check; users can still change password voluntarily

---

## Notes

- This is frontend-only; backend is in Story 11.3
- Consider adding "password strength meter" as future enhancement
- No logout button shown on password change page (user must complete)
- Admin users are excluded from this flow (they don't get temporary passwords)

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

**New Files:**
- `frontend/src/routes/change-password.tsx` - New route for first login password change flow with password strength indicator

**Modified Files:**
- `frontend/src/hooks/useAuth.ts` - Added `mustChangePassword` state, `getMustChangePassword()` and `setMustChangePassword()` functions, updated login to check flag and redirect
- `frontend/src/routes/_layout.tsx` - Added route protection to redirect users who need to change password
- `frontend/src/routeTree.gen.ts` - Auto-generated with new change-password route

### Completion Notes

1. Implemented full first-login password change flow as specified in story
2. Added `mustChangePassword` state to auth hook with session storage persistence
3. Created dedicated `/change-password` route with:
   - Form validation using zod schema (min 8 chars, uppercase, lowercase, number)
   - Password strength indicator with real-time feedback
   - Visual checklist showing password requirements
   - Integration with backend `/users/me/change-initial-password` endpoint
   - Role-based redirect after successful password change
4. Added route protection in `_layout.tsx` to prevent users from bypassing password change
5. Login flow now checks `must_change_password` from token response and redirects accordingly
6. All TypeScript builds pass without errors
7. Backend tests for first login password functionality all pass (12/12)

### Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-12-09 | Initial implementation of Story 11.5 | James (Dev Agent) |
