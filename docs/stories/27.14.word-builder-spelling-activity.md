# Story 27.14: Word Builder (Spelling Activity)

**Status:** Ready for Review

**Epic:** Epic 27 - DreamAI - AI-Powered Content Generation
**Story Points:** 5
**Priority:** Medium
**Dependencies:** Story 27.7 (DCS AI Service Client), Story 27.5 (Edge TTS for audio)

---

## Story

**As a** teacher,
**I want** to create spelling practice activities with letter arrangement,
**so that** my students can practice spelling vocabulary words in an interactive way.

---

## Acceptance Criteria

1. [ ] Show word definition or image/audio hint
2. [ ] Display scrambled letters
3. [ ] **CLICK to place letters** (not drag-drop)
4. [ ] Letter moves to first empty position
5. [ ] Use vocabulary from DCS
6. [ ] Audio pronunciation after correct spelling
7. [ ] Configurable word count
8. [ ] Track attempts and accuracy

---

## Tasks / Subtasks

### Backend Tasks

- [x] **Task 1: Create Word Builder Schemas** (AC: 1, 2, 5, 7, 8)
  - [ ] Create `backend/app/schemas/word_builder.py`
  - [ ] Define `WordBuilderRequest`:
    - `book_id: int`
    - `module_ids: list[int] | None`
    - `word_count: int` (1-15, default: 10)
    - `cefr_levels: list[str] | None`
    - `hint_type: Literal["definition", "audio", "both"]` (default: "both")
  - [ ] Define `WordBuilderItem`:
    - `item_id: str` (UUID)
    - `correct_word: str`
    - `letters: list[str]` (shuffled letters)
    - `definition: str`
    - `audio_url: str | None`
    - `vocabulary_id: str`
    - `cefr_level: str`
  - [ ] Define `WordBuilderActivity`:
    - `activity_id: str`
    - `book_id: int`
    - `module_ids: list[int]`
    - `words: list[WordBuilderItem]`
    - `hint_type: str`
    - `created_at: datetime`
  - [ ] Define `WordBuilderSubmission`:
    - `answers: dict[str, str]` (item_id â†’ spelled word)
    - `attempts: dict[str, int]` (item_id â†’ attempt count)
  - [ ] Define `WordBuilderResult`:
    - Per-word: is_correct, attempts, correct_spelling
    - Overall score with accuracy percentage

- [x] **Task 2: Create Word Builder Service** (AC: 1, 2, 5, 7)
  - [ ] Create `backend/app/services/ai_generation/word_builder_service.py`
  - [ ] Implement `WordBuilderService`:
    - `async generate_activity(request) -> WordBuilderActivity`
  - [ ] Implement vocabulary selection:
    - Fetch from DCS
    - Filter by CEFR level
    - Prefer words with clear definitions
    - Prefer words of reasonable length (4-12 letters)
  - [ ] Implement letter scrambling:
    - Convert word to character list
    - Shuffle ensuring not in correct order
    - Handle repeated letters

- [x] **Task 3: Create Word Builder API Endpoints** (AC: All)
  - [ ] Add to `backend/app/api/routes/ai_generation.py`:
  - [ ] `POST /api/v1/ai/word-builder/generate`
  - [ ] `GET /api/v1/ai/word-builder/{activity_id}`
  - [ ] `POST /api/v1/ai/word-builder/{activity_id}/submit`
  - [ ] `GET /api/v1/ai/word-builder/{activity_id}/result`

- [x] **Task 4: Write Backend Tests** (AC: All)
  - [ ] Create `test_word_builder_service.py`
  - [ ] Test letter scrambling
  - [ ] Test scoring with attempts

### Frontend Tasks

- [x] **Task 5: Create Word Builder Types** (AC: All)
  - [ ] Create `frontend/src/types/word-builder.ts`

- [x] **Task 6: Create Word Builder API Service** (AC: All)
  - [ ] Create `frontend/src/services/wordBuilderApi.ts`

- [x] **Task 7: Create Word Builder Player Component** (AC: 1, 2, 3, 4, 6, 8)
  - [ ] Create `frontend/src/components/ActivityPlayers/WordBuilderPlayer.tsx`
  - [ ] **Hint Area:**
    - Display definition text
    - Audio button to hear word
    - Optional: show blank spaces indicating word length
  - [ ] **Letter Bank:**
    - Display scrambled letters as clickable tiles
    - Letters disappear when placed
    - Letters reappear when removed
  - [ ] **Word Building Area:**
    - Empty slots equal to word length
    - Click letter â†’ places in first empty slot
    - Click placed letter â†’ returns to bank
    - Underscores or boxes for empty slots
  - [ ] **Attempt Tracking:**
    - "Check" button to verify spelling
    - Show incorrect with animation (shake)
    - Track attempt count
    - Allow retry after incorrect
  - [ ] **Success Feedback:**
    - Play pronunciation audio on correct
    - Show success animation
    - Auto-advance to next word

- [x] **Task 8: Create Word Builder Results Component** (AC: 8)
  - [ ] Create `frontend/src/components/ActivityPlayers/WordBuilderResults.tsx`
  - [ ] Display overall score
  - [ ] Show accuracy (1st try vs multiple)
  - [ ] Per-word breakdown:
    - Word + definition
    - Attempts needed
    - Audio button
  - [ ] Statistics: Average attempts, perfect words

- [x] **Task 9: Create Word Builder Form** (AC: 7)
  - [x] Create `frontend/src/components/DreamAI/WordBuilderForm.tsx`
  - [x] Book/module selector
  - [x] Word count slider
  - [x] CEFR filter
  - [x] Hint type selector (Definition/Audio/Both)
  - [x] Generate button

- [x] **Task 10: Create Word Builder Container** (AC: All)
  - [x] Create `frontend/src/components/DreamAI/WordBuilderContainer.tsx`

- [x] **Task 11: Write Frontend Tests** (AC: All)
  - [x] Create `WordBuilderPlayer.test.tsx`
  - [x] Test click-to-place letters
  - [x] Test check/retry flow
  - [x] Test audio playback on success

---

## Dev Notes

### Critical: Click-to-Place (NOT Drag-Drop)

Same as Sentence Builder - this uses click-to-place interaction:
1. Click a letter in the letter bank
2. Letter moves to first empty position
3. Click a placed letter to return it

### UI Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Word Builder                                                â”‚
â”‚  Spell the word from its definition                         â”‚
â”‚  Progress: 3 / 10 words                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  HINT:                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ "to succeed in doing or completing something"       â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚                      [ðŸ”Š Hear Word]                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  LETTER BANK:                                               â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”   â”‚
â”‚  â”‚ c â”‚ â”‚ l â”‚ â”‚ p â”‚ â”‚ o â”‚ â”‚ s â”‚ â”‚ i â”‚ â”‚ h â”‚ â”‚ m â”‚ â”‚ a â”‚   â”‚
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  YOUR SPELLING:                                             â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”   â”‚
â”‚  â”‚ a â”‚ â”‚ c â”‚ â”‚ c â”‚ â”‚ o â”‚ â”‚ m â”‚ â”‚   â”‚ â”‚   â”‚ â”‚   â”‚ â”‚   â”‚   â”‚
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜   â”‚
â”‚                                        â†‘                    â”‚
â”‚                                 First empty slot            â”‚
â”‚                                                             â”‚
â”‚                 Attempts: 0                                 â”‚
â”‚                                                             â”‚
â”‚              [Clear All]         [Check Spelling]           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Correct answer shows:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        âœ… Correct!                          â”‚
â”‚                                                             â”‚
â”‚                       accomplish                            â”‚
â”‚                          ðŸ”Š                                 â”‚
â”‚                                                             â”‚
â”‚                     [Next Word â†’]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Letter Scrambling Algorithm

```python
import random

def scramble_letters(word: str) -> list[str]:
    """
    Scramble letters ensuring they're not in original order.
    Handles repeated letters correctly.
    """
    letters = list(word.lower())
    original = letters.copy()

    # Keep shuffling until different from original
    for _ in range(100):
        random.shuffle(letters)
        if letters != original:
            return letters

    # Fallback: swap first two if same
    if len(letters) >= 2:
        letters[0], letters[1] = letters[1], letters[0]

    return letters
```

### Scoring with Attempts

```python
def calculate_word_builder_score(results: list[dict]) -> dict:
    """
    Calculate score with attempt weighting.

    Perfect (1st try): 100 points
    2nd try: 70 points
    3rd try: 50 points
    4+ tries: 30 points
    """
    total_possible = len(results) * 100
    total_earned = 0

    points_by_attempts = {
        1: 100,
        2: 70,
        3: 50,
    }

    for r in results:
        if r["is_correct"]:
            attempts = r["attempts"]
            points = points_by_attempts.get(attempts, 30)
            total_earned += points

    return {
        "score": total_earned,
        "max_score": total_possible,
        "percentage": (total_earned / total_possible) * 100,
        "perfect_words": sum(1 for r in results if r["attempts"] == 1),
        "average_attempts": sum(r["attempts"] for r in results) / len(results)
    }
```

### API Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/api/v1/ai/word-builder/generate` | Generate activity | Teacher+ |
| GET | `/api/v1/ai/word-builder/{id}` | Get activity | Student+ |
| POST | `/api/v1/ai/word-builder/{id}/submit` | Submit answers | Student+ |
| GET | `/api/v1/ai/word-builder/{id}/result` | Get results | Student+ |

### Source Tree Reference

**New files to create:**
```
backend/app/
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ word_builder.py
â”œâ”€â”€ services/
â”‚   â””â”€â”€ ai_generation/
â”‚       â””â”€â”€ word_builder_service.py
â””â”€â”€ tests/
    â””â”€â”€ test_services/
        â””â”€â”€ test_ai_generation/
            â””â”€â”€ test_word_builder_service.py

frontend/src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ word-builder.ts
â”œâ”€â”€ services/
â”‚   â””â”€â”€ wordBuilderApi.ts
â””â”€â”€ components/
    â”œâ”€â”€ ActivityPlayers/
    â”‚   â”œâ”€â”€ WordBuilderPlayer.tsx
    â”‚   â”œâ”€â”€ WordBuilderPlayer.test.tsx
    â”‚   â””â”€â”€ WordBuilderResults.tsx
    â””â”€â”€ DreamAI/
        â”œâ”€â”€ WordBuilderForm.tsx
        â””â”€â”€ WordBuilderContainer.tsx
```

---

## Testing

### Backend Test Cases

```python
@pytest.mark.asyncio
async def test_scramble_letters_not_original():
    """Test scrambled letters are never in original order."""

@pytest.mark.asyncio
async def test_scramble_handles_repeated_letters():
    """Test scrambling works with repeated letters (e.g., 'accomplish')."""

@pytest.mark.asyncio
async def test_score_first_try_full_points():
    """Test first-try correct gets 100 points."""

@pytest.mark.asyncio
async def test_score_multiple_attempts_reduced():
    """Test multiple attempts get reduced points."""
```

### Frontend Test Cases

```typescript
describe('WordBuilderPlayer', () => {
  it('displays definition as hint')
  it('displays scrambled letters')
  it('moves letter to first empty slot on click')
  it('returns letter to bank when clicked')
  it('tracks attempt count')
  it('shows error animation on wrong answer')
  it('plays audio on correct answer')
  it('advances to next word on success')
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-02 | 0.1 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

**Implementation Date:** 2026-01-02
**Dev Agent:** Claude Opus 4.5

### Files Created/Modified

**Backend:**
- `backend/app/schemas/word_builder.py` - Pydantic schemas for Word Builder
- `backend/app/services/ai_generation/word_builder_service.py` - Word Builder service
- `backend/app/services/ai_generation/__init__.py` - Updated exports
- `backend/app/services/ai_generation/quiz_storage_service.py` - Added word builder storage
- `backend/app/api/routes/ai_generation.py` - Added 4 API endpoints
- `backend/app/tests/test_services/test_ai_generation/test_word_builder_service.py` - 24 backend tests

**Frontend:**
- `frontend/src/types/word-builder.ts` - TypeScript types and helpers
- `frontend/src/services/wordBuilderApi.ts` - API service
- `frontend/src/components/ActivityPlayers/WordBuilderPlayer.tsx` - Player component
- `frontend/src/components/ActivityPlayers/WordBuilderPlayer.test.tsx` - 31 frontend tests
- `frontend/src/components/ActivityPlayers/WordBuilderResults.tsx` - Results component
- `frontend/src/components/DreamAI/WordBuilderForm.tsx` - Form component
- `frontend/src/components/DreamAI/WordBuilderContainer.tsx` - Container component
- `frontend/src/components/DreamAI/index.ts` - Updated exports

### Test Results
- Backend: 24 tests passed
- Frontend: 31 tests passed

### Notes
- Click-to-place interaction (not drag-drop) as specified
- Attempt-based scoring: 100/70/50/30 points for 1/2/3/4+ attempts
- Supports definition, audio, or both hint types
- Word filtering by CEFR level and word length (4-12 characters)

---

## QA Results

_To be filled by QA agent_
