# Story 25.3: Restore Publisher /me Endpoints

## Status: Ready for Review

## Story

As a publisher user, I need working API endpoints to access my profile, stats, schools, and teachers so that I can manage my organization in LMS.

## Acceptance Criteria

- [ ] `GET /publishers/me/profile` returns DCS publisher data for current user
- [ ] `GET /publishers/me/stats` returns organization statistics
- [ ] `GET /publishers/me/schools` returns schools with matching dcs_publisher_id
- [ ] `POST /publishers/me/schools` creates school with auto-set dcs_publisher_id
- [ ] `GET /publishers/me/teachers` returns teachers in publisher's schools
- [ ] `POST /publishers/me/teachers` creates teacher in publisher's school
- [ ] `GET /publishers/me/books` returns books from DCS for publisher
- [ ] 403 returned if user has no dcs_publisher_id set
- [ ] All endpoints require publisher role

## Technical Design

### Restore publishers.py

```python
# backend/app/api/routes/publishers.py

router = APIRouter(prefix="/publishers", tags=["publishers"])

def get_current_publisher_id(current_user: User) -> int:
    """Extract and validate dcs_publisher_id from current user."""
    if current_user.dcs_publisher_id is None:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Publisher account not linked to a DCS publisher"
        )
    return current_user.dcs_publisher_id


@router.get("/me/profile", response_model=PublisherProfile)
async def get_my_profile(
    current_user: User = Depends(require_role(UserRole.publisher))
) -> PublisherProfile:
    """Get current publisher's profile from DCS."""
    publisher_id = get_current_publisher_id(current_user)

    publisher_service = get_publisher_service()
    publisher = await publisher_service.get_publisher(publisher_id)

    if not publisher:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Publisher not found in DCS"
        )

    return PublisherProfile(
        id=publisher.id,
        name=publisher.name,
        contact_email=publisher.contact_email,
        logo_url=publisher.logo_url,
        user_id=current_user.id,
        user_email=current_user.email,
        user_full_name=current_user.full_name,
    )


@router.get("/me/stats", response_model=PublisherStats)
async def get_my_stats(
    session: SessionDep,
    current_user: User = Depends(require_role(UserRole.publisher))
) -> PublisherStats:
    """Get organization statistics."""
    publisher_id = get_current_publisher_id(current_user)

    # Count schools
    schools_count = session.exec(
        select(func.count(School.id))
        .where(School.dcs_publisher_id == publisher_id)
    ).one()

    # Count teachers in publisher's schools
    teachers_count = session.exec(
        select(func.count(Teacher.id))
        .join(School)
        .where(School.dcs_publisher_id == publisher_id)
    ).one()

    # Get books from DCS
    book_service = get_book_service()
    books = await book_service.get_books_by_publisher(publisher_id)

    return PublisherStats(
        schools_count=schools_count,
        teachers_count=teachers_count,
        books_count=len(books),
    )


@router.get("/me/schools", response_model=list[SchoolPublic])
def list_my_schools(
    session: SessionDep,
    current_user: User = Depends(require_role(UserRole.publisher))
) -> list[SchoolPublic]:
    """List schools belonging to publisher."""
    publisher_id = get_current_publisher_id(current_user)

    schools = session.exec(
        select(School)
        .where(School.dcs_publisher_id == publisher_id)
        .order_by(School.name)
    ).all()

    return schools


@router.post("/me/schools", response_model=SchoolPublic, status_code=201)
def create_school(
    session: SessionDep,
    school_in: SchoolCreateByPublisher,
    current_user: User = Depends(require_role(UserRole.publisher))
) -> SchoolPublic:
    """Create school with auto-set publisher ID."""
    publisher_id = get_current_publisher_id(current_user)

    school = School(
        name=school_in.name,
        address=school_in.address,
        contact_info=school_in.contact_info,
        dcs_publisher_id=publisher_id,  # Auto-set from current user
    )
    session.add(school)
    session.commit()
    session.refresh(school)

    return school
```

### Response Schemas

```python
class PublisherProfile(BaseModel):
    """Publisher profile combining DCS and LMS data."""
    id: int  # DCS publisher ID
    name: str
    contact_email: str | None
    logo_url: str | None
    user_id: uuid.UUID  # LMS user ID
    user_email: str | None
    user_full_name: str | None

class PublisherStats(BaseModel):
    """Publisher organization statistics."""
    schools_count: int
    teachers_count: int
    books_count: int
```

### Endpoint Summary

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/publishers/me/profile` | Get publisher profile (DCS + LMS) |
| GET | `/publishers/me/stats` | Get organization stats |
| GET | `/publishers/me/schools` | List publisher's schools |
| POST | `/publishers/me/schools` | Create school for publisher |
| GET | `/publishers/me/teachers` | List teachers in publisher's schools |
| POST | `/publishers/me/teachers` | Create teacher in publisher's school |
| GET | `/publishers/me/books` | List books from DCS |

## Dev Notes

- Remove all `_raise_deprecated()` calls from publishers.py
- Rewrite endpoints to use user's `dcs_publisher_id`
- Schools filtered by `dcs_publisher_id` field
- Books fetched from DCS by publisher ID
- Teachers found via School relationship

## Testing Requirements

- [ ] Profile endpoint returns combined DCS + LMS data
- [ ] Stats endpoint counts correctly
- [ ] Schools filtered by publisher
- [ ] School creation auto-sets publisher ID
- [ ] Teachers filtered by publisher's schools
- [ ] Books fetched from DCS
- [ ] 403 if dcs_publisher_id not set
- [ ] 404 if publisher deleted from DCS

## Tasks

- [ ] Remove deprecated code from publishers.py
- [ ] Create PublisherProfile schema
- [ ] Create PublisherStats schema
- [ ] Implement GET /me/profile
- [ ] Implement GET /me/stats
- [ ] Implement GET /me/schools
- [ ] Implement POST /me/schools
- [ ] Implement GET /me/teachers
- [ ] Implement POST /me/teachers
- [ ] Implement GET /me/books
- [ ] Add authorization checks
- [ ] Write API tests

## File List

| File | Action |
|------|--------|
| `backend/app/api/routes/publishers.py` | Modified (restore endpoints) |
| `backend/app/schemas/publisher.py` | Modified (add new schemas) |
| `backend/app/tests/test_api/test_publisher_me_endpoints.py` | Created (16 tests) |

---

## Dev Agent Record

### Agent Model Used
claude-opus-4-5-20251101

### Tasks
- [x] Remove deprecated code
- [x] Create schemas
- [x] Implement all /me endpoints
- [x] Add authorization
- [x] Write tests

### Debug Log

### Completion Notes
- Removed all deprecated `_raise_deprecated()` calls from publishers.py
- Added `PublisherProfile` and `PublisherStats` schemas to publisher.py
- Implemented all 7 /me endpoints:
  - GET /me/profile - returns DCS publisher + LMS user data
  - GET /me/stats - counts schools, teachers, books
  - GET /me/schools - lists publisher's schools
  - POST /me/schools - creates school with auto-set dcs_publisher_id
  - GET /me/teachers - lists teachers in publisher's schools
  - POST /me/teachers - creates teacher with validation
  - GET /me/books - lists books from DCS
- All endpoints require publisher role
- 403 returned if user has no dcs_publisher_id set
- 16 comprehensive tests covering all endpoints and edge cases

### Change Log
| Date | Change |
|------|--------|
| 2025-12-22 | Implemented all /me endpoints with tests |
