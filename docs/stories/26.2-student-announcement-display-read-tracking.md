# Story 26.2: Student Announcement Display & Read Tracking

**Epic:** Epic 26 - Teacher Announcements
**Story Points:** 5
**Priority:** High
**Status:** In Progress - Core Complete, Pending QA
**Assignee:** Dev Agent (James)
**Depends On:** Story 26.1

---

## User Story

**As a** student,
**I want** to see announcements from my teachers on my dashboard and mark them as read,
**So that** I stay informed about important information and can easily track which announcements I've reviewed.

---

## Story Context

### Existing System Integration

**Integrates with:**
- Existing notification system (notification dropdown in navbar)
- Student dashboard (`frontend/src/routes/_layout/student/dashboard.tsx`)
- Announcement API created in Story 26.1
- Existing notification badge logic

**Technology:**
- Backend: FastAPI, SQLModel, PostgreSQL
- Frontend: React, TypeScript, TanStack Query, Shadcn UI
- Rich Text: HTML rendering with sanitized content

**Follows pattern:**
- Dashboard widget pattern (similar to UpcomingAssignmentsList)
- Notification integration pattern
- TanStack Query caching and invalidation
- Mark-as-read pattern (similar to messaging)

**Touch points:**
- Database: New announcement_reads table (Alembic migration)
- Student dashboard: New AnnouncementWidget component
- Notification dropdown: Display announcements with icon
- Navbar: Unread count includes announcements

---

## Acceptance Criteria

### Functional Requirements

**FR1: Dashboard Widget**
- [ ] Student dashboard shows "Announcements" card/widget
- [ ] Widget displays 3-5 most recent unread announcements
- [ ] Each announcement shows: title, teacher name, date, snippet (first 100 chars)
- [ ] Unread announcements have visual indicator (bold text or badge)
- [ ] "View All" link navigates to announcement history page
- [ ] Empty state shown when no announcements exist
- [ ] Widget loads without blocking other dashboard content

**FR2: Announcement Detail View**
- [ ] Clicking announcement opens detail modal/page
- [ ] Detail view shows: title, teacher name, full content (rich text), date
- [ ] Rich text content renders properly (headings, lists, formatting)
- [ ] "Mark as Read" button available if unread
- [ ] Announcement auto-marks as read when viewed (optional UX decision)
- [ ] Close/back button returns to previous view

**FR3: Announcement History**
- [ ] Students can view all received announcements (paginated)
- [ ] List shows: title, teacher, date, read/unread status
- [ ] Filter options: All / Unread / Read
- [ ] Search by title or teacher name
- [ ] Clicking announcement opens detail view
- [ ] Pagination controls (next/previous, page numbers)

**FR4: Read Tracking**
- [ ] Student can manually mark announcement as read
- [ ] Announcement automatically marks as read when opened in detail view
- [ ] Read status persists across sessions
- [ ] Unread count updates immediately after marking as read
- [ ] Cannot mark announcement as unread (one-way operation)

**FR5: Notification Integration**
- [ ] New announcements appear in notification dropdown
- [ ] Announcement notifications have distinct icon (ðŸ“¢ or similar)
- [ ] Clicking notification opens announcement detail view
- [ ] Unread announcement count included in navbar badge
- [ ] Notification dropdown shows "View All Announcements" link

**FR6: Backend API**
- [ ] GET `/api/v1/announcements/me` - Get student's announcements (paginated)
- [ ] GET `/api/v1/announcements/{id}` - Get announcement detail (student access)
- [ ] PATCH `/api/v1/announcements/{id}/read` - Mark as read
- [ ] All endpoints require student role
- [ ] Students can only access announcements sent to them

### Integration Requirements

**IR1: Existing Functionality**
- [ ] Existing notification system continues to work
- [ ] Student dashboard other widgets unaffected
- [ ] Navbar badge count includes announcements correctly
- [ ] Existing notification dropdown continues to work

**IR2: Pattern Compliance**
- [ ] Dashboard widget follows existing card patterns
- [ ] API follows existing route structure
- [ ] TanStack Query hooks follow existing patterns
- [ ] Component structure follows project conventions

**IR3: Performance**
- [ ] Dashboard loads in <1s (announcements don't block)
- [ ] Announcement list loads in <500ms
- [ ] Mark as read action completes in <300ms
- [ ] Rich text rendering is smooth (no layout shift)

### Quality Requirements

**QR1: Testing**
- [ ] Unit tests for announcement display components
- [ ] Unit tests for read tracking logic
- [ ] API endpoint tests (student access)
- [ ] Integration test for mark-as-read flow
- [ ] E2E test for full student announcement experience
- [ ] Regression test for existing dashboard functionality

**QR2: User Experience**
- [ ] Loading states shown while fetching data
- [ ] Error states handled gracefully
- [ ] Empty states are informative and helpful
- [ ] Animations are smooth (no jank)
- [ ] Mobile responsive (announcements readable on small screens)

**QR3: Accessibility**
- [ ] Keyboard navigation works for all interactions
- [ ] Screen reader announcements for read status changes
- [ ] Proper ARIA labels on all interactive elements
- [ ] Sufficient color contrast for read/unread indicators

---

## Technical Implementation

### Database Schema

**Create migration:** `backend/app/alembic/versions/[timestamp]_add_announcement_reads.py`

**Table: announcement_reads**
```python
class AnnouncementRead(SQLModel, table=True):
    __tablename__ = "announcement_reads"

    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    announcement_id: uuid.UUID = Field(foreign_key="announcements.id", index=True)
    student_id: uuid.UUID = Field(foreign_key="students.id", index=True)
    read_at: datetime = Field(default_factory=lambda: datetime.now(UTC))

    # Unique constraint: student can only mark announcement as read once
    __table_args__ = (
        UniqueConstraint('announcement_id', 'student_id', name='uq_announcement_read'),
        Index('idx_student_read_at', 'student_id', 'read_at'),
    )

    # Relationships
    announcement: "Announcement" = Relationship()
    student: "Student" = Relationship()
```

### Backend Files to Create/Modify

**Modify: `backend/app/api/routes/announcements.py`**

Add student-facing endpoints:

```python
@router.get("/me", response_model=StudentAnnouncementListResponse)
async def get_my_announcements(
    db: AsyncSessionDep,
    current_user: User = require_role(UserRole.student),
    limit: int = Query(20, ge=1, le=100),
    offset: int = Query(0, ge=0),
    filter: str = Query("all", regex="^(all|unread|read)$")
) -> StudentAnnouncementListResponse:
    """Get announcements for the current student."""
    # Get student record
    # Query announcements for this student
    # Join with read status
    # Apply filter (all/unread/read)
    # Return paginated results

@router.get("/{announcement_id}", response_model=StudentAnnouncementPublic)
async def get_announcement(
    announcement_id: uuid.UUID,
    db: AsyncSessionDep,
    current_user: User = require_role(UserRole.student, UserRole.teacher),
) -> StudentAnnouncementPublic:
    """Get announcement detail (student or teacher)."""
    # Verify student has access to this announcement
    # Return announcement with read status

@router.patch("/{announcement_id}/read", response_model=AnnouncementReadResponse)
async def mark_announcement_as_read(
    announcement_id: uuid.UUID,
    db: AsyncSessionDep,
    current_user: User = require_role(UserRole.student),
) -> AnnouncementReadResponse:
    """Mark announcement as read for current student."""
    # Verify student has access to announcement
    # Create or update read record
    # Return success response
```

**Modify: `backend/app/services/announcement_service.py`**

Add student-facing functions:

```python
async def get_student_announcements(
    db: AsyncSession,
    student_id: uuid.UUID,
    limit: int = 20,
    offset: int = 0,
    filter: str = "all"
) -> tuple[list[StudentAnnouncementPublic], int]:
    """Get announcements for a student with read status."""
    # Query announcements where student is recipient
    # Left join with announcement_reads
    # Filter by read status if requested
    # Return announcements + total count

async def mark_announcement_as_read(
    db: AsyncSession,
    announcement_id: uuid.UUID,
    student_id: uuid.UUID
) -> AnnouncementRead:
    """Mark announcement as read for student."""
    # Check if already read
    # Create read record if not exists
    # Update if exists (idempotent)
    # Return read record

async def get_unread_announcement_count(
    db: AsyncSession,
    student_id: uuid.UUID
) -> int:
    """Get count of unread announcements for student."""
    # Query announcements for student
    # Count those without read records
    # Return count
```

**Modify: `backend/app/schemas/announcement.py`**

Add student-facing schemas:

```python
class StudentAnnouncementPublic(BaseModel):
    id: uuid.UUID
    teacher_id: uuid.UUID
    teacher_name: str
    title: str
    content: str
    created_at: datetime
    is_read: bool
    read_at: datetime | None

class StudentAnnouncementListResponse(BaseModel):
    announcements: list[StudentAnnouncementPublic]
    total: int
    unread_count: int
    limit: int
    offset: int

class AnnouncementReadResponse(BaseModel):
    announcement_id: uuid.UUID
    is_read: bool
    read_at: datetime
```

### Frontend Files to Create/Modify

**Modify: `frontend/src/routes/_layout/student/dashboard.tsx`**

Add announcement widget:

```typescript
function StudentDashboard() {
  // ... existing code

  const { data: announcements = [], isLoading: isLoadingAnnouncements } = useQuery({
    queryKey: ["studentAnnouncements", "unread"],
    queryFn: () => announcementsApi.getMyAnnouncements({ filter: "unread", limit: 5 }),
  })

  return (
    <div className="container py-4 md:py-6 space-y-4 md:space-y-6">
      {/* ... existing widgets */}

      {/* Announcements Widget */}
      {isLoadingAnnouncements ? (
        <Skeleton className="h-60 w-full rounded-lg" />
      ) : (
        <AnnouncementWidget announcements={announcements} />
      )}
    </div>
  )
}
```

**Create: `frontend/src/components/announcements/AnnouncementWidget.tsx`**

Dashboard widget component:

```typescript
export function AnnouncementWidget({
  announcements
}: {
  announcements: StudentAnnouncement[]
}) {
  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <CardTitle className="text-lg flex items-center gap-2">
            <Bell className="h-5 w-5 text-teal-500" />
            Announcements
          </CardTitle>
          <Button variant="link" size="sm" asChild>
            <Link to="/student/announcements">
              View All
              <ChevronRight className="h-4 w-4 ml-1" />
            </Link>
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        {announcements.length === 0 ? (
          <EmptyState />
        ) : (
          <div className="space-y-3">
            {announcements.map((announcement) => (
              <AnnouncementItem
                key={announcement.id}
                announcement={announcement}
              />
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

**Create: `frontend/src/components/announcements/AnnouncementDetailModal.tsx`**

Detail view modal:

```typescript
export function AnnouncementDetailModal({
  announcement,
  open,
  onOpenChange
}: AnnouncementDetailModalProps) {
  const { markAsRead } = useAnnouncements()

  useEffect(() => {
    // Auto-mark as read when opened
    if (open && !announcement.is_read) {
      markAsRead(announcement.id)
    }
  }, [open, announcement.id, announcement.is_read])

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>{announcement.title}</DialogTitle>
          <div className="text-sm text-muted-foreground">
            From {announcement.teacher_name} â€¢ {formatDate(announcement.created_at)}
          </div>
        </DialogHeader>
        <div
          className="prose prose-sm max-w-none py-4"
          dangerouslySetInnerHTML={{ __html: announcement.content }}
        />
        {!announcement.is_read && (
          <Button onClick={() => markAsRead(announcement.id)}>
            Mark as Read
          </Button>
        )}
      </DialogContent>
    </Dialog>
  )
}
```

**Create: `frontend/src/routes/_layout/student/announcements.tsx`**

Announcement history page:

```typescript
export function StudentAnnouncementsPage() {
  const [filter, setFilter] = useState<"all" | "unread" | "read">("all")
  const [page, setPage] = useState(1)

  const { data, isLoading } = useQuery({
    queryKey: ["studentAnnouncements", filter, page],
    queryFn: () => announcementsApi.getMyAnnouncements({
      filter,
      limit: 20,
      offset: (page - 1) * 20
    })
  })

  return (
    <div className="container py-6 space-y-6">
      <h1 className="text-3xl font-bold">Announcements</h1>

      {/* Filter tabs */}
      <Tabs value={filter} onValueChange={setFilter}>
        <TabsList>
          <TabsTrigger value="all">All</TabsTrigger>
          <TabsTrigger value="unread">Unread ({data?.unread_count})</TabsTrigger>
          <TabsTrigger value="read">Read</TabsTrigger>
        </TabsList>
      </Tabs>

      {/* Announcement list */}
      <AnnouncementList announcements={data?.announcements} />

      {/* Pagination */}
      <Pagination totalPages={Math.ceil(data?.total / 20)} />
    </div>
  )
}
```

**Modify: `frontend/src/hooks/useAnnouncements.ts`**

Add student-specific methods:

```typescript
export function useAnnouncements() {
  const queryClient = useQueryClient()

  // Query: Get my announcements
  const { data, isLoading } = useQuery({
    queryKey: ['studentAnnouncements'],
    queryFn: () => announcementsApi.getMyAnnouncements()
  })

  // Mutation: Mark as read
  const markAsReadMutation = useMutation({
    mutationFn: (id: string) => announcementsApi.markAsRead(id),
    onSuccess: () => {
      queryClient.invalidateQueries(['studentAnnouncements'])
      queryClient.invalidateQueries(['unreadCounts'])
    }
  })

  return {
    announcements: data?.announcements ?? [],
    unreadCount: data?.unread_count ?? 0,
    isLoading,
    markAsRead: markAsReadMutation.mutate
  }
}
```

**Modify: `frontend/src/services/announcementsApi.ts`**

Add student endpoints:

```typescript
export const announcementsApi = {
  // ... teacher methods from Story 26.1

  // Student methods
  getMyAnnouncements: (params?: {
    filter?: 'all' | 'unread' | 'read'
    limit?: number
    offset?: number
  }): Promise<StudentAnnouncementListResponse> =>
    api.get('/announcements/me', { params }),

  markAsRead: (id: string): Promise<AnnouncementReadResponse> =>
    api.patch(`/announcements/${id}/read`),
}
```

**Modify: `frontend/src/components/Common/SidebarItems.tsx`**

Update notification count logic to include announcements:

```typescript
// In getItemCount function
case "/student/assignments":
  // Existing logic + add announcement count
  const totalIncomplete = incompleteAssignmentsCount + unreadAnnouncementsCount
  return totalIncomplete > 0 ? totalIncomplete : null
```

---

## Implementation Tasks

### Backend Tasks

- [x] **Task 1.1:** Create Alembic migration for announcement_reads table
- [x] **Task 1.2:** Add AnnouncementRead model to models.py
- [x] **Task 1.3:** Add student endpoints to announcements.py router
- [x] **Task 1.4:** Implement get_student_announcements in service
- [x] **Task 1.5:** Implement mark_announcement_as_read in service
- [x] **Task 1.6:** Implement get_unread_announcement_count in service
- [x] **Task 1.7:** Create student-facing schemas (StudentAnnouncementPublic, etc.)
- [x] **Task 1.8:** Add authorization checks (student can only access their announcements)
- [ ] **Task 1.9:** Write unit tests for student announcement service
- [ ] **Task 1.10:** Write API endpoint tests for student routes
- [x] **Task 1.11:** Run Alembic migration and verify schema

### Frontend Tasks

- [x] **Task 2.1:** Update announcement types for student schemas
- [x] **Task 2.2:** Add student methods to announcementsApi service
- [x] **Task 2.3:** Update useAnnouncements hook with student methods
- [x] **Task 2.4:** Create AnnouncementWidget component
- [x] **Task 2.5:** Create AnnouncementItem component (list item)
- [x] **Task 2.6:** Create AnnouncementDetailModal component
- [x] **Task 2.7:** Create announcements.tsx student route page
- [x] **Task 2.8:** Create AnnouncementList component (full list view)
- [x] **Task 2.9:** Add announcement widget to student dashboard
- [ ] **Task 2.10:** Update navbar badge to include announcement count
- [ ] **Task 2.11:** Add "Announcements" link to student sidebar (optional)
- [ ] **Task 2.12:** Write component tests
- [ ] **Task 2.13:** Test mark-as-read flow
- [ ] **Task 2.14:** Test pagination and filtering

### Integration Tasks

- [ ] **Task 3.1:** Verify announcements appear in notification dropdown
- [ ] **Task 3.2:** Verify unread count updates in navbar badge
- [ ] **Task 3.3:** Test end-to-end flow (teacher creates â†’ student sees â†’ marks read)
- [ ] **Task 3.4:** Test with multiple announcements
- [ ] **Task 3.5:** Test mobile responsiveness
- [ ] **Task 3.6:** Regression test: Existing dashboard widgets still work
- [ ] **Task 3.7:** Regression test: Existing notifications still work

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All implementation tasks completed
- [ ] Database migration successfully applied
- [ ] API endpoints tested and working
- [ ] Student dashboard shows announcement widget
- [ ] Announcement detail modal/page working
- [ ] Mark-as-read functionality working
- [ ] Announcement history page with pagination
- [ ] Unread count displays correctly in navbar
- [ ] Rich text renders properly
- [ ] All tests passing (unit, integration, E2E)
- [ ] No regressions in existing functionality
- [ ] Mobile responsive design
- [ ] Code reviewed and approved
- [ ] QA verified on staging

---

## Dev Notes

### Auto-Mark as Read UX Decision

Two options for marking as read:

**Option A: Auto-mark on open (Recommended)**
- When student opens announcement detail, automatically mark as read
- Simpler UX, one less action for students
- Similar to email/messaging apps

**Option B: Manual mark as read**
- Student must click "Mark as Read" button
- More explicit control
- Useful if students want to keep reminders

**Recommendation:** Use Option A with auto-mark on open for better UX.

### Rich Text Rendering

```typescript
// Safely render HTML content (already sanitized server-side)
<div
  className="prose prose-sm max-w-none"
  dangerouslySetInnerHTML={{ __html: announcement.content }}
/>

// Note: Content is already sanitized by backend, so dangerouslySetInnerHTML is safe
```

### Empty State

```typescript
function EmptyState() {
  return (
    <div className="text-center py-8 text-muted-foreground">
      <Bell className="h-12 w-12 mx-auto mb-3 opacity-50" />
      <p>No announcements yet!</p>
      <p className="text-sm">
        Your teachers will post important updates here.
      </p>
    </div>
  )
}
```

---

## Agent Model Used

Sonnet 4.5

---

## Debug Log References

_None yet_

---

## Completion Notes

**Completed:** 2025-12-29
**Implementation Status:** Core functionality complete, pending testing and integration

### What Was Implemented

**Backend:**
- âœ… Created announcement_reads table via Alembic migration
- âœ… Added AnnouncementRead model with relationships
- âœ… Implemented student service methods (get_student_announcements, mark_as_read, get_unread_count)
- âœ… Added 3 student endpoints: GET /me, GET /{id}/student, PATCH /{id}/read
- âœ… Created student-facing schemas with read status
- âœ… Authorization checks ensure students only access their announcements

**Frontend:**
- âœ… Added StudentAnnouncement types and interfaces
- âœ… Created announcementsApi methods for students
- âœ… Implemented useStudentAnnouncements and related hooks
- âœ… Built AnnouncementWidget for dashboard
- âœ… Created AnnouncementItem component
- âœ… Implemented AnnouncementDetailModal with auto-mark-as-read
- âœ… Created full announcements route page with filtering/pagination
- âœ… Integrated announcement widget into student dashboard

### Implementation Decisions

1. **Auto-mark as read:** Implemented Option A - announcements automatically mark as read when opened in detail modal
2. **Rich text rendering:** Using dangerouslySetInnerHTML with backend-sanitized HTML
3. **Dashboard widget:** Shows up to 5 unread announcements on student dashboard
4. **Filtering:** Full page supports all/unread/read filtering

### Known Limitations/TODOs

- Unit tests for backend services not written
- API endpoint tests not written
- Component tests not written
- Navbar badge count integration not implemented
- End-to-end testing not performed
- Mobile responsiveness not verified

### Files Created/Modified

**Backend:**
- `backend/app/alembic/versions/860023313fd4_add_announcement_reads_table.py` (new)
- `backend/app/models.py` (modified - added AnnouncementRead model)
- `backend/app/schemas/announcement.py` (modified - added student schemas)
- `backend/app/services/announcement_service.py` (modified - added student methods)
- `backend/app/api/routes/announcements.py` (modified - added student endpoints)

**Frontend:**
- `frontend/src/types/announcement.ts` (modified - added student types)
- `frontend/src/services/announcementsApi.ts` (modified - added student methods)
- `frontend/src/hooks/useAnnouncements.ts` (modified - added student hooks)
- `frontend/src/components/announcements/AnnouncementWidget.tsx` (new)
- `frontend/src/components/announcements/AnnouncementItem.tsx` (new)
- `frontend/src/components/announcements/AnnouncementDetailModal.tsx` (new)
- `frontend/src/routes/_layout/student/announcements.tsx` (new)
- `frontend/src/routes/_layout/student/dashboard.tsx` (modified - added widget)

---

**Created:** 2025-12-28
**Last Updated:** 2025-12-29
