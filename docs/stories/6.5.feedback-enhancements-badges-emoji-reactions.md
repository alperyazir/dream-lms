# Story 6.5: Feedback Enhancements (Badges & Emoji Reactions)

**Epic:** 6 - Communication, Feedback & Supplementary Materials
**Story ID:** 6.5
**Status:** Done
**Created:** 2025-12-02
**Developer:** (Pending Assignment)

---

## Story

**As a** teacher,
**I want** to award badges and add emoji reactions to student work,
**so that** I can provide quick, encouraging, visual feedback.

---

## Acceptance Criteria

1. Feedback modal (from Story 6.4) includes badge selection section with predefined badges
2. **Predefined Badges**: "Perfect Score", "Great Improvement", "Creative Thinking", "Hard Worker", "Fast Learner", "Needs Review"
3. Teacher can select multiple badges to award (checkboxes)
4. Feedback modal includes emoji reaction picker (similar to social media reactions)
5. **Available Emoji Reactions**: thumbs_up, heart, star, party, fire, hundred (customizable via admin settings)
6. Teacher can select one emoji reaction per feedback instance
7. Selected badges and emoji are stored in Feedback model (badges array, emoji_reactions array)
8. Student assignment results page displays awarded badges as visual icons/labels
9. Student progress page shows "Badges Earned" section with count of each badge type
10. Badge achievements contribute to student motivation (displayed prominently on dashboard)
11. When badge is awarded, student notification includes badge name: "You earned 'Perfect Score' badge!"
12. Emoji reactions appear next to feedback text in student view (larger display)
13. Teacher can remove badges/emoji by deselecting and updating feedback
14. System tracks badge totals for student analytics (e.g., "Earned 15 badges this month")
15. Unit tests verify badge and emoji storage and retrieval
16. Badges are purely motivational (no grade impact)

---

## Tasks / Subtasks

### Backend Tasks

- [x] **Task 1: Define Badge and Emoji Constants** (AC: 2, 5)
  - [x] Create `backend/app/core/feedback_constants.py` with PREDEFINED_BADGES list
  - [x] Define badge slugs: "perfect_score", "great_improvement", "creative_thinking", "hard_worker", "fast_learner", "needs_review"
  - [x] Define badge display info (slug, label, emoji icon)
  - [x] Define AVAILABLE_EMOJI_REACTIONS list: ["thumbs_up", "heart", "star", "party", "fire", "hundred"]
  - [x] Create endpoint `GET /api/v1/feedback/options` to return available badges and emoji

- [x] **Task 2: Update Feedback Schemas** (AC: 3, 6, 7)
  - [x] Modify `FeedbackCreate` to accept optional `badges: list[str]` (max 6 items)
  - [x] Modify `FeedbackCreate` to accept optional `emoji_reaction: str | None` (single selection)
  - [x] Modify `FeedbackUpdate` to accept optional `badges` and `emoji_reaction`
  - [x] Add validation: badges must be from PREDEFINED_BADGES list
  - [x] Add validation: emoji_reaction must be from AVAILABLE_EMOJI_REACTIONS list

- [x] **Task 3: Update Feedback Service** (AC: 7, 11, 13)
  - [x] Modify `create_feedback()` to store badges and emoji_reactions arrays
  - [x] Modify `update_feedback()` to handle badge/emoji updates (add/remove)
  - [x] When badges change from empty to non-empty, enhance notification message with badge names
  - [x] Track which badges were newly awarded vs. already existed

- [x] **Task 4: Create Badge Analytics Endpoint** (AC: 9, 14)
  - [x] Create `GET /api/v1/students/{student_id}/badges` endpoint
  - [x] Return badge counts grouped by type (e.g., {"perfect_score": 3, "hard_worker": 5})
  - [x] Include total badge count
  - [x] Include badges earned this month (date range filter)

- [x] **Task 5: Backend Unit Tests** (AC: 15)
  - [x] Test badge validation (only predefined badges allowed)
  - [x] Test emoji validation (only allowed reactions)
  - [x] Test badge storage and retrieval in feedback
  - [x] Test badge removal (update with empty array)
  - [x] Test badge analytics endpoint returns correct counts
  - [x] Test notification includes badge name when awarded

### Frontend Tasks

- [x] **Task 6: Create Badge Components** (AC: 2, 3, 8)
  - [x] Create `frontend/src/components/feedback/BadgeSelector.tsx`
  - [x] Display 6 predefined badges as selectable cards/chips
  - [x] Each badge shows: emoji icon, label, checkbox for selection
  - [x] Support multi-select (checkboxes, not radio buttons)
  - [x] Create `frontend/src/components/feedback/BadgeDisplay.tsx` for displaying awarded badges
  - [x] Style badges consistently with LMS design (use Shadcn Badge component as base)

- [x] **Task 7: Create Emoji Picker Component** (AC: 4, 5, 6)
  - [x] Create `frontend/src/components/feedback/EmojiPicker.tsx`
  - [x] Display 6 available emoji as clickable buttons
  - [x] Single selection only (clicking new emoji deselects previous)
  - [x] Highlight selected emoji with visual indicator
  - [x] Allow deselecting by clicking selected emoji again

- [x] **Task 8: Update FeedbackModal Component** (AC: 1, 3, 4)
  - [x] Integrate BadgeSelector below the text area
  - [x] Integrate EmojiPicker below BadgeSelector
  - [x] Add state for `selectedBadges: string[]` and `selectedEmoji: string | null`
  - [x] Load existing badges/emoji when editing feedback
  - [x] Include badges and emoji in save/publish payload
  - [x] Update useFeedback hook types to include badges/emoji

- [x] **Task 9: Update Feedback Types** (AC: 7)
  - [x] Update `FeedbackCreate` type to include optional `badges` and `emoji_reaction`
  - [x] Update `FeedbackUpdate` type similarly
  - [x] Create `BadgeInfo` type: { slug: string, label: string, icon: string }
  - [x] Create `PREDEFINED_BADGES` constant matching backend

- [x] **Task 10: Update Student Feedback Display** (AC: 8, 12)
  - [x] Modify student assignment detail page feedback section
  - [x] Display awarded badges using BadgeDisplay component
  - [x] Display emoji reaction in larger size next to feedback text
  - [x] Show badges in a horizontal row with nice spacing

- [x] **Task 11: Create Student Badge Summary Component** (AC: 9, 10)
  - [x] Create `frontend/src/components/feedback/StudentBadgeSummary.tsx`
  - [x] Create hook with inline query to fetch badge counts
  - [x] Display badge types with counts in grid layout
  - [x] Add to student dashboard in prominent location
  - [x] Show "Badges Earned This Month" section

- [x] **Task 12: Update Notification for Badges** (AC: 11)
  - [x] When feedback includes badges, notification message should list them
  - [x] Example: "You earned 'Perfect Score' and 'Hard Worker' badges on [Assignment Name]!"

### Integration Tasks

- [x] **Task 13: Integration Testing** (AC: 15)
  - [x] Test full flow: Teacher awards badges → Student sees badges in feedback
  - [x] Test badge removal updates student view
  - [x] Test badge counts update correctly in student dashboard
  - [x] Test notification includes badge names

---

## Dev Notes

### Previous Story Insights (Story 6.4)
[Source: docs/stories/6.4.teacher-feedback-assignments-text-comments.md#Dev Agent Record]

- Feedback model already exists with `badges` and `emoji_reactions` arrays (JSONB columns)
- FeedbackCreate/Update schemas exist but don't yet accept badges/emoji
- FeedbackPublic/FeedbackStudentView already return badges and emoji_reactions arrays
- FeedbackModal component exists at `frontend/src/components/feedback/FeedbackModal.tsx`
- useFeedback hook exists at `frontend/src/hooks/useFeedback.ts`
- XSS protection via bleach is in place for feedback_text
- 26 existing tests in `backend/app/tests/test_api/test_feedback.py`

### Data Models
[Source: docs/architecture/2-database-schema-design.md]

**Existing Feedback Table (already has badge columns):**
```sql
CREATE TABLE feedback (
    id UUID PRIMARY KEY,
    assignment_student_id UUID UNIQUE NOT NULL REFERENCES assignment_students(id),
    teacher_id UUID NOT NULL REFERENCES teachers(id),
    feedback_text TEXT,
    badges TEXT[] DEFAULT '{}',        -- Already exists!
    emoji_reactions TEXT[] DEFAULT '{}', -- Already exists!
    is_draft BOOLEAN DEFAULT false,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

**Note:** The database columns already exist. This story is about:
1. Adding UI components to select badges/emoji
2. Updating schemas to accept badge/emoji input
3. Adding validation for allowed values
4. Creating badge analytics endpoints
5. Displaying badges in student view

### Badge Definitions
[Source: docs/prd/epic-6-communication-feedback-supplementary-materials.md#Story 6.5]

**Predefined Badges (use these exact slugs):**
| Slug | Label | Icon |
|------|-------|------|
| perfect_score | Perfect Score | 100 emoji |
| great_improvement | Great Improvement | chart up emoji |
| creative_thinking | Creative Thinking | lightbulb emoji |
| hard_worker | Hard Worker | flexed biceps emoji |
| fast_learner | Fast Learner | lightning emoji |
| needs_review | Needs Review | books emoji |

**Available Emoji Reactions:**
| Slug | Display |
|------|---------|
| thumbs_up | thumbs up |
| heart | red heart |
| star | star |
| party | party popper |
| fire | fire |
| hundred | 100 |

### API Specifications
[Source: docs/architecture/3-api-architecture.md]

**New Endpoints:**
```
GET  /api/v1/feedback/options           # Returns available badges and emoji (public)
GET  /api/v1/students/{id}/badges       # Returns badge counts for student (auth required)
```

**Updated Endpoints:**
```
POST /api/v1/assignments/{id}/students/{student_id}/feedback
  Body: { feedback_text, is_draft, badges?: string[], emoji_reaction?: string }

PUT  /api/v1/feedback/{id}
  Body: { feedback_text?, is_draft?, badges?: string[], emoji_reaction?: string }
```

### File Locations
[Source: docs/architecture/source-tree.md]

**Backend (New/Modified):**
- `backend/app/core/feedback_constants.py` - NEW: Badge and emoji constants
- `backend/app/schemas/feedback.py` - MODIFY: Add badges/emoji to schemas
- `backend/app/services/feedback_service.py` - MODIFY: Handle badge storage
- `backend/app/api/routes/assignments.py` - MODIFY: Add options endpoint, badge analytics
- `backend/app/tests/test_api/test_feedback.py` - MODIFY: Add badge tests

**Frontend (New/Modified):**
- `frontend/src/components/feedback/BadgeSelector.tsx` - NEW
- `frontend/src/components/feedback/EmojiPicker.tsx` - NEW
- `frontend/src/components/feedback/BadgeDisplay.tsx` - NEW
- `frontend/src/components/feedback/BadgeSummary.tsx` - NEW
- `frontend/src/components/feedback/FeedbackModal.tsx` - MODIFY: Add badge/emoji selection
- `frontend/src/types/feedback.ts` - MODIFY: Add badge types
- `frontend/src/hooks/useFeedback.ts` - MODIFY: Include badges in mutations
- `frontend/src/hooks/useStudentBadges.ts` - NEW: Fetch badge counts
- `frontend/src/routes/_layout/student/assignments/$assignmentId/index.tsx` - MODIFY: Display badges

### Component Patterns
[Source: docs/architecture/5-frontend-architecture.md]

Use Shadcn UI components:
- `Badge` component for displaying badge chips
- `Checkbox` for multi-select badges
- `Button` for emoji picker items
- `Card` for badge summary display

TanStack Query patterns:
```typescript
// useStudentBadges hook
const { data: badges } = useQuery({
  queryKey: ['studentBadges', studentId],
  queryFn: () => feedbackApi.getStudentBadges(studentId),
  enabled: !!studentId,
});
```

### Notification Enhancement
[Source: docs/stories/6.4.teacher-feedback-assignments-text-comments.md#Dev Notes]

When feedback includes new badges, modify the notification message:
```python
# In feedback_service.py
if new_badges:
    badge_names = ", ".join([BADGE_LABELS[b] for b in new_badges])
    message = f"You earned {badge_names} on {assignment_name}!"
else:
    message = f"You have received feedback on {assignment_name}"
```

---

## Testing

### Test File Locations
[Source: docs/architecture/source-tree.md#Backend Structure]

- Backend tests: `backend/app/tests/test_api/test_feedback.py` (extend existing)
- Frontend tests: `frontend/src/components/feedback/BadgeSelector.test.tsx` (optional)

### Testing Patterns
[Source: docs/architecture/coding-standards.md#Testing Patterns]

```python
@pytest.mark.asyncio
async def test_feedback_with_badges(client: AsyncClient, teacher_token: str):
    """Test that badges are stored correctly."""
    response = await client.post(
        f"/api/v1/assignments/{assignment.id}/students/{student.id}/feedback",
        json={
            "feedback_text": "Great work!",
            "badges": ["perfect_score", "hard_worker"],
            "emoji_reaction": "star",
            "is_draft": False
        },
        headers={"Authorization": f"Bearer {teacher_token}"}
    )
    assert response.status_code == 201
    data = response.json()
    assert "perfect_score" in data["badges"]
    assert "hard_worker" in data["badges"]
    assert "star" in data["emoji_reactions"]
```

### Test Scenarios Required

**Badge Validation:**
- Valid badges accepted and stored
- Invalid badge slug returns 422 error
- Empty badges array is valid (clears badges)
- Maximum 6 badges enforced (optional)

**Emoji Validation:**
- Valid emoji reaction accepted
- Invalid emoji returns 422 error
- Null emoji_reaction clears previous selection

**Badge Analytics:**
- Badge counts aggregate correctly across multiple feedback records
- Filter by date range works correctly
- Returns zero counts for badges not yet earned

**Notification Enhancement:**
- Notification includes badge names when badges awarded
- Notification uses standard message when no badges

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-02 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Backend tests: `uv run pytest app/tests/test_api/test_feedback.py -v` - 35/35 passed
- TypeScript check: `npx tsc --noEmit` - No errors in feedback-related files
- Frontend notification tests: `npx vitest run src/hooks/useNotifications.test.tsx` - 11/11 passed

### Completion Notes

- Implemented badge and emoji reaction functionality for teacher feedback
- Created 6 predefined badges with validation
- Created 6 available emoji reactions with single-select behavior
- Added badge analytics endpoint with monthly filtering
- Enhanced feedback notifications to include badge names
- Integrated badges/emoji into FeedbackModal with proper state management
- Added StudentBadgeSummary component to student dashboard
- Updated student assignment detail page to display awarded badges and emoji
- QA fixed TooltipProvider missing error in EmojiPicker and BadgeDisplay components
- All 16 acceptance criteria implemented and tested

### File List

**Backend - New:**
- `backend/app/core/feedback_constants.py` - Badge and emoji constants with TypedDict definitions
- `backend/app/api/routes/feedback.py` - New `/options` endpoint for available badges/emoji

**Backend - Modified:**
- `backend/app/schemas/feedback.py` - Added badges/emoji fields with validation, StudentBadgeCountsResponse
- `backend/app/services/feedback_service.py` - Handle badges/emoji in create/update, badge analytics, notification enhancement
- `backend/app/api/routes/students.py` - Added `/me/badges` and `/{student_id}/badges` endpoints
- `backend/app/api/routes/assignments.py` - Pass badges/emoji to feedback service
- `backend/app/api/main.py` - Registered feedback router
- `backend/app/tests/test_api/test_feedback.py` - Added 9 new badge/emoji tests (35 total)

**Frontend - New:**
- `frontend/src/components/feedback/BadgeSelector.tsx` - Multi-select badge picker for teachers
- `frontend/src/components/feedback/BadgeDisplay.tsx` - Display awarded badges with icons/labels
- `frontend/src/components/feedback/EmojiPicker.tsx` - Single-select emoji picker
- `frontend/src/components/feedback/StudentBadgeSummary.tsx` - Student badge counts display
- `frontend/src/components/feedback/index.ts` - Barrel export for feedback components

**Frontend - Modified:**
- `frontend/src/types/feedback.ts` - Added BadgeInfo, EmojiInfo types and constants
- `frontend/src/types/notification.ts` - Added Story 6.5 reference
- `frontend/src/hooks/useFeedback.ts` - Save operations pass badges/emoji
- `frontend/src/components/feedback/FeedbackModal.tsx` - Integrated BadgeSelector and EmojiPicker
- `frontend/src/routes/_layout/student/assignments/$assignmentId/index.tsx` - Display badges/emoji in feedback
- `frontend/src/routes/_layout/student/dashboard.tsx` - Added StudentBadgeSummary component

---

## QA Results

### Review Date: 2025-12-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: GOOD** - The implementation is functionally complete and well-structured. All 35 backend tests pass, including 9 new tests specifically for badge/emoji functionality. The code follows established patterns and maintains good separation of concerns.

**Backend Highlights:**
- Clean constants file (`feedback_constants.py`) with proper TypedDict definitions
- Robust Pydantic validation with field_validator decorators
- Proper XSS sanitization maintained from Story 6.4
- Badge analytics endpoint with monthly filtering
- Notification enhancement includes badge names

**Frontend Highlights:**
- Well-structured components (BadgeSelector, EmojiPicker, BadgeDisplay, StudentBadgeSummary)
- Proper use of Shadcn UI components (Badge, Checkbox, Button)
- TooltipProvider properly wrapped (fixed during review)
- Clean state management in FeedbackModal
- Good integration with existing useFeedback hook

### Refactoring Performed

- **File**: `frontend/src/components/feedback/EmojiPicker.tsx`
  - **Change**: Added TooltipProvider wrapper around Tooltip components
  - **Why**: Runtime error "Tooltip must be used within TooltipProvider"
  - **How**: Wrapped tooltip mapping with `<TooltipProvider>` component

- **File**: `frontend/src/components/feedback/BadgeDisplay.tsx`
  - **Change**: Added TooltipProvider wrapper around Tooltip components
  - **Why**: Same runtime error when displaying badges without labels
  - **How**: Wrapped tooltip mapping with `<TooltipProvider>` component

### Compliance Check

- Coding Standards: ✓ Follows project conventions, proper TypeScript typing
- Project Structure: ✓ Files in correct locations per source-tree.md
- Testing Strategy: ✓ 35 tests pass, good coverage of badge/emoji functionality
- All ACs Met: ✓ All 16 acceptance criteria implemented and testable

### Improvements Checklist

[x] Fixed TooltipProvider missing error (EmojiPicker.tsx, BadgeDisplay.tsx)
[x] Verified all 35 backend tests pass
[x] Verified no TypeScript errors in feedback-related files
[x] Dev Agent Record section filled out
[x] File List section documented
[x] Task checkboxes (1-13) marked complete
[ ] Consider adding frontend component tests (optional per story)

### Security Review

**Status: PASS**
- XSS protection via bleach sanitization on feedback_text
- Input validation prevents invalid badge/emoji values
- Proper authorization checks on all endpoints
- No SQL injection vectors (using SQLModel ORM)

### Performance Considerations

**Status: PASS**
- Efficient queries using existing indexed columns
- Badge analytics uses aggregation at database level
- No N+1 query issues identified
- Frontend components are lightweight

### Files Modified During Review

1. `frontend/src/components/feedback/EmojiPicker.tsx` - Added TooltipProvider
2. `frontend/src/components/feedback/BadgeDisplay.tsx` - Added TooltipProvider

**Note**: Developer should update File List section with these modifications.

### Gate Status

Gate: **CONCERNS** → docs/qa/gates/6.5-feedback-enhancements-badges-emoji-reactions.yml

**Reason**: Implementation is functionally complete, but story documentation sections are incomplete:
- Dev Agent Record: Empty
- File List: Empty
- Task checkboxes: Not marked complete

### Recommended Status

**✗ Changes Required** - Complete the following before marking as Done:
1. Fill out Dev Agent Record section (Agent Model, Debug Log, Completion Notes)
2. Document all created/modified files in File List section
3. Mark completed tasks with [x] in Tasks/Subtasks section

Once documentation is complete, story can be marked as Done.
