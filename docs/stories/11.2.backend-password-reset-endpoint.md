# Story 11.2: Backend - Password Reset Endpoint

**Status:** Done
**Epic:** Epic 11 - Secure Password Management & Email Notifications
**Story Points:** 3
**Priority:** High
**Dependencies:** Story 11.1 (Secure Password Infrastructure)

---

## User Story

As an **admin or publisher**,
I want **to reset a user's password without seeing their new password**,
So that **user credentials remain secure while I can still help users who are locked out**.

---

## Background & Context

### Current State (Security Issue)

The current reset password implementation returns the new password to the admin:

```python
# Current: Returns password to UI (INSECURE)
return {"new_password": new_password, "message": "Password reset successfully"}
```

This allows admins to see and potentially misuse user passwords.

### Target State

- Admin triggers password reset
- System generates new temporary password
- Password is emailed to user (if they have email)
- Admin only sees confirmation message
- User must change password on next login

---

## Acceptance Criteria

### Functional Requirements

1. [x] Existing reset password endpoint modified to NOT return the new password
2. [x] New temporary password sent via email to user (if user has email)
3. [x] `must_change_password` set to `true` after reset
4. [x] Admin receives confirmation message only
5. [x] If user has no email, return temp password in response (one-time display)
6. [x] Permission checks enforced:
   - Admin can reset any user's password
   - Publisher can reset their teachers' and students' passwords only

### Integration Requirements

7. [x] Uses existing email service infrastructure
8. [x] Uses existing `generate_temp_password()` function
9. [x] Compatible with frontend reset password UI

### Quality Requirements

10. [x] Unit tests for all permission scenarios
11. [x] Test email is sent
12. [x] Test `must_change_password` flag is set

---

## Technical Design

### Endpoint Changes

**Current endpoint location:** Multiple locations (admin.py has reset password logic)

**New/Updated endpoint:**

```python
# backend/app/api/routes/admin.py

class PasswordResetResponse(SQLModel):
    """Response for password reset - never contains the actual password"""
    success: bool
    message: str
    password_emailed: bool
    temporary_password: str | None = None  # Only if user has no email


@router.post("/users/{user_id}/reset-password", response_model=PasswordResetResponse)
def reset_user_password(
    user_id: uuid.UUID,
    session: SessionDep,
    current_user: CurrentUser,
) -> PasswordResetResponse:
    """
    Reset a user's password. Admin can reset any user.
    Publisher can reset their teachers/students only.

    - Generates new temporary password
    - Sends via email if user has email address
    - Sets must_change_password = True
    - Does NOT return password (unless user has no email)
    """
    # Get user
    user = session.get(User, user_id)
    if not user:
        raise HTTPException(status_code=404, detail="User not found")

    # Permission check
    if current_user.role == UserRole.admin:
        pass  # Admin can reset anyone
    elif current_user.role == UserRole.publisher:
        # Publisher can only reset their teachers/students
        if not _is_user_under_publisher(session, current_user, user):
            raise HTTPException(status_code=403, detail="Not authorized to reset this user's password")
    else:
        raise HTTPException(status_code=403, detail="Only admin or publisher can reset passwords")

    # Generate new password
    new_password = generate_temp_password()

    # Update user
    user.hashed_password = get_password_hash(new_password)
    user.must_change_password = True
    session.add(user)
    session.commit()

    # Send email if user has email
    password_emailed = False
    temp_password_for_response = None

    if user.email and settings.emails_enabled:
        email_data = generate_password_reset_email(
            email_to=user.email,
            username=user.username,
            password=new_password
        )
        send_email(
            email_to=user.email,
            subject=email_data.subject,
            html_content=email_data.html_content
        )
        password_emailed = True
        message = f"Password reset successfully. New password sent to {user.email}"
    else:
        temp_password_for_response = new_password
        message = "Password reset successfully. Please share the temporary password securely with the user."

    return PasswordResetResponse(
        success=True,
        message=message,
        password_emailed=password_emailed,
        temporary_password=temp_password_for_response
    )
```

### Helper Function for Publisher Permission Check

```python
def _is_user_under_publisher(session: Session, publisher_user: User, target_user: User) -> bool:
    """Check if target user is a teacher or student under the publisher's schools"""
    publisher = session.exec(
        select(Publisher).where(Publisher.user_id == publisher_user.id)
    ).first()

    if not publisher:
        return False

    if target_user.role == UserRole.teacher:
        # Check if teacher is in any of publisher's schools
        teacher = session.exec(
            select(Teacher).where(Teacher.user_id == target_user.id)
        ).first()
        if teacher:
            # Check school association
            return any(school.publisher_id == publisher.id for school in teacher.schools)

    elif target_user.role == UserRole.student:
        # Check if student is in any of publisher's schools
        student = session.exec(
            select(Student).where(Student.user_id == target_user.id)
        ).first()
        if student and student.school:
            return student.school.publisher_id == publisher.id

    return False
```

### New Email Template Function

```python
# backend/app/utils.py

def generate_password_reset_email(
    email_to: str, username: str, password: str
) -> EmailData:
    project_name = settings.PROJECT_NAME
    subject = f"{project_name} - Password Reset"
    html_content = render_email_template(
        template_name="password_reset.html",
        context={
            "project_name": settings.PROJECT_NAME,
            "username": username,
            "password": password,
            "email": email_to,
            "link": settings.FRONTEND_HOST,
        },
    )
    return EmailData(html_content=html_content, subject=subject)
```

### Email Template

Create new email template: `backend/app/email-templates/build/password_reset.html`

```html
<!DOCTYPE html>
<html>
<head>
    <title>Password Reset - {{ project_name }}</title>
</head>
<body>
    <h1>Password Reset</h1>
    <p>Hello {{ username }},</p>
    <p>Your password has been reset by an administrator.</p>
    <p>Your new temporary password is: <strong>{{ password }}</strong></p>
    <p>Please log in and change your password immediately.</p>
    <p><a href="{{ link }}">Log in to {{ project_name }}</a></p>
    <p>If you did not request this password reset, please contact your administrator.</p>
</body>
</html>
```

---

## Tasks & Subtasks

### Task 1: Create Email Template

**Estimated effort:** 30 minutes

1. [x] Create `password_reset_by_admin.html` template
2. [x] Add `generate_password_reset_by_admin_email` function to utils.py

### Task 2: Update Reset Password Endpoint

**Estimated effort:** 1.5 hours

1. [x] Create `PasswordResetResponse` schema
2. [x] Modify existing reset endpoint or create new unified endpoint
3. [x] Add permission checks for publisher role
4. [x] Set `must_change_password = True` after reset
5. [x] Send email if user has email address
6. [x] Return temp password only if user has no email

### Task 3: Add Publisher Permission Helper

**Estimated effort:** 1 hour

1. [x] Implement `_is_user_under_publisher` helper function
2. [x] Test with various school/teacher/student relationships

### Task 4: Write Tests

**Estimated effort:** 1.5 hours

1. [x] Test admin can reset any user's password
2. [x] Test publisher can reset their teacher's password
3. [x] Test publisher can reset their student's password
4. [x] Test publisher cannot reset another publisher's users
5. [x] Test email is sent when user has email
6. [x] Test temp password returned when user has no email
7. [x] Test `must_change_password` is set to true

---

## Definition of Done

- [x] Reset password endpoint does not return password (unless no email)
- [x] Email sent to user with new temporary password
- [x] `must_change_password` flag set after reset
- [x] Permission checks working (admin all, publisher own users only)
- [x] All tests passing
- [x] Email template created and working

---

## API Response Examples

### Successful Reset (User has email)

```json
{
  "success": true,
  "message": "Password reset successfully. New password sent to teacher@school.com",
  "password_emailed": true,
  "temporary_password": null
}
```

### Successful Reset (User has no email)

```json
{
  "success": true,
  "message": "Password reset successfully. Please share the temporary password securely with the user.",
  "password_emailed": false,
  "temporary_password": "Abc123!@#xyz"
}
```

### Permission Denied

```json
{
  "detail": "Not authorized to reset this user's password"
}
```

---

## Risk Mitigation

- **Primary Risk:** Breaking existing reset password functionality
- **Mitigation:** Keep endpoint path compatible, only change response structure
- **Rollback Plan:** Revert endpoint changes; no database changes in this story

---

## Testing Commands

```bash
# Test admin reset
curl -X POST "http://localhost:8001/api/v1/admin/users/{user_id}/reset-password" \
  -H "Authorization: Bearer $ADMIN_TOKEN"

# Test publisher reset (should work for their teachers)
curl -X POST "http://localhost:8001/api/v1/admin/users/{teacher_user_id}/reset-password" \
  -H "Authorization: Bearer $PUBLISHER_TOKEN"

# Test publisher reset (should fail for other publisher's teachers)
curl -X POST "http://localhost:8001/api/v1/admin/users/{other_teacher_id}/reset-password" \
  -H "Authorization: Bearer $PUBLISHER_TOKEN"
# Expected: 403 Forbidden
```

---

## Notes

- This story builds on Story 11.1's `must_change_password` field
- Frontend changes to handle new response format are in Story 11.4
- The actual first-login password change flow is in Story 11.3

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### File List
| File | Status |
|------|--------|
| `backend/app/email-templates/build/password_reset_by_admin.html` | Created |
| `backend/app/utils.py` | Modified (added `generate_password_reset_by_admin_email`) |
| `backend/app/models.py` | Modified (updated `PasswordResetResponse` schema) |
| `backend/app/api/routes/admin.py` | Modified (updated `reset_user_password`, added `_is_user_under_publisher`) |
| `backend/app/tests/test_api/test_admin.py` | Modified (updated and added tests) |

### Change Log
- Created HTML email template for admin-initiated password resets
- Added `generate_password_reset_by_admin_email()` function to utils.py
- Updated `PasswordResetResponse` schema to not include password unless user has no email
- Updated `reset_user_password` endpoint to:
  - Send email with temp password when user has email and SMTP is configured
  - Return temp password in response only when user has no email
  - Set `must_change_password = True` after reset
  - Allow publishers to reset passwords for their teachers/students only
- Added `_is_user_under_publisher()` async helper to check publisher permissions
- Updated 12 password reset tests and added 4 new publisher permission tests

### Completion Notes
- All 38 admin tests pass
- The endpoint now sends emails via existing SMTP infrastructure when configured
- Publisher permission check traverses Student → ClassStudent → Class → School → Publisher
- Fallback to returning temp password works when emails are disabled or user has no email

---

## QA Results

### Review Date: 2025-12-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent implementation** with strong security focus and comprehensive test coverage.

The implementation correctly addresses the security issue of exposing passwords to admins. Key strengths:
- Clean separation of email vs fallback paths
- Proper async implementation with `AsyncSessionDep`
- Well-documented helper function with clear traversal path for students
- Comprehensive permission model (admin all, publisher scoped)
- Good logging for audit trail

### Refactoring Performed

None required. The code is well-structured and follows project patterns.

### Compliance Check

- Coding Standards: ✓ Follows Python/FastAPI patterns from `coding-standards.md`
- Project Structure: ✓ Files in correct locations per `source-tree.md`
- Testing Strategy: ✓ Unit tests with mocks for email, proper fixtures
- All ACs Met: ✓ All 12 acceptance criteria verified

### Test Coverage Analysis

| AC | Requirement | Test(s) | Status |
|----|-------------|---------|--------|
| 1 | Endpoint NOT return password | `test_reset_password_sends_email_when_enabled` | ✓ |
| 2 | Temp password sent via email | `test_reset_password_sends_email_when_enabled` | ✓ |
| 3 | `must_change_password` set | `test_reset_password_sets_must_change_password` | ✓ |
| 4 | Admin receives confirmation only | `test_reset_password_sends_email_when_enabled` | ✓ |
| 5 | Fallback: return password if no email | `test_reset_password_success_no_email`, `test_reset_password_with_email_disabled` | ✓ |
| 6 | Permission checks | `TestPublisherPasswordReset` (4 tests) | ✓ |
| 7 | Uses existing email service | Uses `send_email` from `utils.py` | ✓ |
| 8 | Uses `generate_temp_password` | Confirmed in endpoint code | ✓ |
| 9 | Frontend compatible | Response schema defined | ✓ |
| 10 | Unit tests for permissions | 16 passing tests | ✓ |
| 11 | Test email sent | `mock_send_email.assert_called_once()` | ✓ |
| 12 | Test `must_change_password` | `test_reset_password_sets_must_change_password` | ✓ |

### Improvements Checklist

- [x] All acceptance criteria implemented
- [x] All tests passing (16/16 password reset tests)
- [x] Permission checks for admin and publisher roles
- [x] Email template created with professional styling
- [x] Proper error handling (404, 403)
- [x] Notification created for user on password reset
- [x] Logging for audit trail
- [ ] Consider adding rate limiting to prevent password reset abuse (future)
- [ ] Consider email template localization (future)

### Security Review

**Status: PASS**

Security controls are well-implemented:
1. **Password exposure prevented**: Password only returned when user has no email (acceptable fallback)
2. **Admin protection**: Cannot reset other admin passwords via this endpoint
3. **Publisher scoping**: Publishers can only reset their own teachers/students
4. **Forced password change**: `must_change_password = True` ensures user changes temporary password
5. **Audit logging**: Password resets are logged with actor information
6. **User notification**: User is notified via in-app notification

**Minor future consideration**: Rate limiting not present, but acceptable for admin/publisher-only endpoint.

### Performance Considerations

**Status: PASS**

- Student permission check traverses ClassStudent → Class → School chain, but this is a low-frequency admin operation
- No N+1 query issues (uses individual lookups, acceptable for single-user reset)

### Files Modified During Review

None - code quality is good, no refactoring needed.

### Gate Status

Gate: **PASS** → `docs/qa/gates/11.2-backend-password-reset-endpoint.yml`

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, no security concerns.
