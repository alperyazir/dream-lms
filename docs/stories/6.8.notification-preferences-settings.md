# Story 6.8: Notification Preferences & Settings

**Epic:** 6 - Communication, Feedback & Supplementary Materials
**Story ID:** 6.8
**Status:** Done
**Created:** 2025-12-02
**Developer:** (Pending Assignment)

---

## Story

**As a** user of any role,
**I want** to customize my notification preferences,
**so that** I receive notifications that matter to me without being overwhelmed.

---

## Acceptance Criteria

1. User settings page includes "Notifications" tab with preference controls
2. NotificationPreference model: id, user_id (FK), notification_type, enabled (boolean), email_enabled (boolean, future email notifications)
3. Preferences page lists all notification types relevant to user role with toggle switches
4. **Student Notification Preferences**: Assignment Created (on/off), Deadline Approaching (on/off), Feedback Received (on/off), Message Received (on/off)
5. **Teacher Notification Preferences**: Student Completed Assignment (on/off), Message Received (on/off), System Announcements (on/off)
6. **Admin/Publisher Notification Preferences**: System Announcements (on/off), User Activity Alerts (on/off)
7. Default settings: All notifications enabled for new users
8. Changing preference immediately updates database and affects future notifications
9. API endpoint `GET /api/v1/users/me/notification-preferences` returns current preferences
10. API endpoint `PATCH /api/v1/users/me/notification-preferences` updates preferences
11. NotificationService checks user preferences before creating notifications (respects enabled flags)
12. Settings page includes "Email Notifications" section (disabled/grayed out with "Coming soon" label - future phase)
13. Global notification mute: "Pause all notifications" toggle for temporary silence (24-hour max)
14. Unit tests verify preference filtering logic
15. Integration tests verify notifications respect user preferences

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create NotificationPreference Model** (AC: 2)
  - [ ] Add `NotificationPreference` SQLModel to `backend/app/models.py`
  - [ ] Fields: id (UUID), user_id (FK), notification_type (NotificationType), enabled (bool, default True), email_enabled (bool, default False)
  - [ ] Add unique constraint on (user_id, notification_type)
  - [ ] Add index on user_id for efficient lookups
  - [ ] Generate Alembic migration for notification_preferences table

- [ ] **Task 2: Create Preference Schemas** (AC: 9, 10)
  - [ ] Create `backend/app/schemas/notification_preference.py`
  - [ ] Define `NotificationPreferenceResponse` schema
  - [ ] Define `NotificationPreferenceUpdate` schema (partial update)
  - [ ] Define `NotificationPreferencesListResponse` with role-specific types
  - [ ] Define `GlobalMuteRequest` and `GlobalMuteResponse` schemas

- [ ] **Task 3: Extend NotificationService for Preferences** (AC: 7, 11, 13)
  - [ ] Update `backend/app/services/notification_service.py`
  - [ ] Add `get_user_preferences(db, user_id)` method
  - [ ] Add `update_preference(db, user_id, notification_type, enabled)` method
  - [ ] Add `initialize_default_preferences(db, user_id, role)` for new users
  - [ ] Add `is_notification_enabled(db, user_id, notification_type)` check
  - [ ] Add `set_global_mute(db, user_id, muted_until)` method
  - [ ] Add `check_global_mute(db, user_id)` method
  - [ ] Modify `create_notification()` to check preferences before creating
  - [ ] Return gracefully (no notification) if preference disabled

- [ ] **Task 4: Create Preferences API Endpoints** (AC: 9, 10, 13)
  - [ ] Update `backend/app/api/routes/notifications.py`
  - [ ] `GET /api/v1/notifications/preferences` - Get all preferences for user
  - [ ] `PATCH /api/v1/notifications/preferences` - Update multiple preferences
  - [ ] `PATCH /api/v1/notifications/preferences/{type}` - Update single preference
  - [ ] `POST /api/v1/notifications/mute` - Set global mute (max 24 hours)
  - [ ] `DELETE /api/v1/notifications/mute` - Cancel global mute
  - [ ] `GET /api/v1/notifications/mute` - Get current mute status

- [ ] **Task 5: Role-Based Preference Types** (AC: 3, 4, 5, 6)
  - [ ] Create `ROLE_NOTIFICATION_TYPES` mapping in notification service
  - [ ] Student types: assignment_created, deadline_approaching, feedback_received, message_received
  - [ ] Teacher types: student_completed, message_received, system_announcement
  - [ ] Admin/Publisher types: system_announcement (extend as needed)
  - [ ] Filter returned preferences by user role
  - [ ] Reject updates to notification types not applicable to user role

- [ ] **Task 6: Initialize Preferences on User Creation** (AC: 7)
  - [ ] Hook into user creation flow (Story 1.2 patterns)
  - [ ] Call `initialize_default_preferences()` when user is created
  - [ ] All preferences default to enabled=True, email_enabled=False
  - [ ] Consider lazy initialization on first GET if not present

- [ ] **Task 7: Backend Unit Tests** (AC: 14)
  - [ ] Create tests in `backend/app/tests/test_services/test_notification_service.py`
  - [ ] Test `get_user_preferences` returns correct types for role
  - [ ] Test `update_preference` updates correctly
  - [ ] Test `is_notification_enabled` returns correct value
  - [ ] Test `create_notification` respects disabled preferences
  - [ ] Test global mute blocks all notifications
  - [ ] Test global mute expires after 24 hours

- [ ] **Task 8: Backend Integration Tests** (AC: 15)
  - [ ] Add tests to `backend/app/tests/test_api/test_notifications.py`
  - [ ] Test GET preferences returns role-appropriate types
  - [ ] Test PATCH preferences updates correctly
  - [ ] Test disabled preference prevents notification creation
  - [ ] Test global mute endpoints work correctly
  - [ ] Test preferences persist across sessions

### Frontend Tasks

- [ ] **Task 9: Create Preference Types and API** (AC: 9, 10)
  - [ ] Update `frontend/src/types/notification.ts`
  - [ ] Add `NotificationPreference` interface
  - [ ] Add `NotificationPreferencesResponse` interface
  - [ ] Add `GlobalMuteStatus` interface
  - [ ] Update `frontend/src/services/notificationsApi.ts`
  - [ ] Add `getPreferences()` function
  - [ ] Add `updatePreference(type, enabled)` function
  - [ ] Add `setGlobalMute(hours)` function
  - [ ] Add `cancelGlobalMute()` function
  - [ ] Add `getGlobalMuteStatus()` function

- [ ] **Task 10: Create useNotificationPreferences Hook** (AC: 8)
  - [ ] Create `frontend/src/hooks/useNotificationPreferences.ts`
  - [ ] Query for preferences with TanStack Query
  - [ ] Mutation for updating preferences with optimistic updates
  - [ ] Mutation for global mute
  - [ ] Invalidate queries on successful mutations

- [ ] **Task 11: Create NotificationPreferences Component** (AC: 1, 3, 4, 5, 6)
  - [ ] Create `frontend/src/components/UserSettings/NotificationPreferences.tsx`
  - [ ] Display notification types based on user role
  - [ ] Use Shadcn Switch component for toggles
  - [ ] Group by category (Assignments, Communication, System)
  - [ ] Show type name, description, and toggle switch
  - [ ] Loading state with skeleton switches
  - [ ] Error handling with retry option

- [ ] **Task 12: Create GlobalMuteSection Component** (AC: 13)
  - [ ] Create section within NotificationPreferences
  - [ ] "Pause All Notifications" toggle
  - [ ] When enabled, show duration selector (1h, 4h, 8h, 24h)
  - [ ] Display countdown when mute is active
  - [ ] "Resume notifications" button to cancel early

- [x] **Task 13: Create EmailNotificationsSection Component** (AC: 12)
  - [x] Create section within NotificationPreferences
  - [x] Display all email toggles as disabled/grayed out
  - [x] Show "Coming soon" badge next to section title
  - [x] Placeholder for future email notification settings

- [ ] **Task 14: Integrate into Settings Page** (AC: 1)
  - [ ] Update `frontend/src/routes/_layout/settings.tsx`
  - [ ] Add "Notifications" tab to tabsConfig array
  - [ ] Position after "Appearance" tab
  - [ ] Import and use NotificationPreferences component

- [ ] **Task 15: Add Preference Labels and Descriptions** (AC: 4, 5, 6)
  - [ ] Create `frontend/src/lib/notificationPreferenceLabels.ts`
  - [ ] Define labels for each notification type:
    - assignment_created: "New Assignments" / "Notify when you're assigned new work"
    - deadline_approaching: "Deadline Reminders" / "Notify when assignments are due soon"
    - feedback_received: "Feedback Received" / "Notify when teachers provide feedback"
    - message_received: "New Messages" / "Notify when you receive direct messages"
    - student_completed: "Student Completions" / "Notify when students complete assignments"
    - system_announcement: "System Announcements" / "Important system updates and news"
  - [ ] Export function to get label/description by type

- [ ] **Task 16: Frontend Component Tests** (AC: 14)
  - [ ] Create `frontend/src/components/UserSettings/__tests__/NotificationPreferences.test.tsx`
  - [ ] Test renders correct preferences for student role
  - [ ] Test renders correct preferences for teacher role
  - [ ] Test toggle updates preference via mutation
  - [ ] Test global mute toggle and duration selector
  - [ ] Test email section is disabled with "Coming soon"
  - [ ] Test loading and error states

---

## Dev Notes

### Previous Story Insights (Story 6.1)
[Source: docs/stories/6.1.notification-system-foundation.md#Dev Agent Record]

- NotificationType enum already exists in `backend/app/models.py`
- NotificationService exists in `backend/app/services/notification_service.py`
- Notification API routes exist in `backend/app/api/routes/notifications.py`
- Frontend notification hooks exist in `frontend/src/hooks/useNotifications.ts`
- 34 backend tests and 30 frontend tests for notifications already pass
- Settings page exists at `frontend/src/routes/_layout/settings.tsx` with tabs pattern

### Data Models
[Source: docs/architecture/2-database-schema-design.md#2.2.5]

**NotificationPreference Table (to be added):**
```sql
CREATE TABLE notification_preferences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    notification_type notification_type NOT NULL,
    enabled BOOLEAN DEFAULT true,
    email_enabled BOOLEAN DEFAULT false,

    UNIQUE(user_id, notification_type)
);

CREATE INDEX idx_notification_preferences_user_id ON notification_preferences(user_id);
```

**SQLModel Implementation:**
```python
class NotificationPreference(SQLModel, table=True):
    """User notification preference settings."""

    __tablename__ = "notification_preferences"

    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    user_id: uuid.UUID = Field(foreign_key="user.id", index=True, ondelete="CASCADE")
    notification_type: NotificationType = Field(
        sa_column=Column(SAEnum(NotificationType, name="notification_type"), nullable=False)
    )
    enabled: bool = Field(default=True)
    email_enabled: bool = Field(default=False)

    # Composite unique constraint
    __table_args__ = (
        UniqueConstraint("user_id", "notification_type", name="uq_user_notification_type"),
    )
```

**Global Mute (add to User model or separate table):**
```python
# Option 1: Add to User model
notifications_muted_until: datetime | None = Field(default=None)

# Option 2: Separate table (more flexible)
class NotificationMute(SQLModel, table=True):
    __tablename__ = "notification_mutes"

    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    user_id: uuid.UUID = Field(foreign_key="user.id", unique=True, ondelete="CASCADE")
    muted_until: datetime
    created_at: datetime = Field(default_factory=lambda: datetime.now(UTC))
```

### API Specifications
[Source: docs/architecture/3-api-architecture.md#3.4.7]

**Endpoints:**
```
GET    /api/v1/notifications/preferences             # Get all preferences for user
PATCH  /api/v1/notifications/preferences             # Bulk update preferences
PATCH  /api/v1/notifications/preferences/{type}      # Update single preference
POST   /api/v1/notifications/mute                    # Set global mute
DELETE /api/v1/notifications/mute                    # Cancel global mute
GET    /api/v1/notifications/mute                    # Get mute status
```

**Request/Response Examples:**

```python
# GET /api/v1/notifications/preferences
{
    "preferences": [
        {
            "notification_type": "assignment_created",
            "enabled": true,
            "email_enabled": false,
            "label": "New Assignments",
            "description": "Notify when you're assigned new work"
        },
        {
            "notification_type": "deadline_approaching",
            "enabled": true,
            "email_enabled": false,
            "label": "Deadline Reminders",
            "description": "Notify when assignments are due soon"
        }
        // ... more based on user role
    ],
    "global_mute": null  // or { "muted_until": "2025-12-02T18:00:00Z" }
}

# PATCH /api/v1/notifications/preferences
# Request
{
    "assignment_created": true,
    "deadline_approaching": false,
    "feedback_received": true
}

# Response
{
    "updated": ["deadline_approaching"],
    "preferences": [...]
}

# POST /api/v1/notifications/mute
# Request
{
    "hours": 4  // Max 24
}

# Response
{
    "muted_until": "2025-12-02T18:00:00Z",
    "remaining_hours": 4.0
}
```

### Role-Based Notification Types
[Source: docs/prd/epic-6-communication-feedback-supplementary-materials.md#Story 6.8]

```python
ROLE_NOTIFICATION_TYPES = {
    UserRole.student: [
        NotificationType.assignment_created,
        NotificationType.deadline_approaching,
        NotificationType.feedback_received,
        NotificationType.message_received,
        NotificationType.material_shared,
    ],
    UserRole.teacher: [
        NotificationType.student_completed,
        NotificationType.message_received,
        NotificationType.system_announcement,
    ],
    UserRole.admin: [
        NotificationType.system_announcement,
        # Add more admin-specific types as needed
    ],
    UserRole.publisher: [
        NotificationType.system_announcement,
        # Add more publisher-specific types as needed
    ],
}
```

### File Locations
[Source: docs/architecture/source-tree.md]

**Backend (Modify):**
- `backend/app/models.py` - Add NotificationPreference model
- `backend/app/services/notification_service.py` - Add preference methods
- `backend/app/api/routes/notifications.py` - Add preference endpoints
- `backend/app/tests/test_api/test_notifications.py` - Add preference tests

**Backend (New):**
- `backend/app/schemas/notification_preference.py` - Preference schemas
- `backend/app/alembic/versions/XXXX_add_notification_preferences.py` - Migration

**Frontend (Modify):**
- `frontend/src/types/notification.ts` - Add preference types
- `frontend/src/services/notificationsApi.ts` - Add preference API calls
- `frontend/src/routes/_layout/settings.tsx` - Add Notifications tab

**Frontend (New):**
- `frontend/src/hooks/useNotificationPreferences.ts` - Preference hooks
- `frontend/src/components/UserSettings/NotificationPreferences.tsx` - Main component
- `frontend/src/lib/notificationPreferenceLabels.ts` - Labels/descriptions

### Existing Settings Page Pattern
[Source: frontend/src/routes/_layout/settings.tsx]

```typescript
const tabsConfig = [
  { value: "my-profile", title: "My profile", component: UserInformation },
  { value: "password", title: "Password", component: ChangePassword },
  { value: "appearance", title: "Appearance", component: Appearance },
  { value: "notifications", title: "Notifications", component: NotificationPreferences }, // ADD THIS
  { value: "danger-zone", title: "Danger zone", component: DeleteAccount },
]
```

### Component Patterns
[Source: docs/architecture/5-frontend-architecture.md]

**Preference Toggle Pattern (using Shadcn Switch):**
```typescript
import { Switch } from "@/components/ui/switch"
import { Label } from "@/components/ui/label"

interface PreferenceToggleProps {
  id: string
  label: string
  description: string
  checked: boolean
  disabled?: boolean
  onCheckedChange: (checked: boolean) => void
}

function PreferenceToggle({
  id,
  label,
  description,
  checked,
  disabled,
  onCheckedChange,
}: PreferenceToggleProps) {
  return (
    <div className="flex items-center justify-between py-4 border-b">
      <div className="space-y-0.5">
        <Label htmlFor={id} className="text-base font-medium">
          {label}
        </Label>
        <p className="text-sm text-muted-foreground">{description}</p>
      </div>
      <Switch
        id={id}
        checked={checked}
        disabled={disabled}
        onCheckedChange={onCheckedChange}
      />
    </div>
  )
}
```

### NotificationService Preference Check
[Source: backend/app/services/notification_service.py]

```python
async def create_notification(
    db: AsyncSession,
    user_id: uuid.UUID,
    notification_type: NotificationType,
    title: str,
    message: str,
    link: str | None = None,
) -> Notification | None:  # Changed return type to allow None
    """Create notification if user preferences allow."""

    # Check if user has muted all notifications
    if await check_global_mute(db, user_id):
        return None

    # Check if this notification type is enabled
    if not await is_notification_enabled(db, user_id, notification_type):
        return None

    # Original implementation...
    notification = Notification(...)
    db.add(notification)
    await db.commit()
    await db.refresh(notification)
    return notification
```

---

## Testing

### Test File Locations
[Source: docs/architecture/source-tree.md]

- Backend tests: `backend/app/tests/test_api/test_notifications.py` (extend)
- Backend service tests: `backend/app/tests/test_services/test_notification_service.py` (extend)
- Frontend tests: `frontend/src/components/UserSettings/__tests__/NotificationPreferences.test.tsx`

### Testing Patterns
[Source: docs/architecture/coding-standards.md]

```python
# Backend preference tests
@pytest.mark.asyncio
async def test_get_preferences_returns_role_types(
    client: AsyncClient,
    student_token: str
):
    """Test that preferences returns only student-applicable types."""
    response = await client.get(
        "/api/v1/notifications/preferences",
        headers={"Authorization": f"Bearer {student_token}"}
    )

    assert response.status_code == 200
    data = response.json()
    types = [p["notification_type"] for p in data["preferences"]]

    # Student should have these types
    assert "assignment_created" in types
    assert "deadline_approaching" in types
    assert "feedback_received" in types

    # Student should NOT have teacher types
    assert "student_completed" not in types


@pytest.mark.asyncio
async def test_disabled_preference_blocks_notification(
    client: AsyncClient,
    db: AsyncSession,
    student_user: User
):
    """Test that disabled preference prevents notification creation."""
    # Disable deadline_approaching
    await notification_service.update_preference(
        db, student_user.id, NotificationType.deadline_approaching, enabled=False
    )

    # Try to create notification
    notification = await notification_service.create_notification(
        db,
        user_id=student_user.id,
        notification_type=NotificationType.deadline_approaching,
        title="Test",
        message="Test message"
    )

    # Should return None (not created)
    assert notification is None


@pytest.mark.asyncio
async def test_global_mute_blocks_all_notifications(
    client: AsyncClient,
    db: AsyncSession,
    student_user: User
):
    """Test that global mute blocks all notification types."""
    # Set global mute for 1 hour
    await notification_service.set_global_mute(db, student_user.id, hours=1)

    # Try to create notification
    notification = await notification_service.create_notification(
        db,
        user_id=student_user.id,
        notification_type=NotificationType.assignment_created,
        title="New Assignment",
        message="You have a new assignment"
    )

    # Should return None (blocked by mute)
    assert notification is None
```

### Test Scenarios Required

**Backend Preference Tests:**
- Get preferences returns role-appropriate types
- Update preference changes enabled status
- Create notification respects disabled preference
- Create notification respects global mute
- Global mute expires after specified time
- Default preferences are enabled for new users
- Cannot update notification types not applicable to role

**Frontend Component Tests:**
- Renders correct toggles for student role
- Renders correct toggles for teacher role
- Toggle change calls updatePreference mutation
- Global mute toggle shows duration selector
- Email section is disabled with "Coming soon"
- Loading state shows skeleton switches
- Error state shows retry option

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-02 | 1.0 | Initial story draft | Bob (SM Agent) |
| 2025-12-02 | 1.1 | Story approved - ready for development | Bob (SM Agent) |
| 2025-12-02 | 1.2 | QA fix: Added EmailNotificationsSection (AC12) | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20250929

### Debug Log References

N/A - QA fix implementation was straightforward with no debugging required.

### Completion Notes

**QA Fix Applied (2025-12-02):**
- Addressed AC-012 from QA gate review (CONCERNS status)
- Added `EmailNotificationsSection` component to `NotificationSettings.tsx`
- Component includes:
  - Mail icon with section header
  - "Coming soon" badge (styled inline span)
  - Three disabled email preference toggles (Assignment Updates, Feedback, Messages)
  - Opacity 50% to indicate disabled state
  - Explanatory italic text for future availability
- All 72 backend tests pass
- TypeScript compilation successful

### File List

**Modified:**
- `frontend/src/components/UserSettings/NotificationSettings.tsx` - Added EmailNotificationsSection component (AC12)

---

## QA Results

### Review Date: 2025-12-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Overall implementation quality is **excellent**. The backend follows clean architecture patterns with proper separation between service and API layers. The frontend uses TanStack Query effectively with optimistic updates and rollback on error. Test coverage is comprehensive with 72 tests (37 service + 35 API) all passing.

**Strengths:**
- Well-structured models with proper constraints and indexes
- Lazy initialization of preferences prevents N+1 issues
- Timezone handling properly addressed in both service and API layers
- Role-based notification types correctly enforced
- Optimistic updates with rollback provide responsive UX

### Refactoring Performed

None required - code quality is good.

### Compliance Check

- Coding Standards: ✓ Clean code, proper documentation
- Project Structure: ✓ Files in expected locations
- Testing Strategy: ✓ Comprehensive unit and integration tests
- All ACs Met: ✗ AC12 (Email Notifications section) not implemented

### Improvements Checklist

**Required for PASS:**
- [x] Add EmailNotificationsSection component with disabled toggles and "Coming soon" badge (AC12)
- [x] Update story status from "Approved" to "Review" or "Done"
- [x] Fill Dev Agent Record sections (Agent Model, Debug Log, Completion Notes, File List)

**Nice to have (future):**
- [ ] Consider grouping preferences by category (Assignments, Communication, System)
- [ ] Consider adding preference sync indicator for offline scenarios

### Security Review

No security concerns. Role-based access control properly implemented - users can only view/modify their own preferences, and notification types are filtered by user role.

### Performance Considerations

- Lazy initialization ensures preferences are created on-demand
- Optimistic updates in frontend reduce perceived latency
- Proper database indexes on user_id columns
- No N+1 query patterns detected

### Files Modified During Review

None - no refactoring was required.

### Gate Status

**Gate: CONCERNS** → docs/qa/gates/6.8-notification-preferences-settings.yml

**Reason:** AC12 (Email Notifications section with "Coming soon" label) is not implemented in the NotificationSettings component.

### Recommended Status

✗ **Changes Required** - See unchecked items above

To achieve PASS:
1. Add the EmailNotificationsSection component per AC12 specification
2. Update story status and Dev Agent Record sections

(Story owner decides final status)

---

### Review Date: 2025-12-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Re-review following QA fix application.** The previously identified gap (AC12) has been addressed. Implementation quality remains **excellent**.

**AC12 Fix Verification:**
- `EmailNotificationsSection` component added to `NotificationSettings.tsx` (lines 169-211)
- Mail icon with section header ✓
- "Coming soon" badge (styled inline span) ✓
- Three disabled email preference toggles (Assignment Updates, Feedback, Messages) ✓
- Opacity 50% to indicate disabled state ✓
- Explanatory italic text for future availability ✓
- Component properly rendered in main component (line 293) ✓

### Refactoring Performed

None required - fix implementation is clean and follows existing patterns.

### Compliance Check

- Coding Standards: ✓ Clean code, proper documentation
- Project Structure: ✓ Files in expected locations
- Testing Strategy: ✓ Comprehensive unit and integration tests (72 passing)
- All ACs Met: ✓ All 15 acceptance criteria now implemented

### Acceptance Criteria Trace

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| 1 | Notifications tab in settings | ✓ | NotificationSettings component integrated |
| 2 | NotificationPreference model | ✓ | models.py, migration present |
| 3 | Role-relevant preferences | ✓ | ROLE_NOTIFICATION_TYPES mapping |
| 4 | Student preferences | ✓ | Tests verify student types |
| 5 | Teacher preferences | ✓ | Tests verify teacher types |
| 6 | Admin/Publisher preferences | ✓ | Tests verify admin types |
| 7 | Default enabled | ✓ | test_get_preferences_default_enabled |
| 8 | Immediate database update | ✓ | Optimistic updates + invalidation |
| 9 | GET preferences endpoint | ✓ | /api/v1/notifications/preferences |
| 10 | PATCH preferences endpoint | ✓ | Bulk and single update endpoints |
| 11 | Service checks preferences | ✓ | test_create_notification_respects_disabled_preference |
| 12 | Email section "Coming soon" | ✓ | EmailNotificationsSection component |
| 13 | Global mute (24h max) | ✓ | GlobalMuteSection + mute endpoints |
| 14 | Unit tests | ✓ | 37 service tests passing |
| 15 | Integration tests | ✓ | 35 API tests passing |

### Security Review

No security concerns. Role-based access control properly implemented.

### Performance Considerations

No concerns - implementation follows best practices.

### Files Modified During Review

None - no refactoring required.

### Gate Status

**Gate: PASS** → docs/qa/gates/6.8-notification-preferences-settings.yml

**Reason:** All 15 acceptance criteria implemented and verified. 72 tests passing. AC12 fix properly applied.

### Recommended Status

✓ **Ready for Done**

(Story owner decides final status)
