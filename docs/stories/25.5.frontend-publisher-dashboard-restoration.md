# Story 25.5: Frontend Publisher Dashboard Restoration

## Status: Ready for Review

## Story

As a publisher user, I need a working dashboard so that I can view my organization's stats, books, and manage assignments to teachers.
revi
## Acceptance Criteria

- [ ] Publisher dashboard loads without errors (no 410 responses)
- [ ] Profile section shows publisher name and logo from DCS
- [ ] Stats cards show correct school, teacher, and book counts
- [ ] Library page shows books from DCS for publisher
- [ ] Schools page shows publisher's schools
- [ ] Teachers page shows teachers in publisher's schools
- [ ] Book assignment to teachers works
- [ ] Graceful empty state if publisher has no data
- [ ] Error handling if DCS publisher not found

## Technical Design

### Update API Calls

```typescript
// frontend/src/services/publishersApi.ts

export async function getMyProfile(): Promise<PublisherProfile> {
  return PublishersService.getMyProfile()  // Now returns 200, not 410
}

export async function getMyStats(): Promise<PublisherStats> {
  return PublishersService.getMyStats()
}

export async function getMySchools(): Promise<SchoolPublic[]> {
  return PublishersService.getMySchools()
}

export async function getMyBooks(): Promise<Book[]> {
  return PublishersService.getMyBooks()
}
```

### Update Dashboard Component

```typescript
// frontend/src/routes/_layout/publisher/dashboard.tsx

function PublisherDashboard() {
  // These queries now call working endpoints
  const { data: profile, isLoading: profileLoading, error: profileError } = useQuery({
    queryKey: ["publisherProfile"],
    queryFn: () => PublishersService.getMyProfile(),
  })

  const { data: stats, isLoading: statsLoading } = useQuery({
    queryKey: ["publisherStats"],
    queryFn: () => PublishersService.getMyStats(),
  })

  // Handle account not linked to DCS publisher (403)
  if (profileError?.status === 403) {
    return (
      <div className="text-center py-12">
        <AlertCircle className="w-16 h-16 mx-auto text-amber-500 mb-4" />
        <h2 className="text-xl font-semibold mb-2">Account Not Linked</h2>
        <p className="text-muted-foreground">
          Your account is not linked to a publisher. Please contact an administrator.
        </p>
      </div>
    )
  }

  // Handle DCS publisher not found (404)
  if (profileError?.status === 404) {
    return (
      <div className="text-center py-12">
        <AlertCircle className="w-16 h-16 mx-auto text-red-500 mb-4" />
        <h2 className="text-xl font-semibold mb-2">Publisher Not Found</h2>
        <p className="text-muted-foreground">
          Your linked publisher was not found in the system.
        </p>
      </div>
    )
  }

  return (
    <div className="max-w-full p-6 space-y-8">
      {/* Header with Logo */}
      <div className="flex items-center gap-6">
        {profile && (
          <PublisherLogo
            publisherId={profile.id}
            size="lg"
            alt={`${profile.name} logo`}
          />
        )}
        <div>
          <h1 className="text-3xl font-bold">
            {profile?.name || "Publisher Dashboard"}
          </h1>
          <p className="text-muted-foreground">
            Welcome, {profile?.user_full_name}
          </p>
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <StatCard
          icon={<School className="w-6 h-6" />}
          label="Schools"
          value={stats?.schools_count || 0}
        />
        <StatCard
          icon={<Users className="w-6 h-6" />}
          label="Teachers"
          value={stats?.teachers_count || 0}
        />
        <StatCard
          icon={<BookOpen className="w-6 h-6" />}
          label="Books"
          value={stats?.books_count || 0}
        />
      </div>

      {/* Quick Actions */}
      <Card>
        <CardHeader>
          <CardTitle>Quick Actions</CardTitle>
        </CardHeader>
        <CardContent className="flex gap-4">
          <Button asChild>
            <Link to="/publisher/library">View Library</Link>
          </Button>
          <Button variant="outline" asChild>
            <Link to="/publisher/schools">Manage Schools</Link>
          </Button>
          <Button variant="outline" asChild>
            <Link to="/publisher/book-assignments">Assign Books</Link>
          </Button>
        </CardContent>
      </Card>
    </div>
  )
}
```

### Update Library Page

```typescript
// frontend/src/routes/_layout/publisher/library.tsx

function PublisherLibrary() {
  const { data: books, isLoading } = useQuery({
    queryKey: ["publisherBooks"],
    queryFn: () => PublishersService.getMyBooks(),
  })

  if (isLoading) return <LoadingSpinner />

  if (!books?.length) {
    return (
      <EmptyState
        icon={<BookOpen className="w-16 h-16" />}
        title="No Books Yet"
        description="Your books will appear here once added to Dream Central Storage."
      />
    )
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
      {books.map((book) => (
        <BookCard key={book.id} book={book} />
      ))}
    </div>
  )
}
```

### Response Types

```typescript
interface PublisherProfile {
  id: number  // DCS publisher ID
  name: string
  contact_email: string | null
  logo_url: string | null
  user_id: string  // LMS user ID
  user_email: string | null
  user_full_name: string | null
}

interface PublisherStats {
  schools_count: number
  teachers_count: number
  books_count: number
}
```

## Dev Notes

- All API calls should now work (endpoints restored in 25.3)
- Handle 403 (not linked) and 404 (DCS publisher gone) gracefully
- Reuse existing components (StatCard, BookCard, PublisherLogo)
- Ensure book assignment flow works with new API structure

## Testing Requirements

- [ ] Dashboard loads for linked publisher user
- [ ] Profile shows correct name/logo
- [ ] Stats show correct counts
- [ ] 403 error handled gracefully (not linked)
- [ ] 404 error handled gracefully (publisher deleted)
- [ ] Library shows books from DCS
- [ ] Empty state when no books
- [ ] Schools page lists correct schools
- [ ] Teachers page lists correct teachers
- [ ] Book assignment works end-to-end
- [ ] Navigation between publisher pages works

## Tasks

- [ ] Update publishersApi.ts with working calls
- [ ] Update dashboard.tsx error handling
- [ ] Update library.tsx to use new API
- [ ] Update schools.tsx to use new API
- [ ] Update teachers.tsx to use new API
- [ ] Update book-assignments.tsx
- [ ] Regenerate OpenAPI client
- [ ] Test all publisher flows
- [ ] Write component tests

## File List

| File | Action |
|------|--------|
| `frontend/src/services/publishersApi.ts` | Modified (use generated client) |
| `frontend/src/routes/_layout/publisher/dashboard.tsx` | Modified (error handling, correct fields) |
| `frontend/src/routes/_layout/publisher/library.tsx` | Modified (use PublisherLogo) |
| `frontend/src/routes/_layout/publisher/schools.tsx` | Modified (createMySchool, number[] IDs) |
| `frontend/src/routes/_layout/publisher/teachers.tsx` | Modified (createMyTeacher, number[] IDs) |
| `frontend/src/routes/_layout/publisher/book-assignments.tsx` | Modified (SelectItem value type) |
| `frontend/src/routes/_layout/publisher/__tests__/dashboard.test.tsx` | Created (unit tests) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Tasks
- [x] Update API service
- [x] Fix dashboard
- [x] Fix library
- [x] Fix schools
- [x] Fix teachers
- [x] Fix book assignments
- [x] Regenerate client (completed in 25.4)
- [x] Test flows
- [x] Write component tests

### Debug Log
- Fixed publishersApi.ts to use generated client instead of custom axios implementation
- Dashboard was using wrong field names: `active_schools` → `schools_count`, `total_teachers` → `teachers_count`
- schools.tsx and teachers.tsx used wrong methods: `createSchool` → `createMySchool`, `createTeacher` → `createMyTeacher`
- Fixed book ID type mismatch: `selectedBookIds` changed from `string[]` to `number[]` (DCS IDs are integers)
- Fixed book-assignments.tsx SelectItem value: `book.id` converted to `String(book.id)`
- library.tsx updated to use PublisherLogo component instead of custom image handling

### Completion Notes
- Rewrote publishersApi.ts to use generated OpenAPI client with proper types
- Updated dashboard.tsx with proper error handling for 403 (not linked) and 404 (publisher not found) responses
- Added Quick Actions card with links to library, schools, teachers, and book-assignments pages
- Updated library.tsx to use PublisherLogo component for consistent DCS logo display
- Fixed schools.tsx to use `createMySchool` endpoint and `number[]` for book IDs
- Fixed teachers.tsx to use `createMyTeacher` endpoint and `number[]` for book IDs
- Fixed book-assignments.tsx to convert book.id to string for SelectItem value
- Created comprehensive test suite with 16 tests covering API interactions, stats, profile, schools, and teachers
- All TypeScript errors in publisher pages resolved

### Change Log
| Date | Change |
|------|--------|
| 2025-12-22 | Rewrote publishersApi.ts to use generated client |
| 2025-12-22 | Updated dashboard.tsx with error handling and correct field names |
| 2025-12-22 | Updated library.tsx to use PublisherLogo component |
| 2025-12-22 | Fixed schools.tsx - createMySchool endpoint and number[] book IDs |
| 2025-12-22 | Fixed teachers.tsx - createMyTeacher endpoint and number[] book IDs |
| 2025-12-22 | Fixed book-assignments.tsx - SelectItem value type |
| 2025-12-22 | Added dashboard.test.tsx with 16 unit tests |
