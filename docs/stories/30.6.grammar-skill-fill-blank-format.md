# Story 30.6: Grammar Skill — Fill-in-the-Blank Format

**Status:** Ready for Review
**Epic:** Epic 30 - Skill-Based AI Assignment Generation & Reporting
**Story Points:** 5
**Priority:** Medium
**Dependencies:** Story 30.3 (V2 API and dispatcher)

---

## User Story

As a **teacher**,
I want **to generate Grammar fill-in-the-blank activities where students complete sentences with the correct grammatical form**,
So that **I can assess and develop my students' grammar skills with targeted practice**.

---

## Acceptance Criteria

1. [x] Generator produces grammar-focused fill-blank items from module content
2. [x] Each question targets a specific grammar point (e.g., present_simple, comparatives)
3. [x] Grammar topic is stored per question for future sub-skill reporting
4. [x] Supports word bank mode (easier — finite options) and free-type mode (harder)
5. [x] Difficulty aligns with module CEFR level
6. [x] Configurable item count

---

## Tasks & Subtasks

- [x] **Task 1: Create Grammar Fill-Blank Generator** (AC: 1, 2, 3, 5)
  - [x] Create `backend/app/services/ai_generation/grammar_fill_blank_service.py`
  - [x] Full pipeline: DCS fetch → LLM generation → structured output
  - [x] LLM prompt targets grammar topics by CEFR level (A1-B2)
  - [x] Invalid grammar topics default to `present_simple`
  - [x] Word bank mode ensures correct answer is always included

- [x] **Task 2: Define Content Schema** (AC: 1, 3, 4)
  - [x] Create `backend/app/schemas/grammar_fill_blank.py`
  - [x] GrammarFillBlankItem: sentence, correct_answer, word_bank, grammar_topic, grammar_hint, difficulty
  - [x] Public version excludes correct_answer
  - [x] `word_bank` is null when `mode == "free_type"`
  - [x] `grammar_hint` is optional (teacher can toggle via include_hints)

- [x] **Task 3: Grammar Topic Taxonomy** (AC: 3)
  - [x] 18 standard grammar topic slugs defined in GRAMMAR_TOPICS list
  - [x] Stored as `grammar_topic` string field per question (not a DB table)

- [x] **Task 4: Register in Dispatcher** (AC: 1)
  - [x] Updated GENERATOR_MAP: `("grammar", "fill_blank") → ("grammar_fill_blank", "grammar_fill_blank")`
  - [x] Updated V2 endpoint with grammar_fill_blank routing branch
  - [x] Updated QuizStorageService with save/get/get_public
  - [x] Added extra_config field to GenerationRequestV2 for mode/hints passthrough

- [x] **Task 5: Unit Tests** (AC: 1-6)
  - [x] 25 tests in `backend/app/tests/test_grammar_fill_blank.py` — all passing
  - [x] Schema tests (9), topic taxonomy tests (4), prompt tests (4), service tests (5), storage tests (3)
  - [x] Regression: 123 tests passing across Stories 30.1-30.6

---

## Dev Notes

### Grammar Topic Detection
The LLM should detect which grammar topic each generated question tests. This is stored per-question and will be used in future for sub-skill reporting (e.g., "Ali is weak in Present Perfect but strong in Past Simple").

### Mode Selection
The `mode` parameter (word_bank vs free_type) is passed from the frontend configuration step via `extra_config`. Word bank is recommended for A1-A2, free type for B1+.

### Testing
- Test file: `backend/app/tests/test_grammar_fill_blank.py`
- Mock LLM with deterministic grammar-focused output

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `backend/app/schemas/grammar_fill_blank.py` | Created | Request, item, activity, public schemas + GRAMMAR_TOPICS taxonomy |
| `backend/app/services/ai_generation/grammar_fill_blank_service.py` | Created | GrammarFillBlankService with LLM pipeline |
| `backend/app/services/ai_generation/prompts/grammar_fill_blank_prompts.py` | Created | System/user prompts, JSON schema, difficulty guidelines |
| `backend/app/schemas/ai_generation_v2.py` | Modified | Added extra_config field for format-specific options |
| `backend/app/services/skill_generation_dispatcher.py` | Modified | grammar×fill_blank now routes to "grammar_fill_blank" |
| `backend/app/api/routes/ai_generation.py` | Modified | Added grammar_fill_blank branch in V2 endpoint |
| `backend/app/services/ai_generation/quiz_storage_service.py` | Modified | Added grammar fill-blank storage methods |
| `backend/app/services/ai_generation/prompts/__init__.py` | Modified | Added grammar fill-blank prompt exports |
| `backend/app/tests/test_grammar_fill_blank.py` | Created | 25 unit tests |
| `backend/app/tests/test_ai_generation_v2.py` | Modified | Updated map counts (10 implemented, 2 stubs), added dispatcher tests |

### Completion Notes
- All 5 tasks implemented and verified
- 25 unit tests passing, 123 regression tests passing
- GENERATOR_MAP now has 10 implemented combos + 2 stubs

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2026-02-13 | 1.1 | Implementation complete — all tasks done, 25+123 tests passing | Dev Agent (James) |
