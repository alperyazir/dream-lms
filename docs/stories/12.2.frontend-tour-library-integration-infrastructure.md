# Story 12.2: Frontend - Tour Library Integration & Infrastructure

## Status
Done

## Story
**As a** developer,
**I want** a reusable tour infrastructure with library integration,
**so that** we can provide guided onboarding tours across the application with consistent behavior and styling.

## Acceptance Criteria
1. Install and configure React Joyride (or alternative: Shepherd.js, Intro.js)
2. Create `TourProvider` component to wrap application
3. Create `useTour` hook for tour control
4. Tour state management (active, step index, completed)
5. Skip functionality that calls API and dismisses tour
6. Styling matches Shadcn UI / neumorphic design system

## Tasks / Subtasks

- [x] **Task 1: Install React Joyride library** (AC: 1)
  - [x] Run `npm install react-joyride` in frontend directory
  - [x] Verify installation in package.json
  - [x] Run `npm run build` to verify no TypeScript errors

- [x] **Task 2: Create Tour type definitions** (AC: 3, 4)
  - [x] Create `frontend/src/types/tour.ts` with tour step interface
  - [x] Define TourStep type with target, content, title, placement properties
  - [x] Define TourState interface (isActive, stepIndex, isCompleted)
  - [x] Export types for use in hooks and components

- [x] **Task 3: Create TourContext and TourProvider** (AC: 2, 4)
  - [x] Create `frontend/src/contexts/TourContext.tsx`
  - [x] Define TourContextType with state and control methods
  - [x] Implement TourProvider with useState for tour state
  - [x] Add startTour, stopTour, nextStep, prevStep, skipTour methods
  - [x] Export useTourContext hook for consuming context

- [x] **Task 4: Create useTour hook** (AC: 3, 4, 5)
  - [x] Create `frontend/src/hooks/useTour.ts`
  - [x] Import TourContext and API client
  - [x] Implement hook that wraps context with business logic
  - [x] Add `completeTour` function that calls `POST /api/v1/users/me/complete-tour`
  - [x] Add skipTour function that calls completeTour API (AC: 5)
  - [x] Return tour state and control functions

- [x] **Task 5: Create TourTooltip custom component** (AC: 6)
  - [x] Create `frontend/src/components/tour/TourTooltip.tsx`
  - [x] Style tooltip to match Shadcn UI design system
  - [x] Use Tailwind CSS classes matching existing UI patterns
  - [x] Include title, content, navigation buttons, skip button
  - [x] Ensure proper accessibility (aria labels, focus management)

- [x] **Task 6: Create Tour component wrapper** (AC: 2, 4, 6)
  - [x] Create `frontend/src/components/tour/Tour.tsx`
  - [x] Import and configure Joyride component
  - [x] Pass custom TourTooltip as tooltipComponent
  - [x] Configure tour options (continuous, showProgress, showSkipButton)
  - [x] Handle callback events (step change, tour end, skip)

- [x] **Task 7: Integrate TourProvider into app** (AC: 2)
  - [x] Modify `frontend/src/routes/_layout.tsx` to wrap with TourProvider
  - [x] Alternatively, add to CustomProvider hierarchy if more appropriate
  - [x] Ensure TourProvider is available to all authenticated routes

- [x] **Task 8: Regenerate frontend client types** (AC: 5)
  - [x] Run `npm run generate-client` to update types from backend
  - [x] Verify `has_completed_tour` field appears in UserPublic type
  - [x] Verify complete-tour endpoint appears in generated services

- [x] **Task 9: Write unit tests for useTour hook** (AC: 3, 4, 5)
  - [x] Create `frontend/src/hooks/useTour.test.tsx`
  - [x] Test startTour sets isActive to true
  - [x] Test skipTour calls API and sets isCompleted
  - [x] Test step navigation (next, prev)
  - [x] Mock API calls using vitest

- [x] **Task 10: Write component tests for TourTooltip** (AC: 6)
  - [x] Create `frontend/src/components/tour/TourTooltip.test.tsx`
  - [x] Test tooltip renders title and content
  - [x] Test navigation buttons work correctly
  - [x] Test skip button fires callback
  - [x] Test accessibility attributes present

## Dev Notes

### Previous Story Insights (Story 12.1)
- Backend `has_completed_tour` field added to User model
- Login response includes `has_completed_tour` status
- `POST /api/v1/users/me/complete-tour` endpoint created and working
- Frontend client types need regeneration to include new field

### Source Tree References
[Source: architecture/source-tree.md]

**Frontend Structure:**
```
frontend/
├── src/
│   ├── components/
│   │   ├── tour/                    # NEW - Tour components go here
│   │   │   ├── Tour.tsx
│   │   │   └── TourTooltip.tsx
│   │   └── ui/                      # Shadcn UI primitives for reference
│   ├── contexts/
│   │   ├── NavigationContext.tsx    # Existing pattern to follow
│   │   └── TourContext.tsx          # NEW - Tour context
│   ├── hooks/
│   │   ├── useAuth.ts               # Existing hook pattern
│   │   └── useTour.ts               # NEW - Tour hook
│   └── types/
│       └── tour.ts                  # NEW - Tour type definitions
```

### Existing Context Pattern
[Source: frontend/src/contexts/NavigationContext.tsx]

Follow the existing NavigationContext pattern for TourContext:
```typescript
// Pattern from NavigationContext.tsx
import { createContext, type ReactNode, useContext, useState } from "react"

interface TourContextType {
  // State and methods
}

const TourContext = createContext<TourContextType | undefined>(undefined)

export function TourProvider({ children }: { children: ReactNode }) {
  // Implementation
}

export function useTourContext() {
  const context = useContext(TourContext)
  if (!context) {
    throw new Error("useTourContext must be used within TourProvider")
  }
  return context
}
```

### Existing Hook Pattern
[Source: frontend/src/hooks/useAuth.ts]

Follow useAuth.ts pattern for API integration:
```typescript
import { useMutation, useQueryClient } from "@tanstack/react-query"
// Use generated client services
import { UsersService } from "@/client"
```

### App Provider Hierarchy
[Source: frontend/src/main.tsx, frontend/src/routes/_layout.tsx]

Current hierarchy:
```
CustomProvider (ThemeProvider)
  └── QueryClientProvider
       └── RouterProvider
            └── _layout (with NavigationProvider)
                 └── TourProvider (ADD HERE - inside NavigationProvider)
```

**Integration Point:** Add TourProvider inside _layout.tsx wrapping LayoutContent, similar to NavigationProvider.

### API Integration
[Source: Story 12.1 implementation]

**Complete Tour Endpoint:**
```typescript
// Call this when tour is completed or skipped
POST /api/v1/users/me/complete-tour
Authorization: Bearer <token>
Response: { "message": "Tour completed successfully" }
```

**Using Generated Client:**
```typescript
// After regenerating client, use:
import { UsersService } from "@/client"

// The endpoint should be available as:
await UsersService.completeTour()
// OR depending on generated naming
await UsersService.usersCompleteTour()
```

### React Joyride Configuration
[Source: Epic 12 technical notes]

**Recommended Joyride Props:**
```typescript
<Joyride
  steps={steps}
  run={isActive}
  stepIndex={stepIndex}
  continuous={true}
  showProgress={true}
  showSkipButton={true}
  disableOverlayClose={true}
  spotlightClicks={false}
  callback={handleJoyrideCallback}
  tooltipComponent={TourTooltip}
  styles={{
    options: {
      zIndex: 10000, // Above Shadcn modals (9999)
    },
  }}
/>
```

### Styling Requirements
[Source: architecture/coding-standards.md, Epic 12 AC: 6]

- Use Tailwind CSS classes matching existing Shadcn components
- Reference Card, Button components for consistent styling
- Neumorphic design: soft shadows, rounded corners
- Colors should use CSS variables (--background, --foreground, --primary, etc.)

**Example Tooltip Styling:**
```typescript
// Match Shadcn Card styling
className="rounded-lg border bg-card text-card-foreground shadow-lg p-4"
```

### Tour State Shape
```typescript
interface TourState {
  isActive: boolean
  stepIndex: number
  isCompleted: boolean
  tourId: string | null  // For role-specific tours
}

interface TourStep {
  target: string         // CSS selector or data-tour attribute
  title: string
  content: string | React.ReactNode
  placement?: 'top' | 'bottom' | 'left' | 'right' | 'center'
  disableBeacon?: boolean
}
```

### Technical Constraints
- React Joyride works with React 18.x (verified compatible)
- Tour targets should use stable selectors (data-tour attributes preferred)
- Tour should not interfere with existing navigation
- Keyboard navigation must work (Escape to skip, Tab for focus)
- Must work on mobile viewports

### File Locations
- **Tour types:** `frontend/src/types/tour.ts`
- **Tour context:** `frontend/src/contexts/TourContext.tsx`
- **Tour hook:** `frontend/src/hooks/useTour.ts`
- **Tour components:** `frontend/src/components/tour/Tour.tsx`, `TourTooltip.tsx`
- **Tests:** Collocated with source files (e.g., `useTour.test.ts`)

## Testing

### Test File Locations
- `frontend/src/hooks/useTour.test.ts`
- `frontend/src/components/tour/TourTooltip.test.tsx`

### Testing Standards
[Source: architecture/10-testing-strategy.md, architecture/coding-standards.md]

- Use Vitest with React Testing Library
- Follow AAA pattern (Arrange-Act-Assert)
- Mock API calls using vitest.fn() or msw
- Use existing test patterns from `frontend/src/hooks/useAutoSave.test.ts`

### Required Tests

**useTour.test.ts:**
```typescript
import { renderHook, act } from '@testing-library/react'
import { describe, it, expect, vi } from 'vitest'

describe('useTour', () => {
  it('starts tour and sets isActive to true', () => {
    // Arrange - render hook
    // Act - call startTour
    // Assert - isActive is true
  })

  it('advances to next step', () => {
    // Test step navigation
  })

  it('calls API on skipTour', async () => {
    // Mock API, call skipTour, verify API called
  })

  it('marks tour as completed after skip', async () => {
    // Verify isCompleted state after skip
  })
})
```

**TourTooltip.test.tsx:**
```typescript
import { render, screen, fireEvent } from '@testing-library/react'
import { describe, it, expect, vi } from 'vitest'

describe('TourTooltip', () => {
  it('renders step title and content', () => {
    // Render with props, verify text displayed
  })

  it('calls onNext when Next button clicked', () => {
    // Mock onNext, click, verify called
  })

  it('calls onSkip when Skip button clicked', () => {
    // Mock onSkip, click, verify called
  })

  it('has accessible button labels', () => {
    // Check aria-labels on buttons
  })
})
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Initial story draft | Bob (SM Agent) |
| 2025-12-09 | 1.1 | Implementation complete | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- React Joyride installed with `--legacy-peer-deps` due to React 19 peer dependency conflict
- Added `react-is` package to fix recharts build issue
- Regenerated OpenAPI spec from backend to include complete-tour endpoint
- Test files renamed to `.tsx` extension for JSX support

### Completion Notes List
- All 10 tasks completed successfully
- 25 unit tests written and passing (12 for useTour hook, 13 for TourTooltip)
- Build passes with no TypeScript errors
- Tour infrastructure ready for Stories 12.3 and 12.4 to define specific tour steps

### File List
**New Files:**
- `frontend/src/types/tour.ts` - Tour type definitions
- `frontend/src/contexts/TourContext.tsx` - Tour context and provider
- `frontend/src/hooks/useTour.ts` - Tour hook with API integration
- `frontend/src/hooks/useTour.test.tsx` - useTour hook tests (12 tests)
- `frontend/src/components/tour/Tour.tsx` - Joyride wrapper component
- `frontend/src/components/tour/TourTooltip.tsx` - Custom tooltip component
- `frontend/src/components/tour/TourTooltip.test.tsx` - TourTooltip tests (13 tests)

**Modified Files:**
- `frontend/src/routes/_layout.tsx` - Added TourProvider and Tour component
- `frontend/package.json` - Added react-joyride, react-is dependencies
- `frontend/src/client/*` - Regenerated client types with complete-tour endpoint

---

## QA Results

### Review Summary
**Status:** ✅ PASS
**Reviewed by:** Quinn (QA Agent)
**Review Date:** 2025-12-09

### Acceptance Criteria Verification
| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| 1 | Install and configure React Joyride | ✅ PASS | react-joyride@2.9.2 in package.json |
| 2 | Create TourProvider component | ✅ PASS | contexts/TourContext.tsx, integrated in _layout.tsx |
| 3 | Create useTour hook | ✅ PASS | hooks/useTour.ts with full API integration |
| 4 | Tour state management | ✅ PASS | TourState interface with all required properties |
| 5 | Skip functionality calls API | ✅ PASS | skipTour() calls UsersService.completeTour() |
| 6 | Styling matches Shadcn UI | ✅ PASS | TourTooltip uses Shadcn Button, Tailwind classes |

### Test Results
- **Total Tests:** 25
- **Passed:** 25
- **Failed:** 0
- **Test Files:**
  - `useTour.test.tsx` - 12 tests (hook functionality)
  - `TourTooltip.test.tsx` - 13 tests (component rendering, accessibility)

### Build Verification
- ✅ TypeScript build passes
- ✅ Lint checks pass
- ✅ No console errors

### Code Quality
- ✅ Full TypeScript coverage
- ✅ Follows existing context/hook patterns
- ✅ Proper accessibility attributes (aria-labels, roles)
- ✅ Clean separation of concerns

### Known Issues
| Severity | Issue | Mitigation |
|----------|-------|------------|
| LOW | react-joyride installed with --legacy-peer-deps (React 19) | Monitor for updates |
| INFO | react-is added for recharts build | Can be removed when recharts updates |

### Recommendations
1. Stories 12.3/12.4 can proceed to define tour steps
2. Consider E2E tests when tour steps are implemented
3. Monitor react-joyride for React 19 official support

### Gate File
`docs/qa/gates/12.2-frontend-tour-library-integration-infrastructure.yml`
