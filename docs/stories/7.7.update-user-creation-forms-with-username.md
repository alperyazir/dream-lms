# Story 7.7: Update User Creation Forms with Username

**Epic:** Epic 7 - Authentication & User Management Overhaul
**Status:** Done
**Estimated Effort:** 1 day
**Dependencies:** Story 7.1 (Username field added to User model)

---

## Story

**As a** administrator/publisher/teacher,
**I want** all user creation forms to include a username field,
**so that** I can create users with both username and email.

---

## Acceptance Criteria

1. **Admin Publisher Creation Form** (`frontend/src/routes/_layout/admin/publishers.tsx`):
   - Add username input field to create publisher modal
   - Validation: required, 3-50 characters, alphanumeric + underscore/hyphen
   - Position: above email field
   - Update form submission to include username
2. **Admin Teacher Creation Form** (`frontend/src/routes/_layout/admin/teachers.tsx`):
   - Add username input field to create teacher modal
   - Same validation as publisher form
   - Update form submission to include username
3. **Admin Student Creation Form** (`frontend/src/routes/_layout/admin/students.tsx`):
   - Add username input field to create student modal
   - Same validation as publisher form
   - Update form submission to include username
4. **Publisher-specific Forms** (if separate components exist):
   - Add username field to teacher creation
   - Add username field to student creation
   - Enforce same validation rules
5. **Teacher Student Creation** (if UI exists):
   - Add username field to student creation form
   - Same validation rules
6. **Form Validation**:
   - Client-side: regex pattern `/^[a-zA-Z0-9_-]{3,50}$/`
   - Display error: "Username must be 3-50 characters, alphanumeric, underscore, or hyphen"
   - Real-time uniqueness check (optional): debounced API call
7. **Display Updates**:
   - User list tables show username column
   - Sort by username option in table headers
   - Search/filter supports username
8. Update TypeScript schemas for all user creation types
9. Frontend tests for form validation
10. Integration tests for form submission with username

### Integration Verification:

- **IV1**: Existing user creation workflows work with new username field
- **IV2**: Form validation catches invalid usernames before submission
- **IV3**: Backend username uniqueness validation works correctly
- **IV4**: User lists display username alongside email
- **IV5**: No layout breakage in responsive design

---

## Tasks / Subtasks

- [ ] **Task 1: Update Admin Publisher Creation Form (AC: 1, 8)**
  - [ ] Read current implementation at `frontend/src/routes/_layout/admin/publishers.tsx`
  - [ ] Add username state to `newPublisher` object in `PublisherCreateAPI` interface
  - [ ] Add username Input field in create dialog (above `user_email` field)
  - [ ] Add validation handler for username regex pattern
  - [ ] Update `handleAddPublisher` to validate username field
  - [ ] Update mutation call to include username in payload
  - [ ] Test create flow manually

- [ ] **Task 2: Update Admin Teacher/Student Creation Forms (AC: 2, 3)**
  - [ ] Check if teachers.tsx and students.tsx files exist
  - [ ] Apply same username field updates as publishers
  - [ ] Ensure consistent validation and error messaging
  - [ ] Update respective TypeScript interfaces

- [ ] **Task 3: Update Publisher-Specific Forms (AC: 4)**
  - [ ] Check if publisher routes exist for teacher/student creation
  - [ ] If exists, add username fields
  - [ ] If not, document as N/A

- [ ] **Task 4: Update Teacher Student Creation Form (AC: 5)**
  - [ ] Check if teacher routes exist for student creation
  - [ ] If exists, add username field
  - [ ] If not, document as N/A

- [ ] **Task 5: Update User List Tables (AC: 7)**
  - [ ] Add username column to publishers table
  - [ ] Add username column to teachers table (if exists)
  - [ ] Add username column to students table (if exists)
  - [ ] Add sort functionality for username column
  - [ ] Update search/filter to include username field

- [ ] **Task 6: Form Validation Implementation (AC: 6)**
  - [ ] Create username validation utility function
  - [ ] Implement regex validation `/^[a-zA-Z0-9_-]{3,50}$/`
  - [ ] Add error message display
  - [ ] Test validation with edge cases

- [ ] **Task 7: Write Frontend Tests (AC: 9)**
  - [ ] Create test file for publisher form validation
  - [ ] Test username required validation
  - [ ] Test username format validation (valid/invalid patterns)
  - [ ] Test username length validation (min 3, max 50)
  - [ ] Test form submission with username

- [ ] **Task 8: Write Integration Tests (AC: 10)**
  - [ ] Test end-to-end publisher creation with username
  - [ ] Test username uniqueness error handling
  - [ ] Verify username appears in list tables
  - [ ] Test search/filter with username

---

## Dev Notes

### Context from Previous Story (7.6)

**Story 7.6 Insights:**
- User model already has username field with validation (from Story 7.1)
- Username validation regex: `/^[a-zA-Z0-9_-]+$/` enforced at backend
- Frontend uses native `fetch` for dev endpoints, but OpenAPI generated client for production APIs
- Current forms use Shadcn UI components with TanStack Query mutations
[Source: docs/stories/7.6.dynamic-quick-test-login.md#dev-agent-record]

### Current Frontend Architecture Pattern

**Form Component Pattern:**
The admin pages follow a consistent dialog-based CRUD pattern:
- State management with `useState` for form data
- TanStack Query for API calls (`useMutation`, `useQuery`)
- Shadcn UI Dialog components for modals
- Toast notifications on success/error

[Source: docs/architecture/5-frontend-architecture.md#state-management]

**Example from publishers.tsx:**
```typescript
const [newPublisher, setNewPublisher] = useState<PublisherCreateAPI>({
  name: "",
  contact_email: "",
  user_email: "",
  full_name: "",
})

const createPublisherMutation = useMutation({
  mutationFn: (data: PublisherCreateAPI) =>
    AdminService.createPublisher({ requestBody: data }),
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ["publishers"] })
    // ... success handling
  }
})
```
[Source: frontend/src/routes/_layout/admin/publishers.tsx:56-98]

### User Model Schema

**Backend Model (Story 7.1 Implementation):**
```python
class UserBase(SQLModel):
    email: EmailStr = Field(unique=True, index=True, max_length=255)
    username: str = Field(
        unique=True,
        index=True,
        min_length=3,
        max_length=50
    )
    # ... other fields

    @field_validator('username')
    @classmethod
    def validate_username(cls, v: str) -> str:
        """Validate username format."""
        return validate_username_format(v)
```

**Validation Function:**
```python
def validate_username_format(username: str | None) -> str | None:
    if username is None:
        return username
    if not re.match(r'^[a-zA-Z0-9_-]+$', username):
        raise ValueError('Username must contain only letters, numbers, underscores, and hyphens')
    return username
```
[Source: backend/app/models.py:34-72]

### File Locations

**Files to Modify:**
1. **Admin Forms:**
   - `frontend/src/routes/_layout/admin/publishers.tsx` - Add username to create dialog
   - `frontend/src/routes/_layout/admin/teachers.tsx` - If exists, add username
   - `frontend/src/routes/_layout/admin/students.tsx` - If exists, add username

2. **Publisher Forms (if exist):**
   - Check `frontend/src/routes/_layout/publisher/` directory

3. **Teacher Forms (if exist):**
   - Check `frontend/src/routes/_layout/teacher/` directory

[Source: docs/architecture/source-tree.md#frontend-structure]

### TypeScript Client Types

**OpenAPI Generated Types:**
The frontend uses OpenAPI-generated TypeScript types from `@/client`:
- `PublisherCreateAPI` - Publisher creation payload
- `TeacherCreateAPI` - Teacher creation payload (if exists)
- `StudentCreateAPI` - Student creation payload (if exists)

These types are auto-generated from backend Pydantic schemas. After backend changes in Story 7.1, these types should already include `username` field.

**Check if regeneration needed:**
```bash
# From frontend directory
npm run generate-client
```
[Source: docs/architecture/5-frontend-architecture.md#api-service-layer]

### Shadcn UI Components Used

**Components for Forms:**
- `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogDescription`, `DialogFooter` - Modal wrapper
- `Label` - Form field labels
- `Input` - Text input fields
- `Button` - Submit/cancel buttons
- `Table`, `TableHeader`, `TableBody`, `TableRow`, `TableCell` - User lists

**Import paths:**
```typescript
import { Dialog, DialogContent, ... } from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
```
[Source: frontend/src/routes/_layout/admin/publishers.tsx:15-32]

### Username Field Placement

**Recommended Order in Forms:**
1. Username (NEW - add first)
2. Email
3. Full Name
4. Other role-specific fields (company name, school assignment, etc.)

**Rationale:** Username is the primary identifier for login, should be prominent

### Validation Implementation

**Client-Side Validation:**
```typescript
const validateUsername = (username: string): string | null => {
  if (!username) return "Username is required"
  if (username.length < 3) return "Username must be at least 3 characters"
  if (username.length > 50) return "Username must be less than 50 characters"
  if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
    return "Username must contain only letters, numbers, underscores, and hyphens"
  }
  return null
}
```

**Usage in Form:**
```typescript
const handleAddPublisher = () => {
  const usernameError = validateUsername(newPublisher.username)
  if (usernameError) {
    showErrorToast(usernameError)
    return
  }
  // ... rest of validation
  createPublisherMutation.mutate(newPublisher)
}
```

### Table Column Updates

**Add Username Column Pattern:**
```tsx
<TableHeader>
  <TableRow>
    <TableHead>Username</TableHead> {/* NEW */}
    <TableHead>Name</TableHead>
    <TableHead>Email</TableHead>
    {/* ... other columns */}
  </TableRow>
</TableHeader>

<TableBody>
  {publishers.map((pub) => (
    <TableRow key={pub.id}>
      <TableCell>{pub.user_username || "N/A"}</TableCell> {/* NEW */}
      <TableCell>{pub.name}</TableCell>
      <TableCell>{pub.user_email}</TableCell>
      {/* ... other cells */}
    </TableRow>
  ))}
</TableBody>
```

**Note:** Backend should populate `user_username` field in `PublisherPublic` schema (Story 7.8 handles this, but may need to verify)

### Search/Filter Implementation

**Extend Existing Search Logic:**
```typescript
const filteredPublishers = publishers.filter((pub) =>
  pub.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
  pub.user_email.toLowerCase().includes(searchQuery.toLowerCase()) ||
  (pub.user_username?.toLowerCase().includes(searchQuery.toLowerCase()) ?? false) // NEW
)
```

### Error Handling

**Backend Validation Errors:**
- 422 Unprocessable Entity - Username validation failed (format, length)
- 409 Conflict - Username already exists (uniqueness constraint)

**Frontend Error Display:**
```typescript
onError: (error: any) => {
  const detail = error.body?.detail || "Failed to create user"
  showErrorToast(detail)
}
```
[Source: frontend/src/routes/_layout/admin/publishers.tsx:94-98]

---

## Testing

### Unit Tests

**Frontend Form Validation Tests:**

File: `frontend/src/routes/_layout/admin/publishers.test.tsx`

```typescript
describe('Publisher Creation Form', () => {
  it('validates username is required', () => {
    // Test empty username rejection
  })

  it('validates username minimum length', () => {
    // Test username < 3 characters
  })

  it('validates username maximum length', () => {
    // Test username > 50 characters
  })

  it('validates username format', () => {
    // Test invalid characters (spaces, special chars)
    // Test valid characters (alphanumeric, underscore, hyphen)
  })

  it('submits form with username', () => {
    // Test successful submission with username
  })
})
```

### Integration Tests

**E2E Publisher Creation:**

File: `frontend/tests/e2e/admin-publisher-creation.spec.ts`

```typescript
test('admin creates publisher with username', async ({ page }) => {
  await page.goto('/admin/publishers')
  await page.click('text=Add Publisher')

  await page.fill('[name="username"]', 'testpub1')
  await page.fill('[name="name"]', 'Test Publisher')
  await page.fill('[name="user_email"]', 'test@publisher.com')
  await page.fill('[name="full_name"]', 'Test User')

  await page.click('text=Create')

  await expect(page.locator('text=testpub1')).toBeVisible()
})

test('validates username uniqueness', async ({ page }) => {
  // Create first publisher with username 'testpub1'
  // Attempt to create second publisher with same username
  // Expect error message
})
```

**Testing Standards:**
- Use Vitest + React Testing Library for component tests
- Use Playwright for E2E tests
- Test file location: Mirror source structure in `tests/` directory
- Coverage target: >80% for new form components

[Source: docs/architecture/10-testing-strategy.md#frontend-testing]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-10 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

<!-- This section will be populated by the development agent during implementation -->

---

## QA Results

<!-- This section will be populated by the QA agent after review -->
