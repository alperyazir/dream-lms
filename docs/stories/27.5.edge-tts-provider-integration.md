# Story 27.5: Edge TTS Provider Integration

**Status:** Ready for Review

**Epic:** Epic 27 - DreamAI - AI-Powered Content Generation
**Story Points:** 3
**Priority:** High
**Dependencies:** Story 27.4 (TTS Provider Abstraction Layer)

---

## Story

**As a** system,
**I want** Edge TTS integrated as the primary free TTS provider,
**so that** vocabulary audio can be generated at no cost with good quality for Turkish and English languages.

---

## Acceptance Criteria

1. [ ] Edge TTS library integration (`edge-tts`)
2. [ ] Turkish voice support (`tr-TR-AhmetNeural`, `tr-TR-EmelNeural`)
3. [ ] English voice support (multiple accents)
4. [ ] Async audio generation
5. [ ] Audio file caching
6. [ ] Batch processing for vocabulary lists

---

## Tasks / Subtasks

- [x] **Task 1: Add edge-tts Dependency** (AC: 1)
  - [x] Add `edge-tts` to requirements.txt or pyproject.toml
  - [x] Verify installation with `uv sync` or `pip install`
  - [x] Test import works: `import edge_tts`

- [x] **Task 2: Create EdgeTTSProvider Class** (AC: 1, 4)
  - [x] Create `backend/app/services/tts/providers/edge.py`
  - [x] Implement `EdgeTTSProvider` extending `TTSProvider` ABC
  - [x] Implement constructor with settings injection
  - [x] Implement `get_name() -> str` returning "edge"
  - [x] Implement `is_available() -> bool` (always True for Edge TTS)
  - [x] Add Google-style docstrings

- [x] **Task 3: Implement Voice Support** (AC: 2, 3)
  - [x] Define voice constants for Turkish:
    - `tr-TR-AhmetNeural` (male)
    - `tr-TR-EmelNeural` (female)
  - [x] Define voice constants for English:
    - `en-US-JennyNeural` (female)
    - `en-US-GuyNeural` (male)
    - `en-GB-SoniaNeural` (female)
    - `en-GB-RyanNeural` (male)
  - [x] Implement `get_available_voices(language: str) -> list[Voice]`
  - [x] Implement `get_supported_languages() -> list[str]`
  - [x] Implement `supports_language(language: str) -> bool`
  - [x] Support both short codes ("en", "tr") and full codes ("en-US", "tr-TR")

- [x] **Task 4: Implement generate_audio Method** (AC: 4)
  - [x] Implement `async generate_audio(text, options) -> AudioResult`
  - [x] Use `edge_tts.Communicate` for async generation
  - [x] Map `AudioGenerationOptions.format` to edge-tts output format
  - [x] Map `AudioGenerationOptions.rate` to edge-tts rate parameter
  - [x] Map `AudioGenerationOptions.pitch` to edge-tts pitch parameter
  - [x] Auto-select default voice if `options.voice` is None
  - [x] Calculate audio duration from generated bytes
  - [x] Measure and return latency_ms
  - [x] Handle edge-tts exceptions and wrap in TTS exceptions

- [x] **Task 5: Implement Batch Processing** (AC: 6)
  - [x] Implement `async generate_audio_batch(items) -> BatchAudioResult`
  - [x] Process items concurrently with `asyncio.gather`
  - [x] Handle partial failures (some items fail, others succeed)
  - [x] Track success_count and failure_count
  - [x] Calculate total_duration_ms and total_latency_ms

- [x] **Task 6: Register Provider with Manager** (AC: 1, 5)
  - [x] Update `backend/app/services/tts/manager.py` `create_default_manager()`
  - [x] Register EdgeTTSProvider when primary provider is "edge"
  - [x] Ensure cache integration works with EdgeTTSProvider
  - [x] Add `is_edge_available()` check in config

- [x] **Task 7: Update Module Exports** (AC: 1)
  - [x] Export `EdgeTTSProvider` from `backend/app/services/tts/providers/__init__.py`
  - [x] Export from main `backend/app/services/tts/__init__.py`

- [x] **Task 8: Write Unit Tests** (AC: All)
  - [x] Create `backend/app/tests/test_services/test_tts/test_edge_provider.py`
  - [x] Test EdgeTTSProvider initialization
  - [x] Test get_name() returns "edge"
  - [x] Test is_available() returns True
  - [x] Test get_available_voices() for Turkish ("tr", "tr-TR")
  - [x] Test get_available_voices() for English ("en", "en-US", "en-GB")
  - [x] Test get_supported_languages() returns expected codes
  - [x] Test supports_language() for supported and unsupported languages
  - [x] Test generate_audio with mocked edge_tts.Communicate
  - [x] Test generate_audio with different options (rate, pitch)
  - [x] Test generate_audio_batch with multiple items
  - [x] Test batch partial failure handling
  - [x] Test voice auto-selection when voice is None

---

## Dev Notes

### Previous Story Insights (from 27.4)
[Source: docs/stories/27.4.tts-provider-abstraction-layer.md]

- TTSProvider ABC is in `backend/app/services/tts/base.py`
- Must implement 7 abstract methods: `generate_audio`, `generate_audio_batch`, `get_name`, `get_available_voices`, `get_supported_languages`, `is_available`, `supports_language`
- Cache integration handled by TTSManager - provider doesn't need to cache directly
- Exception hierarchy in `backend/app/services/tts/exceptions.py`:
  - Use `TTSAudioGenerationError` for generation failures
  - Use `TTSConnectionError` for network issues
  - Use `TTSUnsupportedLanguageError` for unsupported languages

### TTSProvider Interface
[Source: backend/app/services/tts/base.py]

```python
class TTSProvider(ABC):
    @abstractmethod
    async def generate_audio(
        self, text: str, options: AudioGenerationOptions | None = None
    ) -> AudioResult: ...

    @abstractmethod
    async def generate_audio_batch(
        self, items: list[BatchAudioItem]
    ) -> BatchAudioResult: ...

    @abstractmethod
    def get_name(self) -> str: ...

    @abstractmethod
    def get_available_voices(self, language: str) -> list[Voice]: ...

    @abstractmethod
    def get_supported_languages(self) -> list[str]: ...

    @abstractmethod
    def is_available(self) -> bool: ...

    @abstractmethod
    def supports_language(self, language: str) -> bool: ...
```

### Edge TTS Library Usage
[Source: https://github.com/rany2/edge-tts]

```python
import edge_tts

# Basic usage
communicate = edge_tts.Communicate(text, voice)
await communicate.save("output.mp3")

# Streaming to bytes
audio_bytes = b""
async for chunk in communicate.stream():
    if chunk["type"] == "audio":
        audio_bytes += chunk["data"]

# With rate and pitch adjustment
communicate = edge_tts.Communicate(
    text,
    voice,
    rate="+20%",   # -50% to +100%
    pitch="+0Hz"   # -50Hz to +50Hz
)
```

### Voice Constants
[Source: docs/prd/epic-27-dreamai-content-generation.md]

**Turkish Voices:**
- `tr-TR-AhmetNeural` - Male, neural
- `tr-TR-EmelNeural` - Female, neural

**English Voices (US):**
- `en-US-JennyNeural` - Female, neural
- `en-US-GuyNeural` - Male, neural
- `en-US-AriaNeural` - Female, neural

**English Voices (GB):**
- `en-GB-SoniaNeural` - Female, neural
- `en-GB-RyanNeural` - Male, neural

### Rate/Pitch Conversion
Edge TTS uses percentage strings for rate and Hz strings for pitch:
- `AudioGenerationOptions.rate` (0.5-2.0) → "-50%" to "+100%"
- `AudioGenerationOptions.pitch` (0.5-2.0) → "-50Hz" to "+50Hz"

Conversion formulas:
```python
# rate: 1.0 = 0%, 0.5 = -50%, 2.0 = +100%
rate_percent = int((rate - 1.0) * 100)
rate_str = f"{rate_percent:+d}%"

# pitch: 1.0 = 0Hz, 0.5 = -50Hz, 2.0 = +50Hz
pitch_hz = int((pitch - 1.0) * 100)
pitch_str = f"{pitch_hz:+d}Hz"
```

### Source Tree Reference
[Source: docs/architecture/source-tree.md]

New files to create:
```
backend/app/services/tts/providers/
├── __init__.py          # Export EdgeTTSProvider
└── edge.py              # EdgeTTSProvider implementation

backend/app/tests/test_services/test_tts/
└── test_edge_provider.py  # Unit tests
```

### Coding Standards
[Source: docs/architecture/coding-standards.md]

- Use `async/await` for all edge-tts operations
- Type hints required on all functions
- Google-style docstrings
- Follow snake_case for variables/functions, PascalCase for classes
- Error handling with specific exception types from 27.4

---

## Testing

### Test File Location
`backend/app/tests/test_services/test_tts/test_edge_provider.py`

### Test Standards
[Source: docs/architecture/coding-standards.md]

- Use `pytest` with `pytest-asyncio`
- Mock `edge_tts.Communicate` to avoid actual API calls
- Follow arrange-act-assert pattern
- Aim for >80% coverage on new code

### Test Cases Summary

**test_edge_provider.py:**
- Test provider initialization
- Test get_name returns "edge"
- Test is_available returns True
- Test get_supported_languages includes "en", "tr"
- Test supports_language for valid/invalid languages
- Test get_available_voices for different language codes
- Test generate_audio with mocked edge_tts
- Test generate_audio respects rate/pitch options
- Test generate_audio_batch concurrent processing
- Test batch handling of partial failures
- Test default voice selection per language

### Mocking Strategy

```python
@pytest.fixture
def mock_communicate():
    """Mock edge_tts.Communicate for testing."""
    with patch("edge_tts.Communicate") as mock:
        instance = MagicMock()
        mock.return_value = instance

        # Mock stream() to yield audio chunks
        async def mock_stream():
            yield {"type": "audio", "data": b"fake_audio_data"}

        instance.stream.return_value = mock_stream()
        yield mock
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-02 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2026-01-02 | 1.0 | Implementation complete - all 8 tasks done | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- All 152 TTS tests passing (`uv run pytest app/tests/test_services/test_tts/ -v`)
- Ruff linting passes (`uv run ruff check app/services/tts/`)
- edge-tts package v7.2.7 installed successfully

### Completion Notes List
- Implemented EdgeTTSProvider implementing TTSProvider ABC
- Added 2 Turkish voices (AhmetNeural, EmelNeural) and 5 English voices (3 US, 2 GB)
- Supports both short ("en", "tr") and full BCP-47 codes ("en-US", "tr-TR")
- Rate/pitch conversion: float (0.5-2.0) to edge-tts format (percentage/Hz strings)
- Batch processing with asyncio.gather for concurrent generation
- Partial failure handling in batch - continues processing other items if one fails
- Registered with TTSManager in create_default_manager()
- 40 new unit tests covering all provider functionality

### File List
**Modified Files:**
- `backend/pyproject.toml` - Added edge-tts>=6.1.0 dependency
- `backend/app/services/tts/__init__.py` - Export EdgeTTSProvider
- `backend/app/services/tts/providers/__init__.py` - Export EdgeTTSProvider
- `backend/app/services/tts/manager.py` - Register EdgeTTSProvider in create_default_manager()

**New Files:**
- `backend/app/services/tts/providers/edge.py` - EdgeTTSProvider implementation
- `backend/app/tests/test_services/test_tts/test_edge_provider.py` - 40 unit tests

---

## QA Results
_To be filled by QA agent_
