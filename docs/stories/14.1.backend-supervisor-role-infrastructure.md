# Story 14.1: Backend - Supervisor Role Infrastructure

**Epic:** 14 - Supervisor Role
**Story ID:** 14.1
**Status:** Done
**Created:** 2025-12-19
**Priority:** High

---

## Story

**As an** system administrator,
**I want** a new Supervisor role added to the system with Admin-level permissions but restricted deletion capabilities,
**so that** I can delegate administrative tasks while maintaining control over user hierarchy.

---

## Acceptance Criteria

### Role Definition
1. New `supervisor` value exists in `UserRole` enum
2. Supervisor role persists correctly in database
3. Database migration adds `supervisor` to PostgreSQL enum type

### Permission Inheritance
4. Supervisors have the same API access as Admins for read operations
5. Supervisors have the same API access as Admins for create operations
6. Supervisors have the same API access as Admins for update operations
7. `require_role(UserRole.admin)` is updated to `require_role(UserRole.admin, UserRole.supervisor)` on appropriate endpoints

### Deletion Restrictions
8. Supervisors CANNOT delete Admin users (returns 403)
9. Supervisors CANNOT delete other Supervisor users (returns 403)
10. Supervisors CAN delete Publisher users
11. Supervisors CAN delete Teacher users
12. Supervisors CAN delete Student users
13. Supervisors CAN delete School records

### Self-Deletion Prevention
14. No user can delete themselves regardless of role (returns 403)
15. Admin cannot delete themselves
16. Supervisor cannot delete themselves
17. Clear error message returned for self-deletion attempts

### Audit & Logging
18. Role changes are logged
19. Deletion attempts (successful and blocked) are logged

---

## Tasks / Subtasks

### Backend Tasks - Database Migration

- [x] **Task 1: Update UserRole Enum** (AC: 1, 2)
  - [x] Add `supervisor = "supervisor"` to `UserRole` enum in `backend/app/models.py`
  - [x] Ensure enum is ordered appropriately (admin, supervisor, publisher, teacher, student)
  - [x] Update any TypedDict or Pydantic models that reference UserRole

- [x] **Task 2: Create Database Migration** (AC: 3)
  - [x] Create Alembic migration: `alembic revision -m "add_supervisor_role"`
  - [x] Add upgrade: `ALTER TYPE userrole ADD VALUE 'supervisor'`
  - [x] Document downgrade limitations (PostgreSQL enum removal is complex)
  - [x] Test migration on development database

### Backend Tasks - Permission Updates

- [x] **Task 3: Create Admin-or-Supervisor Dependency** (AC: 4, 5, 6, 7)
  - [x] Create helper in `backend/app/api/deps.py`:
    ```python
    AdminOrSupervisor = require_role(UserRole.admin, UserRole.supervisor)
    ```
  - [x] Identify all endpoints currently using `require_role(UserRole.admin)`
  - [x] Update endpoints to use `AdminOrSupervisor` where Supervisors should have access
  - [x] Keep certain endpoints Admin-only if needed (e.g., creating Supervisors)

- [x] **Task 4: Update Admin Route Permissions** (AC: 4, 5, 6, 7)
  - [x] Update `backend/app/api/routes/admin.py` endpoints:
    - [x] `create_publisher` → AdminOrSupervisor
    - [x] `list_publishers` → AdminOrSupervisor
    - [x] `update_publisher` → AdminOrSupervisor
    - [x] `create_school` → AdminOrSupervisor
    - [x] `list_schools` → AdminOrSupervisor
    - [x] `update_school` → AdminOrSupervisor
    - [x] `create_teacher` → AdminOrSupervisor (with supervisor added)
    - [x] `list_teachers` → AdminOrSupervisor
    - [x] `update_teacher` → AdminOrSupervisor
    - [x] `create_student` → AdminOrSupervisor (with supervisor added)
    - [x] `list_students` → AdminOrSupervisor
    - [x] `update_student` → AdminOrSupervisor
    - [x] `get_stats` → AdminOrSupervisor
    - [x] Other read/update endpoints → AdminOrSupervisor

### Backend Tasks - Deletion Restrictions

- [x] **Task 5: Implement Hierarchical Delete Logic** (AC: 8, 9, 10, 11, 12, 13)
  - [x] Create `can_delete_user()` function in `backend/app/api/deps.py`:
    ```python
    def can_delete_user(current_user: User, target_user: User) -> bool:
        # Self-deletion check handled separately
        if current_user.role == UserRole.admin:
            return True
        if current_user.role == UserRole.supervisor:
            return target_user.role not in [UserRole.admin, UserRole.supervisor]
        return False
    ```
  - [x] Create `can_delete_school()` function (Supervisors can delete)
  - [x] Document the permission hierarchy clearly

- [x] **Task 6: Update Delete Endpoints** (AC: 8, 9, 10, 11, 12, 13)
  - [x] Update `delete_publisher` to check `can_delete_user()`
  - [x] Update `delete_teacher` to check `can_delete_user()`
  - [x] Update `delete_student` to check `can_delete_user()`
  - [x] Update `delete_school` to allow Supervisors
  - [x] Return 403 with clear message when deletion blocked

- [x] **Task 7: Implement Self-Deletion Prevention** (AC: 14, 15, 16, 17)
  - [x] Add self-deletion check at beginning of all delete endpoints:
    ```python
    if target_user.id == current_user.id:
        raise HTTPException(
            status_code=403,
            detail="You cannot delete your own account"
        )
    ```
  - [x] Apply to all user delete endpoints
  - [x] Test for Admin, Supervisor, Publisher, Teacher roles

### Backend Tasks - Testing

- [x] **Task 8: Write Unit Tests for Permissions** (AC: 4-17)
  - [x] Test Supervisor can access all Admin read endpoints
  - [x] Test Supervisor can create users (Publisher, Teacher, Student)
  - [x] Test Supervisor can update users
  - [x] Test Supervisor CANNOT delete Admin
  - [x] Test Supervisor CANNOT delete Supervisor
  - [x] Test Supervisor CAN delete Publisher
  - [x] Test Supervisor CAN delete Teacher
  - [x] Test Supervisor CAN delete Student
  - [x] Test Admin CANNOT delete themselves
  - [x] Test Supervisor CANNOT delete themselves

### Backend Tasks - Logging

- [x] **Task 9: Add Audit Logging** (AC: 18, 19)
  - [x] Log when Supervisor accesses admin endpoints
  - [x] Log deletion attempts with outcome (allowed/blocked)
  - [x] Include current_user.id, target_user.id, action, result

---

## Technical Notes

### UserRole Enum Update

```python
# backend/app/models.py
class UserRole(str, Enum):
    """User role enumeration for RBAC"""
    admin = "admin"
    supervisor = "supervisor"  # NEW
    publisher = "publisher"
    teacher = "teacher"
    student = "student"
```

### Migration Script

```python
# backend/app/alembic/versions/xxxx_add_supervisor_role.py
def upgrade():
    op.execute("ALTER TYPE userrole ADD VALUE 'supervisor' AFTER 'admin'")

def downgrade():
    # PostgreSQL doesn't support removing enum values easily
    # Would require: create new enum, update column, drop old enum
    # For safety, log warning and skip
    print("WARNING: Downgrade does not remove 'supervisor' from enum")
```

### Permission Helper

```python
# backend/app/api/deps.py
from app.models import UserRole

# Dependency for endpoints accessible by Admin OR Supervisor
AdminOrSupervisor = require_role(UserRole.admin, UserRole.supervisor)

# Dependency for endpoints ONLY accessible by Admin
AdminOnly = require_role(UserRole.admin)

def can_delete_user(current_user: User, target_user: User) -> bool:
    """Check if current user can delete target user."""
    # No one can delete themselves
    if current_user.id == target_user.id:
        return False

    # Admins can delete anyone (except themselves, handled above)
    if current_user.role == UserRole.admin:
        return True

    # Supervisors cannot delete Admins or other Supervisors
    if current_user.role == UserRole.supervisor:
        if target_user.role in [UserRole.admin, UserRole.supervisor]:
            return False
        return True

    # Other roles cannot delete users
    return False
```

### Delete Endpoint Pattern

```python
@router.delete("/publishers/{publisher_id}")
async def delete_publisher(
    publisher_id: int,
    session: AsyncSessionDep,
    current_user: User = AdminOrSupervisor,  # Allow both roles to access
):
    publisher_user = await get_publisher_user(session, publisher_id)
    if not publisher_user:
        raise HTTPException(404, "Publisher not found")

    # Check self-deletion
    if publisher_user.id == current_user.id:
        raise HTTPException(403, "You cannot delete your own account")

    # Check hierarchical permission
    if not can_delete_user(current_user, publisher_user):
        raise HTTPException(
            403,
            f"Supervisors cannot delete {publisher_user.role.value} users"
        )

    # Proceed with deletion
    await delete_user(session, publisher_user)
    return {"message": "Publisher deleted"}
```

---

## Dependencies

- None (foundational story for Epic 14)

---

## Estimation

- **Complexity:** Medium
- **Components:** Backend only (models, deps, routes, tests)

---

## Definition of Done

- [x] UserRole enum includes `supervisor`
- [x] Database migration created and tested
- [x] Supervisors can access Admin endpoints (read/create/update)
- [x] Supervisors cannot delete Admins or Supervisors
- [x] Self-deletion blocked for all roles
- [x] All delete endpoints have proper permission checks
- [x] Unit tests cover all permission scenarios
- [x] Audit logging in place
- [ ] Code reviewed and merged

---

## Test Scenarios

| Scenario | Actor | Target | Expected Result |
|----------|-------|--------|-----------------|
| Delete Publisher | Admin | Publisher | Success |
| Delete Publisher | Supervisor | Publisher | Success |
| Delete Teacher | Supervisor | Teacher | Success |
| Delete Admin | Supervisor | Admin | 403 Forbidden |
| Delete Supervisor | Supervisor | Supervisor | 403 Forbidden |
| Delete Self | Admin | Admin (self) | 403 Forbidden |
| Delete Self | Supervisor | Supervisor (self) | 403 Forbidden |
| List Publishers | Supervisor | - | Success |
| Create Teacher | Supervisor | - | Success |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### File List

| File | Action | Description |
|------|--------|-------------|
| `backend/app/models.py` | Modified | Added `supervisor` to UserRole enum |
| `backend/app/alembic/versions/3f90262da238_add_supervisor_role.py` | Created | Alembic migration to add supervisor role to PostgreSQL enum |
| `backend/app/api/deps.py` | Modified | Added `AdminOrSupervisor`, `AdminOnly`, `can_delete_user()`, `can_delete_school()` |
| `backend/app/api/routes/admin.py` | Modified | Updated all endpoints to use AdminOrSupervisor, added hierarchical delete checks, audit logging |
| `backend/app/tests/conftest.py` | Modified | Added `supervisor_user` and `supervisor_token` fixtures |
| `backend/app/tests/test_api/test_supervisor_permissions.py` | Created | 25 unit tests for supervisor permissions |

### Debug Log References
- No issues encountered during implementation

### Completion Notes
- All 9 tasks completed successfully
- 25 new unit tests added, all passing
- 38 existing admin tests still passing (no regressions)
- Migration tested on development database
- Audit logging added for all deletion attempts (both successful and blocked)

### Change Log
| Date | Change | Reason |
|------|--------|--------|
| 2025-12-20 | Initial implementation | Story 14.1 implementation |
