# Story 30.16: Skill Trend Over Time (Teacher & Student)

**Status:** Ready for Review
**Epic:** Epic 30 - Skill-Based AI Assignment Generation & Reporting
**Story Points:** 5
**Priority:** Medium
**Dependencies:** Story 30.12 (Skill score attribution data)

---

## User Story

As a **teacher**,
I want **to see how a student's skill proficiency changes over time**,
So that **I can track improvement, identify regression, and evaluate the effectiveness of my instruction**.

---

## Acceptance Criteria

1. [ ] Line chart renders per-skill trend lines over time (x-axis: date, y-axis: score %)
2. [ ] Date range filtering: last 30 days, last 3 months, semester, all time
3. [ ] Skills with insufficient data (< 3 data points) show "Not enough data" instead of misleading trend
4. [ ] Teacher can view any student's trends (own students only)
5. [ ] Student can view own trends via student dashboard
6. [ ] Chart handles gaps in data gracefully (no connecting line across large time gaps)

---

## Tasks & Subtasks

- [x] **Task 1: Create Skill Trend API** (AC: 1, 2, 3)
  - [x] Add endpoint: `GET /api/v1/students/{student_id}/skill-trends`
  - [x] Query params: `?period=30d|3m|semester|all`
  - [x] Query `StudentSkillScore` ordered by `recorded_at`:
    ```sql
    SELECT skill_id, attributed_score, attributed_max_score, recorded_at, cefr_level
    FROM student_skill_scores
    WHERE student_id = :student_id AND recorded_at >= :start_date
    ORDER BY recorded_at ASC
    ```
  - [x] Group into per-skill time series
  - [x] Apply minimum data threshold: exclude skills with < 3 data points
  - [x] Response schema:
    ```python
    class SkillTrendPoint(BaseModel):
        date: datetime
        score: float  # percentage 0-100
        assignment_name: str | None
        cefr_level: str | None

    class SkillTrendLine(BaseModel):
        skill_id: uuid.UUID
        skill_name: str
        skill_slug: str
        skill_color: str
        data_points: list[SkillTrendPoint]
        has_sufficient_data: bool  # >= 3 points

    class StudentSkillTrendsResponse(BaseModel):
        student_id: uuid.UUID
        period: str
        trends: list[SkillTrendLine]
    ```

- [x] **Task 2: Create Student Self-Endpoint** (AC: 5)
  - [x] Add `GET /api/v1/students/me/skill-trends?period=...`
  - [x] Same logic, student auth

- [x] **Task 3: Create SkillTrendChart Component** (AC: 1, 6)
  - [x] Create `frontend/src/components/analytics/SkillTrendChart.tsx`
  - [x] Use Recharts `LineChart`:
    - One line per skill, colored by skill color
    - X-axis: date (formatted by period granularity)
    - Y-axis: score 0-100%
    - Tooltip: shows score, assignment name, date
    - Legend: clickable to show/hide individual skill lines
  - [x] Handle data gaps: if > 14 days between points, break the line (use `connectNulls={false}`)
  - [x] Skills with insufficient data: show in legend as greyed out with "(Not enough data)"

- [x] **Task 4: Date Range Selector** (AC: 2)
  - [x] Create toggle button group: [30 Days] [3 Months] [Semester] [All Time]
  - [x] Default: 3 Months
  - [x] Refetch data on change

- [x] **Task 5: Integrate into Teacher & Student Views** (AC: 4, 5)
  - [x] Teacher: add below radar chart in student detail view
  - [x] Student: add to skill profile section on dashboard
  - [x] Both views use same SkillTrendChart component

- [x] **Task 6: Unit Tests** (AC: 1-6)
  - [x] Test API returns correct time series per skill
  - [x] Test date range filtering
  - [x] Test skills with < 3 points marked as insufficient
  - [x] Test chart renders with mock time series data
  - [x] Test legend toggling

---

## Dev Notes

### Recharts LineChart Pattern
```typescript
<ResponsiveContainer width="100%" height={400}>
  <LineChart data={mergedTimePoints}>
    <XAxis dataKey="date" tickFormatter={formatDate} />
    <YAxis domain={[0, 100]} />
    <Tooltip />
    <Legend onClick={handleLegendClick} />
    {trends.filter(t => t.has_sufficient_data).map(trend => (
      <Line
        key={trend.skill_slug}
        dataKey={trend.skill_slug}
        stroke={skillColorMap[trend.skill_slug]}
        connectNulls={false}
        dot={{ r: 4 }}
      />
    ))}
  </LineChart>
</ResponsiveContainer>
```
[Source: tech-stack.md — Recharts 2.x]

### Semester Calculation
For "semester" period, use academic calendar:
- Fall: September 1 – January 31
- Spring: February 1 – June 30
Determine current semester based on today's date.

### Testing
- Backend: `backend/app/tests/test_skill_trends.py`
- Frontend: component tests for SkillTrendChart

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `backend/app/schemas/skill.py` | Modified | Added SkillTrendPoint, SkillTrendLine, StudentSkillTrendsResponse schemas |
| `backend/app/api/routes/students.py` | Modified | Added GET /me/skill-trends and GET /{student_id}/skill-trends endpoints |
| `frontend/src/types/skill.ts` | Modified | Added SkillTrendPoint, SkillTrendLine, StudentSkillTrendsResponse TS interfaces |
| `frontend/src/services/skillsApi.ts` | Modified | Added getMySkillTrends() and getStudentSkillTrends() API functions |
| `frontend/src/components/analytics/SkillTrendChart.tsx` | Created | Recharts LineChart with per-skill trend lines and period selector |
| `frontend/src/routes/_layout/teacher/analytics/$studentId.tsx` | Modified | Added SkillTrendChart below radar chart in charts grid |
| `frontend/src/routes/_layout/student/dashboard.tsx` | Modified | Added SkillTrendChart to student dashboard |

### Debug Log References
- No blocking issues encountered

### Completion Notes
- Backend uses shared _build_skill_trends() helper for both endpoints
- Period calculation: 30d, 3m use timedelta; semester uses academic calendar (Sep-Jan/Feb-Jun); all uses year 2000
- Trend lines include assignment names for tooltip context
- Skills with < 3 data points excluded from chart, listed as text below
- ToggleGroup component used for period selector (30 Days / 3 Months / Semester / All Time)
- Chart data merged by date for multi-line rendering with connectNulls={false}
- Teacher view spans full width (md:col-span-2) in the charts grid
- TypeScript check and Vite build both pass clean

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2026-02-13 | 1.1 | Implementation complete | Dev Agent (James) |
