# Story 8.3: Student Multi-Activity Assignment Player

**Epic:** 8 - Multi-Activity Assignments & Page-Based Selection
**Story ID:** 8.3
**Status:** Done/
**Created:** 2025-11-29
**Developer:** James (Dev Agent)

---

## Story

**As a** student,
**I want** to navigate between activities within an assignment and save my progress,
**so that** I can complete all assigned activities at my own pace before submitting.

---

## Acceptance Criteria

1. Assignment detail page shows list of activities with status indicators (not started/in progress/completed)
2. Activity navigation bar shows progress: "Activity 1 of 3" with prev/next buttons
3. Students can jump to any activity (not forced linear progression)
4. Activity status icon: ○ (not started), ◐ (in progress), ✓ (completed)
5. Timer displays total time remaining for entire assignment (shared across activities)
6. "Save & Exit" button saves current activity progress without submitting
7. Progress auto-saved when navigating between activities
8. "Submit Assignment" button enabled only when all activities completed
9. Submit confirmation shows summary: activities completed, estimated score
10. After submission: combined score calculated and stored in AssignmentStudent
11. Backend API `PATCH /api/v1/assignments/{id}/students/me/activities/{activity_id}` saves per-activity progress
12. Backend API `POST /api/v1/assignments/{id}/students/me/submit` validates all activities complete, calculates total score
13. Resume flow: returning student sees previous progress, can continue any activity
14. Time limit enforcement: when timer expires, auto-submit with current progress
15. Unit tests verify progress persistence across activities
16. Integration tests verify submit calculates correct combined score

---

## Tasks / Subtasks

### Backend Tasks

- [x] **Task 1: Create Multi-Activity Start API Endpoint** (AC: 1, 13)
  - [x] Add `GET /api/v1/assignments/{assignment_id}/start-multi` in `backend/app/api/routes/assignments.py`
  - [x] Return: assignment info, list of activities with their configs, and per-activity progress
  - [x] Create schema `MultiActivityStartResponse` with activities list and activity_progress list
  - [x] Initialize `AssignmentStudentActivity` records for each activity if not exist
  - [x] Return existing progress from `AssignmentStudentActivity.response_data` for resume flow
  - [x] Set assignment status to `in_progress` if currently `not_started`

- [x] **Task 2: Create Per-Activity Progress Save API** (AC: 6, 7, 11)
  - [x] Add `PATCH /api/v1/assignments/{assignment_id}/students/me/activities/{activity_id}` endpoint
  - [x] Create schema `ActivityProgressSaveRequest` with: `response_data`, `time_spent_seconds`, `status`
  - [x] Validate: student is assigned to assignment, activity belongs to assignment
  - [x] Update `AssignmentStudentActivity` record with progress
  - [x] Set `started_at` on first save if null
  - [x] Calculate activity score if status is `completed`
  - [x] Rate limit: 120 requests/hour (same as existing save-progress)

- [x] **Task 3: Create Multi-Activity Submit API** (AC: 8, 9, 10, 12, 14)
  - [x] Add `POST /api/v1/assignments/{assignment_id}/students/me/submit-multi` endpoint
  - [x] Create schema `MultiActivitySubmitRequest` with optional `force_submit` flag (for timeout)
  - [x] Validate all activities are completed (unless `force_submit=true` for timer expiry)
  - [x] Calculate combined score using `AssignmentStudent.calculate_combined_score()`
  - [x] Update `AssignmentStudent` with: status=completed, score, completed_at, total time_spent
  - [x] Return `MultiActivitySubmitResponse` with: combined_score, per_activity_scores, completion status

- [x] **Task 4: Backend Unit Tests** (AC: 15, 16)
  - [x] Create `backend/app/tests/test_api/test_multi_activity_player.py`
  - [x] Test: start-multi returns all activities with configs
  - [x] Test: start-multi initializes AssignmentStudentActivity records
  - [x] Test: per-activity progress save updates correct record
  - [x] Test: per-activity progress save sets started_at on first save
  - [x] Test: submit-multi validates all activities completed
  - [x] Test: submit-multi allows force_submit with partial completion
  - [x] Test: combined score calculation is accurate
  - [x] Test: resume flow returns previous progress

### Frontend Tasks

- [x] **Task 5: Create MultiActivityPlayer Component** (AC: 1, 2, 3, 4, 5, 13)
  - [x] Create `frontend/src/components/ActivityPlayers/MultiActivityPlayer.tsx`
  - [x] Props: `assignmentId`, `activities: Activity[]`, `activityProgress: ActivityProgress[]`, `timeLimit?: number`
  - [x] State: `currentActivityIndex`, `activityStates: Map<string, ActivityState>`
  - [x] Render activity navigation bar with prev/next buttons
  - [x] Show "Activity X of Y" progress indicator
  - [x] Display activity status icons: ○ (not started), ◐ (in progress), ✓ (completed)
  - [x] Shared timer component showing total time remaining
  - [x] Wrap existing `ActivityPlayer` component for current activity

- [x] **Task 6: Create ActivityNavigationBar Component** (AC: 2, 3, 4)
  - [x] Create `frontend/src/components/ActivityPlayers/ActivityNavigationBar.tsx`
  - [x] Props: `activities`, `currentIndex`, `activityStates`, `onNavigate`
  - [x] Clickable activity indicators (circles) to jump to any activity
  - [x] Prev/Next buttons at sides
  - [x] Visual distinction for current, completed, in-progress, not-started
  - [x] Mobile responsive: horizontal scroll if too many activities

- [x] **Task 7: Create SharedAssignmentTimer Component** (AC: 5, 14)
  - [x] Create `frontend/src/components/ActivityPlayers/SharedAssignmentTimer.tsx`
  - [x] Props: `totalTimeLimit`, `elapsedTime`, `onTimeExpired`
  - [x] Countdown display for remaining time across all activities
  - [x] Warning state when < 5 minutes remaining (yellow)
  - [x] Critical state when < 1 minute remaining (red)
  - [x] Auto-submit callback when time expires

- [x] **Task 8: Implement Save & Auto-Save Logic** (AC: 6, 7)
  - [x] Auto-save implemented in MultiActivityPlayer (30s interval)
  - [x] Auto-save current activity on: interval (30s), blur, navigation between activities
  - [x] Call `PATCH /activities/{activity_id}` endpoint
  - [x] "Save & Exit" button saves current progress and navigates to assignment detail
  - [x] Show "Saving..." indicator during save
  - [x] Handle save failures gracefully (retry, show error)

- [x] **Task 9: Implement Submit Flow** (AC: 8, 9, 10)
  - [x] Create `SubmitConfirmationDialog` component
  - [x] Show summary: X of Y activities completed, estimated score
  - [x] Enable submit only when all activities completed (or force submit on timeout)
  - [x] Call `POST /submit-multi` endpoint
  - [x] Navigate to success page with combined score

- [x] **Task 10: Create Multi-Activity Play Route** (AC: 1, 13)
  - [x] Create `frontend/src/routes/_layout/student/assignments/$assignmentId/play-multi.tsx`
  - [x] Fetch assignment data via new `startMultiActivityAssignment` API
  - [x] Detect single vs multi-activity and route appropriately
  - [x] Pass activities and progress to `MultiActivityPlayer`

- [x] **Task 11: Update Assignment Detail Page** (AC: 1, 4, 13)
  - [x] Modify `frontend/src/routes/_layout/student/assignments/$assignmentId/index.tsx`
  - [x] Show activity list with status indicators for multi-activity assignments
  - [x] Show progress summary: "3 of 5 activities completed"
  - [x] "Continue" or "Start" button based on progress state
  - [x] Route to `play-multi` for multi-activity assignments

- [x] **Task 12: Update API Service** (AC: 11, 12)
  - [x] Add `startMultiActivityAssignment(assignmentId)` to `frontend/src/services/assignmentsApi.ts`
  - [x] Add `saveActivityProgress(assignmentId, activityId, data)`
  - [x] Add `submitMultiActivityAssignment(assignmentId, forceSubmit?)`
  - [x] Add TypeScript types for new request/response schemas

- [x] **Task 13: Update TypeScript Types**
  - [x] Add `MultiActivityStartResponse` interface to `frontend/src/types/assignment.ts`
  - [x] Add `ActivityProgressSaveRequest` interface
  - [x] Add `MultiActivitySubmitRequest` and `MultiActivitySubmitResponse` interfaces
  - [x] Add `ActivityState` type for UI state tracking

- [x] **Task 14: Frontend Component Tests** (AC: 15)
  - [x] Create `frontend/src/components/ActivityPlayers/MultiActivityPlayer.test.tsx`
  - [x] Test: Activity navigation renders correctly
  - [x] Test: Status icons display correct states
  - [x] Test: Navigation between activities works
  - [x] Test: Timer displays and counts down
  - [x] Create `frontend/src/components/ActivityPlayers/ActivityNavigationBar.test.tsx`
  - [x] Test: All activities rendered as clickable indicators
  - [x] Test: Current activity highlighted
  - [x] Test: Navigation callback triggered on click

---

## Dev Notes

### Previous Story Insights
[Source: Story 8.1 & 8.2 Completion Notes]
- Story 8.1 created `AssignmentActivity` junction table and `AssignmentStudentActivity` for per-activity tracking
- `AssignmentStudent.calculate_combined_score()` method available for score aggregation
- `AssignmentStudent.all_activities_completed` property checks if all activities are done
- Story 8.2 implemented page-based activity selection UI for teachers

### Data Model Reference
[Source: backend/app/models.py]

**AssignmentStudentActivity fields:**
```python
class AssignmentStudentActivityBase(SQLModel):
    status: AssignmentStudentActivityStatus = Field(default=not_started)
    score: float | None = Field(default=None, ge=0)
    max_score: float = Field(default=100.0, ge=0)
    response_data: dict | None = Field(sa_column=Column(JSON))
    started_at: datetime | None
    completed_at: datetime | None
```

**AssignmentStudentActivityStatus enum:**
- `not_started`
- `in_progress`
- `completed`

**AssignmentStudent helper methods:**
```python
def calculate_combined_score(self) -> float | None:
    # Calculates (total_score / total_max_score) * 100

@property
def all_activities_completed(self) -> bool:
    # Returns True if all activity_progress items are 'completed'
```

### Existing API Endpoints Reference
[Source: backend/app/api/routes/assignments.py]

Current endpoints for single-activity:
- `GET /{assignment_id}/start` - starts assignment, returns activity config
- `POST /{assignment_id}/save-progress` - saves progress_json
- `POST /{assignment_id}/submit` - submits with score

These will be preserved for backward compatibility. New multi-activity endpoints:
- `GET /{assignment_id}/start-multi` - NEW
- `PATCH /{assignment_id}/students/me/activities/{activity_id}` - NEW
- `POST /{assignment_id}/students/me/submit-multi` - NEW

### Frontend Types Already Available
[Source: frontend/src/types/assignment.ts]

```typescript
export interface AssignmentStudentActivityResponse {
  id: string
  assignment_student_id: string
  activity_id: string
  status: AssignmentStudentActivityStatus
  score: number | null
  max_score: number
  response_data: Record<string, any> | null
  started_at: string | null
  completed_at: string | null
}
```

### Existing ActivityPlayer Integration
[Source: frontend/src/components/ActivityPlayers/ActivityPlayer.tsx]

The existing `ActivityPlayer` component accepts:
```typescript
interface ActivityPlayerProps {
  activityConfig: ActivityConfig
  assignmentId: string
  bookId: string
  bookName: string
  publisherName: string
  bookTitle: string
  activityType: string
  timeLimit?: number
  onExit: () => void
  initialProgress?: Record<string, any> | null
  initialTimeSpent?: number
}
```

For multi-activity, wrap this component inside `MultiActivityPlayer`:
- Pass current activity's config
- Handle `onExit` to save progress and navigate
- Override timer behavior (use shared timer instead)

### Auto-Save Pattern
[Source: frontend/src/hooks/useAutoSave.ts]

Existing `useAutoSaveWithData` hook pattern:
- Debounced save (30 second interval)
- Calls `saveProgress` API
- Shows toast on save errors

For multi-activity, create `useMultiActivityProgress`:
- Call `saveActivityProgress` with activity_id
- Track per-activity dirty state
- Save on activity navigation

### File Locations
[Source: architecture/source-tree.md]

```
backend/app/
├── api/routes/assignments.py          # Add new endpoints
├── schemas/assignment.py              # Add new request/response schemas
└── tests/test_api/
    └── test_multi_activity_player.py  # NEW test file

frontend/src/
├── components/ActivityPlayers/
│   ├── MultiActivityPlayer.tsx        # NEW - wrapper component
│   ├── ActivityNavigationBar.tsx      # NEW - navigation UI
│   ├── SharedAssignmentTimer.tsx      # NEW - shared timer
│   ├── MultiActivityPlayer.test.tsx   # NEW - tests
│   └── ActivityNavigationBar.test.tsx # NEW - tests
├── routes/_layout/student/assignments/$assignmentId/
│   ├── index.tsx                      # MODIFY - show activity list
│   └── play-multi.tsx                 # NEW - multi-activity route
├── hooks/
│   └── useMultiActivityProgress.ts    # NEW - save/auto-save hook
├── services/assignmentsApi.ts         # ADD new API functions
└── types/assignment.ts                # ADD new types
```

### Shadcn UI Components Available
[Source: frontend/src/components/ui/]
- `Progress` - for overall completion progress bar
- `Button` - prev/next/submit/save buttons
- `Dialog` - submit confirmation dialog
- `Badge` - status indicators
- `Skeleton` - loading states
- `Alert` - error messages
- `Tabs` - could be used for activity switching (alternative to circles)

### Mobile Responsive Patterns
[Source: architecture/coding-standards.md]
- Use Tailwind responsive prefixes: `sm:`, `md:`, `lg:`
- Navigation bar: horizontal scroll on mobile
- Stack layout for activity cards on small screens

### Timer Implementation Notes
[Source: Epic 8 PRD]
- Single timer managed at assignment level
- Elapsed time accumulated across all activities
- Timer persists across browser refresh (store in localStorage + backend)
- Auto-submit triggers when timer expires

---

## Testing

### Backend Testing Requirements
[Source: architecture/10-testing-strategy.md]
- Use pytest with async fixtures
- Test file: `backend/app/tests/test_api/test_multi_activity_player.py`
- Create fixtures for:
  - Multi-activity assignment with 3+ activities
  - AssignmentStudent with partial progress
  - AssignmentStudentActivity records at various states
- Test patterns:
  - Arrange-Act-Assert structure
  - Use `@pytest.mark.asyncio` for async tests
  - Mock database with test session

### Frontend Testing Requirements
[Source: architecture/10-testing-strategy.md]
- Use Vitest + React Testing Library
- Test files colocated with components
- Mock API calls with vitest mocks
- Test accessibility (role queries)

### Test Coverage Expectations
- Backend: 8-10 integration tests for new endpoints
- Frontend: 10-12 component tests for new components
- E2E: Optional - complete multi-activity assignment flow

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-29 | 1.0 | Initial story draft | Bob (SM Agent) |
| 2025-11-30 | 1.1 | QA fixes: Updated 2 failing tests to match UI changes | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

**QA Fix Validation (2025-11-30):**
- `npx vitest run src/components/ActivityPlayers/MultiActivityPlayer.test.tsx` → 13 tests passed
- `npx vitest run src/components/ActivityPlayers/ActivityNavigationBar.test.tsx` → 7 tests passed

### Completion Notes

Story 8.3 implementation completed successfully. All 14 tasks have been implemented:

**Backend (Tasks 1-4):**
- Added 3 new API endpoints for multi-activity assignments
- `GET /assignments/{id}/start-multi` - Returns all activities with configs and per-activity progress
- `PATCH /assignments/{id}/students/me/activities/{activity_id}` - Saves per-activity progress
- `POST /assignments/{id}/students/me/submit-multi` - Validates and submits multi-activity assignments
- 14 backend integration tests all passing

**Frontend (Tasks 5-14):**
- Created MultiActivityPlayer component with activity navigation and state management
- Created ActivityNavigationBar with clickable indicators and status icons
- Created SharedAssignmentTimer with warning/critical states and auto-submit
- Created SubmitConfirmationDialog with activity summary
- Created play-multi route for multi-activity assignments
- Updated assignment detail page to detect and display multi-activity assignments
- Added 3 new API service functions
- Added 12 TypeScript interfaces for multi-activity support
- 20 frontend component tests all passing

**Key Implementation Decisions:**
- Auto-save logic embedded in MultiActivityPlayer (30s interval) rather than separate hook
- Progress saved on activity navigation and before page unload
- Timer shared across all activities (not per-activity)
- Submit button always enabled with warning dialog for incomplete activities (UX improvement)
- Force submit available for timer expiry scenarios

**QA Fixes Applied (2025-11-30):**
- Updated test `renders assignment name and book title` → `renders header with navigation and progress` (header simplified)
- Updated test `disables Submit button when not all completed` → `enables Submit button regardless of completion status` (submit always enabled per UX decision)

### File List

**Backend:**
- `backend/app/api/routes/assignments.py` (modified - added 3 endpoints)
- `backend/app/schemas/assignment.py` (modified - added 8 schemas)
- `backend/app/tests/test_api/test_multi_activity_player.py` (created - 14 tests)

**Frontend:**
- `frontend/src/types/assignment.ts` (modified - added 12 interfaces)
- `frontend/src/services/assignmentsApi.ts` (modified - added 3 functions)
- `frontend/src/components/ActivityPlayers/MultiActivityPlayer.tsx` (created)
- `frontend/src/components/ActivityPlayers/MultiActivityPlayer.test.tsx` (created - 13 tests)
- `frontend/src/components/ActivityPlayers/ActivityNavigationBar.tsx` (created)
- `frontend/src/components/ActivityPlayers/ActivityNavigationBar.test.tsx` (created - 7 tests)
- `frontend/src/components/ActivityPlayers/SharedAssignmentTimer.tsx` (created)
- `frontend/src/components/ActivityPlayers/SubmitConfirmationDialog.tsx` (created)
- `frontend/src/routes/_layout/student/assignments/$assignmentId/play-multi.tsx` (created)
- `frontend/src/routes/_layout/student/assignments/$assignmentId/index.tsx` (modified)

---

## QA Results

### Review Date: 2025-11-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Overall implementation is **solid** with good separation of concerns. The MultiActivityPlayer component properly manages state, handles navigation, auto-save, and submission flows. Backend endpoints are well-structured with proper authorization and rate limiting.

**Strengths:**
- Clean component architecture with proper TypeScript typing
- Good use of hooks (`useCallback`, `useMemo`, `useEffect`) for performance
- Comprehensive error handling with user-friendly toast notifications
- Rate limiting on save endpoints (120/hour)
- Role-based authorization on all endpoints
- Auto-save on 30s interval and page unload using `sendBeacon`

**Recent Session Changes (intentional per user request):**
- Layout simplified to maximize activity area - removed redundant headers
- Submit button now always enabled with warning dialog for incomplete activities
- Added responsive sizing for activity player images and controls

### Refactoring Performed

- No refactoring performed during this review (implementation aligned with story)

### Compliance Check

- Coding Standards: ✓ Follows TypeScript conventions, proper component structure
- Project Structure: ✓ Files in correct locations per source-tree.md
- Testing Strategy: ✓ Unit tests present for components and API endpoints
- All ACs Met: ⚠️ AC8 modified - Submit now always enabled with warning (user-approved UX change)

### Improvements Checklist

- [ ] **Update MultiActivityPlayer.test.tsx** - 2 tests fail due to intentional UI changes:
  - `renders assignment name and book title` - Header no longer shows these
  - `disables Submit button when not all activities are completed` - Submit now always enabled
- [ ] Consider adding E2E test for complete multi-activity flow
- [ ] Add test for `sendBeacon` on page unload behavior

### Security Review

✓ **PASS** - No security concerns found:
- All endpoints require proper role (`UserRole.student`)
- Student can only access their own assignments (verified via AssignmentStudent lookup)
- Rate limiting prevents abuse (120 req/hour on save)
- `force_submit` properly limited to timeout scenarios

### Performance Considerations

✓ **PASS** - Implementation is performant:
- Auto-save debounced to 30s intervals (not on every keystroke)
- Activity states use Map for O(1) lookups
- `useMemo` prevents unnecessary recalculations
- `sendBeacon` for reliable unload saves without blocking

### Files Modified During Review

None - Review only

### Gate Status

Gate: **CONCERNS** → docs/qa/gates/8.3-student-multi-activity-assignment-player.yml

### Recommended Status

✗ Changes Required - See unchecked items above

**Required before Done:**
1. Update failing frontend tests to match new UI behavior

(Story owner decides final status)

---

### Review Date: 2025-11-30 (Follow-up Review)

### Reviewed By: Quinn (Test Architect)

### Previous Issues Resolution

The developer has addressed all CONCERNS from the previous review:

- [x] **Updated MultiActivityPlayer.test.tsx** - 2 tests updated to match new UI:
  - `renders assignment name and book title` → `renders header with navigation and progress`
  - `disables Submit button when not all activities are completed` → `enables Submit button regardless of completion status`

**All 34 tests now passing:**
- Frontend: 20 tests (MultiActivityPlayer: 13, ActivityNavigationBar: 7)
- Backend: 14 tests (test_multi_activity_player.py)

### Requirements Traceability

| AC | Description | Test Coverage | Status |
|----|-------------|---------------|--------|
| 1 | Activity list with status indicators | `test_start_multi_returns_all_activities`, `shows completion progress` | ✓ |
| 2 | Navigation bar: "Activity X of Y" | `renders all activity buttons`, `shows correct activity indicator` | ✓ |
| 3 | Jump to any activity | `calls onNavigate when clicking an activity` | ✓ |
| 4 | Status icons (○, ◐, ✓) | `shows correct status for completed activities` | ✓ |
| 5 | Shared timer | `renders shared timer when time limit is set` | ✓ |
| 6 | Save & Exit | `renders navigation buttons`, `test_save_progress_updates_record` | ✓ |
| 7 | Auto-save on navigation | Implementation in `handleNavigate`, backend tests | ✓ |
| 8 | Submit button (modified UX) | `enables Submit button regardless of completion status` | ✓ (modified) |
| 9 | Submit confirmation summary | SubmitConfirmationDialog implementation | ✓ |
| 10 | Combined score calculation | `test_submit_multi_calculates_combined_score` | ✓ |
| 11 | PATCH per-activity progress | `TestSaveActivityProgress` (4 tests) | ✓ |
| 12 | POST submit-multi | `TestSubmitMultiActivityAssignment` (5 tests) | ✓ |
| 13 | Resume flow | `test_start_multi_resume_returns_existing_progress` | ✓ |
| 14 | Timer auto-submit | `test_submit_multi_force_submit_with_partial_completion` | ✓ |
| 15 | Unit tests for progress | 34 tests total | ✓ |
| 16 | Integration tests for scoring | `test_submit_multi_calculates_combined_score` | ✓ |

### Code Quality Assessment

**Overall: Excellent** - Clean implementation following project patterns.

**Strengths:**
- Well-structured component architecture with clear separation of concerns
- Proper TypeScript typing throughout
- Good use of React hooks for performance optimization
- Comprehensive accessibility support (aria-labels, role="timer")
- sendBeacon for reliable page unload saves
- Rate limiting on save endpoints (120/hour)
- Idempotent submission handling

### Compliance Check

- Coding Standards: ✓ Follows TypeScript conventions
- Project Structure: ✓ Files in correct locations
- Testing Strategy: ✓ Unit + integration tests present
- All ACs Met: ✓ (AC8 modified with UX approval)

### Security Review

✓ **PASS**
- Role-based authorization on all endpoints
- Student can only access their own assignments
- Rate limiting prevents abuse
- No sensitive data exposure

### Performance Considerations

✓ **PASS**
- Auto-save debounced to 30s intervals
- Map-based state for O(1) lookups
- useMemo prevents unnecessary recalculations

### Future Recommendations

- [ ] Consider adding SubmitConfirmationDialog.test.tsx for explicit dialog testing
- [ ] Add E2E test for complete multi-activity assignment flow (optional)
- [ ] Add test for sendBeacon behavior on page unload (optional)

### Gate Status

Gate: **PASS** → docs/qa/gates/8.3-student-multi-activity-assignment-player.yml

### Recommended Status

✓ Ready for Done
(Story owner decides final status)
