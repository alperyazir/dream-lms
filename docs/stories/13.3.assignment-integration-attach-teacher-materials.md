# Story 13.3: Assignment Integration - Attach Teacher Materials

**Status:** Done
**Epic:** Epic 13 - Teacher Supplementary Materials
**Story Points:** 5
**Priority:** High
**Dependencies:** Story 13.1, Story 13.2, Story 10.3 (Video Attachment)

---

## User Story

As a **teacher**,
I want **to attach my uploaded materials to assignments**,
So that **students can access supplementary resources alongside their activities**.

As a **student**,
I want **to view and access materials attached to my assignments**,
So that **I have all the resources I need to complete my work**.

---

## Acceptance Criteria

### Teacher - Assignment Creation
1. [ ] "My Materials" section visible in Additional Resources step
2. [ ] Material picker shows all teacher's uploaded materials
3. [ ] Filter materials by type in picker
4. [ ] Search materials by name in picker
5. [ ] Preview materials before attaching
6. [ ] Add multiple materials to assignment
7. [ ] Remove attached materials before creating
8. [ ] Selected materials shown in Review step
9. [ ] Materials saved with assignment on creation

### Teacher - Assignment Edit
10. [ ] Edit assignment shows currently attached materials
11. [ ] Can add new materials to existing assignment
12. [ ] Can remove materials from existing assignment
13. [ ] Changes saved on update

### Student - View Materials
14. [ ] ResourceSidebar shows attached materials (grouped by type)
15. [ ] Materials display with appropriate icons
16. [ ] Documents show download action
17. [ ] Images show view/preview action
18. [ ] Audio plays using AudioPlayer component
19. [ ] Video plays using VideoPlayer component
20. [ ] Text notes display in modal
21. [ ] URLs open in new tab
22. [ ] Deleted materials show "Material unavailable" message

### Data Persistence
23. [ ] Materials attached via junction table or JSON field
24. [ ] Material metadata cached for display (name, type)
25. [ ] Assignment still functional if material deleted
26. [ ] No orphaned data on assignment deletion

---

## Technical Architecture

### Backend Changes

#### Extend AdditionalResources Schema

```python
# backend/app/schemas/assignment.py

from enum import Enum
from pydantic import BaseModel, field_validator
from typing import Literal
import uuid


class ResourceType(str, Enum):
    """Types of additional resources"""
    video = "video"
    teacher_material = "teacher_material"


class VideoResource(BaseModel):
    """Video from book's DCS folder"""
    type: Literal["video"] = "video"
    path: str
    name: str
    subtitles_enabled: bool = True
    has_subtitles: bool = False

    @field_validator("path")
    def validate_path(cls, v: str) -> str:
        if ".." in v:
            raise ValueError("Invalid path: path traversal not allowed")
        return v


class TeacherMaterialResource(BaseModel):
    """
    Teacher's uploaded material reference.

    Stores denormalized name/type for display even if material is deleted.
    """
    type: Literal["teacher_material"] = "teacher_material"
    material_id: uuid.UUID
    # Denormalized fields for display
    name: str
    material_type: str  # document, image, audio, video, url, text_note


class AdditionalResources(BaseModel):
    """Container for all resources attached to assignment"""
    videos: list[VideoResource] = []
    teacher_materials: list[TeacherMaterialResource] = []


# Response schema with availability status
class TeacherMaterialResourceResponse(TeacherMaterialResource):
    """Response with availability status"""
    is_available: bool = True
    file_size: int | None = None
    mime_type: str | None = None
    # For URLs
    url: str | None = None
    # For text notes
    text_content: str | None = None
    # Download URL (for files)
    download_url: str | None = None


class AdditionalResourcesResponse(BaseModel):
    """Response with enriched material data"""
    videos: list[VideoResource] = []
    teacher_materials: list[TeacherMaterialResourceResponse] = []
```

#### Update Assignment API

```python
# backend/app/api/routes/assignments.py

@router.post("", response_model=AssignmentResponse)
async def create_assignment(
    data: AssignmentCreate,
    current_user: User = Depends(get_current_active_teacher),
    session: Session = Depends(get_db),
) -> AssignmentResponse:
    """Create assignment with optional resources."""

    # ... existing validation ...

    # Validate teacher materials if provided
    if data.resources and data.resources.teacher_materials:
        for mat_ref in data.resources.teacher_materials:
            material = session.exec(
                select(TeacherMaterial).where(
                    TeacherMaterial.id == mat_ref.material_id,
                    TeacherMaterial.teacher_id == current_user.id,
                )
            ).first()

            if not material:
                raise HTTPException(
                    status_code=status.HTTP_404_NOT_FOUND,
                    detail=f"Material {mat_ref.material_id} not found"
                )

            # Update denormalized fields
            mat_ref.name = material.name
            mat_ref.material_type = material.type.value

    # Create assignment with resources
    assignment = Assignment(
        **data.model_dump(exclude={"resources", "activity_ids", ...}),
        teacher_id=current_user.id,
        resources=data.resources.model_dump() if data.resources else None,
    )

    # ... rest of creation logic ...


@router.get("/{assignment_id}", response_model=AssignmentDetailResponse)
async def get_assignment(
    assignment_id: uuid.UUID,
    current_user: User = Depends(get_current_active_user),
    session: Session = Depends(get_db),
) -> AssignmentDetailResponse:
    """Get assignment with enriched resources."""

    assignment = get_assignment_by_id(session, assignment_id)

    # Enrich resources with current availability
    resources_response = None
    if assignment.resources:
        resources = AdditionalResources.model_validate(assignment.resources)
        resources_response = enrich_resources(session, resources, current_user)

    return AssignmentDetailResponse(
        **assignment.model_dump(),
        resources=resources_response,
    )


def enrich_resources(
    session: Session,
    resources: AdditionalResources,
    current_user: User,
) -> AdditionalResourcesResponse:
    """Enrich resource references with current data and availability."""

    enriched_materials = []

    for mat_ref in resources.teacher_materials:
        # Try to fetch current material data
        material = session.exec(
            select(TeacherMaterial).where(
                TeacherMaterial.id == mat_ref.material_id
            )
        ).first()

        if material:
            enriched_materials.append(
                TeacherMaterialResourceResponse(
                    type="teacher_material",
                    material_id=mat_ref.material_id,
                    name=material.name,  # Use current name
                    material_type=material.type.value,
                    is_available=True,
                    file_size=material.file_size,
                    mime_type=material.mime_type,
                    url=material.url,
                    text_content=material.text_content,
                    download_url=f"/api/v1/teachers/materials/{material.id}/download"
                    if material.storage_path else None,
                )
            )
        else:
            # Material was deleted - use cached/denormalized data
            enriched_materials.append(
                TeacherMaterialResourceResponse(
                    type="teacher_material",
                    material_id=mat_ref.material_id,
                    name=mat_ref.name,  # Use cached name
                    material_type=mat_ref.material_type,
                    is_available=False,
                )
            )

    return AdditionalResourcesResponse(
        videos=resources.videos,
        teacher_materials=enriched_materials,
    )
```

#### Student Material Access Endpoint

```python
# backend/app/api/routes/materials.py

@router.get("/{material_id}/student-access")
async def get_material_for_student(
    material_id: uuid.UUID,
    assignment_id: uuid.UUID,
    current_user: User = Depends(get_current_active_user),
    session: Session = Depends(get_db),
) -> StreamingResponse:
    """
    Download material as a student.

    Validates that:
    1. Assignment exists and contains this material
    2. Student is assigned to this assignment
    """
    # Verify student has access to assignment
    assignment_student = session.exec(
        select(AssignmentStudent).where(
            AssignmentStudent.assignment_id == assignment_id,
            AssignmentStudent.student_id == current_user.id,
        )
    ).first()

    if not assignment_student:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="You don't have access to this assignment"
        )

    # Verify material is in assignment
    assignment = session.exec(
        select(Assignment).where(Assignment.id == assignment_id)
    ).first()

    if not assignment or not assignment.resources:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Assignment not found"
        )

    resources = AdditionalResources.model_validate(assignment.resources)
    material_ids = [m.material_id for m in resources.teacher_materials]

    if material_id not in material_ids:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Material not attached to this assignment"
        )

    # Get and stream material
    material = session.exec(
        select(TeacherMaterial).where(TeacherMaterial.id == material_id)
    ).first()

    if not material:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Material no longer available"
        )

    # Stream from DCS
    # ... streaming logic similar to teacher download ...
```

### Frontend Changes

#### Extend TypeScript Types

```typescript
// frontend/src/types/assignment.ts

export interface TeacherMaterialResource {
  type: "teacher_material"
  material_id: string
  name: string
  material_type: "document" | "image" | "audio" | "video" | "url" | "text_note"
}

export interface TeacherMaterialResourceResponse extends TeacherMaterialResource {
  is_available: boolean
  file_size: number | null
  mime_type: string | null
  url: string | null
  text_content: string | null
  download_url: string | null
}

export interface AdditionalResources {
  videos: VideoResource[]
  teacher_materials: TeacherMaterialResource[]
}

export interface AdditionalResourcesResponse {
  videos: VideoResource[]
  teacher_materials: TeacherMaterialResourceResponse[]
}
```

#### Material Picker Component

```typescript
// frontend/src/components/assignments/TeacherMaterialPicker.tsx

import { useState } from "react"
import { useMaterials } from "@/hooks/useMaterials"
import { MaterialTypeIcon } from "@/components/materials/MaterialTypeIcon"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Select } from "@/components/ui/select"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Checkbox } from "@/components/ui/checkbox"
import { formatBytes } from "@/lib/utils"
import type { Material, MaterialType, TeacherMaterialResource } from "@/types/material"

interface TeacherMaterialPickerProps {
  selectedMaterials: TeacherMaterialResource[]
  onSelectionChange: (materials: TeacherMaterialResource[]) => void
}

export function TeacherMaterialPicker({
  selectedMaterials,
  onSelectionChange,
}: TeacherMaterialPickerProps) {
  const [typeFilter, setTypeFilter] = useState<MaterialType | "all">("all")
  const [searchQuery, setSearchQuery] = useState("")

  const { data, isLoading } = useMaterials({
    type_filter: typeFilter === "all" ? undefined : typeFilter,
    limit: 100,
  })

  const materials = data?.materials ?? []

  // Filter by search query
  const filteredMaterials = materials.filter((m) =>
    m.name.toLowerCase().includes(searchQuery.toLowerCase())
  )

  const isSelected = (material: Material) =>
    selectedMaterials.some((s) => s.material_id === material.id)

  const handleToggle = (material: Material) => {
    if (isSelected(material)) {
      onSelectionChange(
        selectedMaterials.filter((s) => s.material_id !== material.id)
      )
    } else {
      onSelectionChange([
        ...selectedMaterials,
        {
          type: "teacher_material",
          material_id: material.id,
          name: material.name,
          material_type: material.type,
        },
      ])
    }
  }

  return (
    <div className="space-y-4">
      <div className="flex gap-2">
        <Input
          placeholder="Search materials..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="flex-1"
        />
        <Select
          value={typeFilter}
          onValueChange={(v) => setTypeFilter(v as MaterialType | "all")}
        >
          <option value="all">All Types</option>
          <option value="document">Documents</option>
          <option value="image">Images</option>
          <option value="audio">Audio</option>
          <option value="video">Video</option>
          <option value="url">Links</option>
          <option value="text_note">Notes</option>
        </Select>
      </div>

      <ScrollArea className="h-64 border rounded-md">
        {isLoading ? (
          <div className="p-4 text-center text-muted-foreground">Loading...</div>
        ) : filteredMaterials.length === 0 ? (
          <div className="p-4 text-center text-muted-foreground">
            No materials found. Upload materials in "My Materials" first.
          </div>
        ) : (
          <div className="divide-y">
            {filteredMaterials.map((material) => (
              <div
                key={material.id}
                className="flex items-center gap-3 p-3 hover:bg-muted/50 cursor-pointer"
                onClick={() => handleToggle(material)}
              >
                <Checkbox
                  checked={isSelected(material)}
                  onCheckedChange={() => handleToggle(material)}
                />
                <MaterialTypeIcon type={material.type} className="h-5 w-5" />
                <div className="flex-1 min-w-0">
                  <p className="font-medium truncate">{material.name}</p>
                  <p className="text-xs text-muted-foreground">
                    {material.file_size ? formatBytes(material.file_size) : material.type}
                  </p>
                </div>
              </div>
            ))}
          </div>
        )}
      </ScrollArea>

      {selectedMaterials.length > 0 && (
        <div className="border rounded-md p-3">
          <p className="text-sm font-medium mb-2">
            Selected ({selectedMaterials.length}):
          </p>
          <div className="flex flex-wrap gap-2">
            {selectedMaterials.map((mat) => (
              <div
                key={mat.material_id}
                className="flex items-center gap-1 bg-muted px-2 py-1 rounded text-sm"
              >
                <MaterialTypeIcon type={mat.material_type} className="h-4 w-4" />
                <span className="truncate max-w-32">{mat.name}</span>
                <button
                  onClick={(e) => {
                    e.stopPropagation()
                    onSelectionChange(
                      selectedMaterials.filter((s) => s.material_id !== mat.material_id)
                    )
                  }}
                  className="ml-1 text-muted-foreground hover:text-foreground"
                >
                  Ã—
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}
```

#### Update StepAdditionalResources

```typescript
// frontend/src/components/assignments/steps/StepAdditionalResources.tsx

import { TeacherMaterialPicker } from "../TeacherMaterialPicker"
import type { AdditionalResources, TeacherMaterialResource, VideoResource } from "@/types/assignment"

interface StepAdditionalResourcesProps {
  bookId: string
  resources: AdditionalResources
  onResourcesChange: (resources: AdditionalResources) => void
}

export function StepAdditionalResources({
  bookId,
  resources,
  onResourcesChange,
}: StepAdditionalResourcesProps) {
  // Existing video handling...
  const handleVideoChange = (videos: VideoResource[]) => {
    onResourcesChange({ ...resources, videos })
  }

  // New: Teacher materials handling
  const handleMaterialsChange = (teacher_materials: TeacherMaterialResource[]) => {
    onResourcesChange({ ...resources, teacher_materials })
  }

  return (
    <div className="space-y-6">
      {/* Existing: Book Videos Section */}
      <div>
        <h3 className="text-lg font-medium mb-3">ğŸ“š Book Resources</h3>
        <p className="text-sm text-muted-foreground mb-3">
          Attach videos from the selected book
        </p>
        {/* Existing video picker */}
        <BookVideoPicker
          bookId={bookId}
          selectedVideos={resources.videos}
          onSelectionChange={handleVideoChange}
        />
      </div>

      <Separator />

      {/* New: Teacher Materials Section */}
      <div>
        <h3 className="text-lg font-medium mb-3">ğŸ“ My Materials</h3>
        <p className="text-sm text-muted-foreground mb-3">
          Attach your uploaded materials (documents, images, audio, video, links, notes)
        </p>
        <TeacherMaterialPicker
          selectedMaterials={resources.teacher_materials}
          onSelectionChange={handleMaterialsChange}
        />
      </div>
    </div>
  )
}
```

#### Update ResourceSidebar for Teacher Materials

```typescript
// frontend/src/components/ActivityPlayers/ResourceSidebar.tsx

import { MaterialTypeIcon } from "@/components/materials/MaterialTypeIcon"
import { AudioPlayer } from "./AudioPlayer"
import { VideoPlayer } from "./VideoPlayer"
import { Button } from "@/components/ui/button"
import { Dialog, DialogContent } from "@/components/ui/dialog"
import { Download, ExternalLink, Eye, AlertTriangle } from "lucide-react"
import type { AdditionalResourcesResponse, TeacherMaterialResourceResponse } from "@/types/assignment"

interface ResourceSidebarProps {
  resources: AdditionalResourcesResponse | null
  bookId: string
  assignmentId: string  // NEW: For student access endpoint
  // ... existing props
}

export function ResourceSidebar({
  resources,
  bookId,
  assignmentId,
  isOpen,
  onClose,
}: ResourceSidebarProps) {
  const [selectedMaterial, setSelectedMaterial] = useState<TeacherMaterialResourceResponse | null>(null)
  const [previewOpen, setPreviewOpen] = useState(false)

  if (!isOpen || !resources) return null

  const { videos, teacher_materials } = resources

  const handleMaterialAction = (material: TeacherMaterialResourceResponse) => {
    if (!material.is_available) return

    switch (material.material_type) {
      case "url":
        // Open URL in new tab
        if (material.url) {
          window.open(material.url, "_blank", "noopener,noreferrer")
        }
        break
      case "document":
        // Download document
        if (material.download_url) {
          window.open(
            `${material.download_url}?assignment_id=${assignmentId}`,
            "_blank"
          )
        }
        break
      default:
        // Open preview modal
        setSelectedMaterial(material)
        setPreviewOpen(true)
    }
  }

  const renderMaterialItem = (material: TeacherMaterialResourceResponse) => {
    if (!material.is_available) {
      return (
        <div className="flex items-center gap-2 p-2 text-muted-foreground">
          <AlertTriangle className="h-4 w-4 text-amber-500" />
          <span className="text-sm italic">Material unavailable</span>
        </div>
      )
    }

    const getActionIcon = () => {
      switch (material.material_type) {
        case "url":
          return <ExternalLink className="h-4 w-4" />
        case "document":
          return <Download className="h-4 w-4" />
        default:
          return <Eye className="h-4 w-4" />
      }
    }

    const getActionLabel = () => {
      switch (material.material_type) {
        case "url":
          return "Open"
        case "document":
          return "Download"
        case "image":
          return "View"
        case "audio":
        case "video":
          return "Play"
        case "text_note":
          return "Read"
        default:
          return "View"
      }
    }

    return (
      <div className="flex items-center justify-between p-2 hover:bg-muted/50 rounded">
        <div className="flex items-center gap-2 min-w-0">
          <MaterialTypeIcon type={material.material_type} className="h-4 w-4 shrink-0" />
          <span className="text-sm truncate">{material.name}</span>
        </div>
        <Button
          variant="ghost"
          size="sm"
          onClick={() => handleMaterialAction(material)}
        >
          {getActionIcon()}
          <span className="ml-1">{getActionLabel()}</span>
        </Button>
      </div>
    )
  }

  return (
    <>
      <aside className="w-80 shrink-0 border-l bg-card p-4 overflow-y-auto">
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-semibold">Resources</h3>
          <Button variant="ghost" size="sm" onClick={onClose}>Ã—</Button>
        </div>

        {/* Videos Section */}
        {videos.length > 0 && (
          <div className="mb-4">
            <h4 className="text-sm font-medium mb-2 text-muted-foreground">ğŸ“¹ Videos</h4>
            <div className="space-y-1">
              {videos.map((video, index) => (
                <VideoResourceItem key={index} video={video} bookId={bookId} />
              ))}
            </div>
          </div>
        )}

        {/* Teacher Materials Section */}
        {teacher_materials.length > 0 && (
          <div>
            <h4 className="text-sm font-medium mb-2 text-muted-foreground">ğŸ“ Materials</h4>
            <div className="space-y-1">
              {teacher_materials.map((material) => (
                <div key={material.material_id}>
                  {renderMaterialItem(material)}
                </div>
              ))}
            </div>
          </div>
        )}

        {videos.length === 0 && teacher_materials.length === 0 && (
          <p className="text-sm text-muted-foreground text-center py-4">
            No resources attached
          </p>
        )}
      </aside>

      {/* Material Preview Modal */}
      <Dialog open={previewOpen} onOpenChange={setPreviewOpen}>
        <DialogContent className="max-w-3xl max-h-[80vh]">
          {selectedMaterial && (
            <MaterialPreview
              material={selectedMaterial}
              assignmentId={assignmentId}
              onClose={() => setPreviewOpen(false)}
            />
          )}
        </DialogContent>
      </Dialog>
    </>
  )
}

// Material preview component
function MaterialPreview({
  material,
  assignmentId,
  onClose,
}: {
  material: TeacherMaterialResourceResponse
  assignmentId: string
  onClose: () => void
}) {
  const getStreamUrl = () =>
    `${material.download_url}?assignment_id=${assignmentId}`

  switch (material.material_type) {
    case "image":
      return (
        <div className="flex flex-col items-center">
          <h3 className="font-semibold mb-4">{material.name}</h3>
          <img
            src={getStreamUrl()}
            alt={material.name}
            className="max-h-[60vh] object-contain"
          />
        </div>
      )

    case "audio":
      return (
        <div>
          <h3 className="font-semibold mb-4">{material.name}</h3>
          <AudioPlayer src={getStreamUrl()} />
        </div>
      )

    case "video":
      return (
        <div>
          <h3 className="font-semibold mb-4">{material.name}</h3>
          <VideoPlayer src={getStreamUrl()} />
        </div>
      )

    case "text_note":
      return (
        <div>
          <h3 className="font-semibold mb-4">{material.name}</h3>
          <ScrollArea className="h-[60vh]">
            <div className="prose dark:prose-invert">
              {material.text_content}
            </div>
          </ScrollArea>
        </div>
      )

    default:
      return null
  }
}
```

---

## UI Design

### Assignment Creation - Resources Step (Extended)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Additional Resources                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ğŸ“š Book Resources                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Attach videos from the selected book                                    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [Select videos from book...]                                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                          â”‚
â”‚  ğŸ“ My Materials                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Attach your uploaded materials                                          â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Search: [________________]     Filter: [All Types â–¼]                â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ â˜ ğŸ“„ Chapter 5 Worksheet.pdf                           2.3 MB       â”‚â”‚
â”‚  â”‚ â˜‘ ğŸ–¼ï¸ Cell Diagram.png                                  850 KB       â”‚â”‚
â”‚  â”‚ â˜ ğŸµ Pronunciation Guide.mp3                           4.2 MB       â”‚â”‚
â”‚  â”‚ â˜‘ ğŸ“ Grammar Rules Summary                             Note         â”‚â”‚
â”‚  â”‚ â˜‘ ğŸ”— Khan Academy - Fractions                          Link         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  Selected (3):                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [ğŸ–¼ï¸ Cell Diagram.png Ã—] [ğŸ“ Grammar Rules Ã—] [ğŸ”— Khan Academy Ã—]    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [â† Back]                                                   [Next â†’]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Student View - ResourceSidebar (Extended)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Assignment: Chapter 5 Review                                  â± 28:45    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚ Resources   â”‚
â”‚                                                            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                            â”‚             â”‚
â”‚                                                            â”‚ ğŸ“¹ Videos   â”‚
â”‚               [ACTIVITY CONTENT]                           â”‚ â”œâ”€ intro.mp4â”‚
â”‚                                                            â”‚    [â–¶ Play] â”‚
â”‚                                                            â”‚             â”‚
â”‚                                                            â”‚ ğŸ“ Materialsâ”‚
â”‚                                                            â”‚ â”œâ”€ ğŸ“„ Worksheetâ”‚
â”‚                                                            â”‚    [Download]â”‚
â”‚                                                            â”‚ â”œâ”€ ğŸ–¼ï¸ Diagram â”‚
â”‚                                                            â”‚    [View]    â”‚
â”‚                                                            â”‚ â”œâ”€ ğŸ“ Grammar â”‚
â”‚                                                            â”‚    [Read]    â”‚
â”‚                                                            â”‚ â””â”€ ğŸ”— Khan   â”‚
â”‚                                                            â”‚    [Open â†—]  â”‚
â”‚                                                            â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Save & Exit]                                 [â† Prev] [Next â†’] [Submit] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Material Unavailable State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Resources                                                           [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚ ğŸ“ Materials                                                             â”‚
â”‚ â”œâ”€ ğŸ“„ Worksheet.pdf                                      [Download]      â”‚
â”‚ â”œâ”€ âš ï¸ Material unavailable                                               â”‚
â”‚ â””â”€ ğŸ”— Khan Academy                                       [Open â†—]        â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Tasks & Subtasks

### Task 1: Backend Schema Updates
**Estimated effort:** 1 hour

1. [ ] Add `TeacherMaterialResource` schema
2. [ ] Add `TeacherMaterialResourceResponse` schema
3. [ ] Update `AdditionalResources` to include `teacher_materials`
4. [ ] Add `AdditionalResourcesResponse` schema

### Task 2: Backend Assignment API Updates
**Estimated effort:** 2 hours

1. [ ] Update assignment create to validate teacher materials
2. [ ] Update assignment create to save denormalized material data
3. [ ] Add `enrich_resources()` helper function
4. [ ] Update assignment get to return enriched resources
5. [ ] Handle deleted materials (is_available=false)
6. [ ] Write unit tests

### Task 3: Backend Student Access Endpoint
**Estimated effort:** 1.5 hours

1. [ ] Create `/materials/{id}/student-access` endpoint
2. [ ] Validate student assignment access
3. [ ] Validate material is attached to assignment
4. [ ] Stream file from DCS
5. [ ] Write integration tests

### Task 4: Frontend Types & API
**Estimated effort:** 30 minutes

1. [ ] Update `assignment.ts` types
2. [ ] Update assignment API service if needed
3. [ ] Add student material access URL helper

### Task 5: TeacherMaterialPicker Component
**Estimated effort:** 2 hours

1. [ ] Create `TeacherMaterialPicker.tsx`
2. [ ] Add type filter dropdown
3. [ ] Add search input
4. [ ] Add material list with checkboxes
5. [ ] Add selected materials chips
6. [ ] Style and test

### Task 6: Update StepAdditionalResources
**Estimated effort:** 1 hour

1. [ ] Import and add TeacherMaterialPicker
2. [ ] Wire up selection to form state
3. [ ] Update resources object structure
4. [ ] Test assignment creation flow

### Task 7: Update ResourceSidebar
**Estimated effort:** 2 hours

1. [ ] Add teacher materials section
2. [ ] Implement material action handlers
3. [ ] Add MaterialPreview component
4. [ ] Handle unavailable materials
5. [ ] Test all material types

### Task 8: Update Review Step
**Estimated effort:** 30 minutes

1. [ ] Display selected teacher materials in review
2. [ ] Show material type icons
3. [ ] Allow removal from review step

### Task 9: Assignment Edit Support
**Estimated effort:** 1 hour

1. [ ] Load existing materials in edit mode
2. [ ] Allow adding/removing materials
3. [ ] Save changes on update
4. [ ] Test edit flow

### Task 10: Testing
**Estimated effort:** 2 hours

1. [ ] Test teacher can attach materials
2. [ ] Test student can view materials
3. [ ] Test all material type actions
4. [ ] Test deleted material handling
5. [ ] Test edit assignment flow
6. [ ] Write component tests

---

## Testing Checklist

### Teacher Flow
- [ ] Open assignment creation
- [ ] Reach Additional Resources step
- [ ] See "My Materials" section
- [ ] Filter materials by type
- [ ] Search materials by name
- [ ] Select multiple materials
- [ ] See selection count and chips
- [ ] Remove material from selection
- [ ] Continue to Review step
- [ ] See selected materials in review
- [ ] Create assignment successfully
- [ ] Verify materials saved with assignment

### Teacher Edit Flow
- [ ] Open existing assignment with materials
- [ ] See attached materials displayed
- [ ] Add new material
- [ ] Remove existing material
- [ ] Save changes
- [ ] Verify changes persisted

### Student Flow
- [ ] Open assignment with attached materials
- [ ] See ResourceSidebar with materials
- [ ] Click document - downloads file
- [ ] Click image - opens preview
- [ ] Click audio - plays in AudioPlayer
- [ ] Click video - plays in VideoPlayer
- [ ] Click text note - opens reader
- [ ] Click URL - opens in new tab
- [ ] See "unavailable" for deleted materials

### Edge Cases
- [ ] Assignment with no materials works normally
- [ ] Mixed book videos and teacher materials display correctly
- [ ] Very long material name truncates properly
- [ ] Many materials (20+) paginate/scroll correctly
- [ ] Student cannot access materials from other assignments

---

## Definition of Done

- [ ] Teachers can attach their materials to assignments
- [ ] Teachers can edit attached materials
- [ ] Students can view/access attached materials
- [ ] All material types have appropriate actions
- [ ] Deleted materials show "unavailable" gracefully
- [ ] ResourceSidebar displays both videos and materials
- [ ] Review step shows all selected resources
- [ ] Unit tests passing
- [ ] Integration tests passing
- [ ] No regression in existing video attachment flow
- [ ] Works on all supported browsers
- [ ] Responsive design verified

---

## Related Documentation

- [Epic 13: Teacher Supplementary Materials](./epic-13-teacher-supplementary-materials.md)
- [Story 13.1: Backend - Teacher Storage Infrastructure](./13.1.backend-teacher-storage-infrastructure.md)
- [Story 13.2: Frontend - My Materials Management](./13.2.frontend-my-materials-management.md)
- [Story 10.3: Video Attachment to Assignments](./10.3.video-attachment-to-assignments.md)

---

## QA Results

**Review Date:** 2025-12-10
**Reviewer:** Quinn (Test Architect)
**Gate Decision:** PASS
**Gate File:** [13.3-assignment-integration-attach-teacher-materials.yml](../qa/gates/13.3-assignment-integration-attach-teacher-materials.yml)

### Summary

Implementation is **complete** with all acceptance criteria met and comprehensive test coverage added.

### Implementation Validation

| Area | Status | Notes |
|------|--------|-------|
| Backend Schemas | PASS | TeacherMaterialResource, AdditionalResourcesResponse properly defined |
| Backend Validation | PASS | _validate_and_denormalize_teacher_materials validates teacher ownership |
| Backend Enrichment | PASS | _enrich_resources handles deleted materials (is_available=false) |
| Download Endpoint | PASS | Validates user auth, assignment access, material attachment |
| Frontend Types | PASS | TypeScript types mirror backend schemas |
| TeacherMaterialPicker | PASS | Search/filter functionality working |
| StepAdditionalResources | PASS | My Materials section integrated |
| ResourceSidebar | PASS | Fullscreen modal viewers for all material types |
| EditAssignmentDialog | PASS | Resource add/remove functionality |
| Streaming | PASS | Video/audio use streaming URLs; documents/images use blob URLs |

### Issues Identified (All Resolved)

| ID | Severity | Finding | Status |
|----|----------|---------|--------|
| TEST-001 | RESOLVED | Backend tests for teacher materials | âœ… Added 11 tests in `test_assignment_materials.py` |
| TEST-002 | RESOLVED | Frontend tests for ResourceSidebar | âœ… Added 26 tests in `ResourceSidebar.test.tsx` |
| ERR-001 | LOW | DCS streaming errors may not surface user-friendly messages | Monitor in production |

### Acceptance Criteria Trace

- [x] AC1: Teachers can attach materials during assignment creation
- [x] AC2: Denormalized storage with name/material_type
- [x] AC3: Validates teacher ownership of materials
- [x] AC4: Students see materials in ResourceSidebar with inline playback
- [x] AC5: is_available=false for deleted materials
- [x] AC6: Download endpoint validates assignment + attachment
- [x] AC7: EditAssignmentDialog allows resource modification
- [x] AC8: Appropriate actions for all material types (video/audio/document/image/text_note/url)

### Test Coverage Added

**Backend Tests** (`backend/app/tests/test_api/test_assignment_materials.py`):
- Assignment creation with teacher materials
- Material ownership validation (prevents using other teacher's materials)
- Download endpoint authorization (student/teacher access)
- Material attachment validation
- Deleted material handling (is_available=false)
- Assignment update with resources (add/remove)

**Frontend Tests** (`frontend/src/components/ActivityPlayers/ResourceSidebar.test.tsx`):
- Rendering with/without resources
- All material type action buttons (document, video, audio, image, text_note, url)
- Unavailable material display
- Video playback modal
- URL external link opening
- Close functionality
- ResourcesButton component

### Future Recommendations

- Consider adding progress indicator for large file streaming
- Monitor DCS streaming errors in production
