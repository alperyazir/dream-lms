# Story 29.1: Integrate Flowbook-Online Viewer Components

**Epic:** 29 - DCS Library Viewer Integration
**Story ID:** 29.1
**Status:** In Progress
**Created:** 2026-01-26
**Developer:** James (Dev Agent)

---

## Story

**As a** developer,
**I want** to integrate flowbook-online viewer components into the LMS codebase,
**so that** users can preview books with full interactivity using the embedded viewer.

---

## Acceptance Criteria

1. Flowbook-online core components imported into LMS frontend
2. `FlowbookViewer` wrapper component created with clean props interface
3. All 7 activity types work within embedded viewer (matchTheWords, dragDropPicture, dragDropPictureGroup, fillPicture, circleMark, fillBlanks, wordSearch)
4. Page navigation (next/prev, thumbnail strip, module navigation) functions correctly
5. Zoom and pan controls work properly
6. Media playback (audio/video positioned on pages) functions correctly
7. Zustand stores adapted to coexist with LMS state management (no conflicts)
8. Tailwind styles configured without conflicts with existing LMS styles
9. Viewer components lazy-loaded to minimize bundle size impact
10. TypeScript types properly defined for BookConfig and related interfaces
11. FlowbookViewer component can be rendered in isolation with just a BookConfig prop

---

## Tasks / Subtasks

### Setup Tasks

- [x] **Task 1: Create Viewer Package Structure**
  - [x] Create `frontend/src/components/FlowbookViewer/` directory
  - [x] Decide on import strategy: copy source files vs. npm package
  - [x] Document component dependencies from flowbook-online

### Component Import Tasks

- [x] **Task 2: Import Core Viewer Components** (AC: 1, 2)
  - [x] Copy `BookViewer.tsx` → adapt for LMS context
  - [x] Copy `PageViewer.tsx` → core page rendering
  - [x] Copy `ThumbnailStrip.tsx` → page navigation
  - [x] Copy `LeftToolbar.tsx` → zoom/pan controls (integrated into FlowbookViewer header)
  - [x] Copy `BottomBar.tsx` → page info bar (integrated into FlowbookViewer header)
  - [x] Remove electron-specific code paths
  - [x] Update import paths for LMS structure

- [x] **Task 3: Import Activity Player Components** (AC: 3)
  - [x] Copy `activities/ActivityOverlay.tsx`
  - [x] Copy `activities/players/MatchTheWords.tsx`
  - [x] Copy `activities/players/DragDropPicture.tsx`
  - [x] Copy `activities/players/DragDropPictureGroup.tsx`
  - [x] Copy `activities/players/FillPicture.tsx`
  - [x] Copy `activities/players/CircleMark.tsx`
  - [x] Copy `activities/players/FillBlanks.tsx`
  - [x] Copy `activities/players/WordSearch.tsx`
  - [x] Copy supporting utilities and hooks

- [x] **Task 4: Import Zustand Stores** (AC: 7)
  - [x] Copy `stores/bookStore.ts` → namespace as `flowbookBookStore`
  - [x] Copy `stores/uiStore.ts` → namespace as `flowbookUIStore`
  - [x] Skipped `stores/annotationStore.ts` (not needed for initial integration)
  - [x] Copy `stores/audioStore.ts` → namespace as `flowbookAudioStore`
  - [x] Ensure store names don't conflict with LMS stores
  - [x] Test store isolation (LMS stores unaffected)

- [x] **Task 5: Import Type Definitions** (AC: 10)
  - [x] Copy `types/book.ts` → `frontend/src/types/flowbook.ts`
  - [x] Include: BookConfig, Module, Page, Activity interfaces
  - [x] Include: AudioReference, VideoReference, ActivityReference types
  - [x] Export types for use in LMS components

### Integration Tasks

- [x] **Task 6: Create FlowbookViewer Wrapper Component** (AC: 2, 11)
  - [x] Create `frontend/src/components/FlowbookViewer/FlowbookViewer.tsx`
  - [x] Props interface: `{ bookConfig: BookConfig, onClose?: () => void, className?: string }`
  - [x] Initialize Zustand stores with provided bookConfig
  - [x] Render BookViewer with all layers (toolbar, thumbnails, page)
  - [x] Handle cleanup on unmount (clear stores)
  - [x] Export as lazy-loadable component

- [x] **Task 7: Configure Lazy Loading** (AC: 9)
  - [x] Create `frontend/src/components/FlowbookViewer/index.tsx` with lazy export
  - [x] Use `React.lazy()` for code-splitting
  - [x] Create loading fallback component
  - [x] Test bundle size impact (component is properly code-split and not included in main bundle)

- [x] **Task 8: Configure Tailwind Integration** (AC: 8)
  - [x] Review flowbook-online Tailwind config
  - [x] Identify any custom colors/utilities needed (none needed - using standard Tailwind)
  - [x] Add necessary config to LMS `tailwind.config.js` (no changes needed)
  - [x] Test for style conflicts with existing LMS components (none found)
  - [x] Use scoped class prefixes if conflicts arise (not needed)

### Verification Tasks (Require Manual Testing with Real Book Data)

- [ ] **Task 9: Test Activity Types** (AC: 3) - *Manual testing when integrated*
  - [ ] Test matchTheWords activity renders and functions
  - [ ] Test dragDropPicture activity renders and functions
  - [ ] Test dragDropPictureGroup activity renders and functions
  - [ ] Test fillPicture activity renders and functions
  - [ ] Test circleMark activity renders and functions
  - [ ] Test fillBlanks activity renders and functions
  - [ ] Test wordSearch activity renders and functions

- [ ] **Task 10: Test Navigation and Controls** (AC: 4, 5) - *Manual testing when integrated*
  - [ ] Test next/previous page navigation
  - [ ] Test thumbnail strip click navigation
  - [ ] Test module/chapter navigation
  - [ ] Test zoom in/out
  - [ ] Test pan/drag
  - [ ] Test double-page spread mode (if applicable)

- [ ] **Task 11: Test Media Playback** (AC: 6) - *Manual testing when integrated*
  - [ ] Test audio icons render on pages
  - [ ] Test audio playback on click
  - [ ] Test video icons render on pages
  - [ ] Test video playback in overlay

- [x] **Task 12: Create Component Tests**
  - [x] Create `FlowbookViewer.test.tsx`
  - [x] Test: Component renders with valid BookConfig
  - [x] Test: Component shows loading state (thumbnail loading states)
  - [x] Test: onClose callback fires when close button clicked
  - [x] Test: Page navigation updates current page

---

## Dev Notes

### Source Project Location
```
/Users/alperyazir/Dev/flowbook-online/src/
├── pages/BookViewer.tsx          # Main viewer
├── components/layout/            # UI components
├── activities/                   # Activity players
├── stores/                       # Zustand state
├── types/book.ts                 # TypeScript types
└── hooks/                        # Custom hooks
```

### Key Components to Import
| Source | Destination | Notes |
|--------|-------------|-------|
| `pages/BookViewer.tsx` | `FlowbookViewer/BookViewer.tsx` | Remove routing deps |
| `components/layout/*` | `FlowbookViewer/layout/*` | All layout components |
| `activities/*` | `FlowbookViewer/activities/*` | All activity players |
| `stores/*` | `FlowbookViewer/stores/*` | Namespace stores |
| `types/book.ts` | `types/flowbook.ts` | Core types |

### Dependency Analysis
From flowbook-online `package.json`:
- `zustand@5.0.2` - Already in LMS
- `fabric@6.9.1` - For annotations (import if annotation tools needed)
- `lucide-react` - Already in LMS
- `@dnd-kit/*` - Already in LMS (for drag-drop activities)

### Store Namespacing Strategy
To avoid conflicts with LMS stores:
```typescript
// Original flowbook-online
export const useBookStore = create(...)

// Adapted for LMS
export const useFlowbookBookStore = create(...)
```

### Lazy Loading Pattern
```typescript
// frontend/src/components/FlowbookViewer/index.ts
import { lazy } from 'react'

export const FlowbookViewer = lazy(() =>
  import('./FlowbookViewer').then(m => ({ default: m.FlowbookViewer }))
)
```

### BookConfig Interface (from flowbook-online)
```typescript
interface BookConfig {
  title: string
  cover: string
  version?: string
  modules: Module[]
  pages: Page[]
}

interface Page {
  id: string
  image: string
  audio?: AudioReference[]
  video?: VideoReference[]
  activities?: ActivityReference[]
}
```

---

## Testing

### Component Testing Requirements
- Use Vitest + React Testing Library
- Mock Zustand stores for isolated testing
- Test rendering with sample BookConfig fixture
- Test user interactions (navigation, zoom)

### Test Fixtures Needed
- Sample BookConfig with 3-5 pages
- Sample activities of each type
- Mock image URLs

### Test Coverage Expectations
- FlowbookViewer wrapper: 5-8 tests
- Store integration: 3-4 tests
- Activity rendering: 1 test per type (7 tests)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Initial story draft | John (PM Agent) |
| 2026-01-26 | 1.1 | Implemented Tasks 1-8, 12: Core components, activities, stores, tests | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

_To be filled by dev agent_

### Completion Notes

**Implementation Complete (Tasks 1-8, 12):**
- All core viewer components integrated (FlowbookViewer, PageViewer, ThumbnailStrip)
- All 7 activity player types implemented (MatchTheWords, DragDropPicture, DragDropPictureGroup, FillPicture, CircleMark, FillBlanks, WordSearch)
- ActivityOverlay and ActivityToolbar with check/reset/show answers functionality
- Zustand stores properly namespaced (useFlowbookBookStore, useFlowbookUIStore, useFlowbookAudioStore)
- Lazy loading configured with React.lazy() and Suspense
- Tailwind integration verified - no custom config needed, no style conflicts
- 26 unit tests created and passing

**Verification Tasks (9-11) - Require Manual Testing:**
- Tasks 9, 10, 11 require testing with actual book configurations and media files
- These should be verified when FlowbookViewer is integrated into a page with real DCS book data
- Activity players were adapted from flowbook-online and follow the same interaction patterns

**Dependencies Added:**
- @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities for drag-drop activities

### File List

**Files Created:**
- `frontend/src/types/flowbook.ts` ✓
- `frontend/src/components/FlowbookViewer/index.tsx` ✓
- `frontend/src/components/FlowbookViewer/FlowbookViewer.tsx` ✓
- `frontend/src/components/FlowbookViewer/stores/index.ts` ✓
- `frontend/src/components/FlowbookViewer/stores/bookStore.ts` ✓
- `frontend/src/components/FlowbookViewer/stores/uiStore.ts` ✓
- `frontend/src/components/FlowbookViewer/stores/audioStore.ts` ✓
- `frontend/src/components/FlowbookViewer/utils/index.ts` ✓
- `frontend/src/components/FlowbookViewer/layout/index.ts` ✓
- `frontend/src/components/FlowbookViewer/layout/PageViewer.tsx` ✓
- `frontend/src/components/FlowbookViewer/layout/ThumbnailStrip.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/index.ts` ✓
- `frontend/src/components/FlowbookViewer/activities/ActivityOverlay.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/ActivityToolbar.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/shared/index.ts` ✓
- `frontend/src/components/FlowbookViewer/activities/shared/ResultIndicator.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/shared/AudioButton.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/shared/ActivityResults.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/players/index.ts` ✓
- `frontend/src/components/FlowbookViewer/activities/players/MatchTheWords.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/players/DragDropPicture.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/players/DragDropPictureGroup.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/players/FillPicture.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/players/CircleMark.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/players/FillBlanks.tsx` ✓
- `frontend/src/components/FlowbookViewer/activities/players/WordSearch.tsx` ✓

**Dependencies Added:**
- `@dnd-kit/core` - Core drag-drop functionality
- `@dnd-kit/sortable` - Sortable drag-drop
- `@dnd-kit/utilities` - DnD utilities

**Test Files Created:**
- `frontend/src/components/FlowbookViewer/FlowbookViewer.test.tsx` ✓ (26 tests)
