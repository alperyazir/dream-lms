# Story 27.13: Sentence Builder Activity (Duolingo-Style)

**Status:** Ready for Review

**Epic:** Epic 27 - DreamAI - AI-Powered Content Generation
**Story Points:** 8
**Priority:** Medium
**Dependencies:** Story 27.7 (DCS AI Service Client), Story 27.5 (Edge TTS for audio)

---

## Story

**As a** teacher,
**I want** to create word-ordering activities where students build sentences,
**so that** my students can practice grammar and sentence structure in an interactive Duolingo-style format.

---

## Acceptance Criteria

1. [ ] Display jumbled words from a sentence
2. [ ] **CLICK to place words** (not drag-drop) - word moves to first empty slot
3. [ ] Click placed word to remove it back to word bank
4. [ ] Sentences extracted from book modules
5. [ ] Focus on grammar and sentence structure
6. [ ] Audio playback of correct sentence
7. [ ] Configurable sentence count
8. [ ] Difficulty levels:
   - Easy: 4-6 words
   - Medium: 7-10 words
   - Hard: 11+ words with complex structure

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create Sentence Builder Schemas** (AC: 1, 4, 7, 8)
  - [ ] Create `backend/app/schemas/sentence_builder.py`
  - [ ] Define `SentenceBuilderRequest`:
    - `book_id: int`
    - `module_ids: list[int] | None`
    - `sentence_count: int` (1-10, default: 5)
    - `difficulty: Literal["easy", "medium", "hard"]` (default: "medium")
    - `include_audio: bool = True`
  - [ ] Define `SentenceBuilderItem`:
    - `item_id: str` (UUID)
    - `correct_sentence: str`
    - `words: list[str]` (shuffled word bank)
    - `word_count: int`
    - `audio_url: str | None` (correct sentence audio)
    - `source_module_id: int`
    - `source_page: int | None`
    - `difficulty: str`
  - [ ] Define `SentenceBuilderActivity`:
    - `activity_id: str`
    - `book_id: int`
    - `module_ids: list[int]`
    - `sentences: list[SentenceBuilderItem]`
    - `difficulty: str`
    - `created_at: datetime`
  - [ ] Define `SentenceBuilderSubmission`:
    - `answers: dict[str, list[str]]` (item_id â†’ ordered words)
  - [ ] Define `SentenceBuilderResult`:
    - Per-sentence: is_correct, submitted, correct
    - Overall score

- [ ] **Task 2: Create Sentence Builder Service** (AC: 4, 5, 8)
  - [ ] Create `backend/app/services/ai_generation/sentence_builder_service.py`
  - [ ] Implement `SentenceBuilderService`:
    - `async generate_activity(request) -> SentenceBuilderActivity`
  - [ ] Implement sentence extraction:
    - Fetch module text from DCS
    - Extract sentences using NLP (spacy or regex)
    - Filter by word count based on difficulty:
      - Easy: 4-6 words
      - Medium: 7-10 words
      - Hard: 11+ words
  - [ ] Implement sentence selection:
    - Prefer grammatically interesting sentences
    - Avoid questions and partial sentences
    - Ensure variety (no repetitive structures)
  - [ ] Implement word shuffling:
    - Tokenize sentence into words
    - Preserve punctuation handling (e.g., period at end)
    - Shuffle ensuring not in correct order

- [ ] **Task 3: Implement Sentence Extraction with LLM Enhancement** (AC: 4, 5)
  - [ ] Create extraction pipeline:
    - Extract raw sentences from module text
    - Use LLM to validate and select best sentences
    - LLM filters out incomplete/awkward sentences
  - [ ] Create `backend/app/services/ai_generation/prompts/sentence_prompts.py`:
    - Prompt for sentence quality assessment
    - Prompt for difficulty categorization

- [ ] **Task 4: Implement TTS for Sentences** (AC: 6)
  - [ ] Use TTS service to generate audio for correct sentences
  - [ ] Cache generated audio URLs
  - [ ] Handle sentences longer than TTS limits

- [ ] **Task 5: Create Sentence Builder API Endpoints** (AC: All)
  - [ ] Add to `backend/app/api/routes/ai_generation.py`:
  - [ ] `POST /api/v1/ai/sentence-builder/generate`
  - [ ] `GET /api/v1/ai/sentence-builder/{activity_id}`
  - [ ] `POST /api/v1/ai/sentence-builder/{activity_id}/submit`
  - [ ] `GET /api/v1/ai/sentence-builder/{activity_id}/result`

- [ ] **Task 6: Write Backend Tests** (AC: All)
  - [ ] Create `test_sentence_builder_service.py`
  - [ ] Test sentence extraction by difficulty
  - [ ] Test word shuffling
  - [ ] Test scoring (exact match required)

### Frontend Tasks

- [ ] **Task 7: Create Sentence Builder Types** (AC: All)
  - [ ] Create `frontend/src/types/sentence-builder.ts`

- [ ] **Task 8: Create Sentence Builder API Service** (AC: All)
  - [ ] Create `frontend/src/services/sentenceBuilderApi.ts`

- [ ] **Task 9: Create Sentence Builder Player Component** (AC: 1, 2, 3, 6)
  - [ ] Create `frontend/src/components/ActivityPlayers/SentenceBuilderPlayer.tsx`
  - [ ] **Word Bank Area:**
    - Display shuffled words as clickable chips
    - Words disappear when placed
    - Words reappear when removed from sentence
  - [ ] **Sentence Building Area:**
    - Empty slots for words
    - Click word bank word â†’ places in first empty slot
    - Click placed word â†’ returns to word bank
    - Visual indication of slot positions
  - [ ] **Audio Button:**
    - Play correct sentence audio (available after submission or as hint)
  - [ ] **Progress:**
    - Sentence counter (e.g., "3 of 5")
    - "Check" button per sentence
    - "Next" after correct

- [ ] **Task 10: Create Sentence Builder Results Component** (AC: All)
  - [ ] Create `frontend/src/components/ActivityPlayers/SentenceBuilderResults.tsx`
  - [ ] Display score
  - [ ] For each sentence:
    - Show student's order
    - Show correct order (if wrong)
    - Audio button for correct sentence
  - [ ] Try Again / Back buttons

- [ ] **Task 11: Create Sentence Builder Form** (AC: 7, 8)
  - [ ] Create `frontend/src/components/DreamAI/SentenceBuilderForm.tsx`
  - [ ] Book/module selector
  - [ ] Sentence count slider
  - [ ] Difficulty selector
  - [ ] Include audio toggle
  - [ ] Generate button

- [ ] **Task 12: Create Sentence Builder Container** (AC: All)
  - [ ] Create `frontend/src/components/DreamAI/SentenceBuilderContainer.tsx`

- [ ] **Task 13: Write Frontend Tests** (AC: All)
  - [ ] Create `SentenceBuilderPlayer.test.tsx`
  - [ ] Test click-to-place interaction
  - [ ] Test click-to-remove interaction
  - [ ] Test audio playback
  - [ ] Test submission flow

---

## Dev Notes

### Critical: Click-to-Place (NOT Drag-Drop)

The Epic specifically states: **"CLICK to place words (not drag-drop)"**

This is a Duolingo-style interaction:
1. User clicks a word in the word bank
2. Word automatically moves to the first empty slot in the sentence area
3. User clicks a placed word to return it to the word bank

This is intentionally simpler and more accessible than drag-drop.

### UI Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sentence Builder                                            â”‚
â”‚  Put the words in the correct order                         â”‚
â”‚  Progress: 2 / 5 sentences                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  WORD BANK:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ quickly â”‚ â”‚  ran   â”‚ â”‚ dog â”‚ â”‚  the  â”‚ â”‚  away   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  YOUR SENTENCE:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   The   â”‚ â”‚   dog   â”‚ â”‚   ran   â”‚ â”‚         â”‚ â”‚       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â†‘                  â”‚
â”‚                                   First empty slot          â”‚
â”‚                                                             â”‚
â”‚                      [ðŸ”Š Hear Answer]                       â”‚
â”‚                                                             â”‚
â”‚              [Clear All]         [Check Answer]             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

When user clicks "quickly" from word bank:
- "quickly" moves to first empty slot
- "quickly" disappears from word bank

When user clicks "ran" in sentence area:
- "ran" returns to word bank
- Empty slot appears where "ran" was
```

### Sentence Extraction Algorithm

```python
import re
from typing import List

def extract_sentences(text: str) -> List[str]:
    """Extract sentences from module text."""
    # Split on sentence boundaries
    sentences = re.split(r'(?<=[.!?])\s+', text)

    # Clean and filter
    cleaned = []
    for s in sentences:
        s = s.strip()
        # Skip if too short or not a complete sentence
        if len(s) < 10:
            continue
        # Skip questions for this activity
        if s.endswith('?'):
            continue
        # Skip if doesn't start with capital
        if not s[0].isupper():
            continue
        cleaned.append(s)

    return cleaned

def filter_by_difficulty(sentences: List[str], difficulty: str) -> List[str]:
    """Filter sentences by word count based on difficulty."""
    ranges = {
        "easy": (4, 6),
        "medium": (7, 10),
        "hard": (11, float('inf'))
    }
    min_words, max_words = ranges[difficulty]

    return [
        s for s in sentences
        if min_words <= len(s.split()) <= max_words
    ]

def shuffle_words(sentence: str) -> List[str]:
    """Shuffle words ensuring not in original order."""
    words = sentence.split()
    original = words.copy()

    # Keep shuffling until order is different
    import random
    for _ in range(100):  # Max attempts
        random.shuffle(words)
        if words != original:
            return words

    # Fallback: swap first two
    words[0], words[1] = words[1], words[0]
    return words
```

### Scoring Logic

```python
def score_sentence(submitted: List[str], correct: str) -> bool:
    """
    Check if submitted word order matches correct sentence.

    Note: Punctuation handling - the correct sentence includes
    punctuation attached to words (e.g., "away."), so submitted
    must match exactly.
    """
    correct_words = correct.split()
    return submitted == correct_words
```

### API Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/api/v1/ai/sentence-builder/generate` | Generate activity | Teacher+ |
| GET | `/api/v1/ai/sentence-builder/{id}` | Get activity | Student+ |
| POST | `/api/v1/ai/sentence-builder/{id}/submit` | Submit answers | Student+ |
| GET | `/api/v1/ai/sentence-builder/{id}/result` | Get results | Student+ |

### Source Tree Reference

**New files to create:**
```
backend/app/
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ sentence_builder.py
â”œâ”€â”€ services/
â”‚   â””â”€â”€ ai_generation/
â”‚       â”œâ”€â”€ sentence_builder_service.py
â”‚       â””â”€â”€ prompts/
â”‚           â””â”€â”€ sentence_prompts.py
â””â”€â”€ tests/
    â””â”€â”€ test_services/
        â””â”€â”€ test_ai_generation/
            â””â”€â”€ test_sentence_builder_service.py

frontend/src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ sentence-builder.ts
â”œâ”€â”€ services/
â”‚   â””â”€â”€ sentenceBuilderApi.ts
â””â”€â”€ components/
    â”œâ”€â”€ ActivityPlayers/
    â”‚   â”œâ”€â”€ SentenceBuilderPlayer.tsx
    â”‚   â”œâ”€â”€ SentenceBuilderPlayer.test.tsx
    â”‚   â””â”€â”€ SentenceBuilderResults.tsx
    â””â”€â”€ DreamAI/
        â”œâ”€â”€ SentenceBuilderForm.tsx
        â””â”€â”€ SentenceBuilderContainer.tsx
```

---

## Testing

### Backend Test Cases

```python
@pytest.mark.asyncio
async def test_extract_easy_sentences():
    """Test extraction of 4-6 word sentences."""

@pytest.mark.asyncio
async def test_extract_hard_sentences():
    """Test extraction of 11+ word sentences."""

@pytest.mark.asyncio
async def test_shuffle_not_original_order():
    """Test shuffled words are never in original order."""

@pytest.mark.asyncio
async def test_score_correct_order():
    """Test correct word order gets full credit."""

@pytest.mark.asyncio
async def test_score_wrong_order():
    """Test wrong word order gets no credit."""
```

### Frontend Test Cases

```typescript
describe('SentenceBuilderPlayer', () => {
  it('displays word bank with shuffled words')
  it('displays empty slots for sentence')
  it('moves word to first empty slot on click')
  it('returns word to bank when clicked in sentence')
  it('enables submit when all slots filled')
  it('plays audio when audio button clicked')
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-02 | 0.1 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
