# Story 9.9: Bulk Student Import via Excel

**Epic:** 9 - UX Improvements & Polish
**Story ID:** 9.9
**Status:** Complete
**Created:** 2025-12-03
**Priority:** Medium

---

## Story

**As an** Admin or Teacher,
**I want** to create multiple students by uploading an Excel file,
**so that** I can quickly onboard entire classrooms without entering each student manually.

---

## Acceptance Criteria

### Template Download
1. "Import Students" button available on student management page
2. Button opens import dialog with "Download Template" option
3. Template is Excel file (.xlsx) with proper headers and example row
4. Template includes all required and optional columns
5. Template has instructions sheet explaining each column

### Template Structure
6. Template columns:
   - Full Name (required) - Student's full name
   - Username (optional) - Auto-generated if empty
   - Password (optional) - Auto-generated if empty
   - Email (optional) - Student or parent email
   - Student ID (optional) - School's internal ID number
   - Class/Grade (optional) - For grouping students
7. Example row shows proper formatting
8. Instructions sheet explains auto-generation rules

### File Upload
9. User can upload completed Excel file
10. Drag-and-drop zone OR file picker button
11. Only .xlsx and .xls files accepted
12. Maximum file size: 5MB
13. Maximum rows: 500 students per upload

### Validation & Preview
14. After upload, system validates all rows
15. Preview table shows all students to be created
16. Each row shows validation status (✓ valid, ⚠ warning, ✗ error)
17. Errors displayed inline: "Row 5: Full Name is required"
18. Warnings for: duplicate usernames (will auto-suffix), missing optional fields
19. Summary shows: X valid, X warnings, X errors
20. Cannot proceed if any errors exist
21. Can download validation report

### Auto-Generation Rules
22. Username generated from Full Name:
    - Lowercase
    - Turkish characters mapped (ığüşöç → igusoc)
    - Spaces removed or replaced with dots
    - If duplicate, append number (john.doe2)
23. Password auto-generated:
    - 8 characters
    - Mix of letters and numbers
    - Easy to type (no confusing characters like 0/O, 1/l)

### Import Execution
24. "Import Students" button to proceed after validation
25. Progress indicator during import
26. Each student created with:
    - Role: student
    - Generated/provided username and password
    - Associated with teacher's school (if Teacher importing)
    - Associated with specified class if provided
27. After completion, show summary: "24 students created successfully"
28. Option to download credentials file (CSV/Excel with usernames and passwords)
29. Credentials file is one-time download (passwords not retrievable later)

### Access Control
30. Admin can import students for any school (must select school)
31. Teacher can only import students for their own school
32. Created students automatically associated with importer's school/class

---

## Tasks / Subtasks

### Backend Tasks - Template

- [ ] **Task 1: Create Template Generation Endpoint** (AC: 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create `GET /api/v1/students/import-template` endpoint
  - [ ] Generate Excel file using `openpyxl` library
  - [ ] Create "Students" sheet with headers:
    - [ ] Full Name, Username, Password, Email, Student ID, Class/Grade
  - [ ] Add example row with sample data
  - [ ] Create "Instructions" sheet with column explanations
  - [ ] Return file as download (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)

### Backend Tasks - Validation

- [ ] **Task 2: Create Import Validation Endpoint** (AC: 14, 15, 16, 17, 18, 19, 20)
  - [ ] Create `POST /api/v1/students/import/validate` endpoint
  - [ ] Accept multipart form data with Excel file
  - [ ] Parse Excel using `openpyxl`
  - [ ] Validate each row:
    - [ ] Full Name required and non-empty
    - [ ] Email format if provided
    - [ ] Check for duplicate usernames in file
    - [ ] Check for existing usernames in database
  - [ ] Generate username if not provided
  - [ ] Return validation results:
    ```json
    {
      "valid_count": 20,
      "warning_count": 3,
      "error_count": 2,
      "rows": [
        {
          "row_number": 1,
          "full_name": "John Doe",
          "username": "john.doe",
          "status": "valid",
          "errors": [],
          "warnings": []
        },
        {
          "row_number": 5,
          "full_name": "",
          "status": "error",
          "errors": ["Full Name is required"],
          "warnings": []
        }
      ]
    }
    ```

### Backend Tasks - Import Execution

- [ ] **Task 3: Create Import Execution Endpoint** (AC: 24, 25, 26, 27)
  - [ ] Create `POST /api/v1/students/import` endpoint
  - [ ] Accept validated data (or re-validate from file)
  - [ ] For each valid row:
    - [ ] Generate password if not provided
    - [ ] Create user with role='student'
    - [ ] Associate with school_id
    - [ ] Associate with class if provided
  - [ ] Return creation results:
    ```json
    {
      "created_count": 24,
      "credentials": [
        {"full_name": "John Doe", "username": "john.doe", "password": "abc12345"},
        ...
      ]
    }
    ```
  - [ ] Handle partial failures gracefully

- [ ] **Task 4: Create Credentials Download Endpoint** (AC: 28, 29)
  - [ ] Create `POST /api/v1/students/import/credentials` endpoint
  - [ ] Accept credentials data from import result
  - [ ] Generate Excel file with columns: Full Name, Username, Password
  - [ ] Return as downloadable file
  - [ ] Clear credentials from memory after download

### Backend Tasks - Utilities

- [ ] **Task 5: Create Username Generator Utility** (AC: 22)
  - [ ] Create `backend/app/utils/username_generator.py`
  - [ ] Implement `generate_username(full_name: str) -> str`:
    - [ ] Apply Turkish character mapping
    - [ ] Convert to lowercase
    - [ ] Replace spaces with dots
    - [ ] Remove special characters
  - [ ] Implement `ensure_unique_username(base: str, existing: Set[str]) -> str`:
    - [ ] Append numbers if duplicate (john.doe, john.doe2, john.doe3)
  - [ ] Add unit tests

- [ ] **Task 6: Create Password Generator Utility** (AC: 23)
  - [ ] Create or update `backend/app/utils/password_generator.py`
  - [ ] Implement `generate_student_password(length=8) -> str`:
    - [ ] Use only unambiguous characters (no 0/O, 1/l/I)
    - [ ] Mix of lowercase, uppercase, numbers
    - [ ] Easy to type and communicate
  - [ ] Add unit tests

### Frontend Tasks - Import Dialog

- [ ] **Task 7: Create Import Students Dialog** (AC: 1, 2, 9, 10, 11, 12, 13)
  - [ ] Create `ImportStudentsDialog.tsx` component
  - [ ] Add "Import Students" button to student management page
  - [ ] Dialog with steps: 1. Download Template, 2. Upload File, 3. Review, 4. Complete
  - [ ] Step 1: Download template button, instructions text
  - [ ] Step 2: Drag-drop zone with file picker fallback
  - [ ] File validation: .xlsx/.xls only, max 5MB
  - [ ] Progress indicator during upload

- [ ] **Task 8: Create Validation Preview Table** (AC: 15, 16, 17, 18, 19, 20, 21)
  - [ ] Create `ImportPreviewTable.tsx` component
  - [ ] Table columns: Row#, Status, Full Name, Username, Email, Student ID, Class, Errors
  - [ ] Status icons: ✓ green checkmark, ⚠ yellow warning, ✗ red X
  - [ ] Expandable error details for each row
  - [ ] Summary header: "24 valid, 3 warnings, 2 errors"
  - [ ] Filter: Show All / Errors Only / Warnings Only
  - [ ] "Download Report" button for validation issues

- [ ] **Task 9: Create Import Execution UI** (AC: 24, 25, 27)
  - [ ] "Import Students" button (disabled if errors exist)
  - [ ] Progress bar during import
  - [ ] Success summary after completion
  - [ ] Handle and display any server errors

- [ ] **Task 10: Create Credentials Download UI** (AC: 28, 29)
  - [ ] After successful import, show credentials section
  - [ ] Warning: "Download credentials now. Passwords cannot be retrieved later."
  - [ ] "Download Credentials (Excel)" button
  - [ ] Confirmation that download was successful
  - [ ] Close dialog option

### Frontend Tasks - Access Control

- [ ] **Task 11: Handle Admin vs Teacher Import** (AC: 30, 31, 32)
  - [ ] If Admin: add school selector dropdown in dialog
  - [ ] If Teacher: auto-use teacher's school_id
  - [ ] Pass school_id to import endpoints
  - [ ] Validate permissions on backend

---

## Template Example

### Students Sheet
| Full Name | Username | Password | Email | Student ID | Class/Grade |
|-----------|----------|----------|-------|------------|-------------|
| Ahmet Yılmaz | | | ahmet@email.com | 12345 | 3A |
| Zeynep Öztürk | zeynep.o | | | 12346 | 3A |

### Instructions Sheet
```
Student Import Template Instructions

Column Descriptions:
- Full Name (Required): Student's full name. Will be used to generate username if not provided.
- Username (Optional): Leave empty to auto-generate from full name. Turkish characters will be converted.
- Password (Optional): Leave empty to auto-generate a secure password.
- Email (Optional): Student or parent email address for communications.
- Student ID (Optional): Your school's internal student ID number.
- Class/Grade (Optional): Class or grade level (e.g., "3A", "Grade 5").

Notes:
- Maximum 500 students per upload
- Usernames are auto-generated as: firstname.lastname (lowercase, Turkish chars converted)
- If username exists, a number will be appended (e.g., john.doe2)
- Passwords are 8 characters with letters and numbers
- Download the credentials file after import - passwords cannot be retrieved later!
```

---

## Technical Notes

### Excel Library
Use `openpyxl` for Python Excel operations:
```bash
pip install openpyxl
```

### Turkish Character Mapping (Backend)
```python
TURKISH_MAP = {
    'ı': 'i', 'İ': 'I',
    'ğ': 'g', 'Ğ': 'G',
    'ü': 'u', 'Ü': 'U',
    'ş': 's', 'Ş': 'S',
    'ö': 'o', 'Ö': 'O',
    'ç': 'c', 'Ç': 'C'
}
```

### Batch Processing
For large imports, consider:
- Chunked processing (50 students at a time)
- Database transaction per chunk
- Rollback chunk on error, continue others

---

## Dependencies

- Story 9.1 (Turkish character mapping utility - can share code)
- User creation system from Epic 7

---

## Estimation

- **Complexity:** Medium
- **Components:** Template generation, file upload, validation, bulk creation
