# Story 12.4: Frontend - Tour Trigger & Flow Integration

## Status
Ready for Review

## Story
**As a** new user who has just logged in for the first time,
**I want** the onboarding tour to start automatically after login,
**so that** I receive guided help learning the system without needing to find and start the tour myself.

## Acceptance Criteria

1. After successful login, check `has_completed_tour` from user data
2. If `has_completed_tour` is false AND user is not admin, start tour automatically
3. Tour overlays on top of dashboard after a short delay (let UI render)
4. Clicking outside or pressing Escape offers "Skip tour?" confirmation
5. Completing all steps calls API to mark complete (`UsersService.completeTour()`)
6. Skip button calls API to mark complete (won't show again)
7. Tour doesn't show for admin role (empty steps returned)
8. Handle edge case: user refreshes mid-tour (tour restarts or can be skipped)

## Tasks / Subtasks

- [x] **Task 1: Create TourTrigger component** (AC: 1, 2, 3, 7)
  - [x] Create `frontend/src/components/tour/TourTrigger.tsx`
  - [x] Import `useAuth` to get current user
  - [x] Import `useTour` for `startTour` function
  - [x] Import `getTourStepsForRole` from steps module
  - [x] Use `useEffect` to check tour eligibility on mount
  - [x] Check `user.has_completed_tour === false && user.role !== 'admin'`
  - [x] Add small delay (500ms) before starting tour to let UI render
  - [x] Call `startTour(getTourStepsForRole(user.role), 'onboarding')` if eligible
  - [x] Run `npm run build` to verify no TypeScript errors

- [x] **Task 2: Integrate TourTrigger into _layout.tsx** (AC: 2, 3)
  - [x] Import `TourTrigger` component
  - [x] Add `<TourTrigger />` inside `TourProvider` in Layout component
  - [x] Ensure TourTrigger renders after LayoutContent
  - [x] Run `npm run build` to verify no TypeScript errors

- [x] **Task 3: Add skip confirmation dialog** (AC: 4)
  - [x] Create `frontend/src/components/tour/SkipTourDialog.tsx`
  - [x] Use Shadcn AlertDialog component
  - [x] Props: `open`, `onConfirm`, `onCancel`
  - [x] Dialog text: "Are you sure you want to skip the tour? You won't see it again."
  - [x] Confirm button calls `skipTour()` and closes dialog
  - [x] Cancel button closes dialog and resumes tour

- [x] **Task 4: Integrate skip confirmation into Tour.tsx** (AC: 4)
  - [x] Add state for `showSkipConfirmation`
  - [x] On Escape key press, show confirmation dialog instead of immediate skip
  - [x] On overlay click (if enabled), show confirmation dialog
  - [x] Handle ACTIONS.SKIP to show confirmation dialog first
  - [x] Only call `skipTour()` after user confirms in dialog

- [x] **Task 5: Handle tour completion API call** (AC: 5, 6)
  - [x] Verify `useTour.completeTour()` calls `UsersService.completeTour()` (already implemented in Story 12.2)
  - [x] Verify `useTour.skipTour()` calls `UsersService.completeTour()` (already implemented in Story 12.2)
  - [x] Add error handling/toast if API call fails but still dismiss tour
  - [x] Verify user data cache is invalidated after completion

- [x] **Task 6: Handle refresh mid-tour edge case** (AC: 8)
  - [x] On page refresh, tour state is reset (context resets)
  - [x] TourTrigger will check `has_completed_tour` again on mount
  - [x] If still false, tour restarts from beginning
  - [x] User can skip at any time if they don't want to redo tour
  - [x] Document this behavior in code comments

- [x] **Task 7: Write unit tests for TourTrigger** (AC: 1, 2, 7)
  - [x] Create `frontend/src/components/tour/TourTrigger.test.tsx`
  - [x] Test: starts tour for teacher with has_completed_tour=false
  - [x] Test: starts tour for student with has_completed_tour=false
  - [x] Test: starts tour for publisher with has_completed_tour=false
  - [x] Test: does NOT start tour for admin
  - [x] Test: does NOT start tour if has_completed_tour=true
  - [x] Test: does NOT start tour if user is null/undefined

- [x] **Task 8: Write unit tests for SkipTourDialog** (AC: 4)
  - [x] Create `frontend/src/components/tour/SkipTourDialog.test.tsx`
  - [x] Test: renders dialog when open=true
  - [x] Test: does not render when open=false
  - [x] Test: calls onConfirm when confirm button clicked
  - [x] Test: calls onCancel when cancel button clicked

- [x] **Task 9: Integration verification** (AC: All)
  - [x] Run `npm run build` to verify no TypeScript errors
  - [x] Run `npm test` to verify all tour-related tests pass (76 tests)
  - [ ] Manual verification: login as new teacher, tour starts
  - [ ] Manual verification: login as admin, tour does not start
  - [ ] Manual verification: skip tour, refresh, tour does not start again

## Dev Notes

### Previous Story Insights (Story 12.3)
[Source: Story 12.3 Dev Agent Record]

- Role-specific tour steps implemented in `frontend/src/components/tour/steps/`
- `getTourStepsForRole(role)` utility returns appropriate steps for each role
- Admin role returns empty array (no tour for admins)
- All tour step definitions use `data-tour` attributes for stable selectors
- 61 tour-related tests passing

### Existing Tour Infrastructure
[Source: Story 12.2 implementation]

**Files already implemented:**
```
frontend/src/
├── components/
│   └── tour/
│       ├── Tour.tsx              # Joyride wrapper - handles callbacks
│       ├── TourTooltip.tsx       # Custom tooltip styling
│       └── steps/                # From Story 12.3
│           ├── index.ts
│           ├── teacherTourSteps.ts
│           ├── studentTourSteps.ts
│           ├── publisherTourSteps.ts
│           └── getTourSteps.ts
├── contexts/
│   └── TourContext.tsx           # Tour state management
├── hooks/
│   └── useTour.ts                # Hook with API integration
└── types/
    └── tour.ts                   # TourStep interface
```

### useTour Hook API
[Source: frontend/src/hooks/useTour.ts]

```typescript
const {
  isActive,           // boolean - is tour running
  stepIndex,          // number - current step
  isCompleted,        // boolean - tour finished
  tourId,             // string | null - identifier
  steps,              // TourStep[] - current steps
  startTour,          // (steps: TourStep[], tourId?: string) => void
  stopTour,           // () => void - stops without marking complete
  nextStep,           // () => void
  prevStep,           // () => void
  goToStep,           // (index: number) => void
  skipTour,           // () => Promise<void> - calls API
  completeTour,       // () => Promise<void> - calls API
  resetTour,          // () => void
  isCompletingTour,   // boolean - API call in progress
} = useTour()
```

### useAuth Hook - User Data
[Source: frontend/src/hooks/useAuth.ts]

```typescript
const { user, loginMutation, logout } = useAuth()

// user is UserPublic | null
// user.has_completed_tour: boolean | undefined
// user.role: 'admin' | 'teacher' | 'student' | 'publisher'
```

### UserPublic Type
[Source: frontend/src/client/types.gen.ts]

```typescript
interface UserPublic {
  id: string
  email: string
  is_active: boolean
  is_superuser: boolean
  full_name: string | null
  role: UserRole
  has_completed_tour?: boolean  // Added in Story 12.1
  // ... other fields
}
```

### Layout Structure
[Source: frontend/src/routes/_layout.tsx]

```typescript
function Layout() {
  return (
    <NavigationProvider>
      <TourProvider>
        <LayoutContent />
        <Tour />
        {/* Add TourTrigger here */}
      </TourProvider>
    </NavigationProvider>
  )
}
```

The `beforeLoad` function in `_layout.tsx` already loads `currentUser` using `ensureQueryData`, so user data is available when layout renders.

### Shadcn AlertDialog Component
[Source: Shadcn UI documentation]

```typescript
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog"

// Usage:
<AlertDialog open={open} onOpenChange={setOpen}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Skip Tour?</AlertDialogTitle>
      <AlertDialogDescription>
        Are you sure you want to skip the tour? You won't see it again.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Continue Tour</AlertDialogCancel>
      <AlertDialogAction onClick={onConfirm}>Skip</AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

### Tour.tsx Callback Handling
[Source: frontend/src/components/tour/Tour.tsx]

Current implementation handles:
- `STATUS.FINISHED` → calls `completeTour()`
- `STATUS.SKIPPED` → calls `skipTour()`
- `ACTIONS.CLOSE` → calls `stopTour()`
- `EVENTS.TARGET_NOT_FOUND` → skips to next step

For skip confirmation, modify the `STATUS.SKIPPED` and `ACTIONS.CLOSE` handlers to show dialog first.

### API Integration
[Source: Story 12.1, Story 12.2]

- Backend endpoint: `POST /api/v1/users/me/complete-tour`
- Frontend service: `UsersService.completeTour()`
- After calling, invalidate `["currentUser"]` query to refresh `has_completed_tour`

### Testing Standards
[Source: architecture/10-testing-strategy.md]

- Use Vitest with React Testing Library
- Follow AAA pattern (Arrange-Act-Assert)
- Mock hooks for isolated component testing
- Test accessibility (screen reader labels)

### File Locations for New Code
- **TourTrigger**: `frontend/src/components/tour/TourTrigger.tsx`
- **SkipTourDialog**: `frontend/src/components/tour/SkipTourDialog.tsx`
- **Tests**: Collocated in same directory

## Testing

### Test File Locations
- `frontend/src/components/tour/TourTrigger.test.tsx`
- `frontend/src/components/tour/SkipTourDialog.test.tsx`

### Required Tests

**TourTrigger.test.tsx:**
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { render, waitFor } from '@testing-library/react'
import { TourTrigger } from './TourTrigger'

// Mock hooks
vi.mock('@/hooks/useAuth', () => ({
  default: vi.fn()
}))
vi.mock('@/hooks/useTour', () => ({
  useTour: vi.fn()
}))

describe('TourTrigger', () => {
  it('starts tour for teacher with has_completed_tour=false', async () => {
    const startTour = vi.fn()
    // Setup mocks
    // Render and verify startTour called with teacher steps
  })

  it('does not start tour for admin', () => {
    // Setup admin user mock
    // Render and verify startTour NOT called
  })

  it('does not start tour if has_completed_tour=true', () => {
    // Setup completed user mock
    // Render and verify startTour NOT called
  })
})
```

**SkipTourDialog.test.tsx:**
```typescript
import { describe, it, expect, vi } from 'vitest'
import { render, screen, fireEvent } from '@testing-library/react'
import { SkipTourDialog } from './SkipTourDialog'

describe('SkipTourDialog', () => {
  it('renders when open is true', () => {
    render(<SkipTourDialog open={true} onConfirm={vi.fn()} onCancel={vi.fn()} />)
    expect(screen.getByText(/skip tour/i)).toBeInTheDocument()
  })

  it('calls onConfirm when skip button clicked', () => {
    const onConfirm = vi.fn()
    render(<SkipTourDialog open={true} onConfirm={onConfirm} onCancel={vi.fn()} />)
    fireEvent.click(screen.getByRole('button', { name: /skip/i }))
    expect(onConfirm).toHaveBeenCalled()
  })
})
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - implementation completed without errors

### Completion Notes List
- Created TourTrigger component that auto-starts onboarding tour for eligible users
- Added 500ms delay before starting tour to allow UI to render
- Implemented SkipTourDialog for skip confirmation (Escape key, skip button, close button)
- Updated Tour.tsx to integrate skip confirmation dialog
- Verified API integration already in place from Story 12.2 (completeTour/skipTour)
- Documented refresh mid-tour behavior: tour restarts if has_completed_tour=false
- All 76 tour-related tests passing (TourTrigger: 10, SkipTourDialog: 5, others: 61)
- Updated tsconfig.build.json to exclude test files from build

### File List
- `frontend/src/components/tour/TourTrigger.tsx` (new)
- `frontend/src/components/tour/TourTrigger.test.tsx` (new)
- `frontend/src/components/tour/SkipTourDialog.tsx` (new)
- `frontend/src/components/tour/SkipTourDialog.test.tsx` (new)
- `frontend/src/components/tour/Tour.tsx` (modified - added skip confirmation)
- `frontend/src/routes/_layout.tsx` (modified - added TourTrigger)
- `frontend/tsconfig.build.json` (modified - exclude test files)

---

## QA Results
_To be filled by QA Agent_
