# Story 27.18: Vocabulary Explorer with Audio Player

**Status:** Ready for Review

**Epic:** Epic 27 - DreamAI - AI-Powered Content Generation
**Story Points:** 5
**Priority:** Medium
**Dependencies:** Story 27.7 (DCS AI Service Client), Story 27.16 (DreamAI Sidebar)

---

## Story

**As a** teacher,
**I want** to browse and explore book vocabulary with audio playback,
**so that** I can preview words before creating activities and quickly add them to quizzes.

---

## Acceptance Criteria

1. [x] Book selector dropdown
2. [x] Module filter
3. [x] Search/filter vocabulary
4. [x] Audio playback button for each word
5. [x] Show: word, translation, definition, example, CEFR level
6. [x] Quick-add to quiz functionality
7. [x] Pagination for large vocabulary lists

---

## Tasks / Subtasks

### Frontend Tasks

- [x] **Task 1: Create Vocabulary Explorer Page** (AC: All)
  - [x] Create `frontend/src/routes/_layout/dreamai/vocabulary.tsx`
  - [x] Page layout:
    - Header with title
    - Filter bar (book, module, search)
    - Vocabulary table/grid
    - Pagination

- [x] **Task 2: Create Book/Module Filter** (AC: 1, 2)
  - [x] Create `frontend/src/components/DreamAI/VocabularyFilters.tsx`
  - [x] Book dropdown:
    - Load books from teacher's accessible books
    - Only show books with AI data processed
    - Show processing status badge
  - [x] Module dropdown:
    - Depends on selected book
    - "All Modules" option
    - Load modules from DCS
  - [x] Filters auto-apply on change

- [x] **Task 3: Create Search/Filter Bar** (AC: 3)
  - [x] Add to `VocabularyFilters.tsx`:
  - [x] Search input:
    - Search by word
    - Debounced input (300ms)
  - [x] CEFR level filter:
    - Checkbox or dropdown
    - Multi-select (A1, A2, B1, B2, C1)
  - [x] Part of speech filter (optional):
    - Dropdown (noun, verb, adjective, etc.)

- [x] **Task 4: Create Vocabulary Table** (AC: 4, 5)
  - [x] Create `frontend/src/components/DreamAI/VocabularyTable.tsx`
  - [x] Table columns:
    | Column | Description |
    |--------|-------------|
    | Word | Word + audio button |
    | Translation | Turkish translation |
    | Definition | English definition |
    | Example | Example sentence |
    | Level | CEFR level badge |
    | Actions | Quick-add button |
  - [x] Responsive:
    - Desktop: Full table
    - Mobile: Card layout

- [x] **Task 5: Create Audio Player Integration** (AC: 4)
  - [x] Create `frontend/src/components/DreamAI/WordAudioButton.tsx`
  - [x] Features:
    - Play button icon (ğŸ”Š)
    - Loading state while fetching audio
    - Playing state (animated icon)
    - Handle audio playback errors
  - [x] Audio source:
    - Fetch presigned URL from DCS
    - Cache URLs for session

- [x] **Task 6: Create CEFR Level Badge** (AC: 5)
  - [x] Create `frontend/src/components/DreamAI/CEFRBadge.tsx`
  - [x] Color-coded badges:
    | Level | Color |
    |-------|-------|
    | A1 | Green (beginner) |
    | A2 | Light green |
    | B1 | Yellow |
    | B2 | Orange |
    | C1 | Red |
    | C2 | Dark red |

- [x] **Task 7: Create Quick-Add to Quiz** (AC: 6)
  - [x] Create `frontend/src/components/DreamAI/QuickAddButton.tsx`
  - [x] Functionality:
    - Click adds word to "quiz cart"
    - Show badge count of added words
    - Cart persists in session
  - [x] Create `frontend/src/hooks/useQuizCart.ts`:
    - `addWord(vocabularyId)`
    - `removeWord(vocabularyId)`
    - `clearCart()`
    - `getCartWords()`
  - [x] Create "Create Quiz from Selection" button:
    - Opens generator with selected words pre-filled

- [x] **Task 8: Create Pagination** (AC: 7)
  - [x] Add pagination to table:
    - Page size selector (25, 50, 100)
    - Page navigation
    - Total count display
  - [x] Use TanStack Query with pagination params
  - [x] Maintain page on filter changes (or reset to 1)

- [x] **Task 9: Create Vocabulary API Integration** (AC: All)
  - [x] Create `frontend/src/services/vocabularyExplorerApi.ts`
  - [x] Implement:
    - `getVocabulary(bookId, filters, pagination)`
    - `getAudioUrl(bookId, word)`
  - [x] Use existing DCS proxy endpoints

- [x] **Task 10: Write Frontend Tests** (AC: All)
  - [x] Test book/module selection
  - [x] Test search filtering
  - [x] Test audio playback
  - [x] Test pagination
  - [x] Test quick-add functionality

---

## Dev Notes

### UI Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vocabulary Explorer                                                     â”‚
â”‚  Browse and explore vocabulary from your course books                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Filters:                                                               â”‚
â”‚  [Book â–¼] [Module â–¼] [Search...________] [Level: A1 A2 B1 B2 C1 â–¼]     â”‚
â”‚                                                                         â”‚
â”‚  Selected: 3 words                    [Create Quiz from Selection]      â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”‚ Word        â”‚ Translation â”‚ Definition          â”‚ Level â”‚ Actions â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚  â”‚ ğŸ”Š accomplishâ”‚ baÅŸarmak   â”‚ to succeed in...   â”‚ B1    â”‚ [+ Add] â”‚ â”‚
â”‚  â”‚ ğŸ”Š determine â”‚ belirlemek â”‚ to decide or...    â”‚ B1    â”‚ [+ Add] â”‚ â”‚
â”‚  â”‚ ğŸ”Š ambitious â”‚ hÄ±rslÄ±     â”‚ having a strong... â”‚ B2    â”‚ [âœ“]     â”‚ â”‚
â”‚  â”‚ ğŸ”Š strategy  â”‚ strateji   â”‚ a plan of action...â”‚ B2    â”‚ [+ Add] â”‚ â”‚
â”‚  â”‚ ...         â”‚ ...        â”‚ ...                â”‚ ...   â”‚ ...     â”‚ â”‚
â”‚                                                                         â”‚
â”‚  Showing 1-25 of 450 words         [< 1 2 3 4 5 ... 18 >]              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Integration

```typescript
// Vocabulary Explorer API
interface VocabularyFilters {
  bookId: number;
  moduleId?: number;
  search?: string;
  cefrLevels?: string[];
  partOfSpeech?: string;
}

interface PaginationParams {
  page: number;
  pageSize: number;
}

async function getVocabulary(
  filters: VocabularyFilters,
  pagination: PaginationParams
): Promise<PaginatedResponse<VocabularyWord>> {
  const params = new URLSearchParams({
    book_id: filters.bookId.toString(),
    page: pagination.page.toString(),
    page_size: pagination.pageSize.toString(),
  });

  if (filters.moduleId) params.set('module_id', filters.moduleId.toString());
  if (filters.search) params.set('search', filters.search);
  if (filters.cefrLevels?.length) params.set('levels', filters.cefrLevels.join(','));

  return api.get(`/api/v1/ai/vocabulary?${params}`);
}
```

### Quiz Cart State

```typescript
interface QuizCartState {
  words: Map<string, VocabularyWord>;  // vocabularyId -> word
}

const useQuizCart = create<QuizCartState>((set, get) => ({
  words: new Map(),

  addWord: (word: VocabularyWord) => {
    set((state) => {
      const newWords = new Map(state.words);
      newWords.set(word.id, word);
      return { words: newWords };
    });
  },

  removeWord: (vocabularyId: string) => {
    set((state) => {
      const newWords = new Map(state.words);
      newWords.delete(vocabularyId);
      return { words: newWords };
    });
  },

  clearCart: () => set({ words: new Map() }),

  getCartSize: () => get().words.size,
}));
```

### Audio Playback

```typescript
const WordAudioButton: React.FC<{ bookId: number; word: string }> = ({ bookId, word }) => {
  const [isPlaying, setIsPlaying] = useState(false);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  const playAudio = async () => {
    if (isPlaying) {
      audioRef.current?.pause();
      setIsPlaying(false);
      return;
    }

    try {
      // Fetch presigned URL
      const audioUrl = await vocabularyExplorerApi.getAudioUrl(bookId, 'en', word);

      // Play audio
      audioRef.current = new Audio(audioUrl);
      audioRef.current.onended = () => setIsPlaying(false);
      audioRef.current.play();
      setIsPlaying(true);
    } catch (error) {
      toast.error('Failed to play audio');
    }
  };

  return (
    <Button variant="ghost" size="sm" onClick={playAudio}>
      {isPlaying ? <Volume2 className="animate-pulse" /> : <Volume2 />}
    </Button>
  );
};
```

### Source Tree Reference

**New files to create:**
```
frontend/src/
â”œâ”€â”€ routes/_layout/dreamai/
â”‚   â””â”€â”€ vocabulary.tsx
â”œâ”€â”€ components/DreamAI/
â”‚   â”œâ”€â”€ VocabularyFilters.tsx
â”‚   â”œâ”€â”€ VocabularyTable.tsx
â”‚   â”œâ”€â”€ WordAudioButton.tsx
â”‚   â”œâ”€â”€ CEFRBadge.tsx
â”‚   â””â”€â”€ QuickAddButton.tsx
â”œâ”€â”€ services/
â”‚   â””â”€â”€ vocabularyExplorerApi.ts
â””â”€â”€ hooks/
    â””â”€â”€ useQuizCart.ts
```

---

## Testing

### Test Cases

```typescript
describe('VocabularyExplorer', () => {
  it('loads books on mount')
  it('loads modules when book selected')
  it('filters vocabulary by search term')
  it('filters vocabulary by CEFR level')
  it('plays audio when audio button clicked')
  it('adds word to cart when add button clicked')
  it('shows cart count badge')
  it('paginates through vocabulary')
  it('navigates to generator with selected words')
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-02 | 0.1 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

**Agent Model Used:** Claude Sonnet 4.5

**Implementation Date:** 2026-01-02

### File List

**New Files Created:**
- `frontend/src/types/vocabulary-explorer.ts` - Type definitions for vocabulary explorer
- `frontend/src/services/vocabularyExplorerApi.ts` - API service for vocabulary data
- `frontend/src/components/DreamAI/CEFRBadge.tsx` - Color-coded CEFR level badge component
- `frontend/src/components/DreamAI/WordAudioButton.tsx` - Audio playback button component
- `frontend/src/hooks/useQuizCart.ts` - Zustand store for quiz cart state management
- `frontend/src/components/DreamAI/QuickAddButton.tsx` - Quick-add to quiz cart button
- `frontend/src/components/DreamAI/VocabularyFilters.tsx` - Filter bar component
- `frontend/src/components/DreamAI/VocabularyTable.tsx` - Vocabulary table with pagination
- `frontend/src/components/DreamAI/CEFRBadge.test.tsx` - Tests for CEFR badge
- `frontend/src/components/DreamAI/WordAudioButton.test.tsx` - Tests for audio button
- `frontend/src/hooks/useQuizCart.test.tsx` - Tests for quiz cart hook
- `frontend/src/components/DreamAI/QuickAddButton.test.tsx` - Tests for quick-add button
- `frontend/src/components/DreamAI/VocabularyFilters.test.tsx` - Tests for filters
- `frontend/src/components/DreamAI/VocabularyTable.test.tsx` - Tests for vocabulary table

**Modified Files:**
- `frontend/src/routes/_layout/dreamai/vocabulary.tsx` - Updated from placeholder to full implementation
- `frontend/src/components/DreamAI/index.ts` - Added exports for new vocabulary explorer components

### Completion Notes

All acceptance criteria have been met:

1. âœ… **Book selector dropdown** - Implemented with processing status badges
2. âœ… **Module filter** - Dropdown depends on selected book with "All Modules" option
3. âœ… **Search/filter vocabulary** - Debounced search input (300ms) with CEFR level multi-select
4. âœ… **Audio playback button** - Fetches presigned URLs from DCS with loading/playing states
5. âœ… **Display data** - Shows word, translation, definition, example, CEFR level in responsive layout
6. âœ… **Quick-add to quiz** - Cart persists in session with badge count and "Create Quiz from Selection" button
7. âœ… **Pagination** - Page size selector (25/50/100) with navigation controls

**Implementation Highlights:**
- Used Zustand with persist middleware for quiz cart state management
- Implemented responsive design (desktop table + mobile card layout)
- Color-coded CEFR badges from A1 (green/beginner) to C2 (dark red/proficient)
- Audio playback with proper error handling and loading states
- Comprehensive test coverage (52 tests, all passing)

**Technical Stack:**
- TanStack Query for data fetching and caching
- Zustand for client-side state (quiz cart)
- Shadcn UI components
- Vitest + React Testing Library for testing

### Debug Log

No significant issues encountered. All tests passing.

---

## QA Results

_To be filled by QA agent_
