# Story 12.1: Backend - Tour Completion Tracking

## Status
Done

## Story
**As a** system administrator,
**I want** to track whether users have completed the onboarding tour,
**so that** new users can be shown the tour on their first login and returning users are not shown it again.

## Acceptance Criteria
1. Add `has_completed_tour` boolean field to User model (default: false)
2. Create Alembic migration script for the new field
3. Login response includes `has_completed_tour` status
4. New endpoint `POST /api/v1/users/me/complete-tour` to mark tour as done
5. Endpoint sets `has_completed_tour=true` for the authenticated user

## Tasks / Subtasks

- [x] **Task 1: Add `has_completed_tour` field to User model** (AC: 1)
  - [x] Add `has_completed_tour: bool = Field(default=False)` to `User` class in `backend/app/models.py`
  - [x] Add field to `UserPublic` schema to expose in API responses
  - [x] Add field to `UserBase` if appropriate for inheritance (not needed - kept at User level)

- [x] **Task 2: Create Alembic migration** (AC: 2)
  - [x] Generate migration: `alembic revision --autogenerate -m "add_has_completed_tour_to_user"`
  - [x] Review migration to ensure `has_completed_tour` column is added with default `false`
  - [x] Test migration with `alembic upgrade head`
  - [x] Verify rollback works with `alembic downgrade -1`

- [x] **Task 3: Update Token schema and login response** (AC: 3)
  - [x] Add `has_completed_tour: bool = False` to `Token` class in `backend/app/models.py`
  - [x] Update `login_access_token` endpoint in `backend/app/api/routes/login.py` to include `has_completed_tour` from user

- [x] **Task 4: Create complete-tour endpoint** (AC: 4, 5)
  - [x] Add new endpoint `POST /api/v1/users/me/complete-tour` in `backend/app/api/routes/users.py`
  - [x] Endpoint requires authentication (use `CurrentUser` dependency)
  - [x] Update user's `has_completed_tour` to `True`
  - [x] Return success message response

- [x] **Task 5: Write unit tests** (AC: 1-5)
  - [x] Test migration applies and rolls back correctly
  - [x] Test login response includes `has_completed_tour` field
  - [x] Test `complete-tour` endpoint sets flag to true
  - [x] Test `complete-tour` endpoint requires authentication
  - [x] Test that subsequent logins show `has_completed_tour=true` after completion

## Dev Notes

### Source Tree References
[Source: architecture/source-tree.md]

**Backend Structure:**
```
backend/
├── app/
│   ├── models.py                    # User model lives here
│   ├── api/
│   │   ├── deps.py                  # Auth dependencies (CurrentUser, SessionDep)
│   │   └── routes/
│   │       ├── login.py             # Login endpoint to modify
│   │       └── users.py             # Add new complete-tour endpoint here
│   └── tests/
│       └── test_api/                # Add tests here
├── alembic/
│   └── versions/                    # Migration files go here
```

### Data Model Details
[Source: architecture/2-database-schema-design.md]

The `users` table already exists with the following structure. We're adding a new boolean field:
- `has_completed_tour` - Boolean, defaults to false, nullable=False

**Existing User Model Pattern:**
```python
class User(UserBase, table=True):
    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    hashed_password: str
    must_change_password: bool = Field(default=False)  # Similar pattern to follow
    # ... other fields
```

### API Specifications
[Source: architecture/3-api-architecture.md]

**New Endpoint:**
```
POST /api/v1/users/me/complete-tour
Authorization: Bearer <token>
Response: { "message": "Tour completed successfully" }
```

**Modified Login Response:**
```json
{
  "access_token": "eyJ0eXAi...",
  "token_type": "bearer",
  "must_change_password": false,
  "has_completed_tour": false  // NEW FIELD
}
```

### Existing Code Patterns

**Current Token Schema** (from `backend/app/models.py:170-173`):
```python
class Token(SQLModel):
    access_token: str
    token_type: str = "bearer"
    must_change_password: bool = False
    # Add: has_completed_tour: bool = False
```

**Current UserPublic Schema** (from `backend/app/models.py:152-156`):
```python
class UserPublic(UserBase):
    id: uuid.UUID
    must_change_password: bool = False
    avatar_url: str | None = None
    avatar_type: AvatarType | None = None
    # Add: has_completed_tour: bool = False
```

**Login Endpoint Pattern** (from `backend/app/api/routes/login.py:24-45`):
```python
@router.post("/login/access-token")
def login_access_token(...) -> Token:
    # ...existing authentication logic...
    return Token(
        access_token=security.create_access_token(...),
        must_change_password=user.must_change_password,
        # Add: has_completed_tour=user.has_completed_tour
    )
```

**Endpoint Authentication Pattern:**
```python
from app.api.deps import CurrentUser, SessionDep

@router.post("/users/me/complete-tour")
def complete_tour(
    session: SessionDep,
    current_user: CurrentUser
) -> Message:
    current_user.has_completed_tour = True
    session.add(current_user)
    session.commit()
    return Message(message="Tour completed successfully")
```

### File Locations
- **Model changes:** `backend/app/models.py` (lines ~136-173 for User, Token, UserPublic)
- **Login endpoint:** `backend/app/api/routes/login.py` (line ~40)
- **New endpoint:** `backend/app/api/routes/users.py`
- **Migration:** `backend/app/alembic/versions/` (auto-generated filename)
- **Tests:** `backend/app/tests/test_api/test_tour_completion.py`

### Technical Constraints
- Keep the simple boolean flag approach (no complex tour progress tracking per epic requirements)
- Field should default to `False` for all existing users after migration
- Endpoint should be idempotent (calling multiple times is safe)

## Testing

### Test File Location
`backend/app/tests/test_api/test_tour_completion.py`

### Testing Standards
[Source: architecture/10-testing-strategy.md, architecture/coding-standards.md]

- Use `pytest` with `@pytest.mark.asyncio` for async tests
- Follow Arrange-Act-Assert pattern
- Use existing fixtures from `conftest.py`: `client`, `session`, `superuser_token_headers`, `normal_user_token_headers`
- Create new fixture for non-superuser authenticated user if needed

### Required Tests
```python
@pytest.mark.asyncio
async def test_login_includes_has_completed_tour(client, session):
    """Test that login response includes has_completed_tour field"""
    # Create user with has_completed_tour=False
    # Login and verify response includes field

@pytest.mark.asyncio
async def test_complete_tour_endpoint_sets_flag(client, session, normal_user_token_headers):
    """Test POST /api/v1/users/me/complete-tour sets flag to true"""
    # Call complete-tour endpoint
    # Verify user.has_completed_tour is True

@pytest.mark.asyncio
async def test_complete_tour_requires_auth(client):
    """Test that complete-tour endpoint requires authentication"""
    # Call without auth header
    # Verify 401 response

@pytest.mark.asyncio
async def test_complete_tour_idempotent(client, session, normal_user_token_headers):
    """Test that calling complete-tour multiple times is safe"""
    # Call twice
    # Verify no error and flag still true

@pytest.mark.asyncio
async def test_login_shows_true_after_tour_completion(client, session):
    """Test that login shows has_completed_tour=true after completing tour"""
    # Create user, complete tour, login again
    # Verify has_completed_tour=true in response
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Initial story draft | Bob (SM Agent) |
| 2025-12-09 | 1.1 | Implementation complete | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- All 7 tour completion tests pass
- All 19 login-related tests pass (including first-login password tests)
- Migration applies and rolls back successfully

### Completion Notes List
- Added `has_completed_tour` field to User model (line 141)
- Added `has_completed_tour` field to UserPublic schema (line 157)
- Added `has_completed_tour` field to Token schema (line 177)
- Updated login endpoint to include `has_completed_tour` in response
- Created new `POST /api/v1/users/me/complete-tour` endpoint
- Migration cleaned up from autogenerate to only include the new column
- Endpoint is idempotent (safe to call multiple times)

### File List
**Modified:**
- `backend/app/models.py` - Added has_completed_tour to User, UserPublic, and Token classes
- `backend/app/api/routes/login.py` - Updated login response to include has_completed_tour
- `backend/app/api/routes/users.py` - Added complete-tour endpoint

**Created:**
- `backend/app/alembic/versions/1a76c2dc70fe_add_has_completed_tour_to_user.py` - Migration script
- `backend/app/tests/test_api/test_tour_completion.py` - Test suite with 7 tests

---

## QA Results

### Review Date: 2025-12-09

### Reviewed By: Quinn (Test Architect)

### Risk Assessment
- **Risk Level:** LOW
- **Escalation Triggers:** None triggered
  - No auth/payment/security core logic modified
  - Tests added (7 tests)
  - Small diff size (<100 LOC changes)
  - 5 ACs (moderate)

### Code Quality Assessment

**Overall: EXCELLENT**

The implementation is clean, follows existing patterns precisely, and demonstrates good engineering practices:

1. **Model Changes** (`models.py`):
   - Field placement follows existing pattern (`must_change_password`)
   - Appropriate default value with clear comment
   - Added to both `User` (database) and `UserPublic` (API response)
   - Added to `Token` schema for login response

2. **Endpoint Implementation** (`users.py`):
   - Clean, minimal implementation
   - Good docstring explaining idempotency
   - Proper use of dependencies (`SessionDep`, `CurrentUser`)
   - Correct HTTP method (POST for state-changing operation)

3. **Migration** (`1a76c2dc70fe_add_has_completed_tour_to_user.py`):
   - Properly cleaned from autogenerate noise
   - Includes `server_default` for existing rows
   - Clean upgrade/downgrade functions

4. **Login Integration** (`login.py`):
   - Simple, correct integration
   - Follows existing pattern for `must_change_password`

### Requirements Traceability (Given-When-Then)

| AC# | Requirement | Test | Coverage |
|-----|-------------|------|----------|
| 1 | Add `has_completed_tour` boolean field to User model | `test_login_includes_has_completed_tour_false_by_default` | ✓ GIVEN user created with default values, WHEN logged in, THEN `has_completed_tour=false` |
| 2 | Create Alembic migration script | Migration tested via `alembic upgrade/downgrade` | ✓ Manual verification documented |
| 3 | Login response includes `has_completed_tour` status | `test_login_includes_has_completed_tour_true_when_completed` | ✓ GIVEN user with tour completed, WHEN logged in, THEN response includes `has_completed_tour=true` |
| 4 | New endpoint `POST /api/v1/users/me/complete-tour` | `test_complete_tour_sets_flag_to_true` | ✓ GIVEN authenticated user, WHEN POST to endpoint, THEN 200 with success message |
| 5 | Endpoint sets `has_completed_tour=true` | `test_login_shows_true_after_tour_completion` | ✓ GIVEN user completes tour, WHEN logs in again, THEN `has_completed_tour=true` |

**Coverage Gaps:** None identified. All ACs have direct test coverage.

### Test Architecture Assessment

**Test Quality: EXCELLENT**

- **7 tests** covering all acceptance criteria
- **Well-organized** into logical test classes
- **Follows AAA pattern** (Arrange-Act-Assert) with clear comments
- **Tests are independent** - each creates its own user
- **Edge cases covered:**
  - Authentication required (401 test)
  - Idempotency (calling twice is safe)
  - State persistence across logins
  - `GET /me` endpoint includes field

**Test Level Appropriateness:**
- Unit/Integration tests at API level - appropriate for this story
- No E2E tests needed - backend-only story

### Refactoring Performed

None required. Code quality is excellent as-is.

### Compliance Check

- Coding Standards: ✓ snake_case, type hints, docstrings present
- Project Structure: ✓ Files in correct locations per source-tree.md
- Testing Strategy: ✓ pytest with proper fixtures, AAA pattern
- All ACs Met: ✓ All 5 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] All acceptance criteria implemented
- [x] All required tests implemented
- [x] Code follows existing patterns
- [x] Migration is clean and reversible
- [x] Endpoint is idempotent as specified
- [ ] Consider: Future story could add `tour_completed_at` timestamp if analytics needed

### Security Review

**Status: PASS**
- Endpoint requires authentication via `CurrentUser` dependency
- No sensitive data exposed
- No authorization bypass risks (users can only modify their own flag)
- Idempotent operation poses no security risk

### Performance Considerations

**Status: PASS**
- Single boolean column addition - minimal DB impact
- Simple UPDATE operation on indexed `user` table
- No N+1 queries or performance concerns

### NFR Validation Summary

| Category | Status | Notes |
|----------|--------|-------|
| Security | PASS | Auth required, no privilege escalation |
| Performance | PASS | Minimal DB impact, simple operations |
| Reliability | PASS | Idempotent, proper error handling |
| Maintainability | PASS | Clean code, follows patterns, well-tested |

### Files Modified During Review

None - no refactoring needed.

### Gate Status

**Gate: PASS** → `docs/qa/gates/12.1-backend-tour-completion-tracking.yml`

### Recommended Status

**✓ Ready for Done**

Excellent implementation. All acceptance criteria met, comprehensive test coverage, clean code following established patterns. No changes required.
