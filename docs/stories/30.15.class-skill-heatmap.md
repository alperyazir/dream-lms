# Story 30.15: Class Skill Heatmap (Teacher)

**Status:** Ready for Review
**Epic:** Epic 30 - Skill-Based AI Assignment Generation & Reporting
**Story Points:** 5
**Priority:** Medium
**Dependencies:** Story 30.12 (Skill score attribution data)

---

## User Story

As a **teacher**,
I want **to see a heatmap showing all students in my class mapped against the 5 language skills**,
So that **I can quickly spot skill-level weaknesses across my entire class and plan targeted instruction**.

---

## Acceptance Criteria

1. [ ] Heatmap displays students (rows) × skills (columns) matrix
2. [ ] Cells colored by proficiency: red (< 50%), yellow (50-70%), green (> 70%)
3. [ ] Sortable by any skill column
4. [ ] Filterable by class
5. [ ] Class average summary row displayed at bottom
6. [ ] Clicking a cell navigates to student skill detail view

---

## Tasks & Subtasks

- [x] **Task 1: Create Class Skill Heatmap API** (AC: 1, 4, 5)
  - [x] Add endpoint: `GET /api/v1/classes/{class_id}/skill-heatmap`
  - [x] Access: teacher (own classes), admin, supervisor
  - [x] Query: join class_students → students → student_skill_scores, grouped by student + skill
  - [x] Return per-student-skill: proficiency score, data_points, confidence
  - [x] Include class averages per skill
  - [x] Response schema:
    ```python
    class StudentSkillCell(BaseModel):
        proficiency: float | None  # 0-100, None if no data
        data_points: int
        confidence: str  # "insufficient", "low", "moderate", "high"

    class StudentSkillRow(BaseModel):
        student_id: uuid.UUID
        student_name: str
        skills: dict[str, StudentSkillCell]  # keyed by skill_slug

    class ClassSkillHeatmapResponse(BaseModel):
        class_id: uuid.UUID
        class_name: str
        skill_columns: list[SkillCategoryPublic]  # ordered list of skills
        students: list[StudentSkillRow]
        class_averages: dict[str, float | None]  # skill_slug → avg proficiency
    ```

- [x] **Task 2: Create SkillHeatmap Component** (AC: 1, 2, 3, 6)
  - [x] Create `frontend/src/components/analytics/SkillHeatmap.tsx`
  - [x] Render as HTML table (Shadcn Table component):
    - Header row: Student Name | Listening | Reading | Writing | Vocabulary | Grammar
    - Data rows: student name + colored cells per skill
    - Footer row: Class averages
  - [x] Cell coloring:
    - `< 50%`: `bg-red-100 text-red-700` (dark: `bg-red-900/30`)
    - `50-70%`: `bg-yellow-100 text-yellow-700`
    - `> 70%`: `bg-green-100 text-green-700`
    - No data: `bg-gray-50 text-gray-400` with "—" text
  - [x] Column sort: click header to sort by that skill (asc/desc toggle)
  - [x] Cell click: navigate to `/teacher/students/{id}` (student detail with skill profile)

- [x] **Task 3: Add Class Filter** (AC: 4)
  - [x] Add class selector dropdown above the heatmap
  - [x] Fetch teacher's classes via existing API
  - [x] Default: first class selected

- [x] **Task 4: Integrate into Teacher Analytics** (AC: 1)
  - [x] Add as a new tab or section in teacher analytics dashboard
  - [x] Or create new route: `/teacher/analytics/skills`
  - [x] Sidebar navigation: add under existing Analytics section

- [x] **Task 5: Unit Tests** (AC: 1-6)
  - [x] Test API returns correct matrix structure
  - [x] Test class averages calculation
  - [x] Test students with no data show null proficiency
  - [x] Test heatmap renders with color coding
  - [x] Test column sorting
  - [x] Test cell click navigation

---

## Dev Notes

### Table Component
Use Shadcn Table component (`frontend/src/components/ui/table.tsx`) for the heatmap. The colored cells are standard `<td>` elements with Tailwind background classes.
[Source: tech-stack.md — Shadcn UI]

### Query Performance
The heatmap query joins across 3-4 tables. For a class of 30 students × 5 skills, this is 150 data points — trivial. Add composite index on `student_skill_scores(student_id, skill_id)` (created in Story 30.12).

### Existing Analytics Patterns
The teacher analytics page already has class performance views (Epic 5). Follow the same layout patterns — tabbed sections, class selector at top, data table below.
[Source: 7-analytics-engine.md]

### Testing
- Backend: `backend/app/tests/test_class_skill_heatmap.py`
- Frontend: component tests for SkillHeatmap

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `backend/app/schemas/skill.py` | Modified | Added StudentSkillCell, StudentSkillRow, ClassSkillHeatmapResponse schemas |
| `backend/app/api/routes/classes.py` | Modified | Added GET /{class_id}/skill-heatmap endpoint |
| `frontend/src/types/skill.ts` | Modified | Added StudentSkillCell, StudentSkillRow, ClassSkillHeatmapResponse TS interfaces |
| `frontend/src/services/skillsApi.ts` | Modified | Added getClassSkillHeatmap() API function |
| `frontend/src/components/analytics/SkillHeatmap.tsx` | Created | Sortable heatmap table with color-coded cells |
| `frontend/src/routes/_layout/teacher/analytics/skills.tsx` | Created | Teacher skill analytics page with class selector |
| `frontend/src/components/Common/SidebarItems.tsx` | Modified | Added "Skill Analytics" nav item for teacher role |

### Debug Log References
- Route tree regeneration required after adding new page (auto-generated by vite build)

### Completion Notes
- Backend uses shared _get_teacher_from_user and _verify_class_ownership helpers from classes.py
- Heatmap queries StudentSkillScore grouped by (student_id, skill_id) for all students in class
- Color coding: red (<50%), yellow (50-70%), green (>70%), grey (no data)
- Columns sortable by clicking header (asc/desc toggle)
- Cell click navigates to student analytics detail page
- Class averages row in footer
- Class selector dropdown auto-selects first class
- TypeScript check and Vite build both pass clean

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2026-02-13 | 1.1 | Implementation complete | Dev Agent (James) |
