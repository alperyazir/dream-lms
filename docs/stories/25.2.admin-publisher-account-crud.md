# Story 25.2: Admin Publisher Account CRUD

## Status: Ready for Review

## Story

As an admin, I need to create and manage publisher user accounts linked to DCS publishers so that publishers can log into LMS and manage their materials.

## Acceptance Criteria

- [ ] Admin can create publisher user account via `POST /admin/publisher-accounts`
- [ ] Must select from valid DCS publishers (validated against DCS API)
- [ ] Multiple user accounts per DCS publisher allowed (team support)
- [ ] Validation error if invalid/non-existent DCS publisher ID
- [ ] Admin can list all publisher user accounts via `GET /admin/publisher-accounts`
- [ ] Admin can update publisher user's DCS link via `PUT /admin/publisher-accounts/{id}`
- [ ] Admin can delete publisher user account via `DELETE /admin/publisher-accounts/{id}`
- [ ] Welcome email sent to new publisher users
- [ ] Password generated and emailed (or shown if email fails)

## Technical Design

### API Endpoints

```python
# backend/app/api/routes/admin.py

# Create publisher account
@router.post(
    "/publisher-accounts",
    response_model=UserCreationResponse,
    status_code=status.HTTP_201_CREATED,
    summary="Create publisher user account",
    description="Creates a new user account with publisher role linked to a DCS publisher.",
)
async def create_publisher_account(
    *,
    session: SessionDep,
    account_in: PublisherAccountCreate,
    current_user: User = AdminOrSupervisor
) -> UserCreationResponse:
    """
    Create publisher user account.

    - Validates DCS publisher exists
    - Creates user with role=publisher
    - Sets dcs_publisher_id on user
    - Sends welcome email with credentials
    """
    # Validate DCS publisher exists
    publisher_service = get_publisher_service()
    publisher = await publisher_service.get_publisher(account_in.dcs_publisher_id)
    if not publisher:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"DCS Publisher ID {account_in.dcs_publisher_id} not found"
        )

    # Create user with publisher role
    # ... implementation
```

### Request/Response Schemas

```python
# backend/app/schemas/publisher.py (or models.py)

class PublisherAccountCreate(SQLModel):
    """Create a publisher user account."""
    dcs_publisher_id: int = Field(description="DCS Publisher ID to link")
    username: str = Field(min_length=3, max_length=50)
    email: EmailStr
    full_name: str = Field(max_length=255)

class PublisherAccountUpdate(SQLModel):
    """Update a publisher user account."""
    dcs_publisher_id: int | None = None
    username: str | None = None
    email: EmailStr | None = None
    full_name: str | None = None
    is_active: bool | None = None

class PublisherAccountPublic(SQLModel):
    """Publisher account response."""
    id: uuid.UUID
    username: str
    email: str | None
    full_name: str | None
    dcs_publisher_id: int | None
    dcs_publisher_name: str | None  # Enriched from DCS
    is_active: bool
    created_at: datetime
```

### Endpoint Summary

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/admin/publisher-accounts` | Create publisher account |
| GET | `/admin/publisher-accounts` | List all publisher accounts |
| GET | `/admin/publisher-accounts/{id}` | Get single publisher account |
| PUT | `/admin/publisher-accounts/{id}` | Update publisher account |
| DELETE | `/admin/publisher-accounts/{id}` | Delete publisher account |

## Dev Notes

- Reuse existing user creation logic from admin.py
- DCS publisher validation must happen before user creation
- Consider caching DCS publisher list for dropdown performance
- Welcome email follows existing pattern (generate_new_account_email)
- If email fails, return temporary password in response

## Testing Requirements

- [ ] Create publisher account with valid DCS publisher ID
- [ ] Reject creation with invalid DCS publisher ID
- [ ] Multiple accounts for same DCS publisher allowed
- [ ] List returns all publisher accounts with DCS enrichment
- [ ] Update changes dcs_publisher_id correctly
- [ ] Delete removes user account
- [ ] Welcome email sent on creation
- [ ] Password fallback works when email fails

## Tasks

- [ ] Create PublisherAccountCreate schema
- [ ] Create PublisherAccountUpdate schema
- [ ] Create PublisherAccountPublic schema
- [ ] Implement POST /admin/publisher-accounts
- [ ] Implement GET /admin/publisher-accounts (list)
- [ ] Implement GET /admin/publisher-accounts/{id}
- [ ] Implement PUT /admin/publisher-accounts/{id}
- [ ] Implement DELETE /admin/publisher-accounts/{id}
- [ ] Add DCS publisher validation
- [ ] Integrate welcome email
- [ ] Write API tests

## File List

| File | Action |
|------|--------|
| `backend/app/api/routes/admin.py` | Modified (add publisher account CRUD endpoints) |
| `backend/app/schemas/publisher.py` | Modified (add account schemas: PublisherAccountCreate, PublisherAccountUpdate, PublisherAccountPublic, PublisherAccountCreationResponse, PublisherAccountListResponse) |
| `backend/app/tests/test_api/test_publisher_accounts.py` | Created (13 API tests) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Tasks
- [x] Create schemas (PublisherAccountCreate, PublisherAccountUpdate, PublisherAccountPublic, PublisherAccountCreationResponse, PublisherAccountListResponse)
- [x] Implement CRUD endpoints (POST, GET list, GET single, PUT, DELETE)
- [x] Add DCS validation (validates publisher exists via get_publisher_service)
- [x] Add email integration (welcome email with temp password)
- [x] Write tests (13 tests covering all CRUD operations)

### Debug Log
N/A

### Completion Notes
- Created 5 new Pydantic schemas in `publisher.py` for publisher account management
- Added 5 CRUD endpoints under `/admin/publisher-accounts`
- DCS publisher validation via async `get_publisher_service().get_publisher()`
- Welcome email integration follows existing pattern from `create_teacher`
- Created `PublisherAccountCreationResponse` because `UserCreationResponse.role_record` is not optional and publishers don't have a role record
- All 13 API tests pass
- Multiple accounts per DCS publisher allowed (team support)
- List endpoint enriches with DCS publisher name

### Change Log
| Date | Change |
|------|--------|
| 2025-12-22 | Added publisher account schemas to publisher.py |
| 2025-12-22 | Added CRUD endpoints to admin.py |
| 2025-12-22 | Created test_publisher_accounts.py with 13 tests |
