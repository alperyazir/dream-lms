# Story 27.12: Vocabulary Matching Activity

**Status:** Ready for Review

**Epic:** Epic 27 - DreamAI - AI-Powered Content Generation
**Story Points:** 8
**Priority:** Medium
**Dependencies:** Story 27.7 (DCS AI Service Client), Story 27.5 (Edge TTS for audio)

---

## Story

**As a** teacher,
**I want** to generate vocabulary matching activities with multiple formats,
**so that** my students can practice word associations through interactive matching exercises.

---

## Acceptance Criteria

1. [x] **Match Types:**
   - Word â†’ Synonym matching
   - Word â†’ Antonym matching
   - Audio â†’ Word matching (listen and select)
   - Word â†’ Definition matching
2. [x] Use DCS vocabulary and audio
3. [x] Configurable number of pairs (5, 8, 10)
4. [x] Timer option for timed challenges
5. [x] Shuffle order on each attempt

---

## Tasks / Subtasks

### Backend Tasks

- [x] **Task 1: Create Vocabulary Matching Schemas** (AC: 1, 2, 3, 4, 5)
  - [x] Create `backend/app/schemas/vocabulary_matching.py`
  - [x] Define `VocabularyMatchingRequest`:
    - `book_id: int`
    - `module_ids: list[int] | None` (optional, defaults to all)
    - `match_type: Literal["synonym", "antonym", "audio_word", "word_definition"]`
    - `pair_count: Literal[5, 8, 10]` (default: 5)
    - `cefr_levels: list[str] | None`
    - `timed: bool = False`
    - `time_limit_seconds: int | None` (60, 90, 120)
  - [x] Define `MatchPair`:
    - `pair_id: str` (UUID)
    - `left_item: str` (word, audio_url, or definition)
    - `left_type: str` ("word", "audio", "definition")
    - `right_item: str`
    - `right_type: str`
    - `vocabulary_id: str` (DCS reference)
  - [x] Define `VocabularyMatchingActivity`:
    - `activity_id: str`
    - `book_id: int`
    - `module_ids: list[int]`
    - `match_type: str`
    - `pairs: list[MatchPair]`
    - `left_items: list[dict]` (shuffled left column)
    - `right_items: list[dict]` (shuffled right column)
    - `timed: bool`
    - `time_limit_seconds: int | None`
    - `created_at: datetime`
  - [x] Define `MatchingSubmission`:
    - `matches: dict[str, str]` (left_id â†’ right_id)
    - `time_taken_seconds: int | None`
  - [x] Define `MatchingResult`

- [x] **Task 2: Create Vocabulary Matching Service** (AC: 1, 2, 3)
  - [x] Create `backend/app/services/ai_generation/vocabulary_matching_service.py`
  - [x] Implement `VocabularyMatchingService`:
    - `async generate_activity(request) -> VocabularyMatchingActivity`
  - [x] Implement match type generation:
    - **Word-Definition:** Use word â†’ definition from DCS
    - **Word-Synonym:** Use LLM to generate synonyms
    - **Word-Antonym:** Use LLM to generate antonyms
    - **Audio-Word:** Use audio URL â†’ word matching
  - [x] Implement pair selection:
    - Fetch vocabulary from DCS
    - Filter by CEFR level
    - Select required number of pairs
    - Avoid duplicate meanings
  - [x] Implement shuffling:
    - Create separate shuffled lists for left/right
    - Ensure no position matching

- [x] **Task 3: Create Synonym/Antonym Generation** (AC: 1)
  - [x] Create `backend/app/services/ai_generation/prompts/matching_prompts.py`
  - [x] Implement LLM-based synonym generation:
    - Generate contextually appropriate synonyms
    - Match CEFR level of source word
  - [x] Implement LLM-based antonym generation:
    - Generate clear antonyms
    - Handle words without clear antonyms

- [x] **Task 4: Create Matching API Endpoints** (AC: All)
  - [x] Add to `backend/app/api/routes/ai_generation.py`:
  - [x] `POST /api/v1/ai/matching/generate` - Generate activity
  - [x] `GET /api/v1/ai/matching/{activity_id}` - Get activity (shuffled)
  - [x] `POST /api/v1/ai/matching/{activity_id}/submit` - Submit matches
  - [x] `GET /api/v1/ai/matching/{activity_id}/result` - Get results

- [x] **Task 5: Extend Quiz Storage for Matching** (AC: All)
  - [x] Add matching activity storage to `quiz_storage_service.py`

- [x] **Task 6: Write Backend Tests** (AC: All)
  - [x] Create `backend/app/tests/test_services/test_ai_generation/test_vocabulary_matching_service.py`
  - [x] Test each match type generation
  - [x] Test shuffling guarantees no position matches
  - [x] Test scoring logic

### Frontend Tasks

- [x] **Task 7: Create Vocabulary Matching Types** (AC: All)
  - [x] Create `frontend/src/types/vocabulary-matching.ts`

- [x] **Task 8: Create Matching API Service** (AC: All)
  - [x] Create `frontend/src/services/vocabularyMatchingApi.ts`

- [x] **Task 9: Create Matching Player Component** (AC: 1, 2, 4, 5)
  - [x] Create `frontend/src/components/ActivityPlayers/VocabularyMatchingPlayer.tsx`
  - [x] Two-column layout:
    - Left column: Items to match from
    - Right column: Items to match to
  - [x] Interaction model:
    - Click left item â†’ highlight as selected
    - Click right item â†’ create match (draw line/highlight)
    - Click matched pair â†’ unmatch
  - [x] Visual feedback:
    - Selected item highlighted
    - Matched pairs connected (line or same color)
    - Remaining items clearly visible
  - [x] Audio support:
    - Play button for audio items
    - Auto-play on selection (optional)
  - [x] Timer display (if timed):
    - Countdown timer
    - Auto-submit when time expires

- [x] **Task 10: Create Matching Results Component** (AC: All)
  - [x] Create `frontend/src/components/ActivityPlayers/VocabularyMatchingResults.tsx`
  - [x] Display score
  - [x] Show correct matches (green)
  - [x] Show incorrect matches (red)
  - [x] Show correct answers for wrong matches
  - [x] Time taken (if timed)

- [x] **Task 11: Create Matching Configuration Form** (AC: 1, 3, 4)
  - [x] Create `frontend/src/components/DreamAI/VocabularyMatchingForm.tsx`
  - [x] Book/module selector
  - [x] Match type selector (radio buttons)
  - [x] Pair count selector (5, 8, 10)
  - [x] Timer toggle + time limit dropdown
  - [x] CEFR filter

- [x] **Task 12: Create Matching Container** (AC: All)
  - [x] Create `frontend/src/components/DreamAI/VocabularyMatchingContainer.tsx`
  - [x] State flow: Form â†’ Player â†’ Results

- [x] **Task 13: Write Frontend Tests** (AC: All)
  - [x] Create `VocabularyMatchingPlayer.test.tsx`
  - [x] Test selection mechanics
  - [x] Test matching/unmatching
  - [x] Test timer functionality
  - [x] Test audio playback

---

## Dev Notes

### Match Type Details

| Match Type | Left Column | Right Column | Data Source |
|------------|-------------|--------------|-------------|
| word_definition | Word | Definition | DCS vocabulary |
| synonym | Word | Synonym | LLM generated |
| antonym | Word | Antonym | LLM generated |
| audio_word | Audio ðŸ”Š | Word | DCS audio + word |

### UI Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vocabulary Matching: Word â†’ Definition                      â”‚
â”‚  Match the words to their definitions                        â”‚
â”‚  Timer: 01:45 remaining                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   LEFT COLUMN           â”‚          RIGHT COLUMN             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”‚          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚                         â”‚                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ accomplish  â”‚â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶â”‚ to succeed in doing sth  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ determine   â”‚       â”‚    â”‚ having a strong desire   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â†‘ selected        â”‚                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ ambitious   â”‚       â”‚    â”‚ to decide or establish   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                   â”‚
â”‚                         â”‚                                   â”‚
â”‚   Matched: 1/5          â”‚                [Submit]           â”‚
â”‚                         â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Audio Matching UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LEFT COLUMN (Audio)   â”‚          RIGHT COLUMN (Words)     â”‚
â”‚                         â”‚                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ ðŸ”Š Play     â”‚â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶â”‚ accomplish               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ ðŸ”Š Play     â”‚       â”‚    â”‚ determine                â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
```

### Synonym/Antonym Generation Prompt

```python
SYNONYM_PROMPT = """
Given the word "{word}" at CEFR level {level}:
Generate one clear synonym at the same difficulty level.

Requirements:
- Synonym should be commonly used
- Should match the CEFR level
- If the word is a verb, synonym must be a verb
- Return ONLY the synonym word

Word: {word}
Part of speech: {pos}
CEFR Level: {level}

Synonym:
"""

ANTONYM_PROMPT = """
Given the word "{word}" at CEFR level {level}:
Generate one clear antonym at the same difficulty level.

Requirements:
- Antonym should be a direct opposite
- Should match the CEFR level
- If no clear antonym exists, respond with "NONE"

Word: {word}
Part of speech: {pos}
CEFR Level: {level}

Antonym:
"""
```

### Scoring Logic

```python
def calculate_matching_score(
    submitted: dict[str, str],  # left_id -> right_id
    correct: dict[str, str]     # left_id -> right_id
) -> MatchingResult:
    correct_count = 0
    results = []

    for left_id, submitted_right_id in submitted.items():
        correct_right_id = correct.get(left_id)
        is_correct = submitted_right_id == correct_right_id
        if is_correct:
            correct_count += 1
        results.append({
            "left_id": left_id,
            "submitted_right_id": submitted_right_id,
            "correct_right_id": correct_right_id,
            "is_correct": is_correct
        })

    return MatchingResult(
        score=correct_count,
        total=len(correct),
        percentage=(correct_count / len(correct)) * 100,
        details=results
    )
```

### API Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/api/v1/ai/matching/generate` | Generate activity | Teacher+ |
| GET | `/api/v1/ai/matching/{id}` | Get activity | Student+ |
| POST | `/api/v1/ai/matching/{id}/submit` | Submit matches | Student+ |
| GET | `/api/v1/ai/matching/{id}/result` | Get results | Student+ |

### Source Tree Reference

**New files to create:**
```
backend/app/
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ vocabulary_matching.py
â”œâ”€â”€ services/
â”‚   â””â”€â”€ ai_generation/
â”‚       â”œâ”€â”€ vocabulary_matching_service.py
â”‚       â””â”€â”€ prompts/
â”‚           â””â”€â”€ matching_prompts.py
â””â”€â”€ tests/
    â””â”€â”€ test_services/
        â””â”€â”€ test_ai_generation/
            â””â”€â”€ test_vocabulary_matching_service.py

frontend/src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ vocabulary-matching.ts
â”œâ”€â”€ services/
â”‚   â””â”€â”€ vocabularyMatchingApi.ts
â””â”€â”€ components/
    â”œâ”€â”€ ActivityPlayers/
    â”‚   â”œâ”€â”€ VocabularyMatchingPlayer.tsx
    â”‚   â”œâ”€â”€ VocabularyMatchingPlayer.test.tsx
    â”‚   â””â”€â”€ VocabularyMatchingResults.tsx
    â””â”€â”€ DreamAI/
        â”œâ”€â”€ VocabularyMatchingForm.tsx
        â””â”€â”€ VocabularyMatchingContainer.tsx
```

---

## Testing

### Backend Test Cases

```python
@pytest.mark.asyncio
async def test_generate_word_definition_matching():
    """Test word-definition matching generation."""

@pytest.mark.asyncio
async def test_generate_synonym_matching():
    """Test synonym matching with LLM generation."""

@pytest.mark.asyncio
async def test_generate_audio_word_matching():
    """Test audio-word matching with audio URLs."""

@pytest.mark.asyncio
async def test_shuffling_no_position_match():
    """Test that shuffled items never match by position."""

@pytest.mark.asyncio
async def test_scoring_all_correct():
    """Test scoring with all correct matches."""

@pytest.mark.asyncio
async def test_scoring_partial():
    """Test scoring with some incorrect matches."""
```

### Frontend Test Cases

```typescript
describe('VocabularyMatchingPlayer', () => {
  it('displays two columns with items')
  it('highlights selected item')
  it('creates visual connection on match')
  it('allows unmatching by clicking matched pair')
  it('plays audio for audio-type items')
  it('shows timer when timed')
  it('auto-submits when timer expires')
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-02 | 0.1 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

**Backend (Created/Modified):**
- `backend/app/schemas/vocabulary_matching.py` (NEW) - Pydantic schemas for matching activity
- `backend/app/services/ai_generation/vocabulary_matching_service.py` (NEW) - Service for generating matching activities
- `backend/app/services/ai_generation/prompts/matching_prompts.py` (NEW) - LLM prompts for synonym/antonym generation
- `backend/app/services/ai_generation/prompts/__init__.py` (MODIFIED) - Added matching prompt exports
- `backend/app/services/ai_generation/quiz_storage_service.py` (MODIFIED) - Extended with matching activity storage
- `backend/app/services/ai_generation/__init__.py` (MODIFIED) - Added matching service exports
- `backend/app/api/routes/ai_generation.py` (MODIFIED) - Added matching API endpoints
- `backend/app/tests/test_services/test_ai_generation/test_vocabulary_matching_service.py` (NEW) - Backend tests (18 tests)

**Frontend (Created/Modified):**
- `frontend/src/types/vocabulary-matching.ts` (NEW) - TypeScript types for matching activity
- `frontend/src/services/vocabularyMatchingApi.ts` (NEW) - API client for matching endpoints
- `frontend/src/components/ActivityPlayers/VocabularyMatchingPlayer.tsx` (NEW) - Interactive matching player
- `frontend/src/components/ActivityPlayers/VocabularyMatchingPlayer.test.tsx` (NEW) - Player tests (23 tests)
- `frontend/src/components/ActivityPlayers/VocabularyMatchingResults.tsx` (NEW) - Results display component
- `frontend/src/components/DreamAI/VocabularyMatchingForm.tsx` (NEW) - Configuration form
- `frontend/src/components/DreamAI/VocabularyMatchingContainer.tsx` (NEW) - Container managing Form â†’ Player â†’ Results flow
- `frontend/src/components/DreamAI/index.ts` (MODIFIED) - Added matching component exports

### Completion Notes
- All 13 tasks completed successfully
- Backend: 18 tests passing
- Frontend: 23 tests passing
- All 4 match types implemented (synonym, antonym, audio_word, word_definition)
- Timer functionality with auto-submit on expiration
- Shuffle algorithm ensures no position matches between columns
- Color-coded matching pairs for visual feedback

### Change Log

| Date | Change | Files |
|------|--------|-------|
| 2026-01-02 | Implemented vocabulary matching activity feature | See File List above |

---

## QA Results

_To be filled by QA agent_
