# Story 30.5: Listening Skill — Fill-in-the-Blank Format

**Status:** Ready for Review
**Epic:** Epic 30 - Skill-Based AI Assignment Generation & Reporting
**Story Points:** 5
**Priority:** Medium
**Dependencies:** Story 30.3 (V2 API), Story 30.4 (TTS pattern established)

---

## User Story

As a **teacher**,
I want **to generate Listening fill-in-the-blank activities where students hear a sentence and type the missing word**,
So that **I can assess my students' ability to recognize specific words within spoken language**.

---

## Acceptance Criteria

1. [ ] Generator produces fill-blank items with TTS audio of the COMPLETE sentence (including the missing word)
2. [ ] Student sees the partial sentence with a blank + hears the full audio
3. [ ] Missing word is pedagogically meaningful (not articles/prepositions at easy levels)
4. [ ] Scoring accepts minor spelling variations (configurable tolerance)
5. [ ] Difficulty scales with CEFR level (word complexity, sentence length)
6. [ ] Configurable item count (5, 10, 15, 20)

---

## Tasks & Subtasks

- [x] **Task 1: Create Listening Fill-Blank Generator** (AC: 1, 3, 5)
  - [x] Create `backend/app/services/ai_generation/listening_fill_blank_service.py`
  - [x] Full pipeline: DCS fetch → LLM generation → TTS audio → structured output
  - [x] LLM prompt enforces content word removal (nouns/verbs at A1-A2, adjectives/adverbs at B1-B2)
  - [x] NEVER removes articles, prepositions, conjunctions, pronouns

- [x] **Task 2: Define Content Schema** (AC: 1, 2)
  - [x] Create `backend/app/schemas/listening_fill_blank.py`
  - [x] ListeningFillBlankItem: full_sentence, display_sentence, missing_word, acceptable_answers, word_type
  - [x] Public version excludes full_sentence, missing_word, acceptable_answers

- [x] **Task 3: Flexible Answer Matching** (AC: 4)
  - [x] Create `backend/app/lib/answer_matching.py`
  - [x] check_answer(): case-insensitive, whitespace-trimmed, variant match, Levenshtein typo tolerance
  - [x] levenshtein_distance(): pure Python implementation, no external deps
  - [x] Typo tolerance only for words >= 3 chars, max distance = 1

- [x] **Task 4: TTS Integration** (AC: 1)
  - [x] Reuses TTS pattern from Story 30.4 (parallel async, retry once, mark "failed")
  - [x] Audio generated for full_sentence (including the missing word)

- [x] **Task 5: Register in Dispatcher** (AC: 1)
  - [x] Updated GENERATOR_MAP: `("listening", "fill_blank") → ("listening_fill_blank", "listening_fill_blank")`
  - [x] Updated V2 endpoint with listening_fill_blank routing branch
  - [x] Updated QuizStorageService with save/get/get_public

- [x] **Task 6: Unit Tests** (AC: 1-6)
  - [x] 29 tests in `backend/app/tests/test_listening_fill_blank.py` — all passing
  - [x] Schema tests (6), answer matching tests (10), prompt tests (3), service tests (5), storage tests (3)
  - [x] Regression: 83 tests passing across Stories 30.1-30.4

---

## Dev Notes

### Reuse from Story 30.4
- TTS generation pattern (batch generation, caching, error handling)
- DCS module text fetching
- LLM structured output pattern

### Answer Matching Considerations
The existing scoring logic in `frontend/src/lib/scoring.ts` handles exact matching for DCS activities. The flexible matching here is backend-side since Listening fill-blank is AI-evaluated. Keep it simple — `acceptable_answers` list plus case-insensitive comparison covers 95% of cases.

### Testing
- Test file: `backend/app/tests/test_listening_fill_blank_generator.py`
- Mock TTS and LLM as in Story 30.4

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `backend/app/schemas/listening_fill_blank.py` | Created | Request, item, activity, public schemas |
| `backend/app/services/ai_generation/listening_fill_blank_service.py` | Created | ListeningFillBlankService with LLM + TTS pipeline |
| `backend/app/services/ai_generation/prompts/listening_fill_blank_prompts.py` | Created | System/user prompts, JSON schema |
| `backend/app/lib/__init__.py` | Created | Package init |
| `backend/app/lib/answer_matching.py` | Created | check_answer() with Levenshtein typo tolerance |
| `backend/app/services/skill_generation_dispatcher.py` | Modified | listening×fill_blank now routes to "listening_fill_blank" |
| `backend/app/api/routes/ai_generation.py` | Modified | Added listening_fill_blank branch in V2 endpoint |
| `backend/app/services/ai_generation/quiz_storage_service.py` | Modified | Added listening fill-blank storage methods |
| `backend/app/tests/test_listening_fill_blank.py` | Created | 29 unit tests |
| `backend/app/tests/test_ai_generation_v2.py` | Modified | Updated map counts (9 implemented, 3 stubs) |

### Completion Notes
- All 6 tasks implemented and verified
- 29 unit tests passing, 83 regression tests passing
- GENERATOR_MAP now has 9 implemented combos + 3 stubs

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2026-02-13 | 1.1 | Implementation complete — all tasks done, 29+83 tests passing | Dev Agent (James) |
