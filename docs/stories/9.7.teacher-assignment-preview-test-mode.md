# Story 9.7: Teacher Assignment Preview & Test Mode

**Epic:** 9 - UX Improvements & Polish
**Story ID:** 9.7
**Status:** To Do
**Created:** 2025-12-03
**Priority:** High

---

## Story

**As a** Teacher,
**I want** to preview activities before assigning them and test assignments as if I were a student,
**so that** I can ensure the content is appropriate and the assignment works correctly before giving it to students.

---

## Background

Teachers need two preview capabilities:
1. **Activity Preview**: See what an activity looks like before adding it to an assignment
2. **Test Mode**: Play through an entire assignment like a student to verify it works

Test mode should include full interactivity and scoring, but results are not saved (or saved separately as "test" data).

---

## Acceptance Criteria

### Activity Preview
1. When browsing activities (in book view or assignment creation), each activity has a "Preview" button/icon
2. Clicking Preview opens activity in modal/overlay
3. Preview shows activity exactly as student would see it
4. Preview is interactive - teacher can try the activity
5. Close button returns to previous view
6. Preview doesn't save any data

### Assignment Test Mode
7. Published assignment detail page has "Test Assignment" button
8. Clicking "Test" enters test mode with banner: "Test Mode - Results won't be saved"
9. Teacher plays through all activities in assignment order
10. Full scoring and feedback displayed as student would see
11. Progress tracked within test session only
12. At end, shows summary with score (but not saved to database)
13. "Exit Test Mode" returns to assignment detail page
14. Test mode available for scheduled (unpublished) assignments too

### Test Mode Indicators
15. Distinct visual indicator during test mode (banner, border, badge)
16. Clear that this is preview/test, not actual student work
17. Timer shows if assignment is timed
18. Activity counter (1 of 5, etc.)

### Assignment Creation Preview
19. During assignment creation, "Preview Assignment" button available after selecting activities
20. Opens test mode with selected activities
21. Allows teacher to verify assignment before publishing

---

## Tasks / Subtasks

### Backend Tasks

- [x] **Task 1: Create Preview Session Endpoint** (AC: 5, 10, 11, 12)
  - [x] Create `GET /api/v1/assignments/{id}/preview` endpoint
  - [x] Returns assignment data for preview/test mode
  - [x] No student data created
  - [x] Teacher, Publisher, or Admin role required

- [x] **Task 2: Create Preview Activity Endpoint** (AC: 1, 2, 3)
  - [x] Create `GET /api/v1/assignments/activities/{id}/preview` endpoint
  - [x] Returns activity data in student-view format
  - [x] No submission recording
  - [x] Teacher, Publisher, or Admin role required

- [x] **Task 3: Modify Activity Player for Preview Mode** (AC: 4, 5, 9, 10)
  - [x] Add `previewMode` prop to MultiActivityPlayer
  - [x] When previewMode=true, skip submission to backend
  - [x] Still calculate scores locally for display
  - [x] Don't update progress tracking
  - [x] Add test mode banner with amber styling

### Frontend Tasks - Activity Preview

- [x] **Task 4: Add Preview Button to Activity Cards** (AC: 1)
  - [x] Added to ActivitySelectionTabs summary panel
  - [x] Eye icon button appears on hover
  - [x] Works in both normal mode and time planning mode
  - [x] Preview callback passed through component hierarchy

- [x] **Task 5: Create Activity Preview Modal** (AC: 2, 3, 4, 5)
  - [x] Created `ActivityPreviewModal.tsx` component
  - [x] Full-screen modal with activity player
  - [x] Preview mode banner shown
  - [x] Shows score after completion
  - [x] Close button returns to previous state

### Frontend Tasks - Test Mode

- [x] **Task 6: Add Test Assignment Button** (AC: 7)
  - [x] Added to teacher assignment detail page header
  - [x] "Test Assignment" button with play icon
  - [x] Opens test mode player

- [x] **Task 7: Create Test Mode Player** (AC: 8, 9, 10, 11, 15, 16, 17, 18)
  - [x] Created `TestModePlayer.tsx` component
  - [x] Wraps MultiActivityPlayer with previewMode=true
  - [x] Test mode banner at top (amber background)
  - [x] Text: "Test Mode - Your results will not be saved"
  - [x] "Exit Test" button
  - [x] Full interactivity enabled
  - [x] Timer if assignment has time limit

- [x] **Task 8: Create Test Mode Results Summary** (AC: 11, 12, 13)
  - [x] Created `TestModeResultsSummary.tsx` component
  - [x] Shows after completing all activities
  - [x] Display: total score, time spent, per-activity breakdown
  - [x] Clear "Test Complete" indicator
  - [x] "Close" and "Try Again" buttons

- [x] **Task 9: Implement Test Mode State Management** (AC: 11)
  - [x] Created `usePreviewMode.ts` hook with:
    - [x] useActivityPreview - for single activity preview
    - [x] useAssignmentPreview - for assignment test mode
    - [x] useQuickActivityPreview - fetch on demand
    - [x] useQuickAssignmentTest - fetch on demand
  - [x] Track state locally, no API saves
  - [x] Clear state on exit

### Frontend Tasks - Preview During Creation

- [x] **Task 10: Add Preview to Assignment Creation Dialog** (AC: 19, 20, 21)
  - [x] Integrated useQuickActivityPreview hook
  - [x] Preview button in activity selection summary
  - [x] Opens ActivityPreviewModal
  - [x] Returns to dialog with selections intact

---

## UI Wireframe - Test Mode

```
┌─────────────────────────────────────────────────────────────────┐
│ ⚠️  TEST MODE - Your results will not be saved    [Exit Test]   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Math Quiz - Grade 3                                            │
│  ────────────────────────────────────────────────────────────   │
│  Activity 2 of 5                    ⏱️ 12:34 remaining          │
│  ▓▓▓▓▓▓▓▓░░░░░░░░░░░░ 40%                                      │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │              [Activity Player Component]                │   │
│  │                                                         │   │
│  │              What is 7 + 5?                             │   │
│  │                                                         │   │
│  │              ○ 10    ○ 11    ● 12    ○ 13              │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│                      [Previous]  [Submit & Next]                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Technical Notes

### Preview Mode Flag
Pass `mode: 'preview' | 'student' | 'review'` to activity players:
- `preview`: Teacher testing, no save
- `student`: Normal student submission
- `review`: Viewing past submission (read-only)

### Local Scoring
Activity players already calculate scores client-side. In preview mode:
- Still show correct/incorrect feedback
- Calculate total score
- Just don't POST to backend

### Session Management
Test mode doesn't need backend sessions if all state is in frontend. Backend endpoint is optional - mainly useful if we want to track that teachers are using preview functionality.

---

## Dependencies

- Epic 4 (Activity players must support preview mode)
- Epic 8 (Multi-activity assignment player)

---

## Estimation

- **Complexity:** Medium
- **Components:** Preview modal, Test mode wrapper, Results view

---

## QA Results

**QA Review Date:** 2025-12-06
**QA Reviewer:** Quinn (QA Agent)
**Status:** PASS

### Summary
Story 9.7 has been comprehensively implemented with all acceptance criteria met. The implementation provides teachers with robust preview capabilities for both individual activities and complete assignments, with clear visual indicators distinguishing preview mode from actual student work.

### Acceptance Criteria Verification

| AC # | Criteria | Status | Notes |
|------|----------|--------|-------|
| 1 | Preview button/icon on activity cards | ✅ PASS | Eye icon button in ActivitySelectionTabs summary panel |
| 2 | Preview opens in modal/overlay | ✅ PASS | ActivityPreviewModal.tsx provides full-screen modal |
| 3 | Preview shows activity as student sees it | ✅ PASS | Uses ActivityPlayer with same config |
| 4 | Preview is interactive | ✅ PASS | Full activity functionality enabled |
| 5 | Close button returns to previous view | ✅ PASS | handleClose resets state and closes modal |
| 6 | Preview doesn't save data | ✅ PASS | previewMode skips all backend calls |
| 7 | "Test Assignment" button on detail page | ✅ PASS | Button renamed to "Preview" per user request |
| 8 | Test mode banner displayed | ✅ PASS | Amber banner: "Preview Mode - Your results will not be saved" |
| 9 | Teacher plays through activities in order | ✅ PASS | MultiActivityPlayer handles activity sequencing |
| 10 | Full scoring and feedback displayed | ✅ PASS | Local scoring calculated, feedback shown |
| 11 | Progress tracked within session only | ✅ PASS | usePreviewMode hooks manage local state |
| 12 | End summary shows score (not saved) | ✅ PASS | TestModeResultsSummary shows breakdown with "Not Saved" badge |
| 13 | "Exit Test Mode" returns to detail page | ✅ PASS | Button renamed to "Exit Preview", closes correctly |
| 14 | Test mode for scheduled assignments | ✅ PASS | Backend allows preview for any status |
| 15 | Distinct visual indicator | ✅ PASS | Amber banner, "Preview Mode" badge |
| 16 | Clear that this is preview/test | ✅ PASS | Multiple indicators: banner, badge, button text |
| 17 | Timer shown if timed | ✅ PASS | SharedAssignmentTimer works in preview mode |
| 18 | Activity counter displayed | ✅ PASS | Activity navigation shows "1 of N" |
| 19 | Preview button during creation | ✅ PASS | "Preview" button on final step opens new tab |
| 20 | Opens test mode with selected activities | ✅ PASS | sessionStorage passes activity data to preview route |
| 21 | Verify assignment before publishing | ✅ PASS | Preview in new tab, selections preserved in dialog |

### Technical Implementation Review

#### Backend (PASS)
- **Endpoints:** `GET /assignments/{id}/preview` and `GET /assignments/activities/{id}/preview`
- **Authorization:** Properly restricted to Teacher/Publisher/Admin roles
- **Security:** Teachers can only preview their own assignments; book access validated for activity preview
- **Test Coverage:** Comprehensive tests in `test_assignment_preview.py` covering auth, authorization, and functionality

#### Frontend (PASS)
- **Components:**
  - `ActivityPreviewModal.tsx` - Single activity preview
  - `TestModePlayer.tsx` - Full assignment preview wrapper
  - `TestModeResultsSummary.tsx` - Results display after completion
  - `preview.tsx` route - Standalone preview page for new tab
- **State Management:** `usePreviewMode.ts` hooks handle preview state cleanly
- **previewMode Integration:** MultiActivityPlayer correctly skips backend calls when `previewMode=true`
- **New Tab Preview:** sessionStorage used to pass data to preview route

#### UI/UX (PASS)
- Preview mode clearly indicated with amber banner and badges
- "Preview" terminology used consistently (updated from "Test" per user request)
- Emoji removed from banner per user request
- Results marked with "Not Saved" badge

### Minor Observations (Non-blocking)
1. Story wireframe still shows "Test Mode" terminology but implementation uses "Preview" - this is acceptable as user explicitly requested the rename
2. Comments in code still reference "Story 9.7: Test mode" but functionality is correct

### Recommendation
**Ready for Done** - All acceptance criteria met, implementation is complete and functional.
