# Story 7.8: Simplify Initial Password Flow

**Epic:** 7 - Authentication & User Management Improvements
**Story ID:** 7.8
**Status:** In Progress
**Created:** 2025-01-10
**Developer:** James (Full Stack Developer)

---

## User Story

**As an** admin/publisher/teacher creating new users
**I want** new users to have their username as initial password
**So that** it's easy to communicate credentials and users are forced to change password on first login

**As a** newly created user
**I want** to be prompted to change my password on first login
**So that** I can set a secure password that only I know

---

## Acceptance Criteria

### Backend

- [ ] Add `must_change_password` boolean field to User model (default: false)
- [ ] Create Alembic migration for new field
- [ ] Update user creation in `create_publisher`, `create_teacher`, `create_student` endpoints:
  - Set password = username (hashed)
  - Set must_change_password = true
- [ ] Update `UserCreationResponse` model:
  - Remove `temp_password` field
  - Add `initial_password: str` field (contains username for display)
- [ ] Update login endpoint (`/login/access-token`):
  - Include `must_change_password` flag in Token response
- [ ] Create new endpoint `POST /users/me/first-password-change`:
  - Accepts only new_password (no current_password required)
  - Only works if must_change_password = true
  - Sets must_change_password = false after success
  - Returns success message
- [ ] Update existing `PATCH /users/me/password`:
  - Only works if must_change_password = false (normal password change)
- [ ] Update `generate_username` to ensure it creates valid passwords (already alphanumeric)
- [ ] Write tests for new password flow

### Frontend

- [ ] Update login flow:
  - Check `must_change_password` flag in auth response
  - Redirect to `/first-login-password-change` if true
  - Redirect to dashboard if false (normal flow)
- [ ] Create new route `/first-login-password-change`:
  - Show message: "Welcome! Please set a new password"
  - Display current username
  - Password + Confirm Password fields
  - Validation: min 8 chars, must match
  - Submit calls new endpoint
  - Redirect to dashboard on success
- [ ] Update user creation forms (publishers.tsx, teachers.tsx, students.tsx):
  - Remove temp_password display from success messages
  - Show: "User created. Initial password: {username}"
  - Provide copy button for username
- [ ] Update TypeScript types (regenerate from OpenAPI)
- [ ] Write frontend tests for password change flow

---

## Technical Implementation Notes

### Database Schema Change

```sql
ALTER TABLE user ADD COLUMN must_change_password BOOLEAN DEFAULT FALSE;
```

### Backend Models

```python
# User model
class User(UserBase, table=True):
    # ... existing fields ...
    must_change_password: bool = Field(default=False)

# Token response (update)
class Token(SQLModel):
    access_token: str
    token_type: str = "bearer"
    must_change_password: bool = False  # NEW

# UserCreationResponse (update)
class UserCreationResponse(SQLModel):
    user: UserPublic
    initial_password: str  # Changed from temp_password
    role_record: PublisherPublic | TeacherPublic | StudentPublic
```

### API Endpoints

```python
# New endpoint
@router.post("/users/me/first-password-change")
def first_password_change(
    session: SessionDep,
    current_user: CurrentUser,
    body: FirstPasswordChange
) -> Message:
    """Change password on first login (no current password required)"""
    if not current_user.must_change_password:
        raise HTTPException(400, "Password change not required")

    # Set new password
    current_user.hashed_password = get_password_hash(body.new_password)
    current_user.must_change_password = False
    session.commit()
    return Message(message="Password updated successfully")
```

### Frontend Flow

```typescript
// After login
const { access_token, must_change_password } = loginResponse;

if (must_change_password) {
  navigate("/first-login-password-change");
} else {
  navigate("/dashboard");
}
```

---

## Testing Strategy

### Backend Tests
- Test user creation sets must_change_password = true
- Test login returns must_change_password flag
- Test first password change succeeds when flag is true
- Test first password change fails when flag is false
- Test normal password change fails when flag is true
- Test password = username on creation

### Frontend Tests
- Test redirect to password change on first login
- Test redirect to dashboard on normal login
- Test password change form validation
- Test successful password change flow
- Test user creation shows initial password

---

## Dependencies

- Alembic migration must run before deployment
- Frontend types must be regenerated after backend changes

---

## Security Considerations

- Username as initial password is simple but somewhat predictable
- Mitigation: Force password change on first login (cannot be bypassed)
- Password complexity requirements on first change
- Rate limiting on login attempts (existing)

---

## Files to Modify

### Backend
- `backend/app/models.py`
- `backend/app/api/routes/login.py`
- `backend/app/api/routes/users.py`
- `backend/app/api/routes/admin.py`
- `backend/app/api/routes/publishers.py`
- `backend/app/api/routes/teachers.py`
- `backend/app/alembic/versions/[new]_add_must_change_password.py`
- `backend/app/tests/test_api_login.py`
- `backend/app/tests/test_api_users.py`
- `backend/app/tests/test_first_password_change.py` (new)

### Frontend
- `frontend/src/routes/login.tsx`
- `frontend/src/routes/first-login-password-change.tsx` (new)
- `frontend/src/routes/_layout/admin/publishers.tsx`
- `frontend/src/routes/_layout/admin/teachers.tsx`
- `frontend/src/routes/_layout/admin/students.tsx`
- `frontend/src/client/types.gen.ts` (regenerate)
- `frontend/tests/first-login.spec.ts` (new)

---

## Estimated Effort

- Backend: 3-4 hours
- Frontend: 2-3 hours
- Testing: 2 hours
- **Total: 7-9 hours**

---

## Related Stories

- Story 7.1: Add username field to User model
- Story 7.2: Update login system for username/email support
- Story 7.7: Update user creation forms with username
