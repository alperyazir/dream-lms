# Story 27.6: Azure TTS Provider (Fallback)

**Status:** Ready for Review

**Epic:** Epic 27 - DreamAI - AI-Powered Content Generation
**Story Points:** 5
**Priority:** Medium
**Dependencies:** Story 27.4 (TTS Provider Abstraction Layer)

---

## Story

**As a** system,
**I want** Azure Cognitive Services TTS integrated as a premium fallback provider,
**so that** vocabulary audio can still be generated with high-quality neural voices when Edge TTS fails.

---

## Acceptance Criteria

1. [x] Azure Cognitive Services TTS integration using `azure-cognitiveservices-speech` SDK
2. [x] Turkey region configuration for KVKK compliance (`turkeycentral`)
3. [x] Neural voice support for Turkish and English
4. [x] SSML support for advanced pronunciation control
5. [x] Cost tracking per request (characters processed)
6. [x] Activation only when Edge TTS fails (fallback behavior)

---

## Tasks / Subtasks

- [x] **Task 1: Add Azure SDK Dependency** (AC: 1)
  - [x] Add `azure-cognitiveservices-speech` to `backend/pyproject.toml`
  - [x] Run `uv sync` to install the dependency
  - [x] Verify installation works: `import azure.cognitiveservices.speech as speechsdk`

- [x] **Task 2: Create AzureTTSProvider Class** (AC: 1, 2)
  - [x] Create `backend/app/services/tts/providers/azure.py`
  - [x] Implement `AzureTTSProvider` extending `TTSProvider` ABC
  - [x] Implement constructor accepting `TTSSettings` for API key and region
  - [x] Use `turkeycentral` as default region from settings (KVKK compliance)
  - [x] Implement `get_name() -> str` returning "azure"
  - [x] Implement `is_available() -> bool` checking if `AZURE_TTS_KEY` is configured
  - [x] Add Google-style docstrings

- [x] **Task 3: Implement Voice Support** (AC: 3)
  - [x] Define voice constants for Turkish:
    - `tr-TR-AhmetNeural` (male, neural)
    - `tr-TR-EmelNeural` (female, neural)
  - [x] Define voice constants for English:
    - `en-US-JennyNeural` (female, neural)
    - `en-US-GuyNeural` (male, neural)
    - `en-GB-SoniaNeural` (female, neural)
    - `en-GB-RyanNeural` (male, neural)
  - [x] Implement `get_available_voices(language: str) -> list[Voice]`
  - [x] Implement `get_supported_languages() -> list[str]`
  - [x] Implement `supports_language(language: str) -> bool`
  - [x] Support both short codes ("en", "tr") and full BCP-47 codes ("en-US", "tr-TR")

- [x] **Task 4: Implement generate_audio Method** (AC: 1, 4, 5)
  - [x] Implement `async generate_audio(text, options) -> AudioResult`
  - [x] Create `SpeechConfig` with API key and region from settings
  - [x] Create `SpeechSynthesizer` with audio output to memory stream
  - [x] Use `speak_text_async()` for plain text generation
  - [x] Map `AudioGenerationOptions.format` to Azure audio format
  - [x] Map `AudioGenerationOptions.rate` to SSML `prosody` rate attribute
  - [x] Map `AudioGenerationOptions.pitch` to SSML `prosody` pitch attribute
  - [x] Auto-select default voice if `options.voice` is None
  - [x] Track character count for cost estimation (~$4/1M chars)
  - [x] Measure and return latency_ms
  - [x] Handle Azure SDK exceptions and wrap in TTS exceptions

- [x] **Task 5: Implement SSML Support** (AC: 4)
  - [x] Create private `_build_ssml(text, voice, rate, pitch) -> str` method
  - [x] Build SSML with `<speak>`, `<voice>`, `<prosody>` elements
  - [x] Use `speak_ssml_async()` when rate or pitch are modified
  - [x] Ensure proper XML escaping for user-provided text

- [x] **Task 6: Implement Batch Processing** (AC: 1)
  - [x] Implement `async generate_audio_batch(items) -> BatchAudioResult`
  - [x] Process items sequentially to avoid rate limiting (Azure has stricter limits)
  - [x] Handle partial failures (some items fail, others succeed)
  - [x] Track success_count and failure_count
  - [x] Calculate total_duration_ms and total_latency_ms
  - [x] Aggregate character count for cost tracking

- [x] **Task 7: Register Provider with Manager** (AC: 6)
  - [x] Update `backend/app/services/tts/manager.py` `create_default_manager()`
  - [x] Uncomment and update Azure provider registration block
  - [x] Register AzureTTSProvider when `AZURE_TTS_KEY` is configured
  - [x] Ensure fallback order: primary (edge) -> fallback (azure)

- [x] **Task 8: Update Module Exports** (AC: 1)
  - [x] Export `AzureTTSProvider` from `backend/app/services/tts/providers/__init__.py`
  - [x] Export from main `backend/app/services/tts/__init__.py`

- [x] **Task 9: Write Unit Tests** (AC: All)
  - [x] Create `backend/app/tests/test_services/test_tts/test_azure_provider.py`
  - [x] Test AzureTTSProvider initialization with settings
  - [x] Test get_name() returns "azure"
  - [x] Test is_available() returns True only when API key is configured
  - [x] Test is_available() returns False when API key is missing
  - [x] Test get_available_voices() for Turkish ("tr", "tr-TR")
  - [x] Test get_available_voices() for English ("en", "en-US", "en-GB")
  - [x] Test get_supported_languages() returns expected codes
  - [x] Test supports_language() for supported and unsupported languages
  - [x] Test generate_audio with mocked Azure SDK
  - [x] Test generate_audio with SSML when rate/pitch modified
  - [x] Test generate_audio_batch with multiple items
  - [x] Test batch partial failure handling
  - [x] Test voice auto-selection when voice is None
  - [x] Test TTSAuthenticationError for invalid API key
  - [x] Test TTSConnectionError for network issues

---

## Dev Notes

### Previous Story Insights (from 27.4 and 27.5)
[Source: docs/stories/27.4.tts-provider-abstraction-layer.md, docs/stories/27.5.edge-tts-provider-integration.md]

**From Story 27.4 (TTS Provider Abstraction Layer):**
- TTSProvider ABC is in `backend/app/services/tts/base.py`
- Must implement 7 abstract methods:
  - `generate_audio(text, options) -> AudioResult`
  - `generate_audio_batch(items) -> BatchAudioResult`
  - `get_name() -> str`
  - `get_available_voices(language) -> list[Voice]`
  - `get_supported_languages() -> list[str]`
  - `is_available() -> bool`
  - `supports_language(language) -> bool`
- Cache integration handled by TTSManager - provider doesn't need to cache directly
- Exception hierarchy in `backend/app/services/tts/exceptions.py`:
  - Use `TTSAudioGenerationError` for generation failures
  - Use `TTSConnectionError` for network issues
  - Use `TTSAuthenticationError` for API key issues
  - Use `TTSUnsupportedLanguageError` for unsupported languages

**From Story 27.5 (Edge TTS Provider):**
- Follow same implementation pattern as EdgeTTSProvider
- Voice constants defined as `ClassVar[dict[str, list[Voice]]]`
- Default voices per language: `ClassVar[dict[str, str]]`
- Language map for short to full codes: `ClassVar[dict[str, str]]`
- Rate/pitch conversion to provider-specific formats

### TTSProvider Interface
[Source: backend/app/services/tts/base.py]

```python
class TTSProvider(ABC):
    @abstractmethod
    async def generate_audio(
        self, text: str, options: AudioGenerationOptions | None = None
    ) -> AudioResult: ...

    @abstractmethod
    async def generate_audio_batch(
        self, items: list[BatchAudioItem]
    ) -> BatchAudioResult: ...

    @abstractmethod
    def get_name(self) -> str: ...

    @abstractmethod
    def get_available_voices(self, language: str) -> list[Voice]: ...

    @abstractmethod
    def get_supported_languages(self) -> list[str]: ...

    @abstractmethod
    def is_available(self) -> bool: ...

    @abstractmethod
    def supports_language(self, language: str) -> bool: ...
```

### Azure TTS Settings (Already Configured)
[Source: backend/app/services/tts/config.py]

```python
# From TTSSettings class:
AZURE_TTS_KEY: str | None = Field(default=None)
AZURE_TTS_REGION: str = Field(default="turkeycentral")  # KVKK compliance

def is_provider_configured(self, provider: TTSProviderType) -> bool:
    if provider == TTSProviderType.AZURE:
        return bool(self.AZURE_TTS_KEY)
```

### Manager Registration Pattern (Commented Out - Ready for Implementation)
[Source: backend/app/services/tts/manager.py]

```python
# Azure TTS provider will be added in Story 27.6
# if settings.is_provider_configured(TTSProviderType.AZURE):
#     from app.services.tts.providers.azure import AzureTTSProvider
#     azure = AzureTTSProvider(settings=settings)
#     manager.register_provider(TTSProviderType.AZURE, azure)
```

### Azure Speech SDK Usage
[Source: Azure Cognitive Services Documentation]

```python
import azure.cognitiveservices.speech as speechsdk

# Configuration
speech_config = speechsdk.SpeechConfig(
    subscription=api_key,
    region="turkeycentral"  # For KVKK compliance
)

# Audio output to memory
audio_config = speechsdk.audio.AudioOutputConfig(use_default_speaker=False)
synthesizer = speechsdk.SpeechSynthesizer(
    speech_config=speech_config,
    audio_config=None  # Output to bytes
)

# Plain text synthesis
result = synthesizer.speak_text_async(text).get()
audio_data = result.audio_data

# SSML synthesis (for rate/pitch control)
ssml = f"""
<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="en-US">
    <voice name="en-US-JennyNeural">
        <prosody rate="+20%" pitch="+10%">
            {text}
        </prosody>
    </voice>
</speak>
"""
result = synthesizer.speak_ssml_async(ssml).get()

# Result handling
if result.reason == speechsdk.ResultReason.SynthesizingAudioCompleted:
    audio_data = result.audio_data
elif result.reason == speechsdk.ResultReason.Canceled:
    cancellation = result.cancellation_details
    raise TTSAudioGenerationError(f"Synthesis canceled: {cancellation.reason}")
```

### Voice Constants for Azure
[Source: docs/prd/epic-27-dreamai-content-generation.md]

**Turkish Neural Voices:**
- `tr-TR-AhmetNeural` - Male, neural
- `tr-TR-EmelNeural` - Female, neural

**English Neural Voices (US):**
- `en-US-JennyNeural` - Female, neural (default)
- `en-US-GuyNeural` - Male, neural
- `en-US-AriaNeural` - Female, neural

**English Neural Voices (GB):**
- `en-GB-SoniaNeural` - Female, neural
- `en-GB-RyanNeural` - Male, neural

### Rate/Pitch Conversion for Azure SSML
Azure uses percentage strings for rate and percentage/semitone for pitch:
- `rate`: "slow", "medium", "fast" OR percentage like "+20%", "-10%"
- `pitch`: "low", "medium", "high" OR percentage like "+5%", "-10%"

Conversion formulas:
```python
# rate: 1.0 = default, 0.5 = -50%, 2.0 = +100%
rate_percent = int((rate - 1.0) * 100)
rate_str = f"{rate_percent:+d}%" if rate_percent != 0 else "default"

# pitch: 1.0 = default, 0.5 = -50%, 2.0 = +50%
pitch_percent = int((pitch - 1.0) * 50)  # More conservative range
pitch_str = f"{pitch_percent:+d}%" if pitch_percent != 0 else "default"
```

### Cost Tracking
[Source: docs/prd/epic-27-dreamai-content-generation.md]

Azure TTS pricing: ~$4/1M characters
- Track character count in each request
- Log character usage for cost monitoring
- Consider adding character count to AudioResult in future

### Source Tree Reference
[Source: docs/architecture/source-tree.md]

New files to create:
```
backend/app/services/tts/providers/
├── __init__.py          # Export AzureTTSProvider (update)
└── azure.py             # AzureTTSProvider implementation (new)

backend/app/tests/test_services/test_tts/
└── test_azure_provider.py  # Unit tests (new)
```

Files to modify:
```
backend/pyproject.toml                     # Add azure-cognitiveservices-speech
backend/app/services/tts/__init__.py       # Export AzureTTSProvider
backend/app/services/tts/providers/__init__.py  # Export AzureTTSProvider
backend/app/services/tts/manager.py        # Uncomment Azure registration
```

### Coding Standards
[Source: docs/architecture/coding-standards.md]

- Use `async/await` - Note: Azure SDK uses sync `.get()` on async operations
- Wrap sync SDK calls in `asyncio.to_thread()` to avoid blocking
- Type hints required on all functions
- Google-style docstrings
- Follow snake_case for variables/functions, PascalCase for classes
- Error handling with specific exception types from 27.4

### Exception Mapping
[Source: backend/app/services/tts/exceptions.py]

```python
# Map Azure SDK errors to TTS exceptions
if result.reason == speechsdk.ResultReason.Canceled:
    cancellation = result.cancellation_details
    if cancellation.reason == speechsdk.CancellationReason.Error:
        if "401" in str(cancellation.error_details):
            raise TTSAuthenticationError(...)
        elif "timeout" in str(cancellation.error_details).lower():
            raise TTSConnectionError(...)
        else:
            raise TTSAudioGenerationError(...)
```

---

## Testing

### Test File Location
`backend/app/tests/test_services/test_tts/test_azure_provider.py`

### Test Standards
[Source: docs/architecture/coding-standards.md]

- Use `pytest` with `pytest-asyncio`
- Mock Azure SDK to avoid actual API calls and costs
- Follow arrange-act-assert pattern
- Aim for >80% coverage on new code

### Test Cases Summary

**test_azure_provider.py:**
- Test provider initialization with valid settings
- Test provider initialization with missing API key
- Test get_name returns "azure"
- Test is_available returns True when API key configured
- Test is_available returns False when API key missing
- Test get_supported_languages includes "en", "tr"
- Test supports_language for valid/invalid languages
- Test get_available_voices for different language codes
- Test generate_audio with mocked Azure SDK
- Test generate_audio with SSML (rate/pitch modified)
- Test generate_audio_batch sequential processing
- Test batch handling of partial failures
- Test default voice selection per language
- Test TTSAuthenticationError on 401 response
- Test TTSConnectionError on network timeout
- Test proper SSML escaping for special characters

### Mocking Strategy

```python
import pytest
from unittest.mock import MagicMock, patch

@pytest.fixture
def mock_speech_sdk():
    """Mock Azure Speech SDK for testing."""
    with patch("azure.cognitiveservices.speech.SpeechConfig") as mock_config:
        with patch("azure.cognitiveservices.speech.SpeechSynthesizer") as mock_synth:
            # Setup mock result
            mock_result = MagicMock()
            mock_result.reason = speechsdk.ResultReason.SynthesizingAudioCompleted
            mock_result.audio_data = b"fake_audio_data"
            mock_result.audio_duration.total_seconds.return_value = 2.5

            # Setup synthesizer
            mock_synth_instance = MagicMock()
            mock_synth_instance.speak_text_async.return_value.get.return_value = mock_result
            mock_synth_instance.speak_ssml_async.return_value.get.return_value = mock_result
            mock_synth.return_value = mock_synth_instance

            yield {
                "config": mock_config,
                "synthesizer": mock_synth,
                "synth_instance": mock_synth_instance,
                "result": mock_result,
            }

@pytest.fixture
def azure_settings():
    """Create TTSSettings with Azure configuration."""
    from app.services.tts.config import TTSSettings
    return TTSSettings(
        AZURE_TTS_KEY="test-api-key",
        AZURE_TTS_REGION="turkeycentral",
    )
```

### Environment Variables for Testing
```bash
# For integration tests (optional, not for unit tests)
AZURE_TTS_KEY=your-test-key
AZURE_TTS_REGION=turkeycentral
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-02 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2026-01-02 | 1.0 | Implementation complete - all tasks done, 51 tests passing | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- All 51 Azure TTS provider tests pass
- All 203 TTS module tests pass (full regression)
- Ruff linter passes with no errors

### Completion Notes List
- Implemented `AzureTTSProvider` class extending `TTSProvider` ABC with all 7 required abstract methods
- Added support for Turkish (tr-TR) and English (en-US, en-GB) neural voices
- Implemented SSML generation for rate/pitch control with proper XML escaping
- Used `asyncio.to_thread()` to wrap synchronous Azure SDK calls
- Integrated with TTSManager as fallback provider (registered when `AZURE_TTS_KEY` is configured)
- Character count tracked in logs for cost monitoring (~$4/1M chars)
- Comprehensive test suite with 51 unit tests covering all functionality

### File List
**New Files:**
- `backend/app/services/tts/providers/azure.py` - AzureTTSProvider implementation
- `backend/app/tests/test_services/test_tts/test_azure_provider.py` - Unit tests (51 tests)

**Modified Files:**
- `backend/pyproject.toml` - Added azure-cognitiveservices-speech>=1.35.0
- `backend/uv.lock` - Updated with azure-cognitiveservices-speech and azure-core
- `backend/app/services/tts/__init__.py` - Export AzureTTSProvider
- `backend/app/services/tts/providers/__init__.py` - Export AzureTTSProvider
- `backend/app/services/tts/manager.py` - Registered Azure provider in create_default_manager()

---

## QA Results
_To be filled by QA agent_
