# Story 30.8: Mix Mode Generation

**Status:** Ready for Review
**Epic:** Epic 30 - Skill-Based AI Assignment Generation & Reporting
**Story Points:** 8
**Priority:** High (Key UX feature for quick assignment creation)
**Dependencies:** Stories 30.3-30.7 (all individual skill generators must be available)

---

## User Story

As a **teacher**,
I want **to generate a balanced multi-skill assignment with a single action**,
So that **I can quickly create comprehensive practice covering multiple language skills without selecting each one individually**.

---

## Acceptance Criteria

1. [ ] Mix mode generates questions spanning at least 3 different skills
2. [ ] Each question is individually tagged with `skill_id` and `format_id`
3. [ ] Distribution is balanced but adapts to module content characteristics
4. [ ] Teacher configures total question count only (no format selection required)
5. [ ] Generated assignment has `is_mix_mode=true` on the Assignment model
6. [ ] All skill-specific generators are called correctly
7. [ ] Works with all CEFR difficulty levels
8. [ ] Skill distribution summary included in response for teacher review

---

## Tasks & Subtasks

- [x] **Task 1: Create Mix Mode Generator Service** (AC: 1, 2, 3, 6)
  - [x] Create `backend/app/services/ai_generation/mix_mode_service.py`
  - [x] Implement `generate_activity(book_id, module_ids, total_count, difficulty, language)`:
    1. Analyze module content for skill signals (heuristics):
       - Vocabulary richness → Vocabulary weight
       - Dialogue/conversation content → Listening weight
       - Grammar pattern density → Grammar weight (steady default)
       - Passage length/complexity → Reading weight
       - Expressive language → Writing weight
    2. Calculate question distribution:
       - Start with proportional allocation based on weights
       - Minimum 1 question per skill
       - Adjust to match exact total_count
    3. For each skill allocation:
       - Select default format per skill
       - Call the respective skill generator with allocated count
    4. Aggregate results via asyncio.gather, tag each question with skill/format

- [x] **Task 2: Define Mix Mode Content Schema** (AC: 2, 8)
  - [x] Created `backend/app/schemas/mix_mode.py` with:
    - SkillAllocation, MixModeQuestion, MixModeActivity, MixModeActivityPublic
    - ContentAnalysisResult for skill weight heuristics

- [x] **Task 3: Content Analysis Heuristics** (AC: 3)
  - [x] Quick module content analysis (runs before LLM generation):
    - Word count > 200 → increase Reading weight
    - Dialogue markers (quotation marks, "said", "asked") → increase Listening weight
    - Vocabulary density (unique words / total words) → adjust Vocabulary weight
    - Expressive language markers → increase Writing weight
  - [x] Equal distribution fallback when all weights are 1.0

- [x] **Task 4: V2 Endpoint Mix Mode Handling** (AC: 4, 5)
  - [x] When `skill_slug == "mix"`:
    - `format_slug` is not required (system selects)
    - Call MixModeService instead of dispatcher
    - Set `is_mix_mode=true` on activity
  - [x] Return `skill_distribution` in response for teacher preview
  - [x] Added mix mode storage to QuizStorageService

- [x] **Task 5: Unit Tests** (AC: 1-8)
  - [x] 25 tests in `backend/app/tests/test_mix_mode.py` — all passing
  - [x] Schema tests (5), content analysis tests (7), distribution tests (5), service tests (5), storage tests (3)
  - [x] Regression: 189 tests passing across Stories 30.1-30.8

---

## Dev Notes

### Generator Orchestration
Mix mode is an orchestrator that calls individual generators. Each generator (30.3-30.7) must support generating a small batch (e.g., 2-3 questions) efficiently. The mix generator collects results and assembles them into a unified structure.

### Performance Consideration
Mix mode makes multiple LLM calls (one per skill). For 5 skills, that's 5 LLM calls. Consider:
- Parallel execution with `asyncio.gather()` for LLM calls
- Batch TTS generation for all Listening questions at once
- Total generation time target: < 15 seconds

### Distribution Algorithm Simplification
For v1, keep distribution simple:
- 10 questions → 2-2-2-2-2 (equal) or 3-2-2-2-1 (adapted)
- Don't over-optimize — teacher can regenerate if unsatisfied

### Testing
- Test file: `backend/app/tests/test_mix_mode_generator.py`
- Mock all individual generators (they're tested separately)
- Focus on distribution logic and aggregation correctness

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `backend/app/schemas/mix_mode.py` | Created | SkillAllocation, MixModeQuestion, MixModeActivity, MixModeActivityPublic, ContentAnalysisResult |
| `backend/app/services/ai_generation/mix_mode_service.py` | Created | MixModeService orchestrator with content analysis, distribution, parallel generation |
| `backend/app/api/routes/ai_generation.py` | Modified | Added mix mode handling before dispatcher (skill_slug == "mix") |
| `backend/app/services/ai_generation/quiz_storage_service.py` | Modified | Added mix mode storage (save/get/get_public) + cleanup |
| `backend/app/tests/test_mix_mode.py` | Created | 25 unit tests |

### Completion Notes
- All 5 tasks implemented and verified
- 25 unit tests passing, 189 regression tests passing
- Mix mode orchestrates vocabulary (MCQ), grammar (fill-blank), reading (MCQ), listening (MCQ), writing (fill-blank)
- Content analysis heuristics adapt distribution based on module text characteristics
- Parallel generation via asyncio.gather for performance

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2026-02-13 | 1.1 | Implementation complete — all tasks done, 25+189 tests passing | Dev Agent (James) |
