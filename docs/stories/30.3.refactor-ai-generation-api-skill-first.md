# Story 30.3: Refactor AI Generation API to Skill-First Model

**Status:** Ready for Review
**Epic:** Epic 30 - Skill-Based AI Assignment Generation & Reporting
**Story Points:** 8
**Priority:** High (Core refactoring — blocks all new generators and frontend)
**Dependencies:** Story 30.1, Story 30.2

---

## User Story

As a **teacher**,
I want **to generate AI assignments by selecting a skill and activity format instead of just an activity type**,
So that **the generated content is pedagogically aligned with the skill I want my students to practice**.

---

## Acceptance Criteria

1. [ ] New generation endpoint `POST /api/v1/ai/generate-v2` accepts `skill_slug` + `format_slug` instead of `activity_type`
2. [ ] All 8 remapped skill-format combinations route to existing generators correctly:
   - (vocabulary, multiple_choice) → vocabulary_quiz generator
   - (vocabulary, word_builder) → word_builder generator
   - (vocabulary, matching) → vocabulary_matching generator
   - (grammar, multiple_choice) → ai_quiz generator with grammar-focused prompt
   - (grammar, sentence_builder) → sentence_builder generator
   - (reading, comprehension) → reading_comprehension generator
   - (writing, sentence_builder) → sentence_builder with writing-focused prompt
   - (writing, fill_blank) → placeholder/stub for Story 30.7
3. [ ] Generated content metadata includes `skill_id` and `format_id`
4. [ ] Content Library save/load includes skill classification
5. [ ] Old `POST /api/v1/ai/generate` endpoints remain functional but return deprecation header
6. [ ] Invalid skill-format combinations return 422 with descriptive error
7. [ ] Grammar quiz generation uses grammar-focused prompt (not generic ai_quiz prompt)

---

## Tasks & Subtasks

- [x] **Task 1: Create Generation Request V2 Schema** (AC: 1)
  - [x] Create `GenerationRequestV2` in `backend/app/schemas/ai_generation_v2.py`
  - [x] Add validator: `format_slug` is required unless `skill_slug == "mix"`
  - [x] Add validator: `book_id` required for book_module source
  - [x] Add validator: `material_text` required for teacher_material source

- [x] **Task 2: Create Skill-Format Router/Dispatcher** (AC: 2, 6)
  - [x] Create `backend/app/services/skill_generation_dispatcher.py`
  - [x] Map `(skill_slug, format_slug)` → (generator_key, activity_type) with DB validation
  - [x] Return 422 for invalid skill/format/combination
  - [x] Return 501 Not Implemented for combinations mapped to None (stubs for future stories)

- [x] **Task 3: Create V2 Generation Endpoint** (AC: 1, 3)
  - [x] Add `POST /generate-v2` endpoint to `backend/app/api/routes/ai_generation.py`
  - [x] Call dispatcher to route to correct generator
  - [x] Inject `skill_id` and `format_id` into generated content metadata
  - [x] Wrap existing generator responses with skill metadata in GenerationResponseV2

- [x] **Task 4: Create Grammar-Focused Quiz Prompt** (AC: 7)
  - [x] Create `backend/app/services/ai_generation/prompts/grammar_prompts.py`
  - [x] Grammar prompt focuses on grammar rules, tense usage, sentence structure
  - [x] Includes grammar_topic field in JSON schema for topic detection
  - [x] Updated prompts `__init__.py` with grammar exports

- [x] **Task 5: Add Deprecation Header to Old Endpoints** (AC: 5)
  - [x] Add `_set_deprecation_headers()` helper to all 5 old generate endpoints
  - [x] Headers: Deprecation, Sunset (2026-06-01), Link to V2 successor
  - [x] Old endpoints continue to function without modification

- [x] **Task 6: Update Content Library** (AC: 4)
  - [x] Add `skill_id` and `format_id` fields to `TeacherGeneratedContent` model (nullable)
  - [x] Create migration `c3d4e5f6a7b8_add_skill_fields_to_content_library.py`
  - [x] Update library save endpoint to persist skill metadata
  - [x] Update library list endpoint to return skill metadata
  - [x] Update library filter to support `?skill=vocabulary` query parameter

- [x] **Task 7: Unit Tests** (AC: 1-7)
  - [x] 29 tests in `backend/app/tests/test_ai_generation_v2.py` — all passing
  - [x] Schema validation tests (6 tests)
  - [x] Dispatcher routing tests (7 tests incl. 422/501 error cases)
  - [x] Generator map validation tests (3 tests)
  - [x] Grammar prompt tests (3 tests)
  - [x] Content Library skill field tests (4 tests)
  - [x] Response schema tests (1 test)
  - [x] Regression: 30.1 (12 tests) + 30.2 (16 tests) all passing

---

## Dev Notes

### Relevant Source Tree
- AI generation routes: `backend/app/api/routes/ai_generation.py` [Source: source-tree.md]
- AI generation schemas: `backend/app/schemas/dcs_ai_data.py` and inline in routes
- Existing generators: inline in `ai_generation.py` — quiz, vocabulary, reading, sentence_builder, word_builder
- Services: `backend/app/services/assignment_from_ai_service.py`
- Content Library: managed in `ai_generation.py` (`/library` endpoints)

### Current Generation Flow
1. Teacher calls `POST /ai/quiz/generate` (or vocab, reading, etc.)
2. Route fetches module text from DCS via `DCSAIServiceClient`
3. LLM generates structured content using provider layer
4. Content returned to teacher for review
5. Teacher saves to library or creates assignment

### LLM Provider Layer
- Primary: DeepSeek (`deepseek-chat` V3) [Source: epic-27]
- Fallback: Gemini (`gemini-1.5-flash`) [Source: epic-27]
- Abstracted via `LLMProvider` base class
- Providers in `backend/app/services/` area

### Key Constraint
Do NOT modify existing generator functions. Create a dispatcher layer that wraps them. The grammar-focused prompt is the one exception — fork the ai_quiz prompt into a separate grammar variant.

### Testing
- Test file: `backend/app/tests/test_ai_generation_v2.py` (new file) [Source: 10-testing-strategy.md]
- Mock LLM responses for deterministic tests
- Test each skill-format routing independently

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
| File | Action | Description |
|------|--------|-------------|
| `backend/app/schemas/ai_generation_v2.py` | Created | GenerationRequestV2 and GenerationResponseV2 schemas |
| `backend/app/services/skill_generation_dispatcher.py` | Created | GENERATOR_MAP + dispatch() with DB validation |
| `backend/app/services/ai_generation/prompts/grammar_prompts.py` | Created | Grammar-focused system/user prompts and JSON schema |
| `backend/app/services/ai_generation/prompts/__init__.py` | Modified | Added grammar prompt exports |
| `backend/app/api/routes/ai_generation.py` | Modified | Added V2 endpoint, deprecation headers on 5 old endpoints, content library skill filter |
| `backend/app/models.py` | Modified | Added skill_id/format_id to TeacherGeneratedContent |
| `backend/app/schemas/ai_quiz.py` | Modified | Added skill_id/format_id to SaveToLibraryRequest |
| `backend/app/schemas/content_library.py` | Modified | Added skill_id/name, format_id/name to ContentItemPublic |
| `backend/app/alembic/versions/c3d4e5f6a7b8_add_skill_fields_to_content_library.py` | Created | Migration: add skill_id/format_id to teacher_generated_content |
| `backend/app/tests/test_ai_generation_v2.py` | Created | 29 unit tests for V2 schema, dispatcher, grammar prompts, library skill fields |

### Debug Log References
- No blocking issues encountered.
- Pre-existing test failures in `test_assignment_schemas.py` (8 tests) from Epic 24 book_id UUID→int migration — NOT caused by this story.

### Completion Notes
- All 7 tasks implemented and verified
- 29 unit tests passing (test_ai_generation_v2.py)
- 28 regression tests passing (12 from 30.1 + 16 from 30.2)
- Migration c3d4e5f6a7b8 verified: forward, rollback, re-apply all successful
- GENERATOR_MAP has 7 implemented combos + 5 stubs (None → 501)
- V2 endpoint dispatches to existing generators without modifying them
- Grammar prompt fork created with grammar_topic detection

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2026-02-13 | 1.1 | Implementation complete — all tasks done, 29+28 tests passing | Dev Agent (James) |
