# Story 8.4: Multi-Activity Assignment Analytics

**Epic:** 8 - Multi-Activity Assignments & Page-Based Selection
**Story ID:** 8.4
**Status:** Done
**Created:** 2025-11-30
**Developer:** (To be assigned)

---

## Story

**As a** teacher,
**I want** to see per-activity score breakdowns for multi-activity assignments,
**so that** I can identify which specific activities students struggled with.

---

## Acceptance Criteria

1. Assignment detail page (teacher view) shows activity-by-activity breakdown
2. Table columns: Activity Title, Page, Type, Class Average Score, Completion Rate
3. Click activity row to expand and see individual student scores for that activity
4. Student assignment result shows: Total Score + per-activity scores
5. Student view (completed assignment) shows score breakdown by activity
6. Export includes per-activity columns (CSV/Excel)
7. API endpoint `GET /api/v1/assignments/{id}/analytics` returns per-activity aggregations
8. Handles mixed completion: shows partial scores if assignment submitted incomplete (timeout)
9. Integration tests verify analytics calculations with multi-activity data

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create Analytics Schema Definitions** (AC: 1, 2, 4, 7)
  - [ ] 1.1: Create `MultiActivityAnalyticsResponse` Pydantic schema in `backend/app/schemas/assignment.py`
  - [ ] 1.2: Create `ActivityAnalyticsItem` schema with fields: activity_id, activity_title, page_number, activity_type, class_average_score, completion_rate, completed_count, total_assigned_count
  - [ ] 1.3: Create `StudentActivityScore` schema with fields: student_id, student_name, status, score, max_score, time_spent_seconds, completed_at
  - [ ] 1.4: Create `PerActivityBreakdown` schema for expanded view (activity_id, students: list[StudentActivityScore])

- [ ] **Task 2: Create Analytics Service Functions** (AC: 7, 8)
  - [ ] 2.1: Create `get_multi_activity_analytics(assignment_id, teacher_id)` function
  - [ ] 2.2: Query `AssignmentStudentActivity` table grouped by activity_id
  - [ ] 2.3: Calculate class_average_score per activity: `AVG(score) WHERE status = 'completed'`
  - [ ] 2.4: Calculate completion_rate per activity: `COUNT(status='completed') / COUNT(*)`
  - [ ] 2.5: Handle partial completion cases (force_submit scenarios) - include all submitted scores
  - [ ] 2.6: Join Activity table to get title, page_number, activity_type

- [ ] **Task 3: Create API Endpoint** (AC: 7, 3)
  - [ ] 3.1: Add `GET /api/v1/assignments/{assignment_id}/analytics` endpoint to `routes/assignments.py`
  - [ ] 3.2: Require `UserRole.teacher` authorization
  - [ ] 3.3: Verify teacher owns assignment (via class → assignment relationship)
  - [ ] 3.4: Return 404 for non-existent or unauthorized assignments
  - [ ] 3.5: Add query parameter `?expand_activity_id={uuid}` to get per-student breakdown for specific activity (AC: 3)
  - [ ] 3.6: Return `MultiActivityAnalyticsResponse` with activities list and optional expanded student list

- [ ] **Task 4: Add Student-Visible Score Breakdown Endpoint** (AC: 4, 5)
  - [ ] 4.1: Add `GET /api/v1/assignments/{assignment_id}/students/me/result` endpoint
  - [ ] 4.2: Require `UserRole.student` authorization
  - [ ] 4.3: Create `StudentAssignmentResultResponse` schema: total_score, activity_scores: list[ActivityScoreItem]
  - [ ] 4.4: Create `ActivityScoreItem` schema: activity_id, activity_title, activity_type, score, max_score, status
  - [ ] 4.5: Return combined score + per-activity breakdown for completed assignments

- [ ] **Task 5: Backend Integration Tests** (AC: 9)
  - [ ] 5.1: Create `backend/app/tests/test_api/test_multi_activity_analytics.py`
  - [ ] 5.2: Test analytics endpoint returns correct activity count
  - [ ] 5.3: Test class_average_score calculation with multiple students at various scores
  - [ ] 5.4: Test completion_rate calculation (completed/total)
  - [ ] 5.5: Test expand_activity_id parameter returns student list
  - [ ] 5.6: Test authorization (teacher can only see own assignments)
  - [ ] 5.7: Test partial completion handling (force_submit scenario)
  - [ ] 5.8: Test student result endpoint returns correct breakdown
  - [ ] 5.9: Test empty assignment (no submissions yet)

### Frontend Tasks

- [ ] **Task 6: Create TypeScript Types** (AC: 1, 2, 4)
  - [ ] 6.1: Add `MultiActivityAnalyticsResponse` interface to `types/assignment.ts`
  - [ ] 6.2: Add `ActivityAnalyticsItem` interface
  - [ ] 6.3: Add `StudentActivityScore` interface
  - [ ] 6.4: Add `StudentAssignmentResultResponse` and `ActivityScoreItem` interfaces

- [ ] **Task 7: Create API Service Functions** (AC: 7)
  - [ ] 7.1: Add `getAssignmentAnalytics(assignmentId)` to `services/assignmentsApi.ts`
  - [ ] 7.2: Add `getAssignmentAnalyticsExpanded(assignmentId, activityId)` for per-activity student list
  - [ ] 7.3: Add `getStudentAssignmentResult(assignmentId)` for student view

- [ ] **Task 8: Create Analytics Hook** (AC: 7)
  - [ ] 8.1: Create `hooks/useAssignmentAnalytics.ts` with TanStack Query
  - [ ] 8.2: 5-minute stale time for caching
  - [ ] 8.3: Return `{ analytics, isLoading, error, expandActivity }`
  - [ ] 8.4: Handle expand/collapse of activity rows

- [ ] **Task 9: Create Teacher Analytics View Component** (AC: 1, 2, 3)
  - [ ] 9.1: Create `components/analytics/MultiActivityAnalyticsTable.tsx`
  - [ ] 9.2: Render table with columns: Activity Title, Page, Type, Class Average, Completion Rate
  - [ ] 9.3: Make rows clickable to expand with student scores (accordion pattern)
  - [ ] 9.4: Show loading skeleton for expanded rows
  - [ ] 9.5: Add Recharts bar chart showing score distribution per activity
  - [ ] 9.6: Mobile responsive: stack cards instead of table on small screens

- [ ] **Task 10: Integrate Analytics into Assignment Detail Page** (AC: 1)
  - [ ] 10.1: Add "Analytics" tab to teacher assignment detail page
  - [ ] 10.2: Check if assignment has multiple activities (via `assignment.activities.length > 1`)
  - [ ] 10.3: Conditionally show MultiActivityAnalyticsTable vs existing single-activity analytics
  - [ ] 10.4: Show empty state if no submissions yet

- [ ] **Task 11: Create Student Score Breakdown View** (AC: 4, 5)
  - [ ] 11.1: Modify student completed assignment view (`routes/_layout/student/assignments/$assignmentId/success.tsx`)
  - [ ] 11.2: Add "Score Breakdown" section showing per-activity scores
  - [ ] 11.3: Create `ActivityScoreCard` component showing activity name, type icon, score
  - [ ] 11.4: Visual progress bars per activity

- [ ] **Task 12: Implement Export Functionality** (AC: 6)
  - [ ] 12.1: Add "Export" button to analytics view (dropdown: CSV, Excel)
  - [ ] 12.2: Use `xlsx` library for Excel export (already used in Story 5.3)
  - [ ] 12.3: Export format: Student Name, Total Score, [Activity 1 Score], [Activity 2 Score], ...
  - [ ] 12.4: Include activity headers with title and page number

- [ ] **Task 13: Frontend Component Tests** (AC: 9)
  - [ ] 13.1: Create `components/analytics/MultiActivityAnalyticsTable.test.tsx`
  - [ ] 13.2: Test table renders correct columns and data
  - [ ] 13.3: Test row expansion shows student scores
  - [ ] 13.4: Test empty state handling
  - [ ] 13.5: Create `routes/__tests__/student-assignment-result.test.tsx`
  - [ ] 13.6: Test student score breakdown displays correctly

---

## Dev Notes

### Previous Story Insights (Story 8.3)
[Source: docs/stories/8.3.student-multi-activity-assignment-player.md#Dev Agent Record]

- Multi-activity endpoints follow pattern: `GET /assignments/{id}/start-multi`, `PATCH .../activities/{id}`, `POST .../submit-multi`
- `AssignmentStudentActivity` stores per-activity progress with fields: status, score, max_score, response_data, started_at, completed_at
- Submit button always enabled with warning dialog for incomplete activities (UX decision)
- Force submit available for timer expiry - handles partial completion scenarios
- 14 backend tests + 20 frontend tests pattern works well

### Data Models
[Source: backend/app/models.py]

**AssignmentStudentActivity table (key for analytics):**
```python
class AssignmentStudentActivity(SQLModel, table=True):
    __tablename__ = "assignment_student_activities"

    id: uuid.UUID
    assignment_student_id: uuid.UUID  # FK → assignment_students
    activity_id: uuid.UUID            # FK → activities
    status: AssignmentStudentActivityStatus  # not_started/in_progress/completed
    score: float | None               # Nullable - populated on completion
    max_score: float = 100.0
    response_data: dict | None        # JSONB - student answers
    started_at: datetime | None
    completed_at: datetime | None
```

**AssignmentStudent (parent record):**
```python
class AssignmentStudent(SQLModel, table=True):
    id: uuid.UUID
    assignment_id: uuid.UUID
    student_id: uuid.UUID
    status: AssignmentStatus
    score: float | None              # Combined score across all activities
    time_spent_minutes: int | None
    # Relationship: activity_progress → list[AssignmentStudentActivity]
```

**Activity table (for title, page, type):**
```python
class Activity(SQLModel, table=True):
    id: uuid.UUID
    title: str | None
    page_number: int
    activity_type: ActivityType      # circle, matchTheWords, dragdroppicture, etc.
```

### Existing Analytics Patterns
[Source: docs/stories/5.3.assignment-specific-analytics-common-mistakes.md]

- Analytics service functions in `backend/app/services/` (or inline in routes)
- Authorization via `_verify_assignment_ownership()` helper
- TanStack Query with 5-minute stale time for frontend
- Recharts BarChart for visualizations
- Export using `xlsx` library (already a project dependency)
- Test pattern: ~10 backend + ~15 frontend tests

### API Specifications
[Source: Epic 8 PRD]

**New Endpoint:**
```
GET /api/v1/assignments/{assignment_id}/analytics
Authorization: Bearer {teacher_token}
Query: ?expand_activity_id={uuid} (optional)

Response:
{
  "assignment_id": "uuid",
  "total_students": 25,
  "submitted_count": 20,
  "activities": [
    {
      "activity_id": "uuid",
      "activity_title": "Match the Words",
      "page_number": 7,
      "activity_type": "matchTheWords",
      "class_average_score": 78.5,
      "completion_rate": 0.80,
      "completed_count": 20,
      "total_assigned_count": 25
    },
    ...
  ],
  "expanded_students": [...] // Only if expand_activity_id provided
}
```

**Student Result Endpoint:**
```
GET /api/v1/assignments/{assignment_id}/students/me/result
Authorization: Bearer {student_token}

Response:
{
  "assignment_id": "uuid",
  "total_score": 85.0,
  "completed_at": "2025-11-30T12:00:00Z",
  "activity_scores": [
    {
      "activity_id": "uuid",
      "activity_title": "Match the Words",
      "activity_type": "matchTheWords",
      "score": 90.0,
      "max_score": 100.0,
      "status": "completed"
    },
    ...
  ]
}
```

### File Locations
[Source: docs/architecture/source-tree.md]

**Backend:**
```
backend/app/
├── api/routes/assignments.py          # Add new analytics endpoints
├── schemas/assignment.py              # Add analytics schemas
└── tests/test_api/
    └── test_multi_activity_analytics.py  # NEW test file
```

**Frontend:**
```
frontend/src/
├── types/assignment.ts                # Add analytics types
├── services/assignmentsApi.ts         # Add API functions
├── hooks/
│   └── useAssignmentAnalytics.ts      # NEW hook
├── components/analytics/
│   └── MultiActivityAnalyticsTable.tsx  # NEW component
└── routes/_layout/
    ├── teacher/assignments/$assignmentId.tsx  # Add Analytics tab
    └── student/assignments/$assignmentId/success.tsx  # Add breakdown
```

### Recharts Usage
[Source: docs/architecture/tech-stack.md]

Recharts 2.x for data visualization. Example pattern from Epic 5:
```typescript
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts'

<ResponsiveContainer width="100%" height={200}>
  <BarChart data={activities}>
    <XAxis dataKey="activity_title" />
    <YAxis domain={[0, 100]} />
    <Tooltip />
    <Bar dataKey="class_average_score" fill="#0d9488" />
  </BarChart>
</ResponsiveContainer>
```

### Excel Export Pattern
[Source: docs/stories/5.3.assignment-specific-analytics-common-mistakes.md]

Use `xlsx` library for client-side Excel export:
```typescript
import * as XLSX from 'xlsx'

const exportToExcel = (data: StudentScore[], activities: Activity[]) => {
  const ws = XLSX.utils.json_to_sheet(data)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Scores')
  XLSX.writeFile(wb, 'assignment-scores.xlsx')
}
```

---

## Testing

### Backend Testing Requirements
[Source: docs/architecture/10-testing-strategy.md]

- Use pytest with async fixtures
- Test file: `backend/app/tests/test_api/test_multi_activity_analytics.py`
- Create fixtures for:
  - Multi-activity assignment with 3+ activities
  - Multiple students with varying completion states
  - Partial completion (force_submit) scenarios
- Test patterns:
  - Arrange-Act-Assert structure
  - Use `@pytest.mark.asyncio` for async tests
  - Mock database with test session

### Frontend Testing Requirements
[Source: docs/architecture/10-testing-strategy.md]

- Use Vitest + React Testing Library
- Test files colocated with components
- Mock API calls with vitest mocks
- Test accessibility (role queries)

### Test Coverage Expectations
- Backend: 8-10 integration tests for analytics endpoints
- Frontend: 10-12 component tests for analytics table and student breakdown
- Hook tests for useAssignmentAnalytics

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes

(To be filled by Dev Agent)

### File List

(To be filled by Dev Agent)

---

## QA Results

(To be filled by QA Agent)
