# Story 25.1: Backend User Model DCS Publisher Link

## Status: Ready for Review

## Story

As a developer, I need to add a `dcs_publisher_id` field to the User model so that publisher users can be linked to their DCS publisher identity.

## Acceptance Criteria

- [ ] User model has `dcs_publisher_id: int | None` field
- [ ] Alembic migration adds column without data loss
- [ ] UserPublic schema exposes the new field
- [ ] UserCreate/UserUpdate schemas support the field
- [ ] Existing users remain unaffected (field is nullable)
- [ ] Index added for query performance
- [ ] Field only relevant for users with role=publisher

## Technical Design

### Model Changes

```python
# backend/app/models.py

class UserBase(SQLModel):
    email: EmailStr | None = Field(default=None, unique=True, index=True, max_length=255)
    username: str = Field(unique=True, index=True, min_length=3, max_length=50)
    is_active: bool = True
    is_superuser: bool = False
    full_name: str | None = Field(default=None, max_length=255)
    role: UserRole = Field(default=UserRole.student)
    dcs_publisher_id: int | None = Field(
        default=None,
        index=True,
        description="DCS Publisher ID - only set for publisher role users"
    )
```

### Migration

```python
# backend/app/alembic/versions/xxx_add_dcs_publisher_id_to_user.py

def upgrade():
    op.add_column(
        'user',
        sa.Column('dcs_publisher_id', sa.Integer(), nullable=True, index=True)
    )
    op.create_index(
        'ix_user_dcs_publisher_id',
        'user',
        ['dcs_publisher_id']
    )

def downgrade():
    op.drop_index('ix_user_dcs_publisher_id', table_name='user')
    op.drop_column('user', 'dcs_publisher_id')
```

### Schema Updates

```python
# Ensure UserPublic includes the field
class UserPublic(UserBase):
    id: uuid.UUID
    dcs_publisher_id: int | None = None  # Exposed in API responses
```

## Dev Notes

- Field is nullable to maintain backward compatibility
- Only publisher role users should have this field set
- Validation of DCS publisher existence happens at account creation (Story 25.2)
- Consider adding a property/method to check if user is a "complete" publisher (has dcs_publisher_id set)

## Testing Requirements

- [ ] Migration runs successfully on existing database
- [ ] Existing users unaffected by migration
- [ ] New users can be created with/without dcs_publisher_id
- [ ] Field appears in UserPublic responses
- [ ] Field can be updated via UserUpdate
- [ ] Index exists and is used in queries

## Tasks

- [ ] Add dcs_publisher_id field to UserBase model
- [ ] Create Alembic migration
- [ ] Update UserPublic schema
- [ ] Update UserCreate schema (optional field)
- [ ] Update UserUpdate schema (optional field)
- [ ] Add index for dcs_publisher_id
- [ ] Write unit tests for model changes
- [ ] Test migration on dev database

## File List

| File | Action |
|------|--------|
| `backend/app/models.py` | Modified (add dcs_publisher_id field to UserBase, UserUpdate) |
| `backend/app/alembic/versions/3e6de9bee8d1_add_dcs_publisher_id_to_user.py` | Created |
| `backend/app/tests/test_dcs_publisher_id.py` | Created (unit tests for new field) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Tasks
- [x] Add dcs_publisher_id to UserBase
- [x] Create migration
- [x] Update schemas (UserUpdate explicit, UserCreate/UserPublic via inheritance)
- [x] Write tests (9 tests)
- [x] Run migration
- [x] Verify index exists

### Debug Log
N/A

### Completion Notes
- Added `dcs_publisher_id: int | None` field to `UserBase` with index
- Created Alembic migration `3e6de9bee8d1` that adds column and index
- `UserCreate` and `UserPublic` inherit the field from `UserBase`
- `UserUpdate` has explicit nullable field for updates
- 9 unit tests added covering creation, update, and schema validation
- Index `ix_user_dcs_publisher_id` verified in database
- All new tests pass (9/9)
- Pre-existing test failure in `test_crud_users.py` unrelated to this story (username validation message mismatch)

### Change Log
| Date | Change |
|------|--------|
| 2025-12-22 | Added dcs_publisher_id field to UserBase, UserUpdate |
| 2025-12-22 | Created Alembic migration 3e6de9bee8d1 |
| 2025-12-22 | Added test_dcs_publisher_id.py with 9 tests |
| 2025-12-22 | Ran migration and verified index creation |
