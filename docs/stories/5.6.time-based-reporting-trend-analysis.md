# Story 5.6: Time-Based Reporting & Trend Analysis

**Epic:** 5 - Analytics, Reporting & Teacher Insights
**Story ID:** 5.6
**Status:** Done
**Created:** 2025-11-28
**Developer:** (To be assigned)

---

## Story

**As a** teacher,
**I want** to generate reports for specific time periods and compare performance across weeks/months,
**so that** I can track progress over the school year and prepare for parent-teacher conferences.

---

## Acceptance Criteria

1. Teacher navigation includes "Reports" section with report builder interface
2. **Report Builder**: Form to configure report with fields: Report type (student/class/assignment), time period (custom date range, week, month, semester), target (select class or student), format (PDF/Excel)
3. **Predefined Report Templates**:
   - "Weekly Class Summary" - class performance for selected week
   - "Student Progress Report" - individual student for semester/year
   - "Monthly Assignment Overview" - all assignments in a month
   - "Parent-Teacher Conference Report" - comprehensive student report
4. Report generation triggers backend job that compiles requested data
5. Generated reports include: cover page with date range and teacher name, summary statistics, detailed tables, charts (embedded in PDF), comparison to previous period
6. **Trend Analysis**: Reports show percentage change vs. previous equivalent period (e.g., "This month's avg score: 85% (+7% from last month)")
7. Reports include narrative summaries: "Students showed improvement in multiple-choice activities but struggled with word searches"
8. API endpoint `POST /api/reports/generate` accepts report configuration and returns report file or job ID
9. For large reports, use asynchronous job processing with status endpoint `GET /api/reports/{job_id}/status`
10. Generated reports are stored temporarily and accessible via download link
11. Teacher can save report configurations as templates for recurring use
12. Report history shows previously generated reports with download links (7-day retention)
13. Unit tests verify report data accuracy and formatting
14. Integration tests verify end-to-end report generation workflow

---

## Tasks / Subtasks

- [ ] **Task 1: Backend Report Schemas** (AC: 2, 3, 4, 5, 8, 11)
  - [ ] 1.1: Create `ReportType` enum (student, class, assignment)
  - [ ] 1.2: Create `ReportFormat` enum (pdf, excel)
  - [ ] 1.3: Create `ReportPeriod` enum (week, month, semester, custom)
  - [ ] 1.4: Create `ReportTemplateType` enum (weekly_class_summary, student_progress_report, monthly_assignment_overview, parent_teacher_conference)
  - [ ] 1.5: Create `ReportJobStatus` enum (pending, processing, completed, failed)
  - [ ] 1.6: Create `ReportGenerateRequest` schema (report_type, period, start_date, end_date, target_id, format, template_type)
  - [ ] 1.7: Create `ReportJobResponse` schema (job_id, status, created_at, estimated_completion)
  - [ ] 1.8: Create `ReportStatusResponse` schema (job_id, status, progress_percentage, download_url, error_message)
  - [ ] 1.9: Create `SavedReportTemplate` schema (id, name, config, created_at)
  - [ ] 1.10: Create `ReportHistoryItem` schema (id, job_id, report_type, template_type, format, target_name, created_at, expires_at, download_url)
  - [ ] 1.11: Create `ReportHistoryResponse` schema (reports: list[ReportHistoryItem])

- [ ] **Task 2: Backend Database Model for Report Jobs** (AC: 9, 10, 11, 12)
  - [ ] 2.1: Create `ReportJob` model in `models.py` (id, teacher_id, status, report_type, template_type, config_json, file_path, created_at, completed_at, expires_at, error_message)
  - [ ] 2.2: Create `SavedReportConfig` model (id, teacher_id, name, config_json, created_at)
  - [ ] 2.3: Create Alembic migration for new tables
  - [ ] 2.4: Add indexes on `teacher_id`, `status`, `expires_at`

- [ ] **Task 3: Backend Report Generation Service** (AC: 4, 5, 6, 7, 8, 9, 10)
  - [ ] 3.1: Create `backend/app/services/report_service.py`
  - [ ] 3.2: Implement `create_report_job(teacher_id, config)` - creates job record, returns job_id
  - [ ] 3.3: Implement `process_report_job(job_id)` - main processing logic
  - [ ] 3.4: Implement `_generate_student_report(config)` - individual student data
  - [ ] 3.5: Implement `_generate_class_report(config)` - class-wide data
  - [ ] 3.6: Implement `_generate_assignment_report(config)` - assignment overview data
  - [ ] 3.7: Implement `_calculate_trend_analysis(current_data, previous_data)` - percentage changes
  - [ ] 3.8: Implement `_generate_narrative_summary(data)` - text summary generation
  - [ ] 3.9: Implement `get_report_status(job_id)` - check job status
  - [ ] 3.10: Implement `get_report_download_url(job_id)` - generate download URL
  - [ ] 3.11: Implement `cleanup_expired_reports()` - delete reports older than 7 days

- [ ] **Task 4: Backend PDF Generation** (AC: 5)
  - [ ] 4.1: Add `reportlab` or `weasyprint` dependency for PDF generation
  - [ ] 4.2: Create `backend/app/services/pdf_generator.py`
  - [ ] 4.3: Implement `generate_pdf_report(data, template_type)` - main PDF builder
  - [ ] 4.4: Implement `_create_cover_page(teacher_name, date_range, report_title)`
  - [ ] 4.5: Implement `_create_summary_section(stats)` - summary statistics
  - [ ] 4.6: Implement `_create_data_table(rows, columns)` - tabular data
  - [ ] 4.7: Implement `_create_chart_image(chart_data, chart_type)` - embed charts as images
  - [ ] 4.8: Implement `_create_trend_section(trend_data)` - trend comparison

- [ ] **Task 5: Backend Excel Generation** (AC: 5)
  - [ ] 5.1: Add `openpyxl` dependency for Excel generation
  - [ ] 5.2: Create `backend/app/services/excel_generator.py`
  - [ ] 5.3: Implement `generate_excel_report(data, template_type)` - main Excel builder
  - [ ] 5.4: Implement `_create_summary_sheet(workbook, stats)`
  - [ ] 5.5: Implement `_create_data_sheet(workbook, data, sheet_name)`
  - [ ] 5.6: Implement `_create_chart_sheet(workbook, chart_data)` - Excel native charts
  - [ ] 5.7: Apply styling (headers, colors, borders)

- [ ] **Task 6: Backend Background Job Processing** (AC: 9)
  - [ ] 6.1: Implement synchronous job processing (MVP approach - no Celery/RQ)
  - [ ] 6.2: Add `POST /api/v1/reports/generate` endpoint that processes in background thread
  - [ ] 6.3: Implement progress tracking via status field updates
  - [ ] 6.4: Add timeout handling for long-running reports

- [ ] **Task 7: Backend Report API Routes** (AC: 8, 9, 10, 11, 12)
  - [ ] 7.1: Create `backend/app/api/routes/reports.py`
  - [ ] 7.2: Add `POST /api/v1/reports/generate` - initiate report generation
  - [ ] 7.3: Add `GET /api/v1/reports/{job_id}/status` - check job status
  - [ ] 7.4: Add `GET /api/v1/reports/{job_id}/download` - download generated report
  - [ ] 7.5: Add `GET /api/v1/reports/history` - list previous reports (7-day retention)
  - [ ] 7.6: Add `POST /api/v1/reports/templates` - save report configuration
  - [ ] 7.7: Add `GET /api/v1/reports/templates` - list saved templates
  - [ ] 7.8: Add `DELETE /api/v1/reports/templates/{id}` - delete saved template
  - [ ] 7.9: Register router in `api/main.py`

- [ ] **Task 8: Backend Integration Tests** (AC: 13, 14)
  - [ ] 8.1: Create `backend/app/tests/test_api/test_reports.py`
  - [ ] 8.2: Test report generation endpoint (POST /reports/generate)
  - [ ] 8.3: Test report status endpoint (GET /reports/{job_id}/status)
  - [ ] 8.4: Test report download endpoint (GET /reports/{job_id}/download)
  - [ ] 8.5: Test report history endpoint (GET /reports/history)
  - [ ] 8.6: Test saved templates CRUD
  - [ ] 8.7: Test authorization (teacher can only access own reports)
  - [ ] 8.8: Test trend analysis calculation accuracy
  - [ ] 8.9: Test PDF generation with sample data
  - [ ] 8.10: Test Excel generation with sample data
  - [ ] 8.11: Test narrative summary generation
  - [ ] 8.12: Test report expiration/cleanup

- [ ] **Task 9: Frontend TypeScript Types** (AC: 2, 3, 8, 9, 11, 12)
  - [ ] 9.1: Create `types/reports.ts`
  - [ ] 9.2: Add `ReportType` type (student | class | assignment)
  - [ ] 9.3: Add `ReportFormat` type (pdf | excel)
  - [ ] 9.4: Add `ReportPeriod` type (week | month | semester | custom)
  - [ ] 9.5: Add `ReportTemplateType` type (weekly_class_summary | student_progress_report | monthly_assignment_overview | parent_teacher_conference)
  - [ ] 9.6: Add `ReportJobStatus` type (pending | processing | completed | failed)
  - [ ] 9.7: Add `ReportGenerateRequest` interface
  - [ ] 9.8: Add `ReportJobResponse` interface
  - [ ] 9.9: Add `ReportStatusResponse` interface
  - [ ] 9.10: Add `SavedReportTemplate` interface
  - [ ] 9.11: Add `ReportHistoryItem` interface

- [ ] **Task 10: Frontend API Service** (AC: 8, 9, 11, 12)
  - [ ] 10.1: Create `services/reportsApi.ts`
  - [ ] 10.2: Add `generateReport(config)` function
  - [ ] 10.3: Add `getReportStatus(jobId)` function
  - [ ] 10.4: Add `downloadReport(jobId)` function - handles file download
  - [ ] 10.5: Add `getReportHistory()` function
  - [ ] 10.6: Add `saveReportTemplate(config)` function
  - [ ] 10.7: Add `getReportTemplates()` function
  - [ ] 10.8: Add `deleteReportTemplate(id)` function

- [ ] **Task 11: Frontend Reports Hook** (AC: 8, 9, 12)
  - [ ] 11.1: Create `hooks/useReports.ts` with TanStack Query
  - [ ] 11.2: Implement `useGenerateReport()` mutation
  - [ ] 11.3: Implement `useReportStatus(jobId)` query with polling
  - [ ] 11.4: Implement `useReportHistory()` query
  - [ ] 11.5: Implement `useReportTemplates()` query + mutations
  - [ ] 11.6: Create `hooks/useReports.test.tsx` with hook tests

- [ ] **Task 12: Frontend Report Builder Component** (AC: 1, 2, 3)
  - [ ] 12.1: Create `components/reports/ReportBuilder.tsx`
  - [ ] 12.2: Add report type selector (Student/Class/Assignment)
  - [ ] 12.3: Add predefined template cards with descriptions
  - [ ] 12.4: Add time period selector (Week/Month/Semester/Custom)
  - [ ] 12.5: Add custom date range picker for custom period
  - [ ] 12.6: Add target selector (class dropdown or student search)
  - [ ] 12.7: Add format selector (PDF/Excel) with icons
  - [ ] 12.8: Add "Generate Report" button with validation
  - [ ] 12.9: Use React Hook Form + Zod for form validation

- [ ] **Task 13: Frontend Report Templates Cards** (AC: 3)
  - [ ] 13.1: Create `components/reports/ReportTemplateCard.tsx`
  - [ ] 13.2: Display template name, description, icon
  - [ ] 13.3: Show quick-generate button for template
  - [ ] 13.4: Create cards for all 4 predefined templates:
    - Weekly Class Summary
    - Student Progress Report
    - Monthly Assignment Overview
    - Parent-Teacher Conference Report

- [ ] **Task 14: Frontend Report Progress Component** (AC: 9)
  - [ ] 14.1: Create `components/reports/ReportProgress.tsx`
  - [ ] 14.2: Show progress bar during generation
  - [ ] 14.3: Display estimated time remaining
  - [ ] 14.4: Handle error states with retry option
  - [ ] 14.5: Show download button when complete

- [ ] **Task 15: Frontend Report History Component** (AC: 12)
  - [ ] 15.1: Create `components/reports/ReportHistory.tsx`
  - [ ] 15.2: Display table of previous reports (last 7 days)
  - [ ] 15.3: Show report type, date, target, format, expiration
  - [ ] 15.4: Add download button for each report
  - [ ] 15.5: Show "Expired" badge for unavailable reports
  - [ ] 15.6: Handle empty state

- [ ] **Task 16: Frontend Saved Templates Component** (AC: 11)
  - [ ] 16.1: Create `components/reports/SavedTemplates.tsx`
  - [ ] 16.2: List saved custom templates
  - [ ] 16.3: Add "Use This Template" button
  - [ ] 16.4: Add delete template option
  - [ ] 16.5: Create save template dialog (name + config)

- [ ] **Task 17: Frontend Reports Page** (AC: 1)
  - [ ] 17.1: Create `routes/_layout/teacher/reports.tsx` page
  - [ ] 17.2: Add tabs: "Generate Report" | "Report History" | "Saved Templates"
  - [ ] 17.3: Compose ReportBuilder, ReportProgress, ReportHistory, SavedTemplates
  - [ ] 17.4: Add responsive layout for mobile
  - [ ] 17.5: Add page loading skeleton

- [ ] **Task 18: Navigation Integration** (AC: 1)
  - [ ] 18.1: Add "Reports" link to teacher sidebar in `SidebarItems.tsx`
  - [ ] 18.2: Add BarChart3 icon for Reports nav item
  - [ ] 18.3: Update route tree with reports route

- [ ] **Task 19: Frontend Component Tests** (AC: 13, 14)
  - [ ] 19.1: Create `frontend/src/components/reports/__tests__/` directory
  - [ ] 19.2: Test ReportBuilder form validation
  - [ ] 19.3: Test ReportTemplateCard rendering
  - [ ] 19.4: Test ReportProgress states (pending, processing, complete, error)
  - [ ] 19.5: Test ReportHistory table rendering
  - [ ] 19.6: Test SavedTemplates list and actions
  - [ ] 19.7: Test file download functionality
  - [ ] 19.8: Test responsive behavior

---

## Dev Notes

### Previous Story Insights (Story 5.5)
[Source: docs/stories/5.5.student-progress-tracking-personal-analytics.md#Dev Agent Record]

- Analytics service patterns established in `analytics_service.py` - reuse for report data aggregation
- TanStack Query with 5-minute stale time works well for analytics caching
- Recharts used for visualizations - can export as images for PDF embedding
- Backend authorization via ownership verification - apply to report access
- Test patterns: 14 backend integration tests + 50 frontend component tests
- Follow same schema patterns from `analytics.py` for report schemas

### Data Models
[Source: docs/architecture/2-database-schema-design.md#2.2.4]

**New tables needed:**

```sql
-- Report jobs table (for async processing and history)
CREATE TYPE report_job_status AS ENUM ('pending', 'processing', 'completed', 'failed');
CREATE TYPE report_type AS ENUM ('student', 'class', 'assignment');
CREATE TYPE report_format AS ENUM ('pdf', 'excel');

CREATE TABLE report_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    teacher_id UUID NOT NULL REFERENCES teachers(id) ON DELETE CASCADE,
    status report_job_status DEFAULT 'pending',
    report_type report_type NOT NULL,
    template_type VARCHAR(100),
    config_json JSONB NOT NULL,
    file_path TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE,
    error_message TEXT,

    CONSTRAINT expires_after_creation CHECK (expires_at IS NULL OR expires_at > created_at)
);

CREATE INDEX idx_report_jobs_teacher_id ON report_jobs(teacher_id);
CREATE INDEX idx_report_jobs_status ON report_jobs(status);
CREATE INDEX idx_report_jobs_expires_at ON report_jobs(expires_at);

-- Saved report configurations
CREATE TABLE saved_report_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    teacher_id UUID NOT NULL REFERENCES teachers(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    config_json JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_saved_report_configs_teacher_id ON saved_report_configs(teacher_id);
```

**Existing tables used for report data:**

- `assignment_students` - score, completed_at, time_spent_minutes, answers_json
- `assignments` - name, due_date, activity_id, book_id
- `activities` - activity_type, title
- `students` - user_id (for name), grade_level
- `classes` - name, grade_level, subject
- `class_students` - student-class relationships

### API Specifications
[Source: docs/architecture/3-api-architecture.md#3.4.6]

**Endpoints to implement:**

```
POST   /api/v1/reports/generate              # Initiate report generation
GET    /api/v1/reports/{job_id}/status       # Check job status
GET    /api/v1/reports/{job_id}/download     # Download generated report
GET    /api/v1/reports/history               # List previous reports
POST   /api/v1/reports/templates             # Save report configuration
GET    /api/v1/reports/templates             # List saved templates
DELETE /api/v1/reports/templates/{id}        # Delete saved template
```

**Request format (POST /reports/generate):**
```json
{
  "report_type": "student",
  "template_type": "parent_teacher_conference",
  "period": "semester",
  "start_date": "2025-08-01",
  "end_date": "2025-12-31",
  "target_id": "student-uuid",
  "format": "pdf"
}
```

**Response format (immediate):**
```json
{
  "job_id": "uuid",
  "status": "pending",
  "created_at": "2025-11-28T10:00:00Z",
  "estimated_completion": "2025-11-28T10:00:30Z"
}
```

**Status response:**
```json
{
  "job_id": "uuid",
  "status": "completed",
  "progress_percentage": 100,
  "download_url": "/api/v1/reports/uuid/download",
  "error_message": null
}
```

### Report Data Structure
[Source: docs/architecture/7-analytics-engine.md]

**Data to aggregate for each report type:**

**Student Report:**
- Student info (name, grade, class)
- Overall stats: avg score, total completed, completion rate
- Score trend over time period
- Activity type breakdown
- Assignment list with scores
- Comparison to previous period
- Narrative summary

**Class Report:**
- Class info (name, teacher, student count)
- Class average score, completion rate
- Score distribution (histogram data)
- Top/struggling students
- Assignment performance list
- Activity type breakdown
- Trend vs previous period
- Narrative summary

**Assignment Report (monthly overview):**
- All assignments in period
- Per-assignment: avg score, completion rate, time spent
- Overall period stats
- Most/least successful assignments
- Activity type comparison

### PDF Generation Strategy
[No specific guidance found in architecture docs]

**Recommended approach:**
- Use `reportlab` library (pure Python, no external dependencies)
- Generate charts as images using matplotlib in memory
- Structure: Cover → Summary → Charts → Tables → Narrative
- Page size: Letter (8.5x11)
- Include footer with page numbers and generation date

**Cover Page Elements:**
- Report title (e.g., "Student Progress Report")
- Teacher name
- School name (from teacher's school)
- Date range covered
- Generation date

### Excel Generation Strategy
[No specific guidance found in architecture docs]

**Recommended approach:**
- Use `openpyxl` library
- Sheet 1: Summary with key metrics
- Sheet 2: Detailed data table
- Sheet 3: Charts (Excel native charts if possible)
- Apply consistent styling (header colors, borders)

### Trend Analysis Calculation
[Source: docs/architecture/7-analytics-engine.md#7.1]

**Trend calculation logic:**
```python
def calculate_trend(current_value: float, previous_value: float) -> dict:
    if previous_value == 0:
        return {"change": None, "direction": "new"}

    change = current_value - previous_value
    percentage = (change / previous_value) * 100

    return {
        "current": current_value,
        "previous": previous_value,
        "change": round(percentage, 1),
        "direction": "up" if change > 0 else "down" if change < 0 else "stable"
    }
```

**Period comparison:**
- Week: Compare to previous week
- Month: Compare to previous month
- Semester: Compare to previous semester (or same semester last year if available)
- Custom: Compare to equal-length period immediately before

### Narrative Summary Generation
[No specific guidance found in architecture docs]

**Rule-based approach (no AI/ML):**

```python
def generate_narrative(data: dict) -> str:
    parts = []

    # Performance direction
    if data["trend"]["direction"] == "up":
        parts.append(f"Performance improved by {data['trend']['change']}% compared to the previous period.")
    elif data["trend"]["direction"] == "down":
        parts.append(f"Performance decreased by {abs(data['trend']['change'])}% compared to the previous period.")
    else:
        parts.append("Performance remained stable compared to the previous period.")

    # Activity type insights
    if data["best_activity"]:
        parts.append(f"Strongest performance was in {data['best_activity']['label']} activities with an average of {data['best_activity']['avg_score']}%.")

    if data["worst_activity"]:
        parts.append(f"Area for improvement: {data['worst_activity']['label']} activities averaged {data['worst_activity']['avg_score']}%.")

    # Completion rate
    if data["completion_rate"] >= 90:
        parts.append("Excellent assignment completion rate.")
    elif data["completion_rate"] < 70:
        parts.append("Consider encouraging more consistent assignment completion.")

    return " ".join(parts)
```

### File Storage Strategy
[No specific guidance found in architecture docs]

**MVP Approach (local filesystem):**
- Store generated reports in `backend/generated_reports/` directory
- File naming: `{job_id}.{format}` (e.g., `uuid.pdf`)
- Set `expires_at` to 7 days from creation
- Cleanup job runs on application startup or scheduled

**Future: Cloud Storage**
- Upload to S3/MinIO
- Return signed URL for download
- Automatic expiration via bucket lifecycle policy

### File Locations
[Source: docs/architecture/source-tree.md]

**Backend:**
- Schemas: `backend/app/schemas/reports.py` (new file)
- Models: `backend/app/models.py` (add ReportJob, SavedReportConfig)
- Service: `backend/app/services/report_service.py` (new file)
- PDF Generator: `backend/app/services/pdf_generator.py` (new file)
- Excel Generator: `backend/app/services/excel_generator.py` (new file)
- Routes: `backend/app/api/routes/reports.py` (new file)
- Tests: `backend/app/tests/test_api/test_reports.py` (new file)
- Migration: `backend/app/alembic/versions/xxxx_add_report_tables.py`

**Frontend:**
- Types: `frontend/src/types/reports.ts` (new file)
- API: `frontend/src/services/reportsApi.ts` (new file)
- Hook: `frontend/src/hooks/useReports.ts` (new file)
- Hook Tests: `frontend/src/hooks/useReports.test.tsx` (new file)
- Components:
  - `frontend/src/components/reports/ReportBuilder.tsx`
  - `frontend/src/components/reports/ReportTemplateCard.tsx`
  - `frontend/src/components/reports/ReportProgress.tsx`
  - `frontend/src/components/reports/ReportHistory.tsx`
  - `frontend/src/components/reports/SavedTemplates.tsx`
  - `frontend/src/components/reports/index.ts`
- Page: `frontend/src/routes/_layout/teacher/reports.tsx` (new file)
- Update: `frontend/src/components/Common/SidebarItems.tsx` (add Reports nav link)

### Technical Constraints
[Source: docs/architecture/tech-stack.md]

- Backend: Python 3.11+, FastAPI, SQLModel, PostgreSQL with JSONB
- Frontend: React 18, TypeScript 5.x, TanStack Query 5.x, Shadcn UI, Tailwind CSS
- Testing: pytest (backend), Vitest + RTL (frontend)
- New dependencies needed:
  - `reportlab` (PDF generation)
  - `openpyxl` (Excel generation)
  - `matplotlib` (chart images for PDF)

### Predefined Template Details (AC: 3)

| Template | Report Type | Default Period | Key Sections |
|----------|-------------|----------------|--------------|
| Weekly Class Summary | class | week | Class avg, distribution, assignments, activity breakdown |
| Student Progress Report | student | semester | Student stats, score trend, activity breakdown, assignments |
| Monthly Assignment Overview | assignment | month | All assignments, avg scores, completion rates |
| Parent-Teacher Conference | student | semester | Comprehensive: stats, trends, charts, narrative, recommendations |

### Background Job Strategy (AC: 9)

**MVP Approach (no external queue):**
1. POST /reports/generate creates `ReportJob` with status='pending'
2. FastAPI background task processes the job
3. Frontend polls GET /reports/{job_id}/status every 2 seconds
4. When status='completed', download_url is available

```python
from fastapi import BackgroundTasks

@router.post("/generate", response_model=ReportJobResponse)
async def generate_report(
    request: ReportGenerateRequest,
    background_tasks: BackgroundTasks,
    current_user: User = Depends(require_role(UserRole.teacher)),
    db: AsyncSession = Depends(get_db)
):
    job = await create_report_job(db, current_user.teacher.id, request)
    background_tasks.add_task(process_report_job, job.id)
    return ReportJobResponse(job_id=job.id, status=job.status)
```

### UI Component Patterns
[Source: docs/architecture/5-frontend-architecture.md]

**Form with React Hook Form + Zod:**
```typescript
const reportSchema = z.object({
  report_type: z.enum(['student', 'class', 'assignment']),
  period: z.enum(['week', 'month', 'semester', 'custom']),
  start_date: z.string().optional(),
  end_date: z.string().optional(),
  target_id: z.string().uuid(),
  format: z.enum(['pdf', 'excel']),
});

type ReportFormData = z.infer<typeof reportSchema>;
```

**Status Polling with TanStack Query:**
```typescript
const useReportStatus = (jobId: string | null) => {
  return useQuery({
    queryKey: ['report-status', jobId],
    queryFn: () => reportsApi.getReportStatus(jobId!),
    enabled: !!jobId,
    refetchInterval: (data) =>
      data?.status === 'completed' || data?.status === 'failed' ? false : 2000,
  });
};
```

---

## Testing

### Test File Locations
- Backend: `backend/app/tests/test_api/test_reports.py`
- Frontend Hook: `frontend/src/hooks/useReports.test.tsx`
- Frontend Components: `frontend/src/components/reports/__tests__/`

### Testing Standards
[Source: docs/architecture/10-testing-strategy.md, docs/architecture/coding-standards.md#Testing Patterns]

**Backend:**
- Use pytest with async fixtures
- Create fixtures for teacher token, sample classes/students/assignments
- Test report generation for each template type
- Test PDF and Excel output validation
- Test trend calculation accuracy
- Test authorization (own reports only)
- Test job status transitions
- Test report expiration and cleanup

**Frontend:**
- Use Vitest + React Testing Library
- Test hook polling behavior
- Test form validation
- Test file download trigger
- Test status progress display
- Test error handling

### Test Coverage Expectations
- Backend: 12-15 integration tests covering all endpoints and report types
- Frontend: 20-25 tests (6-8 hook tests, 15-20 component tests)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-28 | 1.0 | Initial story draft | Bob (SM Agent) |
| 2025-11-29 | 1.1 | QA fixes: Added ReportBuilder.test.tsx (14 tests) | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20251101

### Debug Log References

```
# QA Fix Tests - 2025-11-29
npm run test -- --run src/components/reports/__tests__/ src/hooks/useReports.test.tsx

Test Files: 6 passed (6)
Tests: 70 passed (70)
Duration: 2.01s
```

### Completion Notes

**QA Fix Applied (2025-11-29):**
- Added missing `ReportBuilder.test.tsx` with 14 tests covering:
  - Form rendering with all required fields
  - Report type switching (Student/Class/Assignment)
  - Format switching (PDF/Excel)
  - Target selector visibility based on report type
  - Generate button disabled state during generation
  - Default values verification
- Verified `SavedTemplates.tsx` exists and is properly exported from `index.ts`
- All 70 frontend report tests passing

### File List

**Added:**
- `frontend/src/components/reports/__tests__/ReportBuilder.test.tsx` - 14 component tests

**Verified (no changes):**
- `frontend/src/components/reports/SavedTemplates.tsx` - exists and exported
- `frontend/src/components/reports/index.ts` - all exports correct

---

## QA Results

**Review Date:** 2025-11-29
**QA Agent:** Quinn
**Decision:** PASS

### Summary

Story 5.6 implements a comprehensive time-based reporting system with PDF/Excel generation, trend analysis, saved templates, and asynchronous job processing. All 14 acceptance criteria are verified as complete.

### Acceptance Criteria Status

| AC | Description | Status |
|----|-------------|--------|
| 1 | Reports navigation section | PASS |
| 2 | Report Builder form | PASS |
| 3 | Predefined Report Templates | PASS |
| 4 | Backend job processing | PASS |
| 5 | Report content (cover, stats, charts) | PASS |
| 6 | Trend Analysis | PASS |
| 7 | Narrative summaries | PASS |
| 8 | POST /api/reports/generate | PASS |
| 9 | Async job with status polling | PASS |
| 10 | Report storage with download | PASS |
| 11 | Save template configurations | PASS |
| 12 | Report history (7-day) | PASS |
| 13 | Unit tests | PASS |
| 14 | Integration tests | PASS |

### Test Coverage

- **Backend:** 25+ integration tests covering all endpoints, trend calculations, narrative generation
- **Frontend Hooks:** 20+ tests for useReports hooks (generate, status, history, templates)
- **Frontend Components:** 12+ component tests for ReportProgress, ReportHistory, ReportTemplateCard

### Issues Identified

1. **LOW:** Missing ReportBuilder.test.tsx component tests (non-blocking)
2. **LOW:** Assignment report uses teacher_id as target_id (documentation recommendation)

### Code Quality Scores

- Architecture: 9/10
- Maintainability: 8/10
- Test Coverage: 8/10
- Security: 9/10

### Files Reviewed

**Backend:**
- `backend/app/api/routes/reports.py` - 7 API endpoints
- `backend/app/services/report_service.py` - Core report logic (~1175 lines)
- `backend/app/services/pdf_generator.py` - PDF generation
- `backend/app/services/excel_generator.py` - Excel generation
- `backend/app/schemas/reports.py` - 14 Pydantic schemas
- `backend/app/tests/test_api/test_reports.py` - 25+ tests

**Frontend:**
- `frontend/src/routes/_layout/teacher/reports.tsx` - Main page
- `frontend/src/components/reports/ReportBuilder.tsx` - Form component
- `frontend/src/components/reports/ReportProgress.tsx` - Progress display
- `frontend/src/components/reports/ReportHistory.tsx` - History table
- `frontend/src/components/reports/ReportTemplateCard.tsx` - Template cards
- `frontend/src/hooks/useReports.ts` - TanStack Query hooks
- `frontend/src/services/reportsApi.ts` - API service
- `frontend/src/types/reports.ts` - TypeScript types

### Recommendation

**APPROVED for merge.** The implementation is complete, well-tested, and follows project standards. Minor gaps can be addressed in follow-up work.

See full gate file: `docs/qa/gates/5.6-time-based-reporting-trend-analysis.yml`

---

### Follow-Up Review: 2025-11-29

**Reviewed By:** Quinn (Test Architect)

**Purpose:** Verify QA fixes applied by Dev Agent

### Verification Results

| Issue | Status | Verification |
|-------|--------|--------------|
| Missing ReportBuilder.test.tsx | ✅ RESOLVED | 14 tests added, all passing |
| SavedTemplates.tsx not found | ✅ RESOLVED | Component verified at correct path |

### Test Execution

```
Test Files: 6 passed (6)
Tests: 70 passed (70)
Duration: 1.81s

Breakdown:
- ReportBuilder.test.tsx: 14 tests
- ReportProgress.test.tsx: 10 tests
- ReportHistory.test.tsx: 8 tests
- ReportTemplateCard.test.tsx: 11 tests
- SavedTemplates.test.tsx: 10 tests
- useReports.test.tsx: 17 tests
```

### Updated Quality Scores

- Test Coverage: 9/10 (upgraded from 8/10)
- Quality Score: 95/100

### Gate Status

**Gate: PASS** (Confirmed)

All issues from initial review have been addressed. Story is ready to be marked as Done.

### Recommended Status

✅ **Ready for Done** - All acceptance criteria met, all issues resolved, comprehensive test coverage verified.
