# Story 11.3: Backend - First Login Password Change

**Status:** Done
**Epic:** Epic 11 - Secure Password Management & Email Notifications
**Story Points:** 3
**Priority:** High
**Dependencies:** Story 11.1 (Secure Password Infrastructure)

---

## User Story

As a **new user with a temporary password**,
I want **to be required to change my password on first login**,
So that **only I know my actual password and my account is secure**.

---

## Background & Context

### Current State

Users can log in with their temporary password and continue using the system indefinitely without changing it. This is a security risk as:
- Admin/creator knows the password
- Temporary passwords may be weaker
- Users might never change to a secure personal password

### Target State

- Login response includes `must_change_password` flag
- New endpoint for changing initial password
- Users with `must_change_password=true` are prompted to change password
- After changing, `must_change_password` is set to `false`

---

## Acceptance Criteria

### Functional Requirements

1. [x] Login response includes `must_change_password` field
2. [x] New endpoint: `POST /api/v1/users/me/change-initial-password`
3. [x] Endpoint accepts: `current_password`, `new_password`
4. [x] Validates current password matches
5. [x] Updates password and sets `must_change_password = false`
6. [x] Existing `update_password_me` endpoint also clears `must_change_password` flag

### Integration Requirements

7. [x] Token is valid for password change endpoint even with `must_change_password=true`
8. [x] Works with existing authentication flow
9. [x] Compatible with frontend password change flow

### Quality Requirements

10. [x] Unit tests for password change flow
11. [x] Test flag is cleared after password change
12. [x] Test validation of current password

---

## Technical Design

### Update Login Response

```python
# backend/app/models.py - Update Token class

class Token(SQLModel):
    access_token: str
    token_type: str = "bearer"
    must_change_password: bool = False  # NEW
```

### Update Login Endpoint

```python
# backend/app/api/routes/login.py

@router.post("/login/access-token")
def login_access_token(
    session: SessionDep, form_data: Annotated[OAuth2PasswordRequestForm, Depends()]
) -> Token:
    """
    OAuth2 compatible token login, get an access token for future requests.
    Returns must_change_password flag to indicate if password change is required.
    """
    user = crud.authenticate_with_username_or_email(
        session=session, identifier=form_data.username, password=form_data.password
    )
    if not user:
        raise HTTPException(status_code=400, detail="Invalid credentials")
    elif not user.is_active:
        raise HTTPException(status_code=400, detail="Inactive user")

    access_token_expires = timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
    return Token(
        access_token=security.create_access_token(
            user.id, expires_delta=access_token_expires, extra_claims={"role": user.role}
        ),
        must_change_password=user.must_change_password  # NEW
    )
```

### New Password Change Endpoint

```python
# backend/app/api/routes/users.py

class ChangeInitialPasswordRequest(SQLModel):
    """Request body for changing initial/temporary password"""
    current_password: str = Field(min_length=1)
    new_password: str = Field(min_length=8, max_length=40)


class ChangePasswordResponse(SQLModel):
    """Response for password change"""
    success: bool
    message: str


@router.post("/me/change-initial-password", response_model=ChangePasswordResponse)
def change_initial_password(
    *,
    session: SessionDep,
    current_user: CurrentUser,
    body: ChangeInitialPasswordRequest,
) -> ChangePasswordResponse:
    """
    Change password for first login (when must_change_password is true).
    Also works as a general password change.

    - Validates current password
    - Updates to new password
    - Clears must_change_password flag
    """
    # Verify current password
    if not verify_password(body.current_password, current_user.hashed_password):
        raise HTTPException(status_code=400, detail="Current password is incorrect")

    # Validate new password is different
    if body.current_password == body.new_password:
        raise HTTPException(status_code=400, detail="New password must be different from current password")

    # Update password
    current_user.hashed_password = get_password_hash(body.new_password)
    current_user.must_change_password = False
    session.add(current_user)
    session.commit()

    return ChangePasswordResponse(
        success=True,
        message="Password changed successfully"
    )
```

### Update Existing Password Change Endpoint

```python
# backend/app/api/routes/users.py - update_password_me

@router.patch("/me/password", response_model=Message)
def update_password_me(
    *, session: SessionDep, body: UpdatePassword, current_user: CurrentUser
) -> Message:
    """
    Update own password.
    """
    if not verify_password(body.current_password, current_user.hashed_password):
        raise HTTPException(status_code=400, detail="Incorrect password")
    if body.current_password == body.new_password:
        raise HTTPException(
            status_code=400, detail="New password cannot be the same as the current one"
        )
    hashed_password = get_password_hash(body.new_password)
    current_user.hashed_password = hashed_password
    current_user.must_change_password = False  # ADD THIS LINE
    session.add(current_user)
    session.commit()
    return Message(message="Password updated successfully")
```

### Update /me Endpoint

```python
# backend/app/api/routes/users.py - read_user_me

class UserMePublic(UserPublic):
    """Extended user info including must_change_password"""
    must_change_password: bool


@router.get("/me", response_model=UserMePublic)
def read_user_me(current_user: CurrentUser) -> Any:
    """
    Get current user info including must_change_password flag.
    """
    return current_user
```

---

## Tasks & Subtasks

### Task 1: Update Token/Login Response

**Estimated effort:** 30 minutes

1. [x] Add `must_change_password` to Token model
2. [x] Update login endpoint to include flag in response
3. [x] Update any test that checks Token schema

### Task 2: Create New Password Change Endpoint

**Estimated effort:** 1 hour

1. [x] Create `ChangeInitialPasswordRequest` schema
2. [x] Create `ChangePasswordResponse` schema
3. [x] Implement `/me/change-initial-password` endpoint
4. [x] Add validation for current password
5. [x] Clear `must_change_password` flag

### Task 3: Update Existing Password Endpoint

**Estimated effort:** 30 minutes

1. [x] Update `update_password_me` to clear `must_change_password` flag
2. [x] Update tests if needed

### Task 4: Update /me Endpoint

**Estimated effort:** 30 minutes

1. [x] Create `UserMePublic` schema with `must_change_password` (already in UserPublic)
2. [x] Update `/me` endpoint response model (already includes flag)
3. [x] Update frontend client generation

### Task 5: Write Tests

**Estimated effort:** 1.5 hours

1. [x] Test login returns `must_change_password` flag
2. [x] Test password change endpoint works
3. [x] Test flag is cleared after password change
4. [x] Test incorrect current password is rejected
5. [x] Test same password is rejected
6. [x] Test existing password change endpoint also clears flag

---

## Definition of Done

- [x] Login response includes `must_change_password` field
- [x] New password change endpoint implemented
- [x] Flag cleared after any password change
- [x] `/me` endpoint includes flag
- [x] All tests passing
- [x] API client regenerated

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### File List
- `backend/app/models.py` - Added `must_change_password` to Token, ChangeInitialPasswordRequest, ChangePasswordResponse schemas
- `backend/app/api/routes/login.py` - Updated login_access_token to return must_change_password flag
- `backend/app/api/routes/users.py` - Added change_initial_password endpoint, updated update_password_me to clear flag
- `backend/app/tests/test_api/test_first_login_password.py` - NEW: 12 comprehensive tests for password change functionality
- `frontend/src/client/` - Regenerated API client with new types and endpoints

### Change Log
- Token model now includes `must_change_password: bool = False`
- Login endpoint returns `must_change_password` flag from user record
- New POST `/api/v1/users/me/change-initial-password` endpoint added
- Existing PATCH `/api/v1/users/me/password` now clears `must_change_password` flag
- UserPublic already included `must_change_password` (from prior work)

### Completion Notes
- All 12 new tests pass
- Frontend API client regenerated successfully
- Frontend build passes
- Note: Some pre-existing test failures unrelated to this story exist in the test suite

---

## API Examples

### Login Response (Must Change Password)

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "must_change_password": true
}
```

### Login Response (Normal)

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "must_change_password": false
}
```

### Change Password Request

```json
{
  "current_password": "TempPass123!",
  "new_password": "MySecurePassword456!"
}
```

### Change Password Response

```json
{
  "success": true,
  "message": "Password changed successfully"
}
```

### Get Me Response

```json
{
  "id": "uuid...",
  "email": "user@example.com",
  "username": "teacher1",
  "full_name": "Test Teacher",
  "role": "teacher",
  "is_active": true,
  "must_change_password": true
}
```

---

## Risk Mitigation

- **Primary Risk:** Breaking login flow for existing users
- **Mitigation:** Existing users have `must_change_password=false` by default (from migration)
- **Rollback Plan:** Remove new field from response; no breaking changes to API contract

---

## Testing Commands

```bash
# Test login returns flag
curl -X POST "http://localhost:8001/api/v1/login/access-token" \
  -d "username=teacher1&password=temppass123"
# Check response includes must_change_password

# Test password change
curl -X POST "http://localhost:8001/api/v1/users/me/change-initial-password" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"current_password": "temppass123", "new_password": "NewSecure456!"}'

# Test /me includes flag
curl "http://localhost:8001/api/v1/users/me" \
  -H "Authorization: Bearer $TOKEN"
```

---

## Notes

- Frontend implementation of the password change flow is in Story 11.5
- This story does NOT block user from accessing other endpoints - that's a frontend concern
- Consider adding rate limiting on password change endpoint in future

---

## QA Results

### Review Date: 2025-12-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT**

The implementation is clean, well-structured, and follows FastAPI/SQLModel best practices. Security-sensitive code properly uses existing password hashing utilities. All 12 acceptance criteria are implemented and tested.

**Highlights:**
- Clean separation between the new `/me/change-initial-password` endpoint and existing `/me/password` endpoint
- Both endpoints correctly clear `must_change_password` flag
- Login endpoint properly returns the flag in Token response
- Comprehensive test suite with 12 tests covering positive and negative cases

### Refactoring Performed

None required - code quality is high.

### Compliance Check

- Coding Standards: ✓ Follows Python/FastAPI conventions, proper typing, docstrings
- Project Structure: ✓ Schemas in models.py, endpoints in routes/users.py, tests in test_api/
- Testing Strategy: ✓ 12 tests covering all ACs, uses pytest fixtures appropriately
- All ACs Met: ✓ 12/12 acceptance criteria implemented and tested

### Requirements Traceability

| AC# | Requirement | Test Coverage |
|-----|-------------|---------------|
| 1 | Login response includes `must_change_password` | `test_login_returns_must_change_password_true/false` |
| 2 | New endpoint POST /change-initial-password | `test_change_initial_password_success` |
| 3 | Accepts current_password, new_password | Schema validation + tests |
| 4 | Validates current password | `test_change_initial_password_wrong_current_password` |
| 5 | Updates password, sets flag false | `test_change_initial_password_success` |
| 6 | Existing endpoint clears flag | `test_existing_password_change_clears_flag` |
| 7 | Token valid with must_change_password=true | `test_token_valid_for_must_change_password_user` |
| 8 | Works with existing auth flow | All tests use standard auth flow |
| 9 | Compatible with frontend | API client regenerated |
| 10-12 | Unit tests for all scenarios | 12 passing tests |

### Improvements Checklist

- [x] All acceptance criteria implemented
- [x] Comprehensive test coverage
- [x] Proper error handling with appropriate status codes
- [x] Docstrings on all endpoints
- [x] Frontend API client regenerated
- [ ] Rate limiting on password change endpoints (documented as future work in story Notes section)

### Security Review

**Status: PASS**

- ✓ Uses existing secure password hashing (bcrypt via passlib)
- ✓ Verifies current password before allowing change
- ✓ Enforces minimum password length (8 chars) via Pydantic
- ✓ Prevents password reuse (same as current)
- ⚠️ No rate limiting (noted in story for future enhancement - acceptable for MVP)

No security vulnerabilities identified in the implementation.

### Performance Considerations

No performance concerns. Password hashing is the only computationally intensive operation and uses the existing optimized implementation.

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: **PASS** → docs/qa/gates/11.3-backend-first-login-password-change.yml

### Recommended Status

✓ **Ready for Done**

Excellent implementation with comprehensive test coverage. All acceptance criteria met. Minor rate limiting concern is already documented as future work in the story notes and is acceptable for MVP.
