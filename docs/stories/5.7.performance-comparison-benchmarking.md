# Story 5.7: Performance Comparison & Benchmarking

**Epic:** 5 - Analytics, Reporting & Teacher Insights
**Story ID:** 5.7
**Status:** Done
**Created:** 2025-11-29
**Developer:** (To be assigned)

---

## Story

**As a** teacher,
**I want** to compare my class performance against school or publisher averages (anonymized),
**so that** I can understand if my students are on track relative to peers.

---

## Acceptance Criteria

1. Class analytics page includes "Benchmarking" section (if enabled by school/publisher)
2. Displays comparison metrics: "Your class average: 82% | School average: 78% | Publisher average: 80%"
3. Comparison chart shows class performance vs. aggregated benchmarks over time (line graph)
4. Benchmarks are calculated anonymously across: all classes in the same school, all classes using the same publisher's content (opt-in for privacy)
5. Activity-type benchmarking: "Your class scores 15% higher in word matching compared to school average"
6. Backend calculates aggregated benchmarks with proper anonymization (minimum 5 classes required for benchmark display)
7. API endpoint `GET /api/classes/{class_id}/benchmarks` returns comparison data if available
8. Privacy controls: Teachers cannot see other teachers' specific class data, only aggregates
9. Benchmarking can be disabled at school/publisher level for privacy compliance
10. Encouraging messaging when class outperforms benchmarks: "Your class is excelling!"
11. Constructive messaging when below benchmarks: "Opportunities for growth in [area]"
12. Admin dashboard shows system-wide benchmarks for oversight
13. Integration tests verify benchmark calculations and anonymization

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create Benchmarking Schemas** (AC: 2, 4, 5, 7)
  - [ ] Create `BenchmarkData` Pydantic schema with fields: level (school/publisher), average_score, completion_rate, sample_size, period
  - [ ] Create `ActivityTypeBenchmark` schema with activity_type, class_average, benchmark_average, difference_percent
  - [ ] Create `ClassBenchmarkResponse` schema with class_metrics, school_benchmark, publisher_benchmark, activity_benchmarks, comparison_over_time
  - [ ] Create `BenchmarkSettings` schema for enable/disable controls
  - [ ] Create `AdminBenchmarkOverview` schema for system-wide stats
  - [ ] Add source references in docstrings

- [ ] **Task 2: Add Database Models for Benchmark Settings** (AC: 9)
  - [ ] Add `benchmarking_enabled` boolean field to `School` model (default: True)
  - [ ] Add `benchmarking_enabled` boolean field to `Publisher` model (default: True)
  - [ ] Create Alembic migration for new fields
  - [ ] Add indexes if needed for aggregation queries

- [ ] **Task 3: Implement Benchmark Calculation Service** (AC: 4, 5, 6, 8)
  - [ ] Create `benchmark_service.py` in `backend/app/services/`
  - [ ] Implement `calculate_school_benchmark(school_id, period)` function
    - [ ] Query all classes in school with completed assignments
    - [ ] Check minimum 5 classes threshold
    - [ ] Calculate aggregated average score, completion rate
    - [ ] Return None if threshold not met
  - [ ] Implement `calculate_publisher_benchmark(publisher_id, period)` function
    - [ ] Query all classes using publisher's books
    - [ ] Check minimum 5 classes threshold
    - [ ] Aggregate across all schools using publisher content
  - [ ] Implement `calculate_activity_type_benchmarks(class_id, benchmark_level)` function
    - [ ] Group performance by activity type
    - [ ] Compare class averages vs. benchmark averages
    - [ ] Calculate difference percentages
  - [ ] Implement `get_benchmark_trend(class_id, period)` function
    - [ ] Calculate weekly/monthly benchmark comparisons over time
    - [ ] Return time series data for chart
  - [ ] Ensure all queries use proper anonymization (no individual class identification)

- [ ] **Task 4: Implement Class Benchmark API Endpoint** (AC: 7, 8)
  - [ ] Add route in `backend/app/api/routes/classes.py`
  - [ ] Create `GET /api/v1/classes/{class_id}/benchmarks` endpoint
  - [ ] Add teacher role authorization
  - [ ] Verify teacher owns the class
  - [ ] Check if benchmarking is enabled for school/publisher
  - [ ] Return 403 with message if disabled
  - [ ] Call benchmark service to calculate metrics
  - [ ] Return `ClassBenchmarkResponse` with all comparison data

- [ ] **Task 5: Implement Admin Benchmark Overview Endpoint** (AC: 12)
  - [ ] Add route in `backend/app/api/routes/admin.py`
  - [ ] Create `GET /api/v1/admin/benchmarks/overview` endpoint
  - [ ] Require admin role authorization
  - [ ] Calculate system-wide statistics:
    - [ ] Total schools with benchmarking enabled
    - [ ] Average performance by activity type across system
    - [ ] Schools with above/below average performance
  - [ ] Return `AdminBenchmarkOverview` response

- [ ] **Task 6: Add Privacy Settings Endpoints** (AC: 9)
  - [ ] Add `PATCH /api/v1/schools/{school_id}/settings` endpoint for benchmarking toggle
  - [ ] Add `PATCH /api/v1/publishers/{publisher_id}/settings` endpoint for benchmarking toggle
  - [ ] Require appropriate role authorization (admin for school, publisher for publisher)
  - [ ] Update school/publisher benchmark_enabled field
  - [ ] Return updated settings

- [ ] **Task 7: Backend Integration Tests** (AC: 13)
  - [ ] Create `test_benchmarks.py` in `backend/app/tests/test_api/`
  - [ ] Test benchmark calculation with < 5 classes (should return None)
  - [ ] Test benchmark calculation with >= 5 classes
  - [ ] Test activity type benchmark calculations
  - [ ] Test benchmark trend over time
  - [ ] Test authorization (teacher can only see own class)
  - [ ] Test privacy controls (disabled returns 403)
  - [ ] Test anonymization (no individual class data exposed)
  - [ ] Test admin overview endpoint
  - [ ] Test edge cases: no data, single class, mixed enabled/disabled

### Frontend Tasks

- [ ] **Task 8: Create TypeScript Types for Benchmarking** (AC: 2, 3, 5)
  - [ ] Create `frontend/src/types/benchmarks.ts`
  - [ ] Define `BenchmarkData` interface
  - [ ] Define `ActivityTypeBenchmark` interface
  - [ ] Define `ClassBenchmarkResponse` interface
  - [ ] Define `BenchmarkTrendPoint` interface for chart data
  - [ ] Define `BenchmarkSettings` interface

- [ ] **Task 9: Create Benchmark API Service** (AC: 7)
  - [ ] Create `frontend/src/services/benchmarksApi.ts`
  - [ ] Implement `getClassBenchmarks(classId)` function
  - [ ] Implement `getAdminBenchmarkOverview()` function
  - [ ] Implement `updateSchoolBenchmarkSettings(schoolId, enabled)` function
  - [ ] Implement `updatePublisherBenchmarkSettings(publisherId, enabled)` function
  - [ ] Add proper error handling for 403 (disabled) responses

- [ ] **Task 10: Create useBenchmarks Hook** (AC: 7)
  - [ ] Create `frontend/src/hooks/useBenchmarks.ts`
  - [ ] Implement `useClassBenchmarks(classId)` hook with TanStack Query
  - [ ] Implement `useAdminBenchmarks()` hook
  - [ ] Implement `useBenchmarkSettings()` mutation hooks
  - [ ] Handle disabled state gracefully (show appropriate message)
  - [ ] Add 5-minute stale time for caching

- [ ] **Task 11: Create BenchmarkCard Component** (AC: 1, 2)
  - [ ] Create `frontend/src/components/benchmarks/BenchmarkCard.tsx`
  - [ ] Display class average, school average, publisher average side by side
  - [ ] Show visual comparison (progress bars or gauge charts)
  - [ ] Handle missing benchmark data (< 5 classes threshold)
  - [ ] Display sample sizes for transparency

- [ ] **Task 12: Create BenchmarkComparisonChart Component** (AC: 3)
  - [ ] Create `frontend/src/components/benchmarks/BenchmarkComparisonChart.tsx`
  - [ ] Use Recharts LineChart for time series comparison
  - [ ] Display class line, school benchmark line, publisher benchmark line
  - [ ] Add legend with color coding
  - [ ] Support time period selector (weekly, monthly)
  - [ ] Handle missing data points gracefully

- [ ] **Task 13: Create ActivityBenchmarkTable Component** (AC: 5)
  - [ ] Create `frontend/src/components/benchmarks/ActivityBenchmarkTable.tsx`
  - [ ] Display table with columns: Activity Type, Your Class, School Avg, Difference
  - [ ] Color-code differences (green positive, red negative)
  - [ ] Show friendly activity type labels
  - [ ] Sort by difference (largest gaps first)

- [ ] **Task 14: Create BenchmarkMessage Component** (AC: 10, 11)
  - [ ] Create `frontend/src/components/benchmarks/BenchmarkMessage.tsx`
  - [ ] Display encouraging message when outperforming: "Your class is excelling!"
  - [ ] Display constructive message when below: "Opportunities for growth in [area]"
  - [ ] Use appropriate icons (trophy, star, growth arrow)
  - [ ] Style appropriately (positive = green, needs work = amber)

- [ ] **Task 15: Create BenchmarkDisabledMessage Component** (AC: 9)
  - [ ] Create `frontend/src/components/benchmarks/BenchmarkDisabledMessage.tsx`
  - [ ] Display message when benchmarking is disabled by school/publisher
  - [ ] Suggest contacting admin if interested in enabling
  - [ ] Use informational styling (not error)

- [ ] **Task 16: Integrate Benchmarking Section into Class Analytics** (AC: 1)
  - [ ] Update `frontend/src/routes/_layout/teacher/classrooms_.$classId.tsx`
  - [ ] Add "Benchmarking" tab or section to class analytics page
  - [ ] Conditionally render based on benchmark availability
  - [ ] Show disabled message if benchmarking not enabled
  - [ ] Integrate BenchmarkCard, BenchmarkComparisonChart, ActivityBenchmarkTable, BenchmarkMessage

- [ ] **Task 17: Add Admin Benchmark Dashboard Section** (AC: 12)
  - [ ] Update admin dashboard or create new admin benchmarks page
  - [ ] Display system-wide benchmark overview
  - [ ] Show schools with benchmarking enabled/disabled
  - [ ] Display aggregate statistics

- [ ] **Task 18: Create Frontend Component Tests** (AC: 13)
  - [ ] Create `frontend/src/components/benchmarks/__tests__/` directory
  - [ ] Test BenchmarkCard with various data states
  - [ ] Test BenchmarkComparisonChart with mock chart data
  - [ ] Test ActivityBenchmarkTable sorting and coloring
  - [ ] Test BenchmarkMessage for different performance levels
  - [ ] Test BenchmarkDisabledMessage rendering
  - [ ] Test empty/loading/error states
  - [ ] Test hook with QueryClientProvider

---

## Dev Notes

### Previous Story Insights (Story 5.6)
[Source: Story 5.6 Dev Agent Record]
- Report generation uses async background tasks for heavy calculations
- TanStack Query with 5-minute stale time works well for analytics caching
- Recharts library used consistently for all charts
- PDF/Excel export pattern established for reports

### API Endpoint Pattern
[Source: architecture/3-api-architecture.md]
```
GET /api/v1/classes/{class_id}/benchmarks
Authorization: Bearer {teacher_token}
Response: ClassBenchmarkResponse

GET /api/v1/admin/benchmarks/overview
Authorization: Bearer {admin_token}
Response: AdminBenchmarkOverview
```

### Database Query Pattern
[Source: architecture/7-analytics-engine.md]
```python
# Benchmark calculation query pattern
async def calculate_school_benchmark(school_id: UUID, period: str):
    # Count distinct classes in school
    class_count_query = select(func.count(distinct(Class.id))).where(
        Class.school_id == school_id,
        Class.is_active == True
    )
    class_count = await db.execute(class_count_query)

    if class_count.scalar() < 5:
        return None  # Privacy threshold not met

    # Aggregate scores across all classes
    benchmark_query = select(
        func.avg(AssignmentStudent.score).label('avg_score'),
        func.avg(case(
            (AssignmentStudent.status == 'completed', 1),
            else_=0
        )).label('completion_rate')
    ).join(Assignment).join(Class).where(
        Class.school_id == school_id,
        AssignmentStudent.completed_at >= get_period_start(period)
    )

    return await db.execute(benchmark_query)
```

### Anonymization Requirements
[Source: Epic 5 AC 6, 8]
- Minimum 5 classes required before benchmark data is shown
- Never expose individual class performance to other teachers
- Only aggregated, anonymous statistics visible
- School/Publisher can disable for privacy compliance

### Frontend File Locations
[Source: architecture/source-tree.md]
```
frontend/src/
├── types/
│   └── benchmarks.ts           # TypeScript interfaces
├── services/
│   └── benchmarksApi.ts        # API service
├── hooks/
│   └── useBenchmarks.ts        # TanStack Query hooks
├── components/
│   └── benchmarks/             # Benchmark components
│       ├── BenchmarkCard.tsx
│       ├── BenchmarkComparisonChart.tsx
│       ├── ActivityBenchmarkTable.tsx
│       ├── BenchmarkMessage.tsx
│       ├── BenchmarkDisabledMessage.tsx
│       ├── index.ts
│       └── __tests__/
├── routes/
│   └── _layout/
│       └── teacher/
│           └── classrooms_.$classId.tsx  # Add benchmarking section
```

### Backend File Locations
[Source: architecture/source-tree.md]
```
backend/app/
├── services/
│   └── benchmark_service.py    # Benchmark calculations
├── schemas/
│   └── benchmarks.py           # Pydantic schemas (or add to analytics.py)
├── api/routes/
│   ├── classes.py              # Add benchmarks endpoint
│   └── admin.py                # Add admin benchmarks endpoint
├── models.py                   # Add benchmark_enabled fields
└── tests/test_api/
    └── test_benchmarks.py      # Integration tests
```

### Chart Configuration
[Source: architecture/tech-stack.md - Recharts 2.x]
```tsx
// Benchmark comparison line chart pattern
<LineChart data={trendData}>
  <XAxis dataKey="period" />
  <YAxis domain={[0, 100]} />
  <Tooltip />
  <Legend />
  <Line dataKey="classAverage" stroke="#2563eb" name="Your Class" />
  <Line dataKey="schoolBenchmark" stroke="#16a34a" name="School Average" strokeDasharray="5 5" />
  <Line dataKey="publisherBenchmark" stroke="#9333ea" name="Publisher Average" strokeDasharray="3 3" />
</LineChart>
```

### Encouraging Messaging Patterns
[Source: Story 5.5 - Student Progress]
```tsx
// Performance messaging patterns (adapt for benchmarking)
const getMessage = (difference: number, area: string) => {
  if (difference > 10) return `Your class is excelling in ${area}!`
  if (difference > 0) return `Great job! Your class is above average in ${area}.`
  if (difference > -10) return `Opportunities for growth in ${area} - you're close to the benchmark!`
  return `Let's focus on ${area} - there's room for improvement.`
}
```

---

## Testing

### Backend Testing Requirements
[Source: architecture/10-testing-strategy.md]
- Use pytest with async fixtures
- Create fixtures for:
  - Schools with varying numbers of classes (< 5, = 5, > 5)
  - Publisher with multiple schools
  - Classes with different performance levels
- Test benchmark calculations with edge cases
- Test authorization (teacher, admin, wrong teacher)
- Test privacy controls (enabled/disabled)
- Test anonymization (verify no individual class data exposed)

### Frontend Testing Requirements
[Source: architecture/10-testing-strategy.md]
- Use Vitest + React Testing Library
- Test hooks with QueryClientProvider wrapper
- Test components with mock benchmark data
- Test chart rendering with Recharts
- Test conditional rendering (enabled vs disabled)
- Test message variations based on performance
- Test empty/loading/error states

### Test Coverage Expectations
- Backend: 12-15 integration tests
- Frontend: 25-35 tests (8-10 hook tests, 20-25 component tests)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-29 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes

(To be filled by dev agent)

### File List

(To be filled by dev agent)

---

## QA Results

### Review Summary

**Reviewed by:** Quinn (Test Architect)
**Review Date:** 2025-11-29
**Gate Decision:** ✅ PASS

### Acceptance Criteria Traceability

| AC# | Description | Implementation | Test Coverage |
|-----|-------------|----------------|---------------|
| 1 | Benchmarking section in class analytics | `classrooms_.$classId.tsx` - Benchmarks tab | ✅ Component tests |
| 2 | Comparison metrics display | `BenchmarkCard.tsx` - Shows class/school/publisher averages | ✅ `BenchmarkCard.test.tsx` |
| 3 | Comparison chart over time | `BenchmarkComparisonChart.tsx` - Recharts LineChart | ✅ `BenchmarkComparisonChart.test.tsx` |
| 4 | Anonymous benchmark calculation | `benchmark_service.py` - MIN_CLASSES_FOR_BENCHMARK=5 | ✅ `test_benchmarks.py` |
| 5 | Activity-type benchmarking | `ActivityBenchmarkTable.tsx`, `calculate_activity_type_benchmarks()` | ✅ Both backend & frontend tests |
| 6 | Backend aggregated benchmarks | `benchmark_service.py` - School/Publisher benchmark functions | ✅ 15 backend tests |
| 7 | API endpoint returns comparison data | `GET /api/v1/classes/{class_id}/benchmarks` | ✅ Integration tests |
| 8 | Privacy controls - teachers see aggregates only | Verified in tests - no individual class data exposed | ✅ `test_anonymization_no_individual_class_data` |
| 9 | Benchmarking disable at school/publisher level | Settings endpoints + 403 response handling | ✅ `test_benchmarking_disabled_at_school_level` |
| 10 | Encouraging messaging when outperforming | `BenchmarkMessage.tsx` - "Your class is excelling!" | ✅ `BenchmarkMessage.test.tsx` |
| 11 | Constructive messaging when below | `BenchmarkMessage.tsx` - "Opportunities for growth" | ✅ `BenchmarkMessage.test.tsx` |
| 12 | Admin dashboard system-wide benchmarks | `GET /api/v1/admin/benchmarks/overview` + admin route | ✅ `test_admin_benchmark_overview` |
| 13 | Integration tests for calculations | `test_benchmarks.py` - 15 tests | ✅ All passing |

### Test Results

**Backend Tests:** 15 tests - ✅ All Passing
- Benchmark calculation tests (school, publisher, activity type)
- Authorization tests (teacher, admin)
- Privacy threshold tests (< 5 classes returns null)
- Anonymization verification tests
- Disabled benchmarking 403 response tests

**Frontend Tests:** 35 tests - ✅ All Passing
- `useBenchmarks.test.tsx` - Hook tests with disabled handling
- `BenchmarkCard.test.tsx` - Metric display tests
- `BenchmarkComparisonChart.test.tsx` - Chart rendering tests
- `BenchmarkMessage.test.tsx` - Message variation tests
- `ActivityBenchmarkTable.test.tsx` - Table sorting/coloring tests
- `BenchmarkDisabledMessage.test.tsx` - Disabled state tests

### Code Quality Assessment

**Strengths:**
- Clean separation of concerns (service layer, schemas, API routes)
- Proper TypeScript types aligned with backend Pydantic schemas
- TanStack Query hooks with appropriate stale time (5 min)
- Graceful handling of disabled benchmarking (403 → `isDisabled` state)
- Privacy threshold enforced consistently (MIN_CLASSES_FOR_BENCHMARK = 5)
- Recharts usage consistent with other analytics components

**Architecture:**
- Backend: `benchmark_service.py` centralizes all calculation logic
- Frontend: Component composition pattern (BenchmarkCard, Chart, Table, Message)
- API: RESTful endpoints with proper role authorization

### NFR Validation

| NFR | Status | Notes |
|-----|--------|-------|
| Security | ✅ PASS | Role-based authorization, ownership verification, no data leakage |
| Privacy | ✅ PASS | Minimum 5 classes threshold, anonymization verified |
| Performance | ✅ PASS | 5-minute cache, efficient aggregation queries |
| Maintainability | ✅ PASS | Clean service layer, reusable components |

### Recommendations

**None - Ready for production**

All acceptance criteria are met with comprehensive test coverage. The implementation properly handles edge cases (disabled benchmarking, insufficient data, authorization) and follows established patterns from previous stories.
