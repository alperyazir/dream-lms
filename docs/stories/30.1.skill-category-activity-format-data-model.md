# Story 30.1: Skill Category & Activity Format Data Model

**Status:** Ready for Review
**Epic:** Epic 30 - Skill-Based AI Assignment Generation & Reporting
**Story Points:** 5
**Priority:** High (Foundation — blocks all other Epic 30 stories)
**Dependencies:** None (additive schema changes only)

---

## User Story

As a **system administrator**,
I want **a structured data model for language skill categories and activity formats**,
So that **AI-generated assignments can be classified by pedagogical skill and the system supports skill-based reporting**.

---

## Acceptance Criteria

1. [ ] `SkillCategory` table created with 6 seeded skills (Listening, Reading, Writing, Speaking, Vocabulary, Grammar)
2. [ ] `ActivityFormat` table created with seeded formats (multiple_choice, word_builder, matching, fill_blank, sentence_builder, comprehension)
3. [ ] `SkillFormatCombination` table maps valid skill-format pairs with availability toggle and display ordering
4. [ ] Speaking skill exists but has `is_active=false`
5. [ ] `GET /api/v1/skills/` returns active skills with their available formats
6. [ ] Alembic migration is backward compatible (additive only — no existing table modifications)

---

## Tasks & Subtasks

- [x] **Task 1: Create SkillCategory SQLModel** (AC: 1, 4)
  - [x] Define `SkillCategory` model in `backend/app/models.py` with fields:
    - `id: uuid.UUID` (PK, default uuid4)
    - `name: str` (unique, max_length=100) — e.g., "Listening"
    - `slug: str` (unique, max_length=50) — e.g., "listening"
    - `description: str | None` (max_length=500)
    - `icon: str` (max_length=50) — Lucide icon name, e.g., "ear"
    - `color: str` (max_length=50) — Tailwind color key, e.g., "blue"
    - `display_order: int` (default=0, ge=0)
    - `is_active: bool` (default=True)
    - `parent_id: uuid.UUID | None` (FK self-reference, nullable, for future sub-skills)
    - `created_at: datetime`
  - [x] Add `__tablename__ = "skill_categories"`
  - [x] Add indexes on `slug` (unique) and `is_active`

- [x] **Task 2: Create ActivityFormat SQLModel** (AC: 2)
  - [x] Define `ActivityFormat` model in `backend/app/models.py` with fields:
    - `id: uuid.UUID` (PK, default uuid4)
    - `name: str` (unique, max_length=100) — e.g., "Quiz (MCQ)"
    - `slug: str` (unique, max_length=50) — e.g., "multiple_choice"
    - `description: str | None` (max_length=500)
    - `created_at: datetime`
  - [x] Add `__tablename__ = "activity_formats"`
  - [x] Add unique index on `slug`

- [x] **Task 3: Create SkillFormatCombination SQLModel** (AC: 3)
  - [x] Define `SkillFormatCombination` model in `backend/app/models.py` with fields:
    - `id: uuid.UUID` (PK, default uuid4)
    - `skill_id: uuid.UUID` (FK → skill_categories.id, ondelete CASCADE)
    - `format_id: uuid.UUID` (FK → activity_formats.id, ondelete CASCADE)
    - `is_available: bool` (default=True)
    - `display_order: int` (default=0)
    - `generation_prompt_key: str | None` (max_length=100) — references prompt template identifier
  - [x] Add UniqueConstraint on `(skill_id, format_id)`
  - [x] Add relationships to SkillCategory and ActivityFormat

- [x] **Task 4: Create Alembic Migration** (AC: 6)
  - [x] Generate migration: `alembic revision --autogenerate -m "add_skill_categories_activity_formats"`
  - [x] Verify migration is additive only (CREATE TABLE, no ALTER on existing tables)
  - [x] Test forward migration: `alembic upgrade head`
  - [x] Test rollback: `alembic downgrade -1`

- [x] **Task 5: Create Seed Data** (AC: 1, 2, 3, 4)
  - [x] Create seed script or extend `initial_data.py` with:
    - 6 SkillCategory records:
      - `("Listening", "listening", "ear", "blue", 1, is_active=True)`
      - `("Reading", "reading", "book-open", "green", 2, is_active=True)`
      - `("Writing", "writing", "pencil", "orange", 3, is_active=True)`
      - `("Speaking", "speaking", "mic", "purple", 4, is_active=False)`
      - `("Vocabulary", "vocabulary", "text", "teal", 5, is_active=True)`
      - `("Grammar", "grammar", "braces", "indigo", 6, is_active=True)`
    - 6 ActivityFormat records:
      - `("Quiz (MCQ)", "multiple_choice")`
      - `("Word Builder", "word_builder")`
      - `("Matching", "matching")`
      - `("Fill-in-the-blank", "fill_blank")`
      - `("Sentence Builder", "sentence_builder")`
      - `("Comprehension", "comprehension")`
    - 12 SkillFormatCombination records per the v1 matrix (see Epic 30 matrix)
  - [x] Make seed idempotent (check existence before insert)

- [x] **Task 6: Create Skills API Endpoint** (AC: 5)
  - [x] Create `backend/app/api/routes/skills.py`
  - [x] Implement `GET /api/v1/skills/` endpoint:
    - Returns active skills with nested available formats
    - Ordered by `display_order`
    - Auth required: teacher or higher role
  - [x] Create response schemas in `backend/app/schemas/skill.py`:
    - `SkillCategoryPublic(id, name, slug, icon, color, description, is_active)`
    - `ActivityFormatPublic(id, name, slug, description)`
    - `SkillWithFormatsResponse(skill: SkillCategoryPublic, formats: list[ActivityFormatPublic])`
  - [x] Register router in `backend/app/api/main.py`

- [x] **Task 7: Unit Tests** (AC: 1-6)
  - [x] Test SkillCategory model creation and constraints
  - [x] Test ActivityFormat model creation and constraints
  - [x] Test SkillFormatCombination unique constraint
  - [x] Test GET /api/v1/skills/ returns correct active skills
  - [x] Test Speaking skill is excluded from active results
  - [x] Test unauthorized access returns 401/403

---

## Dev Notes

### Relevant Source Tree
- Models: `backend/app/models.py` — all models in single file [Source: source-tree.md#backend-structure]
- Routes: `backend/app/api/routes/skills.py` — new file [Source: source-tree.md#backend-structure]
- Schemas: `backend/app/schemas/skill.py` — new file [Source: source-tree.md#backend-structure]
- Migrations: `backend/alembic/versions/` [Source: source-tree.md#backend-structure]
- Router registration: `backend/app/api/main.py` [Source: source-tree.md#backend-structure]

### Data Model Patterns
- Use UUID primary keys with `Field(default_factory=uuid.uuid4, primary_key=True)` [Source: coding-standards.md#database-patterns]
- Use SQLModel with `table=True` parameter [Source: coding-standards.md#database-patterns]
- Follow naming: snake_case variables, PascalCase classes [Source: coding-standards.md#naming-conventions]
- JSONB not needed here — these are relational tables

### API Patterns
- Route naming: plural nouns, lowercase (`/skills/`) [Source: 3-api-architecture.md#restful-api-design]
- Auth: Use `require_role(UserRole.teacher)` dependency or higher [Source: 3-api-architecture.md#authentication-authorization]
- Response format: Pydantic response_model [Source: coding-standards.md#fastapi-route-patterns]
- Versioning: `/api/v1/skills/` [Source: 3-api-architecture.md#api-versioning]

### Existing ActivityType Enum Context
The current `ActivityType` enum in `models.py` (lines 761-778) has 13 values (8 DCS + 5 AI). This story does NOT modify the existing enum. The new SkillCategory/ActivityFormat tables are complementary — they add a pedagogical classification layer on top.

### Testing
- Test file location: `backend/app/tests/test_skills.py` [Source: 10-testing-strategy.md]
- Use pytest with async support, AsyncClient [Source: 10-testing-strategy.md#backend-testing]
- Follow arrange-act-assert pattern [Source: coding-standards.md#testing-patterns]
- Test fixtures in conftest.py for teacher_token, admin_token [Source: 10-testing-strategy.md]

---

## Dev Agent Record

### Agent Model Used
claude-opus-4-6

### File List
| File | Action | Description |
|------|--------|-------------|
| `backend/app/models.py` | Modified | Added SkillCategory, ActivityFormat, SkillFormatCombination models |
| `backend/app/schemas/skill.py` | Created | SkillCategoryPublic, ActivityFormatPublic, SkillWithFormatsResponse schemas |
| `backend/app/api/routes/skills.py` | Created | GET /api/v1/skills/ endpoint |
| `backend/app/api/main.py` | Modified | Registered skills router |
| `backend/app/core/db.py` | Modified | Added _seed_skill_data() for idempotent seeding |
| `backend/app/alembic/versions/a1b2c3d4e5f6_add_skill_categories_activity_formats.py` | Created | Migration for 3 new tables |
| `backend/app/tests/test_skills.py` | Created | 12 unit tests (model + API) |

### Completion Notes
- All 12 tests pass (6 model tests + 6 API tests)
- Migration tested forward and rollback successfully
- Live API verified: 5 active skills with correct format mappings
- Speaking skill seeded with is_active=False as required
- 12 skill-format combinations seeded per Epic 30 v1 matrix
- Pre-existing test failures (37 errors importing removed Book model) are NOT caused by this story

### Debug Log References
None — no issues encountered.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2026-02-12 | 1.1 | Implementation complete | Dev Agent (James) |
